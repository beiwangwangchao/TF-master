<#--
        * description: 创建出入库单界面
        * version: 1.0
        * author: mclin
        * .
        *
        -->
    <#include "../include/head.html">
        <body style="padding: 10px;">
        <script type="text/javascript" src="${base.contextPath}/sys/org/current"></script>
        <script src="${base.contextPath}/common/code?
        stockIoStatus=INV.STOCK_IN_OUT_STATUS&trxType=INV.ADJUSTMENT_TYPE&
        stockOutReason=INV.STOCK_REASON&isOrNotArray=SYS.YES_NO"
                type="text/javascript">
        </script>

        <form id="stockio_create_form" method="post"></form>
        <form id="stockio_create_btns"></form>
        <div id="stockio_create_grid" style="margin: 0; padding: 0"></div>
        <script type="text/javascript">
            $(function () {
            <#assign isedit = (RequestParameters.isedit !'0')/>

                /* 下拉框选中事件标志，防止一聚焦下拉框就触发事件 */
                var flag1 = 1; //包装类型下拉框
                var flag4 = 1; //库存组织下拉框

                var uomFlag = false; //标志

                /* 调整类型入库代码 */
                var stkin = 'STKIN';
                var stadj = 'STADJ';
                var stkot = 'STKOT';
                var pstin = 'PSTIN';
                var pstot = 'PSTOT';
                var rtuin = 'RTUIN';

                /* 各个调整类型的出库原因  */
                var stkinStockOutReason = new Array();
                var stadjStockOutReason = new Array();
                var stkotStockOutReason = new Array();
                var pstinStockOutReason = new Array();
                var pstotStockOutReason = new Array();
                var rtuinStockOutReason = new Array();
                /* 根据 调整类型 确定 出库原因 的范围 */
                function getStockOutReason() {
                    for (i = 0; i < stockOutReason.length; i++) {
                        if (stockOutReason[i].description != null && stockOutReason[i].description != '') {
                            if (stockOutReason[i].description.indexOf(stkin) > -1) {
                                stkinStockOutReason.push(stockOutReason[i]);
                            }
                            if (stockOutReason[i].description.indexOf(stadj) > -1) {
                                stadjStockOutReason.push(stockOutReason[i]);
                            }
                            if (stockOutReason[i].description.indexOf(stkot) > -1) {
                                stkotStockOutReason.push(stockOutReason[i]);
                            }
                            if (stockOutReason[i].description.indexOf(pstin) > -1) {
                                pstinStockOutReason.push(stockOutReason[i]);
                            }
                            if (stockOutReason[i].description.indexOf(pstot) > -1) {
                                pstotStockOutReason.push(stockOutReason[i]);
                            }
                            if (stockOutReason[i].description.indexOf(rtuin) > -1) {
                                rtuinStockOutReason.push(stockOutReason[i]);
                            }
                        }
                    }
                }

                getStockOutReason();

                /* 获取Cookie中的值 */
                function getCookie(cookie_name) {
                    var allcookies = document.cookie;
                    var cookie_pos = allcookies.indexOf(cookie_name);//索引的长度

                    if (cookie_pos != -1) {
                        // 把cookie_pos放在值的开始，只要给值加1即可。
                        cookie_pos += cookie_name.length + 1;
                        var cookie_end = allcookies.indexOf(";", cookie_pos);
                        if (cookie_end == -1) {
                            cookie_end = allcookies.length;
                        }
                        var value = unescape(allcookies.substring(cookie_pos, cookie_end));
                    }
                    return value;
                }

                /* 新建订单状态 */
                var nw = 'NEW';
                var cmp = 'COMP';
                var count = 0;

                /* 处理日起和创建日期默认值 */
                var thisDate = new Date(${.now?long});

                /* 表单数据暂存 */
                var formExData = null;

                /* 存储批次号数组初始化 */
                window.lotArray = new Array();

                /* 生成库存组织下拉框 */
                makeOrgSelection();

                window.packingTypeSel = null;
                window.packingTypeLen = 0;

                /* 保存下拉框选中的 */
                var tmpType = null;
                var tmpLotNumber = null;

                /* 是否重置回原值*/
                var isResetOldValue = true;
                var oldValue = null;

                /* 根据 invOrgId 动态设置 operationUnitId */
                function getOperationUnitId(invOrgId) {
                    var operationUnitId;
                    for (var i = 0; i < window.orgSelLen; i++) {
                        if (orgSel[i].invOrgId == invOrgId) {
                            if (orgSel[i].operationUnitId == null) {
                                operationUnitId = '';
                            } else {
                                operationUnitId = orgSel[i].operationUnitId;
                            }
                            return operationUnitId;
                        }
                    }
                }

                /* ----------------------------------------------------------------------------
                                                    页面表单
                   ---------------------------------------------------------------------------- */
                window['stockio_create_form'] = $("#stockio_create_form").ligerForm({
                    inputWidth: 200,
                    space: 15,
                    fields: [
                        /* 出入库ID */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.trxid"/>',
                            type: 'text',
                            name: 'trxId'
                        },
                        /* 单据编号 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.docno"/>',
                            type: 'text', name: 'trxNumber', readonly: true
                        },
                        /* 业务实体ID */
                        {
                            label: ' ',
                            type: 'text',
                            name: 'operationUnitId',
                            newline: false,
                            readonly: true,
                            options: {
                                value: getOperationUnitId(_invOrgId)
                            }
                        },
                        /* 业务实体 */
                        /* {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.delivery.dto.deliverydetail.operationunitid"/>',
                            type: 'text', name: 'operationUnitName', newline: false, readonly: true,
                            options:{
                                value: getOperationUnitId(_invOrgId)
                            },
                            validate: {
                                required: true
                            }
                        }, */
                        /* 库存组织 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.organization"/>',
                            type: 'select', name: 'organizationId', newline: false,
                            options: {
                                data: orgSel,
                                valueField: 'invOrgId',
                                textField: 'name',
                                value: _invOrgId,
                                cancelable: false,
                                onBeforeSelect: function () { //该事件用于记录原值以及将重复标记置为true
                                    isResetOldValue = true;
                                    oldValue = liger.get('organizationId').getValue();
                                },
                                onSelected: function (newKey, newValue) {

                                    // 根据 invOrgId 动态设置 operationUnitId
                                    liger.get('operationUnitId').setValue(getOperationUnitId(newKey));
                                    // 清除行信息
                                    var createGrid = window['stockio_create_grid'];
                                    if (isResetOldValue) {
                                        //库存组织改变时，将退货单号清空
                                        $.ligerui.get('transactionId').setValue("");
                                        $.ligerui.get('transactionId').setText("");
                                        if (createGrid != undefined && createGrid.getData().length > 0) {
                                            $.ligerDialog.confirm('<@spring.message "dsis.lkkhpg.tip.change_confirm"/>', $l('sys.hand.tip.info'), function (yes) {
                                                if (yes) {
                                                    //清空表格
                                                    createGrid.currentData = [];
                                                    createGrid.reRender();
                                                    isResetOldValue = true;
                                                } else { //选择否则重置为原值,并重置标记置false防止重复调用该方法
                                                    isResetOldValue = false;
                                                    liger.get('organizationId').setValue(oldValue); //重置回原值
                                                }
                                            });
                                        }
                                    }
                                },
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 创建日期 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.creationdate"/>',
                            type: 'date', newline: false, name: 'creationDate',
                            options: {
                                format: 'yyyy-MM-dd hh:mm:ss',
                                showTime: true,
                                readonly: true,
                                value: thisDate
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 处理日期 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.trxdate"/>',
                            type: 'date', newline: true, name: 'trxDate',
                            options: {
                                format: 'yyyy-MM-dd hh:mm:ss',
                                showTime: true,
                                value: thisDate,
                                onChangeDate: function (value) {
                                    var now = new Date(${.now?long});
                                    var trxDate = new Date(value).getTime();
                                    if (trxDate > now) {
                                        $.ligerDialog.warn('<@spring.message "msg.warning.inventory.trx_date_must_less_than_now_date"/>', null, function () {
                                            $.ligerui.get('trxDate').setValue(now);
                                        });
                                    }
                                }
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 调整类型 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.trxtype"/>',
                            type: 'select', newline: false, name: 'trxType',
                            options: {
                                valueField: "value",
                                textField: "meaning",
                                data: trxType,
                                cancelable: false,
                                onBeforeSelect: function () { //该事件用于记录原值以及将重复标记置为true
                                    isResetOldValue = true;
                                    oldValue = liger.get('trxType').getValue();
                                },
                                onSelected: function (newKey, newValue) {
                                    if (isResetOldValue) {//如果重复标记为true
                                        var createGrid = window['stockio_create_grid'];
                                        if (createGrid != undefined && createGrid.getData().length > 0) {
                                            $.ligerDialog.confirm('<@spring.message "dsis.lkkhpg.tip.change_confirm"/>', $l('sys.hand.tip.info'), function (yes) {
                                                if (yes) {
                                                    //清空表格
                                                    createGrid.currentData = [];
                                                    createGrid.reRender();

                                                    var input = $('input[id$="_operReasonCode"]');
                                                    var span = input.parents('li').next('li').eq(0).children('span');
                                                    var selection = $.ligerui.get("operReasonCode");
                                                    if (newKey == stkin) {//入库
                                                        if (stkinStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': true,
                                                                'cancelable': false,
                                                                'data': stkinStockOutReason,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                            *  updated by 15750 at 2018/02/09
                                                            * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        } else {
                                                            selection.set({
                                                                //'disabled': true,
                                                                'cancelable': false,
                                                                'data': stkinStockOutReason,
                                                                'value': stkinStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        }
                                                    } else if (newKey == stadj) {//盘盈
                                                        if (stadjStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': true,
                                                                'cancelable': false,
                                                                'data': stadjStockOutReason,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        } else {
                                                            selection.set({
                                                                //'disabled': true,
                                                                'cancelable': false,
                                                                'data': stadjStockOutReason,
                                                                'value': stadjStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        }
                                                    } else if (newKey == pstin) {//采购入库
                                                        if (pstinStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': true,
                                                                'cancelable': false,
                                                                'data': pstinStockOutReason,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        } else {
                                                            selection.set({
                                                                //'disabled': true,
                                                                'cancelable': false,
                                                                'data': pstinStockOutReason,
                                                                'value': pstinStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        }
                                                    } else if (newKey == rtuin) {//退货入库
                                                        if (rtuinStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': true,
                                                                'cancelable': false,
                                                                'data': rtuinStockOutReason,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为退货入库时，退货单号可选，且为必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setEnabled()
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : true});
                                                            $('#manualEnter').css("display", 'block');
                                                        } else {
                                                            selection.set({
                                                                //'disabled': true,
                                                                'cancelable': false,
                                                                'data': rtuinStockOutReason,
                                                                'value': rtuinStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为退货入库时，退货单号可选，且为必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setEnabled();
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : true});
                                                            $('#manualEnter').css("display", 'block');
                                                        }
                                                    } else if (newKey == pstot) {//采购出库
                                                        if (pstotStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': true,
                                                                'cancelable': false,
                                                                'data': pstotStockOutReason,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        } else {
                                                            selection.set({
                                                                //'disabled': true,
                                                                'cancelable': false,
                                                                'data': pstotStockOutReason,
                                                                'value': pstotStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#manualEnter').css("display", 'block');
                                                        }
                                                    }else  if (newKey == stkot) {//出库
                                                        if (stkotStockOutReason.length == 0) {
                                                            selection.set({
                                                                'disabled': false,
                                                                'cancelable': false,
                                                                'data': null,
                                                                'value': ''
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#lotNumberEnter').val(null);
                                                            $('#manualEnter').css("display", 'none');
                                                        } else {
                                                            selection.set({
                                                                'disabled': false,
                                                                'cancelable': false,
                                                                'data': stkotStockOutReason,
                                                                'value': stkotStockOutReason[0].value
                                                            });
                                                            /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                             *  updated by 15750 at 2018/02/09
                                                             * */
                                                            $.ligerui.get('transactionId').setValue("");
                                                            $.ligerui.get('transactionId').setText("");
                                                            $.ligerui.get('transactionId').set('disabled', true);
                                                            window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                            $('#lotNumberEnter').val(null);
                                                            $('#manualEnter').css("display", 'none');
                                                        }
                                                    }
                                                    isResetOldValue = true;
                                                } else { //选择否则重置为原值,并重置标记置false防止重复调用该方法
                                                    isResetOldValue = false;
                                                    liger.get('trxType').setValue(oldValue); //重置回原值
                                                }
                                            })
                                        } else {
                                            var input = $('input[id$="_operReasonCode"]');
                                            var span = input.parents('li').next('li').eq(0).children('span');
                                            var selection = $.ligerui.get("operReasonCode");
                                            if (newKey == stkin) {//入库
                                                if (stkinStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stkinStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stkinStockOutReason,
                                                        'value': stkinStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            } else if (newKey == stadj) {//盘盈
                                                if (stadjStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stadjStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stadjStockOutReason,
                                                        'value': stadjStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            } else if (newKey == pstin) {//采购入库
                                                if (pstinStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': pstinStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': pstinStockOutReason,
                                                        'value': pstinStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            }else if (newKey == rtuin) {//退货入库
                                                if (rtuinStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': rtuinStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为退货入库时，退货单号可选，且为必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setEnabled();
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : true});
                                                    $('#manualEnter').css("display", 'block');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': rtuinStockOutReason,
                                                        'value': rtuinStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为退货入库时，退货单号可选，且为必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setEnabled();
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : true});
                                                    $('#manualEnter').css("display", 'block');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            }else if (newKey == pstot) {//采购出库
                                                if (pstotStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': pstotStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': pstotStockOutReason,
                                                        'value': pstotStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#manualEnter').css("display", 'block');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            }else {//出库STKOT
                                                if (stkotStockOutReason.length == 0) {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stkotStockOutReason,
                                                        'value': ''
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#lotNumberEnter').val(null);
                                                    $('#manualEnter').css("display", 'none');
                                                } else {
                                                    selection.set({
                                                        'disabled': false,
                                                        'cancelable': false,
                                                        'data': stkotStockOutReason,
                                                        'value': stkotStockOutReason[0].value
                                                    });
                                                    /*如果调整类型为非退货入库时，退货单号不可选，且为非必填
                                                     *  updated by 15750 at 2018/02/09
                                                     * */
                                                    $.ligerui.get('transactionId').setValue("");
                                                    $.ligerui.get('transactionId').setText("");
                                                    $.ligerui.get('transactionId').set('disabled', true);
                                                    window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                                                    $('#lotNumberEnter').val(null);
                                                    $('#manualEnter').css("display", 'none');
                                                }
                                                stockio_create_form.setFieldValidate("operReasonCode", {
                                                    required: true
                                                });
                                            }
                                            isResetOldValue = true;
                                        }
                                    }
                                },
                                value: trxType[1].value
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 出库原因 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.stockoutreason"/>',
                            type: 'select', newline: false, name: 'operReasonCode',
                            options: {
                                valueField: 'value',
                                textField: 'meaning',
                                data: stkinStockOutReason,
                                value: stkinStockOutReason[0].value
                            }
                        },
                        /* 供应商代码 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.vendorid"/>',
                            name: "vendorId",
                            type: "popup",
                            newline: true,
                            textField: 'name',
                            options:${lovService.getLov(base.contextPath,base.locale, "lov_vendor")}
                        },
                        /*退货退款单号*/
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.order.dto.payrefundrequest.outrefundno"/>',
                            name: "transactionId",
                            type: "popup",
                            newline: false,
                            textField: 'outRefundNo',
                             /*options:${lovService.getLov(base.contextPath,base.locale, "lov_pay_refund_query")}*/
                            options:
                                $.extend(
                                    ${lovService.getLov(base.contextPath,base.locale, "lov_pay_refund_query")}, {
                                        onLoadData: function () {
                                            this.setParm('invOrgId', liger.get("organizationId").getValue());
                                        },
                                        onSelected: function (v) {
                                            if(v.value.length>0){
                                                var rows=stockio_create_grid.getData()
                                                if(rows.length>0){
                                                    //提示用户重新保存
                                                    $.ligerDialog.confirm(
                                                        $l('<@spring.message "msg.warning.dto.stocktrx.transactionid.change"/>'),
                                                        $l('sys.hand.tip.info'), function (yes) {
                                                            if (yes) {
                                                                findOutRefundNoItem(v.text)
                                                            }else {
                                                                findOutRefundNoItem(v.text)
                                                            }
                                                        }
                                                    )}
                                                else{findOutRefundNoItem(v.text)}

                                            }
                                        },
                                        onChangeValue: function (v) {
                                            this.setParm('invOrgId', liger.get("organizationId").getValue());
                                        }
                                    }
                                )
                        },
                        /* 状态 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.status"/>',
                            type: 'select', newline: false, name: 'status',
                            options: {
                                valueField: "value",
                                textField: "meaning",
                                cancelable: false,
                                data: stockIoStatus,
                                value: stockIoStatus[0].value,
                                readonly: true,
                                onSelected: function (newKey, newValue) {
                                    /* ----------暂时存放---------- */
                                    var ioAddBtn = $("div[toolbarid=ioAddBtn]");
                                    var ioDelBtn = $("div[toolbarid=ioDelBtn]");
                                    var tlDelBtn = $.ligerui.get("tlDelBtn");
                                    var tlSavBtn = $.ligerui.get("tlSavBtn");
                                    var tlSubBtn = $.ligerui.get("tlSubBtn");
                                    if (newKey != nw) {
                                        ioAddBtn.addClass('l-toolbar-item-disable');
                                        ioDelBtn.addClass('l-toolbar-item-disable');
                                        tlDelBtn.set("disabled", true);
                                        tlSavBtn.set("disabled", true);
                                        tlSubBtn.set("disabled", true);
                                    } else {
                                        ioAddBtn.removeClass('l-toolbar-item-disable');
                                        ioDelBtn.removeClass('l-toolbar-item-disable');
                                        tlDelBtn.set("disabled", false);
                                        tlSavBtn.set("disabled", false);
                                        tlSubBtn.set("disabled", false);
                                    }
                                }
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 创建人 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.creatorid"/>',
                            type: 'text',
                            name: 'creator',
                            newline: false,
                            readonly: true,
                            options: {
                                value: getCookie('loginName'),
                            }
                        },
                        /* 备注 */
                        {
                            label: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memwithdraw.remarks"/>',
                            type: 'textarea',
                            newline: true,
                            name: 'remark',
                            editor: {
                                height: 40
                            }
                        }
                    ]
                });

                /* 默认出库原因必输 */
                stockio_create_form.setFieldValidate("operReasonCode", {
                    required: true
                });

                /*默认退货单号不可选*/
                $.ligerui.get('transactionId').set('disabled', true);
                window['stockio_create_form'] .setFieldValidate("transactionId", {required : false});
                /* 隐藏业务实体ID, 用 type:hidden 将无法给业务实体ID动态赋值,所以采用 setVisible 方法 */
                stockio_create_form.setVisible("operationUnitId", false);
                stockio_create_form.setVisible("trxId", false);
                /* ----------------------------------------------------------------------------
                                                    页面表格
                ---------------------------------------------------------------------------- */
                window['stockio_create_grid'] = $("#stockio_create_grid").ligerGrid({
                    columns: [
                        /* 商品代码 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.delivery.dto.deliverydetail.itemid"/>',
                            name: 'itemId', align: 'left', width: 100,
                            textField: 'itemNumber',
                            valueField: 'itemId',
                            editor:
                                $.extend(
                                    ${lovService.getLov(base.contextPath,base.locale, "lov_im_item_query")}, {
                                        onChangeValue: function (v) {
                                            if (!v || v == null || v == "") {
                                                var p = this.options;
                                                var curRow = p.host_grid_row;
                                                p.host_grid.updateRow(curRow, {
                                                    itemName: "",
                                                    uomCode: "",
                                                    uomName: "",
                                                    packingType: null,
                                                    unitOfCarton: "",
                                                    amount: "",
                                                    quantity: "",
                                                    lotNumber: null,
                                                    expiryDate: null,
                                                    remark: "",
                                                    tp: "",
                                                    lc: ""
                                                })
                                            } else {
                                                var p = this.options;
                                                var curRow = p.host_grid_row;
                                                p.host_grid.updateRow(curRow, {
                                                    itemName: "",
                                                    uomCode: "",
                                                    uomName: "",
                                                    packingType: null,
                                                    unitOfCarton: "",
                                                    amount: "",
                                                    quantity: "",
                                                    lotNumber: null,
                                                    expiryDate: null,
                                                    remark: "",
                                                    tp: "",
                                                    lc: ""
                                                })
                                            }
                                        },
                                        staticOptions: function (e) {
                                            e.column.editor.parms = {
                                                trxType: $.ligerui.get("trxType").getValue(),
                                                organizationId: $.ligerui.get("organizationId").getValue()
                                            }
                                        },
                                        onSelect: function (datas) {
                                            var p = this.options;
                                            var curRow = p.host_grid_row;
                                            p.host_grid.updateRow(curRow, {
                                                itemName: datas.data[0].itemName,
                                                uomCode: datas.data[0].uomCode,
                                                uomName: datas.data[0].uomName,
                                                packingType: datas.data[0].uomCode,
                                                unitOfCarton: "",
                                                amount: "",
                                                quantity: "",
                                                lotNumber: null,
                                                expiryDate: null,
                                                remark: "",
                                                tp: datas.data[0].uomName
                                            });
                                        }
                                    }
                                ),
                            validate: {
                                required: true
                            }
                        },
                        /* 商品名称 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.platform.dto.inv.item.itemname"/>',
                            name: 'itemName', align: 'left', width: 160
                        },
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.platform.dto.inv.unit.uomcode"/>',
                            name: 'uomCode', align: 'left', width: 2, hide: true
                        },
                        /* 单位 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.delivery.dto.deliverydetail.uomcode"/>',
                            name: 'uomName', align: 'center', width: 60
                        },
                        /* 批次号 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.delivery.dto.deliverydetail.lotnum"/>',
                            name: 'lotNumber', textField: 'lotNumber', width: 100,
                            editor:
                                $.extend(
                                    ${lovService.getLov(base.contextPath,base.locale, "lov_lot")}, {
                                        onChangeValue: function (v) {
                                            var curRow = this.options.host_grid_row;
                                            if (!v || v == null || v == "") {
                                                tmpLotNumber = null;
                                                stockio_create_grid.updateRow(curRow, {
                                                    lotNumber: null,
                                                    expiryDate: v,
                                                    tl: ""
                                                });
                                            } else {
                                                var p = this.options;
                                                var data = {};
                                                data.itemId = curRow.itemId;
                                                data.invOrgId = $.ligerui.get("organizationId").getValue();
                                                var trxType = $.ligerui.get("trxType").getValue()
                                                if (trxType == stkin || trxType == stadj || trxType == pstin) {
                                                    data.hasOnHandQty = 0;
                                                } else {
                                                    data.hasOnHandQty = 1;
                                                }
//                                      data.hasOnHandQty = $.ligerui.get("trxType").getValue() == stkin ? 0 : 1;
                                                data.lotNumber = v;
                                                var expiryDate = null;
                                                tmpLotNumber = v;
                                                $.ajax({
                                                    url: '${base.contextPath}/pm/lot/getExpiryDate',
                                                    data: data,
                                                    type: 'post',
                                                    async: false,
                                                    dataType: 'json',
                                                    success: function (reData) {
                                                        p.host_grid.updateRow(curRow, {
                                                            //lotNumber: reData.rows[0].lotNumber,
                                                            expiryDate: reData.rows[0].expiryDate,
                                                            tl: v
                                                        });
                                                    }
                                                });
                                            }
                                        },
                                        staticOptions: function (e) {
                                            var itemId = e.record.itemId;
                                            if (!itemId || itemId == null) {
                                                e.column.editor.parms = {
                                                    itemId: 0,
                                                    invOrgId: 0,
                                                    hasOnHandQty: 0
                                                }
                                            } else {
                                                var trxType = $.ligerui.get("trxType").getValue()
                                                var hasOnHandQtyValue = 0;
                                                if (trxType == stkin || trxType == stadj || trxType == pstin) {
                                                    hasOnHandQtyValue = 0;
                                                } else {
                                                    hasOnHandQtyValue = 1;
                                                }
                                                e.column.editor.parms = {
                                                    itemId: e.record.itemId,
                                                    invOrgId: $.ligerui.get('organizationId').getValue(),
                                                    //出库则查询存在库存量的有效批次，入库或盘盈则查询所有有效批次，对应mapper里的hasOnHandQty
                                                    hasOnHandQty: hasOnHandQtyValue
                                                }
                                            }
                                        },
                                        onSelect: function (datas) {
                                            var p = this.options;
                                            tmpLotNumber = null;
                                            if (datas.data.length == 0) {
                                                p.host_grid.updateCell('expiryDate', null, p.host_grid_row);
                                            } else {
                                                p.host_grid.updateCell('expiryDate', datas.data[0].expiryDate, p.host_grid_row);
                                            }
                                        }
                                    }
                                ),
                            validate: {}
                        },
                        /* 批次到期日 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.expirydate"/>',
                            type: 'date', name: 'expiryDate', align: 'center', width: 160, format: 'yyyy-MM-dd',
                            editor: {
                                type: 'date'
                            }
                        },
                        /* 包装类型 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.packingtype"/>',
                            name: 'packingType', textField: 'tp', valueField: 'toUom', align: 'center', width: 80,
                            isSort: false,
                            /* editor: {
                                type: 'text'
                            } */
                            editor: {
                                type: 'select',
                                textField: 'name',
                                valueField: 'toUom',
                                url: "${base.contextPath}/pm/uom/query",
                                cancelable: false,
                                staticOptions: function (e) {
                                    e.column.editor.parms = {
                                        itemId: e.record.itemId == null ? 0 : e.record.itemId,
                                        uomCode: e.record.uomCode == null ? '' : e.record.uomCode
                                    }
                                }
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 箱子单位数量 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.unitofcarton"/>',
                            name: 'unitOfCarton', align: 'right', width: 100,hide: true
                        },
                        /* 数量 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.quantity"/>',
                            name: 'amount', align: 'right', width: 100,
                            editor: {
                                type: 'digits'
                            },
                            validate: {
                                required: true
                            }
                        },
                        /* 出/入库数量 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.inventory.stockio.quantity"/>',
                            name: 'quantity', align: 'right', width: 100,hide: true
                        },
                        /* 备注 */
                        {
                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memwithdraw.remarks"/>',
                            name: 'remark', align: 'left', width: 180,
                            editor: {
                                type: 'text'
                            }
                        },
                        {
                            display: '价格',
                            name: 'unitPrice',
                            width: 90,
                            editor: {
                                type: 'float',
                            },
                            align: "right",
                            validate: {
                                required: true
                            }
                        },
                        /* 明细ID */
                        {
                            display: ' ',
                            name: 'trxDetailId', align: 'left', width: 2, hide: true
                        },
                        /* 包装类型下拉框聚焦时候显示的内容 */
                        {
                            display: ' ',
                            name: 'tp', align: 'left', width: 2, hide: true
                        },
                        /* 批次号手动输入的内容 */
                        {
                            display: ' ',
                            name: 'tl', align: 'left', width: 2, hide: true
                        },
                        /* 批次控制标志 */
                        {
                            display: ' ',
                            name: 'lc', align: 'left', width: 2, hide: true
                        }],
                    toolbar: {
                        id: 'stockio_create_grid_tool_bar',
                        items: [
                            {
                                text: '<@spring.message "sys.hand.btn.new"/>',
                                disable: false,
                                id: 'ioAddBtn',
                                click: function () {
                                    stockio_create_grid.addRow({});
                                    validateHasRows();
                                },
                                icon: 'add'
                            },
                            {line: true},
                            {
                                text: '<@spring.message "sys.hand.btn.delete"/>', disable: false, id: 'ioDelBtn',
                                click: function () {
                                    gridDel({
                                        grid: stockio_create_grid,
                                        url: '${base.contextPath}/im/stocktrxdetails/delete',
                                        successTip: '<@spring.message "msg.info.system.delete_successful"/>'
                                    });
                                }, icon: 'delete'
                            }
                        ]
                    },
                    enabledEdit: true,
                    width: '99%',
                    height: '98%',
                    checkbox: true,
                    rownumbers: true,
                    usePager: false,
                    onBeforeEdit: function (item) {
                        var name = item.column.name, data = item.record;
                        /* if (name == 'packingType'){
                            if(data.itemId != null && data.itemId != ''){
                                item.column.editor = {
                                    type: 'select',
                                    textField: 'name',
                                    valueField: 'toUom',
                                    url: "${base.contextPath}/pm/uom/query",
                                    cancelable: false,
                                    parms:{
                                        itemId : data.itemId,
                                        uomCode: data.uomCode
                                    }
                                }
                                item.column.textField = 'tp';
                                item.column.render=Hap.gridSelectRenderer('tp');
                            }else{
                                item.column.editor = {
                                    type : 'text'
                                }
                                item.column.render = null;
                            }
                        } */
                        if (name == 'lotNumber' || name == 'expiryDate') {
                            var result = false;
                            if (!data.itemId || data.itemId == null || data.itemId == '') {
                                return result;
                            } else {
                                if (item.record.lc == "Y") {
                                    // 启用批次控制
                                    result = true;
                                    item.column.validate = {
                                        required: true
                                    }
                                } else {
                                    // 不启用批次控制
                                    result = false;
                                    item.column.validate = null;
                                }
                                return result;
                            }
                        }
                    },
                    onAfterEdit: function (editParam) {
                        if (editParam.column.name == 'itemId') {
                            var result = "";
                            var temp = $.ligerui.get('organizationId').getValue();
                            $.ajax({
                                url: '${base.contextPath}/im/stocktrx/isLotControl',
                                data: {itemId: editParam.record.itemId, organizationId: temp},
                                type: 'post',
                                dataType: 'json',
                                async: false,
                                success: function (reData) {
                                    if (reData.success) {
                                        if (reData.rows[0].lotControl) {
                                            // 启用批次控制
                                            result = "Y";
                                        } else {
                                            // 不启用批次控制
                                            result = "N";
                                        }
                                    }
                                }
                            })
                            this.updateCell("lc", result, editParam.record);
                        }
                        if (editParam.column.name == 'amount') {
                            if (editParam.record.uomCode == editParam.record.packingType) {
                                this.updateCell("quantity", editParam.record.amount, editParam.record);
                            } else {
                                var newValue = editParam.record.amount * editParam.record.unitOfCarton;
                                if (isNaN(newValue) || parseInt(newValue) == 0) {
                                    this.updateCell("quantity", '');
                                } else {
                                    this.updateCell("quantity", newValue, editParam.record);
                                }
                            }
                        }
                        if (editParam.column.name == 'packingType') {
                            /* if(editParam.record.packingType == ""){
                                this.updateRow(editParam.record,{
                                    packingType: tmpType
                                })
                            } */
                            loadUnitOfCarton(this, editParam, editParam.record.packingType);
                        }
                        if (isNaN(editParam.record.amount) || editParam.record.amount <= 0
                            || isNaN(editParam.record.quantity) || parseInt(editParam.record.quantity) <= 0) {
                            this.updateRow(editParam.record, {
                                amount: '',
                                quantity: ''
                            })
                        }
                        if (editParam.column.name == 'lotNumber') {
                            if (editParam.record.tl != null && editParam.record.tl != "") {
                                this.updateRow(editParam.record, {
                                    lotNumber: editParam.record.lotNumber == "" ? editParam.record.tl : editParam.record.lotNumber
                                })
                            }
                        }
                        stockio_create_grid.reRender();
                    }
                });

                /* ----------------------------------------------------------------------------
                                                    页面按钮
                ---------------------------------------------------------------------------- */
                window['stockio_create_btns'] = $("#stockio_create_btns").ligerForm({
                    buttons: [{
                        text: '<@spring.message "sys.hand.btn.delete"/>',
                        disabled: false, width: 60,
                        id: 'tlDelBtn',
                        click: function () {
                            if ($.ligerui.get("trxNumber").getValue() == null) {
                                reSet();
                                return;
                            }
                            /* 删除整张出入单 */
                            deleteFormAndGrid({
                                form: stockio_create_form,
                                grid: stockio_create_grid,
                                gridName: 'stockTrxDetails',
                                url: "${base.contextPath}/im/stocktrx/allDelete"
                            });
                        }
                    }, {
                        text: '<@spring.message "sys.hand.btn.save"/>',
                        disabled: false, width: 60,
                        id: 'tlSavBtn',
                        click: function () {
                            submitMyForm({
                                form: stockio_create_form,
                                grid: stockio_create_grid,
                                gridName: 'stockTrxDetails',
                                url: "${base.contextPath}/im/stocktrx/create?userId=${Session.userId}",
                                callback: function (json) {
                                    var rs = $.isArray(json.rows) ? json.rows[0].stockTrxDetails : [];
                                    if (rs.length > 0) {
                                        $.each(rs, function (i, n) {
                                            var r = stockio_create_grid.records[n['__id']];
                                            if (r) {
                                                r = $.extend(r, n, {
                                                    '__status': 'nochanged',
                                                    'trxDetailId': r.trxDetailId
                                                })
                                            }
                                        });
                                        stockio_create_grid.deletedRows = [];
                                        stockio_create_grid.reRender();
                                    }

                                    // 保存后，调整类型和库存组织 不可编辑
                                    $.ligerui.get("organizationId").set("disabled", true);
                                    $.ligerui.get("trxType").set("disabled", true);
                                    $.ligerui.get('trxNumber').set({
                                        value: json.rows[0].trxNumber
                                    });
                                    $.ligerui.get('trxId').set({
                                        value: json.rows[0].trxId
                                    });
                                    //$('#trxId').attr('value',json.rows[0].trxId);
                                    formExData = stockio_create_form.getData();

                                    // 若有权限打印，设置打印清单按钮可用
                                <#if accessService.access("EDITABLE_PRINT") == true >
                                    $.ligerui.get('printlistBtn').set('disabled', false);
                                </#if>
                                }
                            })
                        }
                    },
                        {
                            text: '<@spring.message "sys.hand.btn.submit"/>',
                            disabled: false, width: 60,
                            id: 'tlSubBtn',
                            click: function () {
                                $.ligerDialog.confirm('<@spring.message "msg.warning.system.commit_or_not"/>', $l('sys.hand.tip.info'), function (yes) {
                                    if (yes) {
                                        submit();
                                        // 若有权限打印，设置打印清单按钮可用
                                    <#if accessService.access("EDITABLE_PRINT") == true >
                                        $.ligerui.get('printlistBtn').set('disabled', false);
                                    </#if>
                                    }
                                })
                            }
                        }
//                        ,   隐藏列印功能，列印是打印不同格式的报表，调取报表服务器     hand-9633
//                        {
//                            text: '<@spring.message "msg.info.stockio.printlist"/>',
//                            id: 'printlistBtn',
//                            disabled: true,
//                            width: 60,
//                            click: function () {
//                                f_printList();
//                            }
//                        }
                    ]
                });

                /* ----------------------------------------------------------------------------
                                            页面表格列逻辑设置
                ---------------------------------------------------------------------------- */

                /* 包装类型!=单件时，根据商品代码和包装类型自动带出箱子单位数量(!=主单位) */
                function loadUnitOfCarton(grid, curRow, newKey) {
                    if (newKey == curRow.record.uomCode) {
                        grid.updateCell("unitOfCarton", '', curRow.record);
                        grid.updateCell("quantity", curRow.record.amount, curRow.record);
                    } else {
                        if (curRow.record.itemId && curRow.record.itemId != null) {
                            $.ajax({
                                url: "${base.contextPath}/pm/iuc/get",
                                type: "POST",
                                data: {
                                    itemId: curRow.record.itemId,
                                    fromUom: curRow.record.uomCode,
                                    toUom: curRow.record.packingType
                                },
                                success: function (json) {
                                    if (json.success) {
                                        if (!json.rows || json.rows.length == 0) {
                                            grid.updateCell("unitOfCarton", '', curRow.record);
                                            grid.updateCell("quantity", curRow.record.amount, curRow.record);
                                        } else {
                                            var total = curRow.record.amount * json.rows[0].convertRate;
                                            if (isNaN(total)) {
                                                total = 0;
                                            }
                                            grid.updateCell("unitOfCarton", json.rows[0].convertRate, curRow.record);
                                            grid.updateCell("quantity", total, curRow.record);
                                        }
                                    } else {
                                        grid.updateCell("unitOfCarton", '', curRow.record);
                                        grid.updateCell("quantity", curRow.record.amount, curRow.record);
                                    }
                                }
                            });
                        }
                    }
                }

                /* 查询库存组织(下拉框) */
                function makeOrgSelection() {
                    $.ajax({
                        //url : '${base.contextPath}/spm/org/get',
                        url: '${base.contextPath}/spm/invOrganization/queryInvOrgsByRole',
                        async: false,
                        type: "POST",
                        dataType: "json",
                        contentType: "application/json",
                        success: function (json) {
                            window.orgSel = json.rows;
                            if (orgSel != undefined) {
                                window.orgSelLen = orgSel.length;
                            } else {
                                window.orgSelLen = 0;
                            }
                        },
                        error: function () {
                            return;
                        }
                    });
                }

                /* 重置页面上所有字段 */
                function reSet() {
                    $.ligerui.get("trxNumber").set('value', '');
                    $.ligerui.get("trxDate").set('value', null);
                    $.ligerui.get("creationDate").set('value', new Date(${.now?long}));
                    $.ligerui.get("trxType").set('value', 'stock_out');
                    $.ligerui.get("vendorId").clear();
                    $.ligerui.get("status").set('value', nw);
                    var rowsCount = stockio_create_grid.getData().length;
                    if (rowsCount > 0) {
                        for (var i = 0; i < rowsCount; i++) {
                            stockio_create_grid.select(i);
                        }
                        stockio_create_grid.deleteSelectedRow();
                    }
                    $('#remark').val(null);
                    //getLots();
                }

                /**
                 * 删除表单数据(头行数据可一起提交).
                 *
                 * <ul>
                 * <li>options.wrapArray: 是否包装成数组</li>
                 * <li>options.form: form对象</li>
                 * <li>options.grid: grid对象</li>
                 * <li>options.gridName: grid数据的name</li>
                 * <li>options.url: 提交的url</li>
                 * <li>options.success: success回调函数</li>
                 * <li>options.failure: failure回调函数</li>
                 * </ul>
                 * @param options
                 */
                deleteFormAndGrid = function (options) {
                    $.ligerDialog.confirm(options.confirmTip || $l('sys.hand.tip.delete_confirm'), $l('sys.hand.tip.info'), function (yes) {
                        if (yes) {
                            var form = options.form, grid = options.grid, url = options.url,
                                wa = options.wrapArray || true;
                            if (!form) return;
                            if (!(form instanceof $.ligerui.controls.Form)) {
                                form = $.ligerui.get(form);
                            }
                            var d = form.getData();
                            for (var key in d) {
                                if (!d[key]) {
                                    delete d[key]
                                }
                            }
                            if (grid) {
                                grid.endEdit();
                                d[options.gridName || 'grid'] = grid.getData();
                            }
                            $.ajax({
                                url: url,
                                type: "POST",
                                dataType: "json",
                                contentType: "application/json",
                                data: JSON2.stringify(wa ? [d] : d),
                                success: function (json) {
                                    options.json = json;
                                    Hap.defaultSuccessHandler(options)
                                    options = $.extend(options, {
                                        json: json,
                                        grid: grid,
                                        callback: function (json) {
                                            window.top.f_removeCurrentTab();
                                        }
                                    })
                                    Hap.defaultSuccessHandler(options);
                                },
                                error: function () {
                                    $.ligerDialog.closeWaitting();
                                }
                            });
                        }
                    });
                }

                /**
                 * 提交出入库事务(头行数据可一起提交).
                 *
                 * <ul>
                 * <li>options.wrapArray: 是否包装成数组</li>
                 * <li>options.form: form对象</li>
                 * <li>options.grid: grid对象</li>
                 * <li>options.gridName: grid数据的name</li>
                 * <li>options.url: 提交的url</li>
                 * <li>options.success: success回调函数</li>
                 * <li>options.failure: failure回调函数</li>
                 * </ul>
                 * @param options
                 */
                submit = function () {
                    if (!formExData) {
                        /* 未保存时先保存再提交事务 */
                        saveAndSubmit();
                    } else {
                        var changeLen = stockio_create_grid.getChanges().length;
                        var formCurData = stockio_create_form.getData();
                        /* 已保存但有修改过还未保存 */
                        if (validateEqua(formExData, formCurData, changeLen)) {
                            saveAndSubmit();
                        } else {
                            /* 已保存且没有修改过，直接提交事务 */
                            submitForm1({
                                form: stockio_create_form,
                                grid: stockio_create_grid,
                                gridName: 'stockTrxDetails',
                                url: "${base.contextPath}/im/stocktrx/submit?userId=${Session.userId}"

                            });
                        }
                    }
                };

                saveAndSubmit = function () {
                    submitMyForm({
                        form: stockio_create_form,
                        grid: stockio_create_grid,
                        gridName: 'stockTrxDetails',
                        //successTip: '<@spring.message "msg.info.system.commit_successful"/>',
                        url: "${base.contextPath}/im/stocktrx/saveSubmit?userId=${Session.userId}",
                        callback: function (json) {
                            var rs = $.isArray(json.rows) ? json.rows[0].stockTrxDetails : [];
                            if (rs.length > 0) {
                                $.each(rs, function (i, n) {
                                    var r = stockio_create_grid.records[n['__id']];
                                    if (r) {
                                        r = $.extend(r, n, {'__status': 'nochanged', 'trxDetailId': r.trxDetailId})
                                    }
                                });
                                stockio_create_grid.deletedRows = [];
                                stockio_create_grid.reRender();
                            }
                            $.ligerui.get('trxNumber').set({
                                value: json.rows[0].trxNumber
                            });
                            $.ligerui.get('trxId').set({
                                value: json.rows[0].trxId
                            });
                            formExData = stockio_create_form.getData();
                            //修改出入库单状态
                            $.ligerui.get("status").set({
                                value: "COMP"
                            });
                            liger.get('stockio_create_form').setEditable(false);
                            liger.get('stockio_create_grid_tool_bar').setDisabled('ioAddBtn');
                            liger.get('stockio_create_grid_tool_bar').setDisabled('ioDelBtn');
                            stockio_create_grid.options.enabledEdit = false;
                        }
                    });
                };

                /* 只提交事务 */
                submitForm1 = function (options) {
                    var form = options.form, grid = options.grid, url = options.url, wa = options.wrapArray;
                    if (!form) return;
                    var d = form.getData();
                    for (var key in d) {
                        if (!d[key]) {
                            delete d[key]
                        }
                    }
                    if (grid) {
                        grid.endEdit();
                        d[options.gridName || 'grid'] = grid.getData();
                    }
                    $.ligerDialog.waitting(options.waitingTip || $l('sys.hand.tip.processing'));
                    $.ajax({
                        url: url,
                        type: "POST",
                        dataType: "json",
                        contentType: "application/json",
                        data: JSON2.stringify(wa === false ? d : [d]),
                        success: function (json) {
                            options.json = json;
                            //options.successTip = '<@spring.message "msg.info.system.commit_successful"/>';
                            if (json.success) {
                                //修改出入库单状态
                                $.ligerui.get("status").set({
                                    value: "COMP"
                                });
                                liger.get('stockio_create_form').setEditable(false);
                                liger.get('stockio_create_grid_tool_bar').setDisabled('ioAddBtn');
                                liger.get('stockio_create_grid_tool_bar').setDisabled('ioDelBtn');
                                stockio_create_grid.options.enabledEdit = false;
                            }
                            Hap.defaultSuccessHandler(options);
                        },
                        error: function () {
                            $.ligerDialog.closeWaitting();
                        }
                    });
                }
                gridDel = function (options) {
                    var grid = options.grid;
                    if (!grid) $.ligerDialog.alert('"grid" not found in options!', $l('sys.hand.tip.info'), 'error');
                    grid.endEdit();
                    var rows = grid.getSelectedRows(), dls = [];
                    //TODO:给个提示比较好
                    if (rows.length > 0)
                        $.ligerDialog.confirm(
                            options.confirmTip || $l('sys.hand.tip.delete_confirm'),
                            $l('sys.hand.tip.info'), function (yes) {
                                if (yes) {
                                    if (options.url) {
                                        var adds = [];
                                        $.each(rows, function (i, d) {
                                            if (d['__status'] == 'add') {
                                                adds.push(d);
                                                grid.remove(d);
                                            }
                                        });

                                        dls = $.grep(rows, function (item) {
                                            var isL = false;
                                            $.each(adds, function (i, data) {
                                                if (item['__id'] == data['__id']) {
                                                    isL = true;
                                                    return false;
                                                }
                                            })
                                            return !isL;
                                        })

                                        if (dls.length == 0) {
                                            validateHasRows();
                                            return;
                                        }
                                        $.ligerDialog.waitting(options.waitingTip || $l('sys.hand.tip.processing'));
                                        $.ajax({
                                            url: options.url || '',
                                            type: "POST",
                                            dataType: "json",
                                            contentType: "application/json",
                                            data: JSON2.stringify(dls),
                                            success: function (json) {
                                                options = $.extend(options, {
                                                    json: json,
                                                    grid: grid,
                                                    callback: function (json) {
                                                        $.each(dls, function (i, n) {
                                                            grid.remove(grid.records[n['__id']]);
                                                        });
                                                        validateHasRows();
                                                    }
                                                })
                                                Hap.defaultSuccessHandler(options);
                                            },
                                            error: function () {
                                                $.ligerDialog.closeWaitting();
                                            }
                                        });
                                    } else {
                                        $.each(rows, function (i, d) {
                                            if (d['__status'] == 'add') {
                                                grid._removeData(grid.getRow(d));
                                            }
                                        });
                                        grid.deleteSelectedRow();
                                        validateHasRows();
                                    }
                                }
                            });
                }
                /**
                 * 提交表单数据(头行数据可一起提交).
                 *
                 * <ul>
                 * <li>options.wrapArray: 是否包装成数组</li>
                 * <li>options.form: form对象</li>
                 * <li>options.grid: grid对象</li>
                 * <li>options.gridName: grid数据的name</li>
                 * <li>options.url: 提交的url</li>
                 * <li>options.success: success回调函数</li>
                 * <li>options.failure: failure回调函数</li>
                 * </ul>
                 * @param options
                 */
                submitMyForm = function (options) {
                    var form = options.form, grids = options.grid ? [].concat(options.grid) : [],
                        gridNames = [].concat(options.gridName), url = options.url, wa = options.wrapArray;
                    if (!form || form.con) return;
                    if (Hap.validateForm(form) && Hap.validateGrid(grids)) {
                        var d = form.getData();
                        for (var key in d) {
                            if (!d[key]) {
                                delete d[key]
                            }
                        }
                        if (grids.length > 0) {
                            $.each(grids, function (i, grid) {
                                grid.endEdit();
                                d[gridNames[i]] = grid.getData();
                            })
                        }
                        form.con = $.ajax({
                            url: url,
                            type: "POST",
                            dataType: "json",
                            contentType: "application/json",
                            data: JSON2.stringify(wa === false ? d : [d]),
                            success: function (json) {
                                options.json = json;
                                Hap.defaultSuccessHandler(options);
                                form.con = null;
                            },
                            error: function () {
                                $.ligerDialog.closeWaitting();
                                form.con = null;
                            }
                        });
                    }
                };
                /* 移除表格头行的右键菜单 */
                $("div[class='l-grid-popup']").remove();

                /* 判断表格是否有行 */
                function validateHasRows() {
                    var datas = stockio_create_grid.getData();
                    if (!datas || datas.length == 0) {
                        $.ligerui.get('tlSavBtn').set('disabled', true);
                        $.ligerui.get('tlSubBtn').set('disabled', true);
                    } else {
                        $.ligerui.get('tlSavBtn').set('disabled', false);
                        $.ligerui.get('tlSubBtn').set('disabled', false);
                    }
                }

                /* 判断表单某些字段是否有修改 */
                function validateEqua(formExData, formCurData, changeLen) {
                    //trxData
                    if (formExData.trxDate != null && $.trim(formExData.trxDate).length <= 0) {
                        formExData['trxDate'] = null;
                    }
                    if (formCurData.trxDate != null && $.trim(formCurData.trxDate).length <= 0) {
                        formCurData['trxDate'] = null;
                    }
                    //trxType
                    if (formExData.trxType != null && $.trim(formExData.trxType).length <= 0) {
                        formExData['trxType'] = null;
                    }
                    if (formCurData.trxType != null && $.trim(formCurData.trxType).length <= 0) {
                        formCurData['trxType'] = null;
                    }
                    //vendorId
                    if (formExData.vendorId != null && $.trim(formExData.vendorId).length <= 0) {
                        formExData['vendorId'] = null;
                    }
                    if (formCurData.vendorId != null && $.trim(formCurData.vendorId).length <= 0) {
                        formCurData['vendorId'] = null;
                    }
                    //operReasonCode
                    if (formExData.operReasonCode != null && $.trim(formExData.operReasonCode).length <= 0) {
                        formExData['operReasonCode'] = null;
                    }
                    if (formCurData.operReasonCode != null && $.trim(formCurData.operReasonCode).length <= 0) {
                        formCurData['operReasonCode'] = null;
                    }
                    //remark
                    if (formExData.remark != null && $.trim(formExData.remark).length <= 0) {
                        formExData['remark'] = null;
                    }
                    if (formCurData.remark != null && $.trim(formCurData.remark).length <= 0) {
                        formCurData['remark'] = null;
                    }
                    return (formExData.trxDate != formCurData.trxDate ||
                        formExData.trxType != formCurData.trxType ||
                        formExData.vendorId != formCurData.vendorId ||
                        formExData.operReasonCode != formCurData.operReasonCode ||
                        formExData.remark != formCurData.remark || changeLen != 0);
                }

                /* 有传条件就新加载数据 */
                var trxId;
                var tempOrganizationId;
            <#if isedit == '1' >
                //getLots();
                trxId = ${RequestParameters.trxId!'0'};
                tempOrganizationId = ${RequestParameters.organizationId!'0'};
            <#else>
                $.ligerui.get('tlSavBtn').set('disabled', true);
                $.ligerui.get('tlSubBtn').set('disabled', true);
            </#if>
                if (trxId != undefined && trxId != null &&
                    trxId != '0' && trxId != '' && $.trim(trxId).length > 0) {
                    /* 加载表单数据 */
                    Hap.loadForm({
                        form: stockio_create_form,
                        url: '${base.contextPath}/im/stocktrx/get',
                        para: {trxId: trxId, organizationId: tempOrganizationId},
                        callback: function (data) {
                            //$.ligerui.get("trxNumber").setValue(data.trxNumber);
                            /* 加载表格数据 */
                            var jsonObj = {};
                            var gridData = data.stockTrxDetails;
                            var arr = new Array();
                            /* 修改 */
                            for (var i in gridData) {
                                var tmp = gridData[i];
                                tmp.tp = tmp.toUomName;
                                tmp.tl = tmp.lotNumber;
                                if (tmp.lotNumber != null && tmp.lotNumber != "") {
                                    tmp.lc = "Y";
                                } else {
                                    tmp.lc = "N";
                                }
                                arr.push(tmp);
                            }
                            jsonObj.rows = arr;
                            stockio_create_grid.set({data: jsonObj});
                            stockio_create_grid.reRender();

                            /* 默认出库原因必输 */
                            stockio_create_form.setFieldValidate("operReasonCode", {
                                required: true
                            });

                            // 若有权限打印，设置打印清单按钮可用
                        <#if accessService.access("EDITABLE_PRINT") == true >
                            $.ligerui.get('printlistBtn').set('disabled', false);
                        </#if>

                            //如果状态为完成，表单和表格不能编辑
                            if ($.ligerui.get("status").getValue() == cmp) {
                                liger.get('stockio_create_form').setEditable(false);
                                liger.get('stockio_create_grid_tool_bar').setDisabled('ioAddBtn');
                                liger.get('stockio_create_grid_tool_bar').setDisabled('ioDelBtn');
                                stockio_create_grid.options.enabledEdit = false;
                            } else if ($.ligerui.get("status").getValue() == nw) {
                                // 如果状态为新建，调整类型和库存组织不可编辑
                                $.ligerui.get("organizationId").set("disabled", true);
                                $.ligerui.get("trxType").set("disabled", true);
                            }

                            if (!data || data.stockTrxDetails == null) {
                                $.ligerui.get('tlSavBtn').set('disabled', true);
                                $.ligerui.get('tlSubBtn').set('disabled', true);
                            }
                            formExData = data;
                        <#if accessService.access("EDITABLE") == false >
                            liger.get('stockio_create_form').setEditable(false);
                            liger.get('stockio_create_btns').setEditable(false);
                            liger.get('stockio_create_grid_tool_bar').setDisabled('ioAddBtn');
                            liger.get('stockio_create_grid_tool_bar').setDisabled('ioDelBtn');
                            stockio_create_grid.options.enabledEdit = false;
                        </#if>
                        }
                    })
                }
                //
                /*根据退货单号得到退货单中的商品及其价格数量
                * updated by 15750 at 2018/02/09*/
                function findOutRefundNoItem(outRefundNo) {
                    $.ajax({
                        url: "${base.contextPath}/im/stocktrx/getOutRefundItem",
                        type: "POST",
                        dataType: "json",
                        contentType : "application/x-www-form-urlencoded; charset=UTF-8",
                        data: {outRefundNo: outRefundNo},
                        success: function (json) {
                            var jsonObj = {};
                            var gridData = json.rows;
                            var arr = new Array();
                            /* 修改 */
                            for (var i in gridData) {
                                var tmp = gridData[i];
                                tmp.tp = tmp.toUomName;
                                tmp.tl = tmp.lotNumber;
                                if (tmp.lotNumber != null && tmp.lotNumber != "") {
                                    tmp.lc = "Y";
                                } else {
                                    tmp.lc = "N";
                                }
                                arr.push(tmp);
                            }
                            jsonObj.rows = arr;
                            //stockio_create_grid.set({data: jsonObj});
                            //stockio_create_grid.reRender();

                            //updated by 15750 at 2018/02/27
                            //清空表格 并删除数据库中的数据
                            var rows=stockio_create_grid.getData(),dls = [];
                            if (rows.length > 0){
                                var adds = [];
                                //如果表单数据为新增的直接移除表单
                                $.each(rows, function (i, d) {
                                    if (d['__status'] == 'add') {
                                        adds.push(d);
                                        //stockio_create_grid.remove(d);
                                    }
                                });
                                //如果表单数据已加到数据库则需将数据库的数据同时删除
                                dls = $.grep(rows, function (item) {
                                    var isL = false;
                                    $.each(adds, function (i, data) {
                                        if (item['__id'] == data['__id']) {
                                            isL = true;
                                            return false;
                                        }
                                    })
                                    return !isL;
                                })
                                if (dls.length == 0) {
                                    validateHasRows();
                                }else{
                                    $.ajax({
                                        url: '${base.contextPath}/im/stocktrxdetails/delete',
                                        type: "POST",
                                        dataType: "json",
                                        contentType: "application/json",
                                        data: JSON2.stringify(dls),
                                        success: function (json) {
                                        },
                                        error: function () {
                                        }
                                    });
                                }
                            }
                            stockio_create_grid.currentData = [];
                            //将查到的数据依次添加到表单中
                            for(var i in jsonObj.rows) {
                                var row=jsonObj.rows[i];
                                stockio_create_grid.addRow({
                                    itemId: row.itemId,
                                    itemName:row.itemName,
                                    itemNumber:row.itemNumber,
                                    lc:row.lc,
                                    packingType:row.packingType,
                                    quantity:row.quantity,
                                    toUomName:row.toUomName,
                                    tp:row.tp,
                                    unitPrice:row.unitPrice,
                                    uomCode:row.uomCode,
                                    uomName:row.uomName,
                                    amount:row.amount,
                                });
                            }
                        },
                        error: function () {

                        }
                    });
                    /*设置保存及提交按钮可用*/
                    $.ligerui.get('tlSavBtn').set('disabled', false);
                    $.ligerui.get('tlSubBtn').set('disabled', false);
                }
                /* 打印出入库清单 */
                function f_printList() {
                    $.ligerDialog.open({
                        title: '<@spring.message "type.com.lkkhpg.dsis.report.type.choosing"/>',
                        width: 400,
                        height: 300,
                        slide: false,
                        url: "${base.contextPath}/sys/report/sys_report_type_dialog.html",
                        buttons: [{
                            text: '<@spring.message "sys.hand.btn.ok" />',
                            onclick: function (i, d) {
                                var trxId = stockio_create_form.getData().trxId;
                                if (!trxId) {
                                    return;
                                } else {
                                    var form = d.frame.report_type_form;
                                    if (form.valid()) {
                                        window.open('${base.contextPath}/report/run?docType=' + form.getData().docType + '&reportProgramCode=RPT-00180' + '&trxId=' + trxId);
                                        d.close();
                                    }
                                }
                            }
                        },
                            {
                                text: '<@spring.message "sys.hand.btn.cancel" />',
                                onclick: function (i, d) {
                                    d.hide();
                                }
                            }]
                    });
                }
            });
        </script>
        </body>
        </html>