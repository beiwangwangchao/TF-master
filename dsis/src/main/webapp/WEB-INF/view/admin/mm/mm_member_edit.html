<#--
        * description: 会员详情页
        * version: 1.0
        * author: frank.li
        * Copyright LKK Health Products Group Limited.
        *
        -->

    <#include "../include/head.html">

        <script type="text/javascript" src="${base.contextPath}/sys/org/current"></script>
        <script src="${base.contextPath}/resources/js/mm/mm.min.js" type="text/javascript"></script>
        <script src="${base.contextPath}/resources/js/spm/location_edit.min.js" type="text/javascript"></script>


        <body style="padding: 3px; overflow: hidden;">
        <div id="member_detail_btns">
        </div>
        <div id="member_detail_tabs">
            <div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberinfo'/>" tabid="tab1">
                <form id="tab1_form" method="post">
                </form>
            </div>
            <div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.contactsinfo'/>" tabid="tab2">
                <form id="tab2_form" method="post">
                </form>
            </div>
            <div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.relevantsinfo'/>" tabid="tab3">
                <form id="tab3_grid" method="post">
                </form>
            </div>
            <div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.membershipinfo'/>" tabid="tab4">
                <form id="tab4_form">
                </form>
            </div>
            <div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.accountinfo'/>" tabid="tab5">
                <div id="tab5_grid1" style="width: 100%;">
                </div>
                <form id="tab5_form" method="post">
                </form>
                <div id="tab5_grid2" style="width: 100%;">
                </div>
            </div>
            <!--<div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.accountingbalance.accountinginfo'/>" tabid="tab6">-->
            <!--<form id="tab6_form1" method="post">-->
            <!--</form>-->
            <!--<form id="tab6_form2" method="post">-->
            <!--</form>-->
            <!--<div id="tab6_grid" style="width: 100%;">-->
            <!--</div>-->
            <!--</div>-->
            <!--<div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponsinfo'/>" tabid="tab7">-->
            <!--<form id="tab7_form" method="post">-->
            <!--</form>-->
            <!--</div>-->
            <!--<div title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.leveloverview'/>" tabid="tab8">-->
            <!--<form id="tab8_form" method="post">-->
            <!--</form>-->
            <!--<form id="tab8_form2" method="post">-->
            <!--</form>-->
            <!--<div id="tab8_grid">-->
            <!--</div>-->
            <!--</div>-->
            <style>
                .l-layout-left,.l-layout-center {border-top:none;}
            </style>
            <!--<div id="layout" title="<@spring.message 'type.com.lkkhpg.dsis.common.member.dto.memberdetails.offlineinfo'/>" tabid="tab9">-->
            <!--<div position="left" id="accordion" style="overflow:auto">-->
            <!--<div id="tab9_tree"></div>-->
            <!--</div>-->
            <!--<div position="center" >-->
            <!--<form id="tab9_form" >-->
            <!--</form>-->
            <!--<form id="tab9_form2" >-->
            <!--</form>-->
            <!--<div id="tab9_grid" style="margin:10px;">-->
            <!--</div>-->
            <!--</div>-->
            <!--</div>-->
        </div>
        <div id="checkPassword" class="l-panel" style="text-align: center;margin: 8px;display:none;">
            <form id="checkform" method="post"></form>
        </div>

        <!-- 获取代码 -->
        <script src="${base.contextPath}/common/code?memberGender=MM.MEMBER_GENDER&memberIdType=MM.MEMBER_ID_TYPE&memberType=MM.MEMBER_TYPE&memberRole=MM.MEMBER_ROLE&memberLanguage=MM.MEMBER_LANGUAGE&memberRace=MM.MEMBER_RACE&memberEducation=MM.MEMBER_EDUCATION&memberCitizen=MM.MEMBER_CITIZEN&memberAsset=MM.MEMBER_ASSET&memberRelationshipType=MM.MEMBER_RELATIONSHIP_TYPE&memberStatus=MM.MEMBER_STATUS&reviewStatus=SYS.REVIEW_STATUS&yesNo=SYS.YES_NO&relationshipType=MM.RELATIONSHIP_TYPE&siteUseCode=MM.MEMBER_ADDRESS&bankCodeLOV=MM.BANK_CODE&accountingTypeLOV=MM.ACCOUNTING_TYPE&cardStatusLOV=MM.CARD_STATUS&cardTypeLOV=MM.CARD_TYPE&cardSubTypeLOV=MM.CREDIT_CARD_TYPE&idNumberLengthLOV=MM.ID_NUMBER_LENGTH&brNumberLengthLOV=MM.BR_NUMBER_LENGTH&bonusReceivingMethodLOV=MM.MEMBER_BONUS_RECEIVE_METHOD&telCountryCodeLOV=SYS.TEL_COUNTRY_CODE&voucherCategoryLOV=PDM.VOUCHER_CATEGORY&voucherStatusLOV=PDM.VOUCHER_STATUS&memberNationality=MM.MEMBER_NATIONALITY&memberCountryLOV=MM.MEMBER_COUNTRY&travelPlanMonthLOV=ISG.DAPP_TRAVEL_PLAN_MONTH&countryList=MM.MEMBER_DEFAULT_COUNTRY&memberTypeAccess=MM.MEMBER_TYPE_ACCESS" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?creditCardTypeData=MM.CREDIT_CARD_TYPE" type="text/javascript"></script>

        <!-- 获取配置文件 -->
        <script src="${base.contextPath}/common/profile?sysTempPwdReset=SYS.TEMP_PWD_RESET" type="text/javascript"></script>


        <script type="text/javascript">
            $l('sys.hand.title.addressinfo','<@spring.message "sys.hand.title.addressinfo"/>');
            var memberData = {}; //加载的会员数据
            var submitMemberData; //保存的会员数据
            var memberId; //当前会员Id
            var sourceMemberId; //更改所有权的来源会员表Id
            var sourceMemberCode; //更改所有权的来源会员编号
            var defaultCountry;//默认国家，根据市场
            var defaultAcceptBonus;//默认是否接受奖金标识
            getDefaultCountry();//根据市场设置默认国家

            //当前销售组织
            var currentSalesOrgId = ${_salesOrgId?default('')};
            var currentSalesOrgCode = '';

            //组织参数
            var spmParamMemberHomeAddress = '${spmParamMemberHomeAddress}';
            var spmParamMemberRace = '${spmParamMemberRace}';
            var spmParamMemberGstId = '${spmParamMemberGstId}';
            var spmParamMemberNhiTaxExcluded = '${spmParamMemberNhiTaxExcluded}';
            var spmParamMemberApplicitionList = '${spmParamMemberApplicitionList}';
            var spmParamMemberAgeAlert = '${spmParamMemberAgeAlert}';
            var spmParamMemberBankBranch = '${spmParamMemberBankBranch}';
            var spmParamMemberLastNameEditable = '${spmParamMemberLastNameEditable}';

            //编辑模式参数
            <#assign isedit = (RequestParameters.isedit ! '0') />
            <#assign memberId = (RequestParameters.memberId ! ) />

            //更改所有权来源参数
            <#assign isChangeOwnership = (RequestParameters.isChangeOwnership ! '0') />
            <#assign sourceMemberId = (RequestParameters.sourceMemberId ! ) />
            <#assign sourceMemberCode = (RequestParameters.sourceMemberCode ! ) />

            //编辑模式
            var isedit = '0';
            <#if isedit = '1'>
            isedit = ${RequestParameters.isedit};
            </#if>

            //警告tab页、警告信息（只是弹出警告信息，不影响会员保存）
            var warningTab;
            var warningMsg;

            //I-point用户创建会员时，无法填写、查看银行账户、银行卡信息，且其创建的会员的会员类型只能为"个人"；I-point用户只能查看、更新今天创建的会员
            var userType = '${userType?default('')}';
            var isIpoint = '0';
            if (userType == 'IPONT') {
                isIpoint = '1';
            }

            //tab2的校验标记,需要初始化tab2后才会置true
            var tab2ValidateFlag = false;
            //tab5的校验标记,需要初始化tab5后才会置true
            var tab5ValidateFlag = false;
            //页面初次奖金提示,提示过后置false
            var isFirstBonusWaring = true;
            //用于保存会员姓名和账户信息原信息,用于奖金计算日比较
            var oldChnFirstName;
            var oldChnLastName;
            var oldEngFirstName;
            var oldEngLastName;
            var oldAccountNumber;
            var oldBankId;
            var oldAccountHolder;
            var oldAccountIdNumber;
            var oldRemark;
            var oldBankBranchId;

            //获取组织参数，更新会员获取市场组织参数，新增会员只有当前销售区域所以获取销售区域组织参数
            function getOrgParam(orgType, orgId) {
                var params = [{orgType: orgType,
                    orgId: orgId,
                    paramNames: ['SPM.MEMBER_HOME_ADDRESS','SPM.MEMBER_RACE','SPM.MEMBER_HOME_CITIZEN_TYPE','SPM.MEMBER_GST_ID',
                        'SPM.MEMBER_NHI_TAX_EXCLUDED','SPM.MEMBER_APPLICITION_LIST','SPM.MEMBER_AGE_ALERT',
                        'SPM.MEMBER_BANK_BRANCH','SPM.SPM_EDITABLE']}];

                Hap.ajax({
                    url : '${base.contextPath}/spm/orgParam/get',
                    data : params,
                    success : function(json) {
                        //都是维护唯一值的组织参数
                        spmParamMemberHomeAddress = json.rows[0].paramValues['SPM.MEMBER_HOME_ADDRESS'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_HOME_ADDRESS'][0];
                        spmParamMemberRace = json.rows[0].paramValues['SPM.MEMBER_RACE'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_RACE'][0];
                        spmParamMemberGstId = json.rows[0].paramValues['SPM.MEMBER_GST_ID'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_GST_ID'][0];
                        spmParamMemberNhiTaxExcluded = json.rows[0].paramValues['SPM.MEMBER_NHI_TAX_EXCLUDED'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_NHI_TAX_EXCLUDED'][0];
                        spmParamMemberApplicitionList = json.rows[0].paramValues['SPM.MEMBER_APPLICITION_LIST'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_APPLICITION_LIST'][0];
                        spmParamMemberAgeAlert = json.rows[0].paramValues['SPM.MEMBER_AGE_ALERT'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_AGE_ALERT'][0];
                        spmParamMemberBankBranch = json.rows[0].paramValues['SPM.MEMBER_BANK_BRANCH'] == undefined ? null : json.rows[0].paramValues['SPM.MEMBER_BANK_BRANCH'][0];
                        spmParamMemberLastNameEditable = json.rows[0].paramValues['SPM.SPM_EDITABLE'] == undefined ? null : json.rows[0].paramValues['SPM.SPM_EDITABLE'][0];
                    }
                });
            }

            //保存会员
            function save() {
                var manager = $.ligerDialog.waitting('<@spring.message "sys.hand.tip.processing"/>');
                if(!mergerData()){
                    manager.close();
                    return false;
                }
                //若是奖金计算日3号和12号,则比较会员姓名和账户信息是否被更改
                if(isBonusDayAndModify()){
                    $.ligerDialog.confirm('<@spring.message "msg.error.member.cannot_change_info_util_bonus_calculation_done"/>', function (yes) {
                        if(yes){
                            //校验是否有重复的银行账户
                            Hap.ajax({
                                url: '${base.contextPath}/mm/member/isSameAccount',
                                data: submitMemberData,
                                success : function(json) {
                                    if(json&&json.code == "Y"){
                                        $.ligerDialog.confirm("<@spring.messageArgs 'msg.error.member_bank_account_exist' ,['" + json.message + "']/>", function (yes) {
                                            if(yes){
                                                saveMember(manager);
                                            } else {
                                                manager.close();
                                                return false;
                                            }
                                        });
                                    } else {
                                        saveMember(manager);
                                    }
                                }//success
                            });
                        } else {
                            manager.close();
                            return false;
                        }
                    });
                } else {
                    //校验是否有重复的银行账户
                    Hap.ajax({
                        url: '${base.contextPath}/mm/member/isSameAccount',
                        data: submitMemberData,
                        success : function(json) {
                            if(json&&json.code == "Y"){
                                $.ligerDialog.confirm("<@spring.messageArgs 'msg.error.member_bank_account_exist' ,['" + json.message + "']/>", function (yes) {
                                    if(yes){
                                        saveMember(manager);
                                    } else {
                                        manager.close();
                                        return false;
                                    }
                                });
                            } else {
                                saveMember(manager);
                            }
                        }//success
                    });
//         	saveMember(manager);
                }

            }

            //updated by 11816 at 2018/01/04 14:40
            //0115
            function saveMember(manager) {
                //保存会员
                //console.log("--------test start at 2018/01/04 14:32-----------" );
                //console.log(submitMemberData.discount);
                if(submitMemberData.discount >= 0  && submitMemberData.discount<=100) {
                    Hap.ajax({
                        url: '${base.contextPath}/mm/member/save',
                        data: [submitMemberData],
                        success: function (data) {
                            manager.close();
                            if (data.rows[0].isSameSpouseName == 'Y') { //若存在重复配偶姓名则弹出提示
                                $.ligerDialog.alert('<@spring.message "msg.warn.member.is_same_spouse_name"/>', function (yes) {
                                    //同步至GDS
                                    synToGds(data);
                                });
                            } else {
                                //同步至GDS
                                synToGds(data);
                            }
                        }//success
                    }); //Hap.ajax}
                }else{
                    Hap.showError('<@spring.message "msg.warn.member.invaild_discount"/>');
                }
            }

            $(function() {

                //编辑模式加载会员数据
                <#if isedit == '1' >
                Hap.ajax({
                    url: '${base.contextPath}/mm/member/get?memberId=${RequestParameters.memberId}',
                    success: function(data) {
                        if (data.rows == undefined || data.rows[0] == null) {
                            Hap.showError('<@spring.message "msg.error.sys.data_no_found"/>',
                                function() {
                                    if (window.top.f_removeTab  != undefined) {
                                        window.top.f_removeTab('MEMBER_DETAIL')
                                    } else {
                                        window.opener=null;
                                        window.open('','_self');
                                        window.close();
                                    }
                                });
                        } else {
                            memberData = data.rows[0];
                            if (memberData == null) {
                                return;
                            }
                            defaultAcceptBonus = memberData.acceptBonus;
                            // 获取市场组织参数
                            //getOrgParam('MKT', memberData.marketId);

                            //获取本市场可访问会员类型
                            getAccessableMemberType();

                            loadTab1();
                        }
                    },
                    failure: function(data) {
                        Hap.showError(data.message,
                            function() {
                                if (window.top.f_removeTab  != undefined) {
                                    window.top.f_removeTab('MEMBER_DETAIL')
                                } else {
                                    window.opener=null;
                                    window.open('','_self');
                                    window.close();
                                }
                            });
                        return;
                    }
                });
                <#else>
                if (currentSalesOrgId == '') {
                    Hap.showError('<@spring.message "msg.error.sys.user_role_not_assign_org"/>');
                    return;
                }

                Hap.ajax({
                    url: '${base.contextPath}/spm/market/getCompAndMarket?salesOrgId=' + currentSalesOrgId,
                    success: function(data) {
                        if (data.rows != undefined && data.rows[0] != null) {
                            currentSalesOrgCode = data.rows[0].salesOrgCode;
                            memberData.companyCode = data.rows[0].companyCode;
                            memberData.marketCode = data.rows[0].marketCode;

                            //获取本市场可访问会员类型
                            getAccessableMemberType();

                            loadTab1();
                            $.ligerui.get('companyId').setValue(data.rows[0].companyId);
                            $.ligerui.get('companyId').setText(data.rows[0].companyName);
                            $.ligerui.get('marketId').setValue(data.rows[0].marketId);
                            $.ligerui.get('marketId').setText(data.rows[0].marketName);

                            var marketId=data.rows[0].marketId;
                            $.ajax({
                                url: '${base.contextPath}/sys/Organization/selectOrganization',
                                type:"GET",
                                dataType:"json",
                                contentType : "application/json",
                                async: false,
                                data : {"marketId":marketId},
                                success : function(json) {
                                    //console.log(json.rows);
                                    liger.get('salesOrganization').setData(json.rows);
                                    if(json.success){
//                                    var taxRate = json.rows[0].taxRate;
//                                    if(taxRate == null || taxRate== ''){
//                                        tab.selectTabItem('tab2');
//                                        Hap.showError('<@spring.message "msg.error.member.gst_location_tax_not_null"/>');
//                                        tax_validate = false;
//                                    }
                                    }
                                },
                                error : function() {
                                }
                            })
                            // 获取当前销售区域组织所属市场参数
                            //getOrgParam('MKT', data.rows[0].marketId);
                        } else {
                            loadTab1();
                            Hap.showError('<@spring.message "msg.error.member.get_current_comp_market_error"/>');
                        }
                    }
                });

                </#if>

                // 加载工具栏
                window.tab = $("#member_detail_tabs").ligerTab({
                    height:'90%',
                    changeHeightOnResize:true
                });
                window['member_detail_btns'] = $('#member_detail_btns').ligerForm({
                    buttons : [
                        {   // 保存按钮
                            text: '<@spring.message "sys.hand.btn.save"/>',
                            id: 'save_btn',
                            disabled: true,
                            width: 80,
                            click: function() {
                                if (validate()) {
                                    //显示警告信息后继续保存会员
                                    if (warningMsg != null) {
                                        tab.selectTabItem(warningTab||'tab1');
                                        $.ligerDialog.alert(warningMsg, null, function() {save()});  //callback function
                                    } else {
                                        save();
                                    }
                                } //if (validate())
                            }
                        },
                        {   // 提交按钮
                            text: '<@spring.message "sys.hand.btn.submit"/>',
                            id: 'submit_btn',
                            disabled: true,
                            width: 80,
                            click: function() {
                                var manager = $.ligerDialog.waitting('<@spring.message "sys.hand.tip.processing"/>');
                                if (memberData.status != 'NEW' && memberData.status != 'RJECT') {
                                    Hap.showError("<@spring.message 'msg.error.member.memberdetails.submiterror'/>");
                                    manager.close();
                                    return;
                                }

                                // 提交会员
                                Hap.ajax({
                                    url: '${base.contextPath}/mm/member/submit',
                                    data: [memberData],
                                    success : function() {
                                        Hap.showSuccess("<@spring.message 'msg.info.member.member_submit_success'/>", function(){self.location.reload();});
                                    },
                                    error : function() {
                                        Hap.showError("<@spring.message 'msg.error.member.memberdetails.submitprocesserror'/>");
                                    }
                                });
                            }
                        },
//                {   // 下单按钮
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.createorder"/>',
//                    id: "create_order_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        if (window.top.f_addTab != undefined) {
//                            window.top.f_removeTab('ORDER_CREATE');
//                            window.top.f_addTab('ORDER_CREATE', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.member.createorder"/>', '${base.contextPath}/om/om_order_create.html?memberId=' + memberData.memberId);
//                        } else {
//                            window.open('${base.contextPath}/om/om_order_create.html?memberId=' + memberData.memberId, "info", "width=700,height=400")
//                        }
//                    }
//                },
                        {   // 历史订单按钮
                            text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.historyorder"/>',
                            id: "history_order_btn",
                            disabled: true,
                            width: 80,
                            click: function() {
                                if (window.top.f_addTab != undefined) {
                                    window.top.f_addTab('ORDER_INFO', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.historyorder"/>', '${base.contextPath}/om/om_order_query.html?memberCode=' + memberData.memberCode);
                                } else {
                                    window.open('${base.contextPath}/om/om_order_query.html?memberCode=' + memberData.memberCode, "info", "width=700,height=400")
                                }
                            }
                        }
                        ,
//                {   // 变更所有权按钮
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeownership"/>',
//                    id: "change_ownership_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        //先根据此会员remaining balance给出提示
//                        $.ajax({
//                            url: '${base.contextPath}/mm/withdraw/getBalanceByMemberId',
//                            type:"GET",
//                            dataType:"json",
//                            contentType : "application/json",
//                            data : {memberId:memberData.memberId},
//                            success : function(json) {
//                                if(json.success){
//                                    if(json.rows.length==0 || json.rows[0] == '0'){
//                                        $.ligerDialog.confirm('<@spring.message "msg.confirm.mm.change_ownership"/>', function (yes){
//                                            if(yes){
//                                                window.top.f_removeTab('MEMBER_CHANGE_OWNERSHIP');
//                                                window.top.f_addTab('MEMBER_CHANGE_OWNERSHIP', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeownership"/>', '${base.contextPath}/mm/mm_member_edit.html?isChangeOwnership=1&sourceMemberId=' + memberData.memberId + '&sourceMemberCode=' + memberData.memberCode + '&jointDate=' + memberData.jointDate + '&approvalDate=' + (memberData.approvalDate||''));
//                                            }
//                                        })
//                                    }else{
//                                        $.ligerDialog.confirm('<@spring.message "msg.confirm.mm.change_ownership_with_rb"/>', function (yes){
//                                            if(yes){
//                                                window.top.f_removeTab('MEMBER_CHANGE_OWNERSHIP');
//                                                window.top.f_addTab('MEMBER_CHANGE_OWNERSHIP', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeownership"/>', '${base.contextPath}/mm/mm_member_edit.html?isChangeOwnership=1&sourceMemberId=' + memberData.memberId + '&sourceMemberCode=' + memberData.memberCode + '&jointDate=' + memberData.jointDate + '&approvalDate=' + (memberData.approvalDate||''));
//                                            }
//                                        })
//                                    }
//
//                                }
//                            },
//                            error : function() {
//                                window.top.f_removeTab('MEMBER_CHANGE_OWNERSHIP');
//                                window.top.f_addTab('MEMBER_CHANGE_OWNERSHIP', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeownership"/>', '${base.contextPath}/mm/mm_member_edit.html?isChangeOwnership=1&sourceMemberId=' + memberData.memberId + '&sourceMemberCode=' + memberData.memberCode + '&jointDate=' + memberData.jointDate + '&approvalDate=' + (memberData.approvalDate||''));
//                            }
//                        })
//
//                    }
//                },
//                {   // 变更市场
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changemarket"/>',
//                    id: "change_market_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        if (window.top.f_addTab != undefined) {
//                            window.top.f_removeTab('MARKET_CHANGE_APPLY');
//                            window.top.f_addTab('MARKET_CHANGE_APPLY', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changemarket"/>', '${base.contextPath}/mm/mm_marketchange_apply.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&marketId=' + memberData.marketId + '&marketName=' + memberData.marketName + '&memberStatus=' + memberStatus);
//                        } else {
//                            window.open('${base.contextPath}/mm/mm_marketchange_apply.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&marketId=' + memberData.marketId + '&marketName=' + memberData.marketName + '&memberStatus=' + memberStatus, "info", "width=700,height=400");
//                        }
//                    }
//                },
//                {   // 变更上线
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeupstream"/>',
//                    id: "change_upstream_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        if (window.top.f_addTab != undefined) {
//                            window.top.f_removeTab('UPSTREAM_CHANGE_APPLY');
//                            window.top.f_addTab('UPSTREAM_CHANGE_APPLY', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changeupstream"/>', '${base.contextPath}/mm/mm_upstreamchange_apply.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode);
//                        } else {
//                            window.open('${base.contextPath}/mm/mm_upstreamchange_apply.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&memberStatus=' + memberStatus, "info", "width=700,height=400")
//                        }
//                    }
//                },
//                {   // 冲销节余
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.withdraw"/>',
//                    id: "withdraw_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        if (window.top.f_addTab != undefined) {
//                            window.top.f_removeTab('WITHDRAW');
//                            window.top.f_addTab('WITHDRAW', '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.withdraw"/>', '${base.contextPath}/mm/mm_withdraw_query.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&memberStatus=' + memberStatus);
//                        } else {
//                            window.open('${base.contextPath}/mm/mm_withdraw_query.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&memberStatus=' + memberStatus, "info", "width=700,height=400")
//                        }
//                    }
//                },
//                {   // 暂停
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.suspend"/>',
//                    id: "suspend_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        $.ligerDialog.confirm('<@spring.message "msg.warning.member.confirm_suspend"/>', $l('sys.hand.tip.info'), function(yes) {
//                            if (yes) {
//                                $.ligerDialog.waitting('<@spring.message "sys.hand.tip.processing"/>');
//                                Hap.ajax({
//                                    url: '${base.contextPath}/mm/statusChange/save',
//                                    data: {
//                                        memberId: memberData.memberId,
//                                        operationType: "SUSP",
//                                        remark: ""
//                                    },
//                                    success : function() {
//                                        Hap.showSuccess();
//                                        self.location.reload();
//                                    }
//                                });
//                            }
//                        });
//                    }
//                },
//                {   // 重新激活
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.reactivate"/>',
//                    id: "reactive_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        $.ligerDialog.confirm('<@spring.message "msg.warning.member.confirm_reactive"/>', $l('sys.hand.tip.info'), function(yes) {
//                            if (yes) {
//                                $.ligerDialog.waitting('<@spring.message "sys.hand.tip.processing"/>');
//                                Hap.ajax({
//                                    url: '${base.contextPath}/mm/statusChange/save',
//                                    data: {
//                                        memberId: memberData.memberId,
//                                        operationType: "REACT",
//                                        remark: ""
//                                    },
//                                    success : function() {
//                                        Hap.showSuccess();
//                                        self.location.reload();
//                                    }
//                                });
//                            }
//                        });
//                    }
//                },
//                {   // 终止
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.terminate"/>',
//                    id: "terminate_btn",
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        //先验证是否有正在审核中的停权记录
//                        $.ajax({
//                            url: '${base.contextPath}/mm/statusChange/validRecord',
//                            type: "GET",
//                            dataType: "json",
//                            contentType: "application/json",
//                            data: {
//                                memberId: memberData.memberId,
//                                operationType: "TERM",
//                                remark: ""
//                            },
//                            success: function(json) {
//                                if(json.rows[0].isSuccess==false){
//                                    $.ligerDialog.error('<@spring.message "msg.error.member.status.valid_record"/>');
//                                    return;
//                                }else{
//                                    $.ligerDialog.confirm('<@spring.message "msg.warning.member.confirm_terminate"/>', $l('sys.hand.tip.info'), function(yes) {
//                                        if (yes) {
//                                            //$.ligerDialog.waitting('<@spring.message "sys.hand.tip.processing"/>');
//                                            /* Hap.ajax({
//                                        url: '${base.contextPath}/mm/statusChange/save',
//                                        data: {
//                                                 memberId: memberData.memberId,
//                                                 operationType: "TERM",
//                                                 remark: ""
//                                              },
//                                        success : function() {
//                                            Hap.showSuccess();
//                                            self.location.reload();
//                                        }
//                                    }); */
//
//                                            if (window.top.f_addTab != undefined) {
//                                                window.top.f_removeTab('MEMBER_STATUS_CHANGE');
//                                                window.top.f_addTab('MEMBER_STATUS_CHANGE', '会员状态变更', '${base.contextPath}/mm/mm_statuschange_query.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&status=' + memberData.status);
//                                            } else {
//                                                window.open('${base.contextPath}/mm/mm_statuschange_query.html?memberId=' + memberData.memberId + '&memberCode=' + memberData.memberCode + '&status=' + memberData.status, "info", "width=700,height=400")
//                                            }
//
//                                        }
//                                    });
//                                }
//                            },
//                            error: function() {
//                                $.ligerDialog.closeWaitting();
//                            }
//                        });
//                    }
//                },
//                {   // 更改角色
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.changerole"/>',
//                    id: "changerole_btn",
//                    disabled: true,
//                    width: 80,
////                    show:false,
////                    allowClose:false,
//                    click: function() {
//                        $.ligerDialog.confirm('<@spring.message "msg.warning.member.confirm_changerole"/>', $l('sys.hand.tip.info'), function(yes) {
//                            if (yes) {
//                                Hap.ajax({
//                                    url: '${base.contextPath}/mm/member/changeRole',
//                                    data: memberData.memberId,
//                                    success : function() {
//                                        Hap.showSuccess();
////                                              self.location.reload();
//                                    }
//                                });
//                            }
//                        });
//                    }
//                }
//                ,
//                {   // 审计
//                    text: '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.audit"/>',
//                    id: 'audit_btn',
//                    disabled: true,
//                    width: 80,
//                    click: function() {
//                        $.ligerDialog.open({
//                            height     : 630,
//                            width      : 1000,
//                            title      : '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.audit"/>',
//                            url        : 'audit/mm_member_audit.html?memberId=' + memberData.memberId,
//                            showMax    : false,
//                            showToggle : true,
//                            showMin    : false,
//                            isResize   : true,
//                            slide      : false
//                        });
//                    }
//                }
                    ]
                });


                tab.bind('afterSelectTabItem',
                    function(tabid) {
                        if (tabid) {
                            /*********************************
                             *Tab2：联系人信息
                             *********************************/
                            if (tabid == 'tab2' && !window.tab2FormObj) {
                                for (var i in memberIdType) {
                                    if(memberData.marketCode != 'TW' && memberIdType[i].value == 'LPT') {
                                        memberIdType.splice(i,1);
                                    }
                                }
                                //调整界面布局
                                var newline_gstId = true;
                                if(spmParamMemberRace == 'Y'){
                                    newline_gstId = false;
                                }

                                window.tab2FormObj = $('#tab2_form').ligerForm({
                                    inputWidth: 200,
                                    labelWidth: 75,
                                    space: 15,
                                    fields: [
                                    <#if spmParamMemberLastNameEditable == 'Y'>
                                { //中文姓
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.chineselastname"/>',
                                    type: 'text',
                                    id: 'chineseLastName',
                                    name: 'chineseLastName',
                                    newline: true,
                                    options : {
//                         	<#if isedit =="1">
//                                 onFocus : function(){
//                                 	if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                 		isBonusDay_MemberInfo();
//                                 	}
//                                 }
//                         	</#if>
                                    },
                                    validate: {
                                    }
                                },
                                    </#if>
                                { //中文名
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesefirstname"/>',
                                        type: 'text',
                                    id: 'chineseFirstName',
                                    name: 'chineseFirstName',
                                    newline: false,
                                    options : {
//                         	<#if isedit =="1">
//                             	onFocus : function(){
//                                     if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                     	isBonusDay_MemberInfo();
//                                     }
//                                 }
//                         	</#if>
                                },
                                    validate: {
                                        required: true
                                    }
                                },
                            <#if spmParamMemberLastNameEditable == 'Y'>
                                { //英文姓
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishlastname"/>',
                                    type: 'text',
                                    id: 'englishLastName',
                                    name: 'englishLastName',
                                    newline: true,
                                    options : {
//                         	<#if isedit =="1">
//                             	onFocus : function(){
//                                     if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                     	isBonusDay_MemberInfo();
//                                     }
//                                 }
//                         	</#if>
                                    },
                                    validate: {
                                    }
                                },
                                    </#if>
                                { //英文名
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishfirstname"/>',
                                        type: 'text',
                                    id: 'englishFirstName',
                                    name: 'englishFirstName',
                                    newline: false,
                                    options : {
//                         	<#if isedit =="1">
//                             	onFocus : function(){
//                                     if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                     	isBonusDay_MemberInfo();
//                                     }
//                                 }
//                         	</#if>
                                },
                                    validate: {
                                    }
                                },
                                { //性别
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.gender"/>',
                                        type: 'select',
                                    name: 'gender',
                                    newline: false,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: memberGender
                                },
                                    validate: {
                                        required: true
                                    }
                                },
                                { //出生日期
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.dob"/>',
                                        type: 'date',
                                    name: 'dob',
                                    newline: true,
                                    options: {
                                    format: 'yyyy-MM-dd'
                                },
                                    validate: {
                                        required: false
                                    }
                                },
                                { //证件类型
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.idtype"/>',
                                        type: 'select',
                                    name: 'idType',
                                    newline: false,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: memberIdType
                                },
                                    validate: {
                                        required: false
                                    }
                                },
                                { //证件编码
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.idnumber"/>',
                                        type: 'text',
                                    name: 'idNumber',
                                    newline: false,
                                    validate: {
                                    required: false,
                                        maxlength: 30
                                },
                                    options: {
                                        onChangeValue:function(v){ //若为台湾市场则根据证件编号来填充性别
                                            if(memberData.marketCode == 'TW'){
                                                var idNumber = $.ligerui.get('idNumber').getValue();
                                                var secondWord = idNumber.charAt(1);
                                                if(secondWord == '1' || secondWord == 'A' || secondWord == 'C') {
                                                    $.ligerui.get('gender').setValue('M');
                                                }
                                                if(secondWord == '2' || secondWord == 'B' || secondWord == 'D') {
                                                    $.ligerui.get('gender').setValue('F');
                                                }
                                            }
                                        }
                                    }
                                },
                                { //联系号码-区号
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"/>',
                                        type: 'select',
                                    name: 'areaCode',
                                    newline: true,
                                    validate: {
                                    required: true,
                                        maxlength: 30
                                },
                                    width: 50,
                                        options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: telCountryCodeLOV
                                },
                                    validate: {
                                        validatePhoneNo : true,
                                            required:true
                                    }
                                },
                                { //联系号码
                                    display: '-',
                                        type: 'text',
                                    name: 'phoneNo',
                                    newline: false,
                                    labelWidth: 15,
                                    labelAlign: 'left',
                                    validate: {
                                    required: true,
                                        maxlength: 30
                                },
                                    width: 115,
                                        validate: {
                                    validatePhoneNo : true,
                                        required:true
                                }
                                },
                                { //其他联系号码-区号
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.othphoneno"/>',
                                        type: 'select',
                                    name: 'othAreaCode',
                                    width: 50,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: telCountryCodeLOV
                                },
                                    newline: false,
                                        validate: {
                                    validateOthPhoneNo : true
                                }
                                },
                                { //其他联系号码
                                    display: '-',
                                        type: 'text',
                                    name: 'othPhoneNo',
                                    labelWidth: 15,
                                    labelAlign: 'left',
                                    width: 115,
                                    newline: false,
                                    validate: {
                                    validateOthPhoneNo : true
                                }
                                },
                                { //邮箱
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.email"/>',
                                        type: 'text',
                                    name: 'email',
                                    newline: false,
                                    validate: {
                                    email: true
                                }
                                },
                                { //家庭住址ID
                                    type: 'hidden',
                                        name: 'homeLocationId',
                                    hidden: true
                                },
//                        { //家庭住址
//                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.homeaddress"/>',
//                                type: 'text',
//                            name: 'homeLocation',
//                            width: 348,
//                            newline: true,
//                            options: {
//                            onFocus: function(item) {
//                            <#if accessService.access("EDITABLE") == false>
//                                    return;
//                            </#if>
//                                // 如果组织参数设置家庭地址必输则允许弹出编辑器
//                                if (spmParamMemberHomeAddress == 'Y' && memberData.status != 'TERM' && memberData.status != 'ATERM') {
//                                    var e = this;
//                                    location_edit('${base.contextPath}', memberData.homeSpmLocation, function(data){
//                                        e.setValue(data.address);
//                                        memberData.homeSpmLocation = data;
//                                        memberData.homeSpmLocation.locationId = memberData.homeLocationId;
//                                        tab2FormObj.validField("homeLocation")
//                                    })
//                                }
//                            }
//
//                        },
//                            validate: {
//                                required: true
//                            }
//                        },
                                { //联系地址
                                    type: 'hidden',
                                        name: 'contactLocationId',
                                    hidden: true
                                },
                                { //联系地址
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.contactaddress"/>',
                                        type: 'text',
                                    name: 'contactLocation',
                                    width: 348,
                                    newline: true,
                                    options: {
                                    onFocus: function() {
                                    <#if accessService.access("EDITABLE") == false>
                                            return;
                                    </#if>
                                        if (memberData.status != 'TERM' && memberData.status != 'ATERM') {
                                            var e = this;
                                            location_edit('${base.contextPath}', memberData.contactSpmLocation, function(data){
                                                e.setValue(data.address);
                                                memberData.contactSpmLocation = data;
                                                memberData.contactSpmLocation.locationId = memberData.contactLocationId;
                                                tab2FormObj.validField("contactLocation")
                                            })
                                        }
                                    }
                                },
                                    validate: {
                                        required: true
                                    }
                                },
//                        { //复制家庭地址按钮
//                            labelWidth: 2,
//                                id : "copy_location_btn",
//                            name : "copy_location_btn",
//                            type : "html",
//                            newline : false,
//                            render:function(v){
//                        <#if accessService.access("EDITABLE") == false>
//                                return;
//                        </#if>
//                            if (memberData.status == 'TERM' || memberData.status == 'ATERM' || memberData.status == 'SUPSE') {
//                                return '<input type="button" onclick="copyLocation()" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copyaddress"/>' + '" disabled="disabled"/>';
//                            } else {
//                                return '<input type="button" onclick="copyLocation()" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copyaddress"/>' + '"/>';
//                            }
//                        }
//                        },
                                { //国籍
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.nationality"/>',
                                        newline: true,
                                    name: 'nationality',
                                    type: 'select',
                                    options: {
                                    valueField: "value",
                                        textField: "description",
                                        data: memberNationality
                                }
                                },
                                { //国家
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.country"/>',
                                        newline: false,
                                    name: 'country',
                                    type: 'select',
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: memberCountryLOV
                                },
                                    validate: {
                                        required: false
                                    }
                                },
                                { //语言
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.language"/>',
                                        type: 'select',
                                    name: 'language',
                                    newline: false,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: memberLanguage
                                }
                                },
                                { //学历
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.education"/>',
                                        type: 'select',
                                    name: 'education',
                                    newline: true,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: memberEducation
                                }
                                },
                                { //广告接收
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.adoptin"/>',
                                        type: 'select',
                                    name: 'adOptIn',
                                    newline: false,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        valueFieldId: "adOptInFieldId",
                                        data: yesNo
                                },
                                    validate: {
                                        required: true
                                    }
                                },
                                { //系统通知接收
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.sysmsgin"/>',
                                        type: 'select',
                                    name: 'sysMsgIn',
                                    newline: false,
                                    options: {
                                    valueField: "value",
                                        textField: "meaning",
                                        data: yesNo
                                },
                                    validate: {
                                        required: true
                                    }
                                },
                            <#if spmParamMemberRace == 'Y'>
                                { //种族
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.race"/>',
                                    type: 'select',
                                    name: 'race',
                                    newline: true,
                                    options: {
                                        valueField: "value",
                                        textField: "meaning",
                                        data: memberRace
                                    },
                                    validate: {
                                        required: true
                                    }
                                },
                                    </#if>
                            <#if spmParamMemberGstId == 'Y'>
                                { //GST ID编码
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.gstid"/>',
                                    type: 'text',
                                    name: 'gstIdNumber',
                                    newline: newline_gstId,
                                    validate: {
                                        maxlength: 20
                                    }
                                },
                                    { //GST 地址
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.gstsite"/>',
                                        type: 'text',
                                        name: 'gstLocation',
                                        newline: false,
                                        options: {
                                            onFocus: function() {
                                                var e = this;
                                                if(memberData.gstSpmLocation == undefined){
                                                    memberData.gstSpmLocation = {};
                                                }
                                                memberData.gstSpmLocation.countryCode = defaultCountry;

                                                gst_location_edit('${base.contextPath}', memberData.gstSpmLocation, function(data){
                                                    e.setValue(data.address);
                                                    memberData.gstSpmLocation = data;
                                                    memberData.gstSpmLocation.locationId = memberData.gstLocationId;
                                                })

                                            }
                                        }
                                    },
                                    </#if>
                            <#if spmParamMemberNhiTaxExcluded == 'Y'>
                                { //健保税外
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.nhitaxexcluded"/>',
                                    type: 'select',
                                    name: 'nhiTaxExcluded',
                                    newline: true,
                                    options: {
                                        valueField: "value",
                                        textField: "meaning",
                                        data: yesNo
                                    },
                                    validate: {
                                        required: true
                                    }
                                },
                                    </#if>
                            <#if spmParamMemberApplicitionList == 'Y'>
                                { //申请清单
                                    width: 30,
                                    labelWidth: 75,
                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.applicationlist"/>',
                                    type: 'none',
                                    name: 'applyTip',
                                    newline: true
                                },
                                    { //ID复印件
                                        width: 30,
                                        labelWidth: 52,
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.idcopy"/>',
                                        type: 'checkbox',
                                        name: 'idCopy',
                                        newline: false
                                    },
                                    { //申请表
                                        width: 30,
                                        labelWidth: 42,
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.application"/>',
                                        type: 'checkbox',
                                        name: 'applicationForm',
                                        newline: false
                                    },
                                    { //银行账户复印件
                                        width: 30,
                                        labelWidth: 92,
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankaccountcopy"/>',
                                        type: 'checkbox',
                                        name: 'banckAccountCopy',
                                        newline: false
                                    },
                                    { //保密协议
                                        width: 30,
                                        labelWidth: 52,
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.secrecyagreement"/>',
                                        type: 'checkbox',
                                        name: 'confiAgreement',
                                        newline: false
                                    },
                                    </#if>
                                { //签名图片
                                    height: 40,
                                        display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.signature"/>',
                                    type: 'html',
                                    name: 'signature',
                                    id: 'signature',
                                    newline: true,
                                    render:function(v){
                                    return '<img id="signatureImg" width="200px" height="100px" src="${base.contextPath}/sys/attach/file/view?fileId=' + (memberData.signatureFileId||0) + '&_r=' + Math.random() + '"/>';
                                }
                                },
                                { //上传签名按钮
                                    labelWidth: 2,
                                        name : "upload_signature_btn",
                                    type : "html",
                                    newline : false,
                                    render:function(v){
                                <#if accessService.access("EDITABLE") == false>
                                        return;
                                </#if>
                                    if (memberData.status == 'TERM' || memberData.status == 'ATERM' || memberData.status == 'SUPSE') {
                                        return '<input type="button" disabled="disabled" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.upload"/>' + '" onclick="uploadSignature()" />';
                                    } else {
                                        return '<input type="button" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.upload"/>' + '" onclick="uploadSignature()"/>';
                                    }
                                }
                                }]
                            });

                                initTab(2);
                                tab2ValidateFlag = true;
                            } //if(tabid = 2)
                            /*********************************
                             *Tab3：相关人信息
                             *********************************/
                            if (tabid == 'tab3') {
                                if (!window.tab3GridObj) {
                                    for (var i in memberIdType) {
                                        if(memberData.marketCode != 'TW' && memberIdType[i].value == 'LPT') {
                                            memberIdType.splice(i,1);
                                        }
                                    }
                                    window.tab3GridObj = $("#tab3_grid").ligerGrid({
                                            columns: [{
                                                name: 'memberId', type: 'hidden', hide: true
                                            },{
                                                name: 'memRelId', type: 'hidden', hide: true
                                            },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.member.reltype"/>',
                                                    name: 'relType',
                                                    width: 80,
                                                    align: 'left',
                                                    editor: {
                                                        type: 'select',
                                                        valueField: "value",
                                                        textField: "meaning",
                                                        data: relationshipType,
                                                        onChanged:function(e){
//                                     if(e.value == 'SPOUS'){
//                                     	e.column.validate = {
//                                                 required: true
//                                         }
//                                     }
//                                     if ("BENF" == e.record.relType) { debugger
//                                         if (e.column.columnname == "idType" || e.column.columnname == "idNumber" || e.column.columnname == "dob" || e.column.columnname == "relDesc") {
//                                             e.column.validate = {
//                                                     required: true
//                                             };
//                                             return true;
//                                         }
//                                     }
                                                        }
                                                    },
                                                    render: function(item) {
                                                        return getCodeDesc(relationshipType, item.relType);
                                                    }
//                             ,
//                             validate: {
//                                 required: true
//                             }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"/>',
                                                    name: 'chineseName',
                                                    width: 150,
                                                    align: 'left',
                                                    editor: {
                                                        type: 'text'
                                                    },
                                                    validate: {
                                                        maxlength: 23,
                                                        validateRelationshipName : true
                                                    }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"/>',
                                                    name: 'englishName',
                                                    width: 150,
                                                    align: 'left',
                                                    editor: {
                                                        type: 'text'
                                                    },
                                                    validate: {
                                                        maxlength: 69,
                                                        validateRelationshipName : true
                                                    }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.idtype"/>',
                                                    name: 'idType',
                                                    align: 'left',
                                                    width: 80,
                                                    newline: false,
                                                    editor: {
                                                        type: 'select',
                                                        valueField: "value",
                                                        textField: "meaning",
                                                        data: memberIdType
                                                    },
                                                    render: function(item) {
                                                        for (var i in memberIdType) {
                                                            if (memberIdType[i].value == item.idType) {
                                                                return memberIdType[i].meaning;
                                                            }
                                                        }
                                                        return '';
                                                    }
//                             ,
//                             validate: {
//                                 required: true
//                             }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.id"/>',
                                                    name: 'idNumber',
                                                    width: 200,
                                                    align: 'left',
                                                    editor: {
                                                        type: 'text'
                                                    }
//                             ,
//                             validate: {
//                                 maxlength: 20,
//                                 required: true
//                             }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.dob"/>',
                                                    name: 'dob',
                                                    width: 100,
                                                    align: 'left',
                                                    type: 'date',
                                                    editor: {
                                                        type: 'date',
                                                        format: 'yyyy-MM-dd'
                                                    }
//                             ,
//                             validate: {
//                                 required: true
//                             }
                                                },
                                                {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.specificrelation"/>',
                                                    name: 'relDesc',
                                                    width: 150,
                                                    align: 'left',
                                                    editor: {
                                                        type: 'text'
                                                    }
//                             ,
//                             validate: {
//                                 maxlength: 20,
//                                 required: true
//                             }
                                                }],
                                            width: '99%',
                                            height: '95%',
                                            enabledEdit: true,
                                            checkbox: true,
                                            onBeforeEdit : function (e) {
//                             if ("SPOUS" == e.record.relType) {
//                                 if (e.column.columnname == "idType" || e.column.columnname == "idNumber" || e.column.columnname == "dob" || e.column.columnname == "relDesc") {
//                                 	e.column.validate = null;
//                                     return true;
//                                 }
//                             }
//                             if ("BENF" == e.record.relType) {
//                                 if (e.column.columnname == "idType" || e.column.columnname == "idNumber" || e.column.columnname == "dob" || e.column.columnname == "relDesc") {
//                                     e.column.validate = {
//                                             required: true
//                                     };
//                                     return true;
//                                 }
//                             }
                                            },
                                        <#if isedit == '1' >
                                    url: '${base.contextPath}/mm/relationship/query?memberId=${RequestParameters.memberId}',
                                </#if>
                                    toolbar : {
                                        id : 'tab3_grid_toolbar',
                                            items : [ {
                                            text : '<@spring.message "sys.hand.btn.new"/>',
                                            disable : false,
                                            click : function() {
                                                window.tab3GridObj.addRow({})
                                            },
                                            icon : 'add '
                                        }, {
                                            line : true
                                        }, {
                                            text : '<@spring.message "sys.hand.btn.delete"/>',
                                            click : function() {
                                                Hap.gridDelete({
                                                    grid : window.tab3GridObj
                                                })
                                            },
                                            icon : 'delete '
                                        } ]
                                    }
                                });
                                    initTab(3);
                                }
                            }//if(tabid = 3)

                            /*********************************
                             *Tab4：会员身份信息
                             *********************************/
                            if(tabid == 'tab4' && !window.tab4FormObj){
                                window.tab4FormObj = $("#tab4_form").ligerForm({
                                    inputWidth : 200,
                                    space : 15,
                                    fields : [{
                                        display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.joinchannel"/>',
                                        type : 'text', name : 'jointSiteName',newline : true, readonly : true,
                                    }, {
                                        display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.joindate"/>',
                                        type : 'date', name : 'jointDate', newline : false, readonly : true
                                    }, {
                                        display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.approvaldate"/>',
                                        type : 'date', name : 'approvalDate', newline : false, readonly : true
                                    }
//                            , {//推荐人
//                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.sponsorid"/>',
//                                name : "sponsorNo",
//                                <#if isedit == '1'>
//                                  type : "html",
//                                  <#else>
//                                  type : "text",
//                                </#if>
//                                newline : true,
//                                render:function(v){
//                                    <#if isedit == '1'>
////                                         if(memberData.marketCode == memberData.sponsorMarketCode) {
//	                                       if(memberData.sponsorNo==null || memberData.sponsorNo==undefined){
//	                                            return null;
//	                                       } else {
//	                                    	    return '<a href="javascript:toSponsorDetailsHtml('+memberData.sponsorId+')">'+memberData.sponsorNo||''+'</a>';
//	                                       }
////                                         } else {
////                                         	$.ligerDialog.error('<@spring.message "msg.error.member.sponsor_not_in_current_market"/>');
////                                             return '<a href="javascript:void(0);">'+memberData.sponsorNo+'</a>';
////                                         }
//                                    </#if>
//                                },
////                                 readonly :
////                                     <#if isedit == '0'>
////                                        false,
////                                     <#else>
////                                         true,
////                                     </#if>
//                                options: {
//                                    onChangeValue : function(data){
//                                        if (isedit == '0') {
//                                            $.ligerui.get('sponsorChineseName').setValue('');
//                                            $.ligerui.get('sponsorEnglishName').setValue('');
//                                            memberData.isSponsorVerify = false;
//                                            if (data != null && data.length == 9) {
//                                                verifySponsor(data);
//                                            }
//                                        }
//                                    },
//                                },
//                                validate : {
//                                    required : true,
//                                    validateSponsor : true,
//                                    maxlength : 9
//                                }
//                            }, {
//                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.sponsorcnname"/>',
//                                type : 'text', name : 'sponsorChineseName', newline : false, readonly : true
//                            }, {
//                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.sponsorenname"/>',
//                                type : 'text', name : 'sponsorEnglishName', newline : false,readonly : true
//                            }, { //推荐人即时鉴别按钮
//                                labelWidth: 2,
//                                width: 60,
//                                name : "verify_sponsor_btn",
//                                type : "html",
//                                newline : false,
//                                render:function(v){
//                                    <#if isedit == '0'>
//                                        return '<input type="button" onclick="verifySponsor()" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.verifysponsor"/>' + '"/>';
//                                    </#if>
//                                    }
//                            }
//                                ,{
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.sponsorrank"/>',
//                                    type : 'text', name : 'sponsorRankDesc', newline : true, readonly : true
//                                }, {
//                                    type : 'hidden', name : 'rank', hide: true
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bonusreceive"/>',
//                                    type : 'combobox', name : 'acceptBonus', newline : false,
//                                    options : {
//                                        valueField : "value",
//                                        textField : "meaning",
//                                        data : yesNo
//                                    },
//                                    validate : {
//                                        required : true
//                                    }
//                                }, {
//                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bonusrcvmethod"/>',
//                                    type: 'select', name: 'bonusRcvMethod', newline : false,
//                                    options: {
//                                        valueField : "value",
//                                        textField : "meaning",
//                                        data : bonusReceivingMethodLOV
//                                    },
//                                    validate : {
//                                        required : true
//                                    }
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberlevel"/>',
//                                    type : 'text', name : 'rankDesc', newline : true, readonly : true
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tourplaneffectmonth"/>',
//                                    type : 'date', name : 'travelPlanMonth', newline : false, align: 'left',
//                                    options : {
//                                        format: "yyyyMM"
//                                    },
//                                    validate : {
//                                        required : true
//                                    }
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tp"/>',
//                                    type : 'text', name : 'tp', newline : false, readonly : true
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.terminatedate"/>',
//                                    type : 'text', name : 'deadline', newline : true, readonly : true
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.terminationdate"/>',
//                                    type : 'text', name : 'terminationDate', newline : false, readonly : true
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.lastorderdate"/>',
//                                    type : 'text', name : 'lastOrderDate', newline : false, readonly : true, labelWidth:100
//                                }, {
//                                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.traveltimes"/>',
//                                    type : 'text', name : 'travelCount', newline : true, readonly : true
//                                }
                                    ]
                                });

                                initTab(4);
                            }//if(tabid = 4)

                            /*********************************
                             *Tab5：账户信息
                             *********************************/
                            if(tabid == 'tab5'){
                                if(!window.tab5Grid1Obj){
                                    window.tab5Grid1Obj = $("#tab5_grid1").ligerGrid({
                                            title : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.billinginfo"/>',
                                            columns: [ {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.siteuseto"/>',
                                                name: 'siteUseCode', align: 'left', width: 90,
                                                editor: {
                                                    type : 'select',
                                                    valueField : "value",
                                                    textField : "meaning",
                                                    data : siteUseCode
                                                },
                                                render: function(item) {return getCodeDesc(siteUseCode, item.siteUseCode)},
                                                validate: {
                                                    required: true
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.payername"/>',
                                                name: 'name', align: 'left', width: 120,
                                                editor: { type: 'text' },
                                                validate: {
                                                    maxlength : 80,
                                                    required: true
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.areacode"/>',
                                                name: 'areaCode', align: 'left', width: 80,
                                                editor: {
                                                    type: 'select' ,
                                                    valueField: "value",
                                                    textField: "meaning",
                                                    data: telCountryCodeLOV
                                                },
                                                validate: {
                                                    maxlength : 3,
                                                    validateAddrPhoneNo : true,
                                                    required:true
                                                }
                                            },{
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"/>',
                                                name: 'phone', align: 'left', width: 100,
                                                editor: { type: 'text' },
                                                validate: {
                                                    maxlength : 15,
                                                    validateAddrPhoneNo : true,
                                                    required:true
                                                }
                                            }, {//付款地址Id
                                                type : 'hidden', name : 'locationId', hide: true
                                            }, {//付款地址
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.paymentaddress"/>',
                                                name : 'address', align: 'left', width : 345, textField : "address",
                                                editor : {
                                                    type : 'popup',
                                                    onButtonClick:function(){
                                                        var editor = this,pop = this.options,loc = pop.host_grid_row.spmLocation||{}
                                                        location_edit('${base.contextPath}',
                                                            {
                                                                locationId : pop.host_grid_row.locationId||null,
                                                                countryCode :loc.countryCode,
                                                                stateCode :loc.stateCode,
                                                                cityCode :loc.cityCode,
                                                                addressLine1 :loc.addressLine1,
                                                                addressLine2 :loc.addressLine2,
                                                                addressLine3 :loc.addressLine3,
                                                                addressLine4 :loc.addressLine4,
                                                                addressLine5 :loc.addressLine5,
                                                                zipCode :loc.zipCode
                                                            }, function(data){
                                                                pop.host_grid_row.spmLocation = data;
                                                                pop.host_grid_row.spmLocation.locationId = pop.host_grid_row.locationId||null;
                                                                editor.setValue(data.address);
                                                                editor.setText(data.address);
                                                                pop.host_grid.endEdit();
                                                            })
                                                    }
                                                },
                                                validate : {
                                                    required : true
                                                }
                                            }, { //复制联系地址按钮
                                                display : '<@spring.message "sys.hand.btn.action"/>',
                                                name : "copy_contact_location_btn",
                                                type : "html",
                                                width : 100,
                                                newline : false,
                                                render:function(item){
                                                    <#if accessService.access("EDITABLE") == false>
                                                        return;
                                                    </#if>
                                                    if (memberData.status == 'TERM' || memberData.status == 'ATERM' || memberData.status == 'SUPSE') {
                                                        return '<input type="button" disabled="disabled" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copycontactlocation"/>' + '" />';
                                                    } else {
                                                        return '<input type="button" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copycontactlocation"/>' + '" onclick="copyContactLocation(\'' + item.__id+ '\')"/>';
                                                    }
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.defaultaddress"/>',
                                                name: 'defaultFlag', align: 'left', width: 70,
                                                editor: {
                                                    type : 'select',
                                                    valueField : "value",
                                                    textField : "meaning",
                                                    data : yesNo
                                                },
                                                render: function(item) {return getCodeDesc(yesNo, item.defaultFlag)},
                                                validate: {
                                                    required: true
                                                }
                                            } ],
                                            toolbar : {
                                                id : 'tab5_grid1_toolbar',
                                                items : [ {
                                                    text : '<@spring.message "sys.hand.btn.new"/>',
                                                    disable : false,
                                                    click : function() {
                                                        window.tab5Grid1Obj.addRow({})
                                                    },
                                                    icon : 'add '
                                                }, {
                                                    line : true
                                                }, {
                                                    text : '<@spring.message "sys.hand.btn.delete"/>',
                                                    click : function() {
                                                        Hap.gridDelete({
                                                            grid : window.tab5Grid1Obj
                                                        })

                                                    },
                                                    icon : 'delete '
                                                }]
                                            },
                                        <#if isedit == '1'>
                                    url: '${base.contextPath}/mm/site/query?memberId=${RequestParameters.memberId}',
                                </#if>
                                    rownumbers : true,
                                        usePager : true,
                                        enabledEdit : true,
                                        width : '99%',
                                        height : '240px',
                                        checkbox : true
                                });
                                }

                                //非Ipoint用户才可见银行账户和
                                if (isIpoint != '1') {
                                    if(!window.tab5FormObj){
                                        var beforeValue;
                                        var beforeText;
                                        var bool;
                                        window.tab5FormObj = $("#tab5_form").ligerForm({
                                            fields: [ {
                                                type : 'hidden', name : 'accountId', hide: true
                                            }, {
                                                type : 'hidden', name : 'memberId', hide: true
                                            }, {
                                                type : 'hidden', name : 'accountNumber', hide: true
                                            }, {
                                                type : 'hidden', name : 'isCardUpdate', hide: true
                                            }, {
                                                labelWidth : 0,
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankaccountinfo"/>',
                                                type : 'none', name : 'bankTip',
                                                style : 'font-size:12px;font-weight:bold;margin-left:0px;color:#333333'
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankcode"/>',
                                                type : 'popup', name: 'bankId', newline : true,
                                                //银行LOV-总行
                                                valueField :'bankId',
                                                textField :'bankName',
                                                options: $.extend(${lovService.getLov(base.contextPath,base.locale, "lov_bank")},{
                                                    onLoadData: function(){
                                                        this.setParm('bankType','HQ');
                                                        this.setParm('marketId',_marketId);
                                                    },
                                                    onSelect : function(data) {
                                                        if (spmParamMemberBankBranch == 'Y') {
                                                            var manager = $.ligerui.get('bankBranchId');
                                                            manager.setValue("");
                                                            manager.setText("");
                                                            if (data == "" || data == null) {
                                                                manager.setDisabled();
                                                            } else {
                                                                if (spmParamMemberBankBranch == 'Y') {
                                                                    manager.setEnabled();
                                                                }
                                                            }
                                                        }
//                                                 <#if isedit =="1">
//                                                     if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                                     	beforeValue = $.ligerui.get('bankId').getValue();
//                                                     	beforeText = $.ligerui.get('bankId').getText();
//                                                     	isBonusDay_AccountInfo();
//                                                     }
//                                                 </#if>
                                                    },
//                                             onSelected: function(newKey, newValue){
//                                             	if(!bool){ //若正处于奖金计算日,则把bankId原值重置
//                                             		$.ligerui.get('bankId').setValue(beforeValue);
//                                                     $.ligerui.get('bankId').setText(beforeText);
//                                             	}
//                                             },
                                                    onChangeValue : function(data) {
                                                        if (spmParamMemberBankBranch == 'Y') {
                                                            var manager = $.ligerui.get('bankBranchId');
                                                            manager.setValue("");
                                                            manager.setText("");
                                                            if (data == "" || data == null) {
                                                                manager.setDisabled();
                                                            } else {
                                                                if (spmParamMemberBankBranch == 'Y') {
                                                                    manager.setEnabled();
                                                                }
                                                            }
                                                        }
                                                    }
                                                })
                                            },
                                            <#if spmParamMemberBankBranch == 'Y'>
                                        {
                                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankbranchcode"/>',
                                            type : 'popup', name: 'bankBranchId', newline : false,
                                            //银行LOV-支行
                                            valueField :'bankBranchId',
                                            textField :'bankBranchName',
                                            options: $.extend(${lovService.getLov(base.contextPath,base.locale, "lov_bank")},{
                                                onLoadData: function(){
                                                    this.setParm('headOfficeId', $.ligerui.get('bankId').getValue());
                                                    this.setParm('bankType','BH');
                                                }
                                            })
                                        },
                                            </#if>
                                        {
                                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.accountnumber"/>',
                                                name: 'accountNumber', newline : false,
                                            options : {
                                            type: 'text'
//                                             onChangeValue : function(data) {
//                                                 text = this.options;
//                                                 text.host_form.data.isCardUpdate = true;
//                                                 $("#accountNumber").val(($.ligerui.get('maskedAccountNumber').getValue())||'');
//                                             }
//                                             <#if isedit =="1">
//                                              ,onFocus : function(){
//                                             	 if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                                      isBonusDay_AccountInfo();
//                                                  }
//                                              }
//                                             </#if>
                                        },
                                            validate : {
                                                maxlength : 20
                                            }
                                        }, {
                                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.comments"/>',
                                                type: 'text',
                                                name: 'comments',
                                                newline: false,
                                                options : {
//                                             <#if isedit =="1">
//                                                  onFocus : function(){
//                                                      if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                                          isBonusDay_AccountInfo();
//                                                      }
//                                                  }
//                                             </#if>
                                            },
                                            validate: {
                                                maxlength: 100,
                                            }
                                        }, {
                                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.accountholder"/>',
                                                type: 'text', name: 'accountHolder', newline : true,
                                                options : {
//                                         	<#if isedit =="1">
//                                                  onFocus : function(){
//                                                      if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                                          isBonusDay_AccountInfo();
//                                                      }
//                                                  }
//                                         	</#if>
                                            },
                                            validate : {
                                                maxlength : 50
                                            }
                                        }, {
                                            display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.idnumber"/>',
                                                type: 'text', name: 'idNumber', id: "accountIdNumber", newline : false,
                                                options : {
//                                         	<#if isedit =="1">
//                                                 onFocus : function(){
//                                                     if(memberData.status != 'TERM' && memberData.status != 'ATERM' && isFirstBonusWaring){
//                                                         isBonusDay_AccountInfo();
//                                                     }
//                                                 }
//                                         	</#if>
                                            },
                                            validate : {
                                                maxlength : 20
                                            }
                                        }, { //复制账户信息按钮
                                            //labelWidth: 2,
                                            id : "copy_account_btn",
                                                name : "copy_account_btn",
                                                type : "html",
                                                newline : false,
                                                render:function(v){
                                            <#if accessService.access("EDITABLE") == false>
                                                    return;
                                            </#if>
                                                if (memberData.status == 'TERM' || memberData.status == 'ATERM' || memberData.status == 'SUPSE') {
                                                    return '<input type="button" onclick="copyAccount()" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copy"/>' + '" disabled="disabled"/>';
                                                } else {
                                                    return '<input type="button" onclick="copyAccount()" value="' + '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.copy"/>' + '"/>';
                                                }
                                            }
                                        } ],
                                    });
                                    }
                                    if(!window.tab5Grid2Obj){
                                        window.tab5Grid2Obj = $("#tab5_grid2").ligerGrid({
                                                title : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankcardinfo"/>',
                                                columns: [ {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.cardtype"/>', name: 'cardType', align: 'left', width: 100,
                                                    editor: {
                                                        type: 'select',
                                                        valueField : "value",
                                                        textField : "meaning",
                                                        data : cardTypeLOV
                                                    },
                                                    render: function(item) {return getCodeDesc(cardTypeLOV, item.cardType)},
                                                    validate: {
                                                        required: true
                                                    }
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.cardsubtype"/>', name: 'cardSubType', align: 'left', width: 100,
                                                    editor: {
                                                        type: 'select',
                                                        valueField : "value",
                                                        textField : "meaning",
                                                        data : cardSubTypeLOV
                                                    },
                                                    render: function(item) {return getCodeDesc(cardSubTypeLOV, item.cardSubType)},
                                                    validate: {
                                                        required: true
                                                    }
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankcode"/>', name: 'bankCode', align: 'left', width: 100,
                                                    editor: {
                                                        type: 'text'
                                                    }
                                                }, {
                                                    name: 'cardNumber', hide : true
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankcardnumber"/>', name: 'maskedCardNumber', align: 'left', width: 200,
                                                    editor : {
                                                        type : 'text',
                                                        onChangeValue : function(date) {
                                                            var editor = this,text = this.options;
                                                            text.host_grid_row.cardNumber = date;
                                                            text.host_grid_row.isCardUpdate = true;
                                                        }
                                                    },
                                                    validate: {
                                                        maxlength : 20,
                                                        required: true
                                                    }
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.effectdate"/>', name: 'expiryDate', align: 'left', width: 90,
                                                    type : 'date',
                                                    format : 'yyyy-MM',
                                                    width : 100,
                                                    editor : {
                                                        format : 'yyyy-MM',
                                                        type : 'date'
                                                    },
                                                    validate: {
                                                        required: true
                                                    }
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.defaultcard"/>', name: 'defaultFlag', align: 'left', width: 70,
                                                    editor: {
                                                        type: 'select',
                                                        valueField : "value",
                                                        textField : "meaning",
                                                        data : yesNo
                                                    } ,
                                                    render: function(item) {return getCodeDesc(yesNo, item.defaultFlag)},
                                                    validate: {
                                                        required: true
                                                    }
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankardstatus"/>', name: 'status', align: 'left', width: 70,
                                                    editor: {
                                                        type: 'select',
                                                        valueField : "value",
                                                        textField : "meaning",
                                                        data : cardStatusLOV
                                                    },
                                                    render: function(item) {return getCodeDesc(cardStatusLOV, item.status)},
                                                    validate: {
                                                        required: true
                                                    }
                                                }],
                                                toolbar: {
                                                    id : 'tab5_grid2_toolbar',
                                                    items: [
                                                        { text: '<@spring.message "sys.hand.btn.new"/>',disable:false, click: function(){window.tab5Grid2Obj.addRow({})}, icon: 'add ' },
                                                        { line: true },
                                                        { text: '<@spring.message "sys.hand.btn.delete"/>', click: function(){
                                                            Hap.gridDelete({
                                                                grid:window.tab5Grid2Obj
                                                            })
                                                        }, icon: 'delete'},
                                                        { line : true },
                                                        { text : '<@spring.message "type.com.lkkhpg.dsis.common.order.dto.orderpayment.querybank"/>',
                                                            click : function() {
                                                                checkBankCard();
                                                            }
                                                        }
                                                    ]
                                                },
                                            <#if isedit == '1'>
                                        url: '${base.contextPath}/mm/card/query?memberId=${RequestParameters.memberId}',
                                    </#if>
                                        rownumbers : true,
                                            enabledEdit: true,
                                            usePager: true,
                                            width: '99%',
                                            height: '240px',
                                            checkbox: true
                                    });
                                        initTab(5);
                                        tab5ValidateFlag = true;
                                    }
                                }//if (isIpoint != '1')
                            <#if isedit == '0'>
                                    if(liger.get('tab5_grid1').recordNumber==0){
                                        if(memberData.marketCode == 'TW'){
                                            liger.get('tab5_grid1').addRow({siteUseCode:'BILL',defaultFlag:'Y',areaCode:'886'})
                                            liger.get('tab5_grid1').addRow({siteUseCode:'SHIP',defaultFlag:'Y',areaCode:'886'})
                                        } else {
                                            liger.get('tab5_grid1').addRow({siteUseCode:'BILL',defaultFlag:'Y'})
                                            liger.get('tab5_grid1').addRow({siteUseCode:'SHIP',defaultFlag:'Y'})
                                        }
                                    }
                            </#if>
                            }//if(tabid = 5)


                            /*********************************
                             *Tab6：资产信息
                             *********************************/
                            if(tabid == 'tab6'){
                                /*资产信息*/
                                if(!window.tab6formObj1){
                                    window.tab6formObj1 = $("#tab6_form1").ligerForm({
                                        fields: [ {
                                            labelWidth : 100,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingbalance.accountinginfo"/>',
                                            type : 'none', name : 'accountingInfoTip',
                                            style : 'font-size:12px;font-weight:bold;margin-left:20px;color:#333333'
                                        }, {
                                            labelWidth : 120,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingbalance.salespoint"/>',
                                            type : 'text', name : 'salesPoint', newline : true,readonly : true
                                        }, {
                                            labelWidth : 120,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingbalance.exchangebalance"/>',
                                            type : 'text', name : 'exchangeBalance', newline : true,readonly : true
                                        }, {
                                            labelWidth : 130,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingbalance.remainingbalance"/>',
                                            type : 'text', name : 'remainingBalance', newline : false,readonly : true
                                        } ]
                                    });


                                    //获取资产信息数据并行列转置
                                    var sales_point = null;
                                    var exchange_balance = null;
                                    var remaining_balance = null;
                                    if (memberData.memAccountingBalances != null) {
                                        for (i = 0; i < memberData.memAccountingBalances.length; i++) {
                                            if (memberData.memAccountingBalances[i].accountingType == 'SP') {
                                                sales_point = memberData.memAccountingBalances[i].balance;
                                            } else if (memberData.memAccountingBalances[i].accountingType == 'EB') {
                                                exchange_balance = memberData.memAccountingBalances[i].balance;
                                            } else if (memberData.memAccountingBalances[i].accountingType == 'RB') {
                                                remaining_balance = memberData.memAccountingBalances[i].balance;
                                            }
                                        }
                                    }

                                    //加载资产信息
                                <#if isedit == '1'>
                                    $("#tab6_form1").ligerForm().setData({
                                        salesPoint: sales_point,
                                        exchangeBalance: exchange_balance,
                                        remainingBalance: remaining_balance
                                    });
                                </#if>
                                }

                                /*资产交易明细查询*/
                                if(!window.tab6formObj2){
                                    window.tab6formObj2 = $("#tab6_form2").ligerForm({
                                        fields: [ {
                                            labelWidth : 100,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.accountingtrxinfo"/>',
                                            type : 'none', name : 'accountingInfoTip',
                                            style : 'font-size:12px;font-weight:bold;margin-left:20px;color:#333333'
                                        }, {
                                            labelWidth : 100,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.accountingtype"/>',
                                            type: 'combobox', name : 'accountingType', newline : true,
                                            editor : {
                                                valueField : "value",
                                                textField : "meaning",
                                                data : accountingTypeLOV
                                            }
                                            ,
                                            validate : {
                                                required : true
                                            }
                                        }, {
                                            labelWidth : 100,
                                            display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.datefromto"/>',
                                            type : 'date', name : 'trxDateFrom', newline : false,
                                            editor : {
                                                format: "yyyy-MM-dd"
                                            }
                                        }, {
                                            labelWidth : 50,
                                            display : '-',
                                            type : 'date', name : 'trxDateTo', newline : false,
                                            editor : {
                                                format: "yyyy-MM-dd"
                                            }
                                        } ],
                                        buttons: [
                                            {  text: '<@spring.message "sys.hand.btn.query"/>',
                                                id: 'queryAccountingTrxBtn',
                                                disabled: false,
                                                width: 60,
                                                click: function(){
                                                    if (window.tab6formObj2.getData().accountingType == "" ) {
                                                        Hap.showError('<@spring.message "msg.warning.member.choose_accounting_type"/>');
                                                        return;
                                                    }

                                                    Hap.gridQuery({
                                                        form: window.tab6formObj2,
                                                        grid: window.tab6gridObj
                                                    })
                                                }}
                                        ]
                                    });

                                }

                                //资产交易明细查询
                                if(!window.tab6gridObj){
                                    window.tab6gridObj = $("#tab6_grid").ligerGrid({
                                            columns: [ {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.trxdate"/>',
                                                name: 'trxDate', align: 'left', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.remark"/>',
                                                name: 'remark', align: 'left', width: 400
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.income"/>',
                                                name: 'trxValue', align: 'right', width: 100,
                                                render: function(item) {
                                                    if (item.trxValue > 0)
                                                        return item.trxValue;
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.accountingtrx.expenditure"/>',
                                                name: 'trxValue', align: 'right', width: 100,
                                                render: function(item) {
                                                    if (item.trxValue < 0)
                                                        return item.trxValue;
                                                }
                                            } ],
                                        <#if isedit == '1'>
                                    url: '${base.contextPath}/mm/accountingtrx/query?memberId=${RequestParameters.memberId}',
                                </#if>
                                    delayLoad  : true,
                                        rownumbers : true,
                                        usePager: true,
                                        enabledEdit: true,
                                        width: '99%',
                                        height: '95%'
                                });
                                }
                            }//if(tabid = 6)

                            /*********************************
                             * Tab7：优惠券信息
                             *********************************/
                            if(tabid == 'tab7' && !window.tab7gridObj){
                                window.tab7gridObj = $("#tab7_form").ligerGrid({
                                        title : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponsinfo"/>',
                                        columns: [
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponscode"/>',
                                                name: 'voucherCode', align: 'left', width: 100},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponsname"/>',
                                                name: 'name', align: 'left', width: 100},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponsstatus"/>',
                                                name: 'enabledFlag', align: 'left', width: 100,
                                                editor: {
                                                    type: 'select',
                                                    valueField : "value",
                                                    textField : "meaning",
                                                    data : yesNo
                                                },
                                                render: function(item) {return getCodeDesc(yesNo, item.enabledFlag)},
                                            },
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponscategory"/>',
                                                name: 'category', align: 'left', width: 100,
                                                editor: {
                                                    type: 'select',
                                                    valueField : "value",
                                                    textField : "meaning",
                                                    data : voucherCategoryLOV
                                                },
                                                render: function(item) {return getCodeDesc(voucherCategoryLOV, item.category)},
                                            },
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.couponsdescribe"/>',
                                                name: 'description', align: 'left', width: 300},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.effectdatefrom"/>',
                                                name: 'startActiveDate', align: 'left', width: 100},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.effectdateto"/>',
                                                name: 'endActiveDate', align: 'left', width: 100},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.remainingqty"/>',
                                                name: 'quantity', align: 'right', width: 100},
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.ordernumber"/>',
                                                name: 'orderNumber', align: 'center', width: 100}
                                        ],
                                    <#if isedit == '1'>
                                url: '${base.contextPath}/mm/voucherAssign/query?memberId=${RequestParameters.memberId}',
                            </#if>
                                rownumbers : true,
                                    usePager: true,
                                    enabledEdit: false,
                                    width: '99%',
                                    height: '95%',
                                    checkbox: false
                            });
                            }//if(tabid = 7)

                            /*********************************
                             * Tab8：会员等级概要
                             *********************************/
                            if(tabid == 'tab8'){
                                if(!window.tab8_formObj){
                                    var today = new Date();
                                    today.setMonth(0); //取当年的第一个月,即一月份
                                    window.tab8_formObj = $("#tab8_form").ligerForm({
                                        fields: [
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.fromtomonth"/>',
                                                type: 'date', name: 'monthFrom', newline:false,
                                                options : {
                                                    cancelable : false,
                                                    value : today,
                                                    format : 'yyyy/MM',
                                                    showTime: true
                                                }
                                            }, { type: 'none', display:'', width : 10},
                                            { type: 'date', display: ' -',name: 'monthTo',
                                                newline:false, space : 0, labelWidth : 15,
                                                options : {
                                                    cancelable : false,
                                                    value   : new Date(),
                                                    format : 'yyyy/MM',
                                                    showTime: true
                                                }
                                            }
                                        ],
                                        buttons: [
                                            { text: '<@spring.message "sys.hand.btn.query"/>', disabled:false, width: 60, click: function(){
                                                window.tab8_formObj2.setData({
                                                    tpSum : "",
                                                    downLineSum : "",
                                                    memberId : memberData.memberCode
                                                });
                                                Hap.gridQuery({
                                                    form: window.tab8_formObj,
                                                    grid:  window.tab8_gridObj
                                                });
                                            }}
                                        ]
                                    });
                                }

                                if(!window.tab8_formObj2){
                                    window.tab8_formObj2 = $("#tab8_form2").ligerForm({
                                        fields: [
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tpsum"/>',
                                                type: 'text', name: 'tpSum', newline:false, readonly:true
                                            },
                                            { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.downlinesum"/>',
                                                type: 'text', name: 'downLineSum', newline:false, readonly:true
                                            }
                                        ]
                                    });
                                }

                                if(!window.tab8_gridObj){
                                    window.tab8_gridObj = $("#tab8_grid").ligerGrid({
                                            columns: [ {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.month"/>',
                                                name: 'month', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberlevel"/>',
                                                name: 'rankDesc', align: 'middle', width: 100,
                                            }, {
                                                type : 'hidden', name : 'rank', hide: true
                                            }, {
                                                type : 'hidden', name : 'localMarketId', hide: true
                                            }, {
                                                type : 'hidden', name : 'interMarketId', hide: true
                                            }, {
                                                type : 'hidden', name : 'localBonusId', hide: true
                                            }, {
                                                type : 'hidden', name : 'interBonusId', hide: true
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.localbonus"/>',
                                                name: 'bonusLocal', align: 'middle', width: 100,
                                                render: function(item) {
                                                    if(item.bonusLocal){
                                                        return html = '<a href="javascript:toBonusHtml('+item.localBonusId+','+item.localMarketId+')">'+ item.bonusLocal +'</a>';
                                                    }
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.bonus"/>',
                                                name: 'bonusInternational', align: 'middle', width: 100,
                                                render: function(item) {
                                                    if(item.bonusInternational){
                                                        return html = '<a href="javascript:toBonusHtml('+item.interBonusId+','+item.interMarketId+')">'+ item.bonusInternational +'</a>';
                                                    }
                                                }
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.pv"/>',
                                                name: 'pv', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.pgv"/>',
                                                name: 'pgv', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.localov"/>',
                                                name: 'localOv', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.ov"/>',
                                                name: 'ov', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tp"/>',
                                                name: 'tp', align: 'middle', width: 100
                                            }, {
                                                display: '<@spring.message "msg.info.member.new_down_line"/>',
                                                name: 'downLine', align: 'middle', width: 100
                                            } ],
                                        <#if isedit == '1'>
                                    url: '${base.contextPath}/mm/rank/query?memberCode='+memberData.memberCode,
                                </#if>
                                    delayLoad  : false,
                                        enabledEdit: false,
                                        width: '99%',
                                        height: '95%',
                                        checkbox: false,
                                        rownumbers : true,
                                        onAfterShowData : function() {
                                        var tab8GridData = window.tab8_gridObj.getData();
                                        var tpSum = 0;
                                        var downLineSum = 0;
                                        for (i in tab8GridData) {
                                            tpSum = tpSum + tab8GridData[i].tp;
                                            downLineSum = downLineSum + tab8GridData[i].downLine;
                                        }
                                        tpSum = parseFloat(tpSum).toFixed(1);
                                        window.tab8_formObj2.setData({
                                            tpSum : tpSum,
                                            downLineSum : downLineSum
                                        });
                                        return;
                                    }
                                });
                                }
                            }//if(tabid = 8)

                            /*********************************
                             * Tab9：下线信息
                             *********************************/
                            if(tabid == 'tab9'){
                                var memDownLines = [{}];
                                var downLinesData = [];
                                var today = new Date();
                                today.setMonth(0); //取当年的第一个月,即一月份
                                /*下线会员树*/
                                if(!window.tab9_treeObj){
                                    if (isedit == '1') {
                                        //获取下线会员树
//                                  /* Hap.ajax({
//                                      //如果使用MySQL需要Java递归调用url: '${base.contextPath}/mm/dowmlines/query?memberId=' + memberData.memberId,
//                                      url: '${base.contextPath}/mm/omkDowmlines/get?memberCode=' + memberData.memberCode,
//                                      success : function(data) {
//                                          memDownLines = data.rows;
//                                          //如果使用MySQL需要Java递归调用，加载当前会员
//                                          /*downLinesData.push({id: memberData.memberId,
//                                                              pid: 0,
//                                                              text: memberData.memberName,
//                                                              ischecked: true });*/

//                                          //循环加载下线会员
//                                          if (memDownLines != null) {
//                                              for (i = 0; i < memDownLines.length; i++) {
//                                                  /* downLinesData.push({ id: memDownLines[i].memberId,
//                                                                      pid: memDownLines[i].sponsorId,
//                                                                      text: memDownLines[i].memberName}); */
//                                                  downLinesData.push({ id: memDownLines[i].memberCode,
//                                                                       pid: memDownLines[i].sponsorNo,
//                                                                       text: memDownLines[i].memberName});
//                                              }
//                                          }


//                                      }
//                                  }); */
                                        init_tab9();
                                    } else {
                                        init_tab9();
                                    }

                                    function init_tab9() {
                                        var downMemberCode = null;
                                        $("#layout").ligerLayout({
                                            leftWidth : 250,
                                            height : '100%',
                                            space : 4
                                        });
                                        $('#accordion').height($(".l-layout-left").height()-45);

                                        window.tab9_treeObj = $("#tab9_tree").ligerTree({
                                            checkbox : false,
                                            nodeWidth : 500,
                                            slide : false,
                                            url: '${base.contextPath}/mm/omkDowmlines/get?level=1&memberCode=' + memberData.memberCode,
                                            isLeaf : function(data) {//判断是否是叶子
                                                if(data.isLeaf == "N"){
                                                    return true;
                                                }else{
                                                    return false;
                                                }
                                            },
                                            delay : function(e) {
                                                var data = e.data;
                                                return {
                                                    url: '${base.contextPath}/mm/omkDowmlines/get?level=2&memberCode=' + data.memberCode
                                                };
                                            },
                                            render : function(data, text, level) {
                                                return data.memberName;
                                            },
                                            onSelect : function(node) {
                                                $.ligerui.get('query_dowm_line_btn').setEnabled();
                                                setDowmLineQueryData(node);
                                                $.ligerui.get('monthFrom').set('value',today);
                                                $.ligerui.get('monthTo').set('value',new Date());
                                                var data = window.tab9_gridObj.getData();
                                                Hap.gridQuery({
                                                    form: window.tab9_formObj,
                                                    grid: window.tab9_gridObj
                                                });
                                                // if(data!=null && data!='' && data!=undefined){
                                                //    var grid = window.tab9_gridObj;
                                                //    grid.currentData = {};
                                                //    grid.reRender();
                                                //    $("#tab9_form2").ligerForm().setData({tpSum:"",downLineSum:""});
                                                // }
                                            },
                                            unSelect : function(node) {
                                                $("#query_dowm_line_btn").ligerButton().setDisabled();
                                                $("#tab9_form").ligerForm().setData(null);
                                            }
                                        });
                                    }

                                    /*下线会员等级Form*/
                                    if(!window.tab9_formObj){
                                        window.tab9_formObj = $("#tab9_form").ligerForm({
                                            fields : [ {
                                                type : 'hidden', name : 'memberId'
                                            },{
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberid"/>',
                                                type : 'text', name : 'memberCode', readonly : true
                                            }, {
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.membername"/>',
                                                type : 'text', name : 'memberName', newline : false, readonly : true
                                            },{
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"/>',
                                                type : 'text', name : 'areaCode', newline : false, width: 35, readonly : true
                                            }, {
                                                display : '-',
                                                type : 'text', name : 'phoneNo', newline : false, labelWidth: 5, labelAlign: 'left', width: 95, readonly : true
                                            },{
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberstatus"/>',
                                                type : 'text', name : 'statusDesc', newline : true, readonly : true
                                            }, {
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.joindate"/>',
                                                type : 'date', name : 'jointDate', newline : false, readonly : true
                                            }, {
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.expirydate"/>',
                                                type : 'text', name : 'deadline', newline : false, readonly : true
                                            }, {
                                                labelWidth : 100,
                                                display : '&nbsp;',
                                                type : 'none', name : 'accountingTrxQueryTip',
                                            }, {
                                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.fromtomonth"/>',
                                                type : 'date', name : 'monthFrom', newline : true,
                                                options : {
                                                    cancelable : false,
                                                    value : today,
                                                    format : 'yyyy/MM',
                                                    showTime: true
                                                }
                                            }, {
                                                display : '-',
                                                type : 'date', name : 'monthTo', newline : false, labelWidth : 50,
                                                options : {
                                                    cancelable : false,
                                                    value   : new Date(),
                                                    format : 'yyyy/MM',
                                                    showTime: true
                                                }
                                            } ],
                                            buttons: [
                                                {  text: '<@spring.message "sys.hand.btn.query"/>',
                                                    id: 'query_dowm_line_btn',
                                                    disabled: true,
                                                    width: 60,
                                                    click: function(){
                                                        window.tab9_formObj2.setData({
                                                            tpSum : "",
                                                            downLineSum : ""
                                                        });
                                                        Hap.gridQuery({
                                                            form: window.tab9_formObj,
                                                            grid: window.tab9_gridObj
                                                        })
                                                    }}
                                            ]
                                        });
                                    }

                                    if(!window.tab9_formObj2){
                                        window.tab9_formObj2 = $("#tab9_form2").ligerForm({
                                            fields: [
                                                { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tpsum"/>',
                                                    type: 'text', name: 'tpSum', newline:false, readonly:true
                                                },
                                                { display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.downlinesum"/>',
                                                    type: 'text', name: 'downLineSum', newline:false, readonly:true
                                                }
                                            ]
                                        });
                                    }

                                    /*下线会员树Grid*/
                                    if(!window.tab9_gridObj){
                                        window.tab9_gridObj = $("#tab9_grid").ligerGrid({
                                                columns: [ {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.month"/>',
                                                    name: 'month', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberlevel"/>',
                                                    name: 'rankDesc', align: 'middle', width: 100,
                                                }, {
                                                    type : 'hidden', name : 'rank', hide: true
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.pv"/>',
                                                    name: 'pv', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.pgv"/>',
                                                    name: 'pgv', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.localov"/>',
                                                    name: 'localOv', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.ov"/>',
                                                    name: 'ov', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.tp"/>',
                                                    name: 'tp', align: 'middle', width: 100
                                                }, {
                                                    display: '<@spring.message "msg.info.member.new_down_line"/>',
                                                    name: 'downLine', align: 'middle', width: 100
                                                } ],
                                            <#if isedit == '1'>
                                        url: '${base.contextPath}/mm/rank/query',
                                    </#if>
                                        delayLoad  : true,
                                            enabledEdit: false,
                                            width: '99%',
                                            height: '95%',
                                            checkbox: false,
                                            rownumbers : true,
                                            onAfterShowData : function() {
                                            var tab9GridData = window.tab9_gridObj.getData();
                                            var tpSum = 0;
                                            var downLineSum = 0;
                                            for (i in tab9GridData) {
                                                tpSum = tpSum + tab9GridData[i].tp;
                                                downLineSum = downLineSum + tab9GridData[i].downLine;
                                            }
                                            tpSum = parseFloat(tpSum).toFixed(1);
                                            window.tab9_formObj2.setData({
                                                tpSum : tpSum,
                                                downLineSum : downLineSum
                                            });
                                            return;
                                        }
                                    });
                                    }
                                }
                            }//if(tabid = 9)
                        }//if(tabid)
                    });//bind

                /*********************************
                 *Tab1：会员信息
                 *********************************/
                function loadTab1() {
                    window.tab1FormObj = $("#tab1_form").ligerForm({
                        inputWidth : 200,
                        space : 15,
                        fields : [{
                            type : 'hidden', name : 'memberId'
                        }, {
                            type : 'hidden', name : 'status'
                        },
                            {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.belongmarket"/>',
                                name : "marketId",
                                readonly : true,
                                type : "popup",
                                newline : false,
                                textField: 'marketName',
                                options: $.extend(${lovService.getLov(base.contextPath,base.locale, "lov_market")},{
                                    onLoadData: function(){
                                        //this.setParm('companyId',$.ligerui.get('companyId').getValue())
                                    }},{
                                    onSelected: function(e){
                                        //console.log(e.data[0].marketId);
                                        var marketId=e.data[0].marketId;
                                        $.ajax({
                                            url: '${base.contextPath}/sys/Organization/selectOrganization',
                                            type:"GET",
                                            dataType:"json",
                                            contentType : "application/json",
                                            async: false,
                                            data : {"marketId":marketId},
                                            success : function(json) {
                                                //console.log(json.rows);
                                                liger.get('salesOrganization').clear();
                                                liger.get('salesOrganization').setData(json.rows);
                                                // liger.get('salesOrganization').clear();
                                                if(json.success){
//                                    var taxRate = json.rows[0].taxRate;
//                                    if(taxRate == null || taxRate== ''){
//                                        tab.selectTabItem('tab2');
//                                        Hap.showError('<@spring.message "msg.error.member.gst_location_tax_not_null"/>');
//                                        tax_validate = false;
//                                    }
                                                }
                                            },
                                            error : function() {
                                            }
                                        })

//                        $.ligerui.get('companyId').setValue(e.data[0].companyId);
//                        $.ligerui.get('companyId').setText(e.data[0].companyName);
                                    }
                                }),
                                validate : {
                                    required : true
                                }
                            },
                            {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.belongcompany"/>',
                                name : "companyId",
                                readonly : true,
                                type : "popup",
                                newline : false,
                                textField: 'companyName',
                                options: $.extend(${lovService.getLov(base.contextPath,base.locale, "lov_company")},{
                                    onSelect: function(datas){
                                        var d = datas.data[0];
                                        if(d[this.options.valueField]!=this.getValue()){
                                            $.ligerui.get('companyId').setValue(null);
                                            $.ligerui.get('companyId').setText(null);
                                        }
                                    }
                                }),
                                validate : {
                                    required : true
                                }
                            },
                            {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberid"/>',
                                type : 'text', name : 'memberCode', newline : false, readonly: true,
                                validate : {
                                    required : true
                                }
                            },  {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.membertype"/>',
                                type : 'select',
                                id : 'memberType',
                                name : 'memberType',
                                newline : true,
                                options : {
                                    valueField : "value",
                                    textField : "meaning",
                                    data : accessableMemberType,
                                    onSelected : function(newKey, newValue) {
                                        var memberType = $.ligerui.get('memberType').getValue();
                                        if (memberType == "COMP") {
                                            if (memberData.status != 'TERM' && memberData.status != 'ATERM') {
                                                $.ligerui.get('refCompany').setEnabled();
                                                //Mclin修改
                                                //window.tab1FormObj.setFieldValidate("refCompany", {required : true});
                                                $.ligerui.get('refCompanyEn').setEnabled();

                                                $.ligerui.get('brNumber').setEnabled();
                                                window.tab1FormObj.setFieldValidate("brNumber", {required : true});
                                            }
                                        } else {
                                            $.ligerui.get('refCompany').setValue("");
                                            $.ligerui.get('refCompany').setDisabled();
                                            //Mcin修改
                                            //window.tab1FormObj.setFieldValidate("refCompany", {required : false});
                                            $.ligerui.get('refCompanyEn').setValue("");
                                            $.ligerui.get('refCompanyEn').setDisabled();

                                            $.ligerui.get('brNumber').setValue("");
                                            $.ligerui.get('brNumber').setDisabled();
                                            window.tab1FormObj.setFieldValidate("brNumber", {required : false});
                                        }
                                        memberData.memberType = memberType;
                                    }
                                },
                                validate : {
                                    required : true
                                }
                            }, {
                                type : 'hidden', name : 'status',
                                readonly : true,
                                validate : {
                                    required : true
                                }
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberstatus"/>',
                                type : 'text', name : 'statusDesc', newline : false,
                                readonly : true,
                                validate : {
                                    required : true
                                }
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberrole"/>',
                                type : 'select',
                                name : 'memberRole',
                                newline : false,
                                options : {
                                    valueField : "value",
                                    textField : "meaning",
                                    data : memberRole,
                                    onSelected : function(newKey, newValue){
                                        var memberRole = $.ligerui.get('memberRole').getValue();
                                        if($("#tab4_form").ligerForm()){
                                            if(memberRole == 'VIP'){
                                                memberData.acceptBonus = 'N';
                                                if(liger.get('acceptBonus')){
                                                    liger.get('acceptBonus').setValue('N');
                                                    liger.get('acceptBonus').setDisabled();
                                                }
                                            } else {
                                                memberData.acceptBonus = defaultAcceptBonus==undefined?'Y':defaultAcceptBonus;
                                                if(liger.get('acceptBonus')){
                                                    liger.get('acceptBonus').setValue(defaultAcceptBonus==undefined?'Y':defaultAcceptBonus);
                                                    liger.get('acceptBonus').setEnabled();
                                                }
                                            }
                                        }
                                    }
                                },
                                validate : {
                                    required : true
                                }
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.crc"/>',
                                type : 'text', name : 'brNumber', newline : true
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.companyzhname"/>',
                                type : 'text', name : 'refCompany', newline : false, disabled: false
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.companyenname"/>',
                                type : 'text', name : 'refCompanyEn', newline : false, disabled: false
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.temppassword"/>',
                                type: 'password', name : 'tempPassword', newline : true, disabled: false, id : "tempPassword"
                            }, {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.cardpass"/>',
                                type: 'password', name : 'cardPass', newline : false, disabled: false, id : "cardPass"
                            },{
                                display:'<@spring.message "com.lkkhpg.dsis.common.member.dto.discount"/>',
                                type:"float", name:"discount", newline:false, disable:false, id:"discount"
                            },
                            {
                                display:'销售组织',
                                type:"select",
                                name:"salesOrganization",
                                newline:true,
                                id:"salesOrganization",
                                options: {
                                    valueField: 'name',
                                    textField: 'name'
//                        data: sales
                                }
                                ,
                                validate : {
                                    required : true
                                }
                            },
//                  {
//                    display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberwarninginfo"/>',
//                    type : 'textarea', name : 'warningMsg', width : 810, newline : true
//                  },
                            {
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.remarks"/>',
                                type : 'textarea', name : 'remark', width : 810, newline : true
                            } ]
                    });

                    //初始化数据

                    initData();

                    //初始化化组件
                    initTab(1);
                }
            });//$(function)

            /**
             * 初始化Tab
             */
            function initTab(index) {
//       $.ligerui.get('changerole_btn').hide();
//        $.ligerui.get('audit_btn').hide();
                /**
                 * 初始化工具栏
                 */
                if (isedit == '1') {

                    //状态为"终止"、"自动终止"的会员，不允许编辑会员详情页的任何字段、按钮
                    if (memberData.status == 'TERM' || memberData.status == 'ATERM' || memberData.status == 'SUPSE') {
                        liger.get("member_detail_btns").setEditable(false);
                        if (index == 1) {
                            liger.get("tab1_form").setEditable(false);
                        } else if (index == 2) {
                            liger.get("tab2_form").setEditable(false);
                        } else if (index == 4) {
                            liger.get("tab4_form").setEditable(false);
                        } else if (index == 3) {
                            tab3GridObj.setEditable(false);
                            liger.get('tab3_grid_toolbar').setEditable(false);
                        } else if (index == 5) {
                            window.tab5Grid1Obj.options.enabledEdit=false;
                            liger.get("tab5_form").setEditable(false);
                            window.tab5Grid2Obj.options.enabledEdit=false;
                            liger.get('tab5_grid1_toolbar').setEditable(false);
                            liger.get('tab5_grid2_toolbar').setEditable(false);
                        }
                    }

                    //状态为"暂停"的会员不允许编辑会员详情页的部分字段，但可以使用"重新激活"、"冲销结余"、"历史订单"按钮
                    if (memberData.status == 'SUPSE') {
                    <#if accessService.access("REACTIVE_ENABLE") == true>
                        liger.get('reactive_btn').setEnabled();
                    </#if>
                    <#if accessService.access("WITHDRAW_ENABLE") == true>
                        liger.get('withdraw_btn').setEnabled();
                    </#if>
                    <#if accessService.access("HISTORY_ORDER_ENABLE") == true>
                        $.ligerui.get('history_order_btn').setEnabled();
                    </#if>
                    }

                    //状态为"审核中"的会员，只能点击"保存"、"下单"按钮
                    if (memberData.status == 'PEND') {
                        liger.get("member_detail_btns").setEditable(false);
                    <#if accessService.access("SAVE_ENABLE") == true>
                        liger.get('save_btn').setEnabled();
                    </#if>
                    <#if accessService.access("CREATE_ORDER_ENABLE") == true>
                        liger.get('create_order_btn').setEnabled();
                    </#if>
                    <#if accessService.access("HISTORY_ORDER_ENABLE") == true>
                        $.liger.get('history_order_btn').setEnabled();
                    </#if>
                    }

                    //"新"或"无效"会员，可以点击"保存"、"提交"按钮
                    if (memberData.status == 'NEW' || memberData.status == 'RJECT') {
                        liger.get("member_detail_btns").setEditable(false);
                    <#if accessService.access("SAVE_ENABLE") == true>
                        liger.get('save_btn').setEnabled();
                    </#if>
                    <#if accessService.access("SUBMIT_ENABLE") == true>
                        liger.get('submit_btn').setEnabled();
                    </#if>
                    }

                    //"新"会员，可以点击"下单"和"历史订单"按钮
                    if (memberData.status == 'NEW') {
                    <#if accessService.access("CREATE_ORDER_ENABLE") == true>
                        liger.get('create_order_btn').setEnabled();
                    </#if>
                    <#if accessService.access("HISTORY_ORDER_ENABLE") == true>
                        $.ligerui.get('history_order_btn').setEnabled();
                    </#if>
                    }

                <#if accessService.access("EDITABLE") == true>
                    //会员为激活状态
                        if (memberData.status == 'ACTV') {
                            //不存在待更权预存会员，则启用更改所有权按钮
                            if (memberData.hasChangeOwnershipTemp != 'Y') {
                            <#if accessService.access("CHANGE_OWNERSHIP_ENABLE") == true>
//                        $.ligerui.get('change_ownership_btn').setEnabled();
                                </#if>
                            } else {
                            <#if accessService.access("CHANGE_OWNERSHIP_ENABLE") == false>
                                $.ligerui.get('change_ownership_btn').setDisabled();
                            </#if>
                            }
                        <#if accessService.access("SAVE_ENABLE") == true>
                            //启用"保存"按钮
                            $.ligerui.get('save_btn').setEnabled();
                        </#if>
                        <#if accessService.access("CREATE_ORDER_ENABLE") == true>
                            //启用"下单"按钮
//                    $.ligerui.get('create_order_btn').setEnabled();
                            </#if>
                        <#if accessService.access("HISTORY_ORDER_ENABLE") == true>
                            //启用"历史订单"按钮
                            $.ligerui.get('history_order_btn').setEnabled();
                        </#if>
                        <#if accessService.access("CHANGE_MARKET_ENABLE") == true>
                            //启用"变更市场"按钮
//                    $.ligerui.get('change_market_btn').setEnabled();
                            </#if>
                        <#if accessService.access("CHANGE_UPSTREAM_ENABLE") == true>
                            //启用"变更上线"按钮
//                    $.ligerui.get('change_upstream_btn').setEnabled();
                            </#if>
                        <#if accessService.access("WITHDRAW_ENABLE") == true>
                            //启用"冲销结余"按钮
//                    $.ligerui.get('withdraw_btn').setEnabled();
                            </#if>
                        <#if accessService.access("SUSPEND_ENABLE") == true>
                            //启用"暂停"按钮
//                    $.ligerui.get('suspend_btn').setEnabled();
                            </#if>
                        <#if accessService.access("TERMINATE_ENABLE") == true>
                            //启用"终止"按钮
//                    $.ligerui.get('terminate_btn').setEnabled();
                            </#if>
                        <#if accessService.access("CHANGE_ROLE_ENABLE") == true>
                            //启用"更改角色"按钮
//                    $.ligerui.get('changerole_btn').setEnabled();
                            </#if>
                        }
                </#if>
                } else { //若是创建会员,则只启用保存按钮
                <#if accessService.access("SAVE_ENABLE") == true>
                    $.ligerui.get('save_btn').setEnabled();
                </#if>
                }//初始化工具栏

                //审计权限
            <#if accessService.access("AUDIT_ENABLE") == true>
//        $.ligerui.get('audit_btn').setEnabled();
                </#if>

                /**
                 * 初始化Tab1
                 */
                if (index == 1) {
                    //初始化数据-会员信息
                    $("#tab1_form").ligerForm().setData(memberData);
                    //只有新建才允许编辑 公司、市场、角色
                    if (isedit == '1') {
                        liger.get('companyId').setDisabled();
                        liger.get('marketId').setDisabled();
                        liger.get('memberRole').setDisabled();

                        //0115带出销售组织值
                        if(memberData.salesOrganization!=''){
                            liger.get('salesOrganization').setText(memberData.salesOrganization);
                        }
                        liger.get('salesOrganization').setDisabled();

                        //台湾市场，激活状态下的会员可修改会员类型
                        if (memberData.status == 'ACTV' && memberData.marketCode == 'TW') {
                            liger.get('memberType').setEnabled();
                        } else {
                            liger.get('memberType').setDisabled();
                        }
                    }

                    // I-point用户只能创建个人类型的会员和经销商角色
                    if (isedit == '0' && isIpoint == '1') {
                        liger.get('memberType').setValue('IDV');
                        liger.get('memberType').setDisabled();

                        liger.get('memberRole').setValue('DIS');
                        liger.get('memberRole').setDisabled();
                    }
                    // 非VIP会员不可点击更改角色按钮
                    if (memberData.memberRole != 'VIP') {
//                $.ligerui.get('changerole_btn').setDisabled();
                    }
                    // 编辑模式，配置文件控制是否允许启用重置密码字段
                    if (isedit == '1' && sysTempPwdReset == 'Y') {
                        liger.get('tempPassword').setEnabled();
                    } else {
                        liger.get('tempPassword').setDisabled();
                    }
                }

                /**
                 * 初始化Tab2
                 */
                if (index == 2) {
                    if (liger.get('homeLocation') != undefined && spmParamMemberHomeAddress != 'Y') {
                        liger.get('homeLocation').setDisabled();
                        window.tab2FormObj.setFieldValidate("homeLocation", {required : false});
                    }
                    if (liger.get('race') != undefined && spmParamMemberRace != 'Y') {
                        liger.get('race').setDisabled();
                        window.tab2FormObj.setFieldValidate("race", {required : false});
                    }
                    if (liger.get('gstIdNumber') != undefined && spmParamMemberGstId != 'Y') {
                        liger.get('gstIdNumber').setDisabled();
                    }
                    if (liger.get('nhiTaxExcluded') != undefined && spmParamMemberNhiTaxExcluded != 'Y') {
                        liger.get('nhiTaxExcluded').setDisabled();
                        window.tab2FormObj.setFieldValidate("nhiTaxExcluded", {required : false});
                    }


                    //初始化数据-联系人
                    if(isedit == '0'){
                        memberData.country = defaultCountry;
                    }
                    $("#tab2_form").ligerForm().setData(memberData);
                    //保存中英文姓名原值
                    oldChnFirstName = memberData.chineseFirstName||'';
                    oldChnLastName = memberData.chineseLastName||'';
                    oldEngFirstName = memberData.englishFirstName||'';
                    oldEngLastName = memberData.englishLastName||'';

                    //初始化数据-联系人申请清单
                    if (spmParamMemberApplicitionList == 'Y') {
                        var id_copy_flag = false;
                        var applicationForm_flag = false;
                        var banckAccountCopy_flag = false;
                        var confiAgreement_flag = false;
                        for (var i in memberData.memAttributes) {
                            if (memberData.memAttributes[i].attribute == "id_copy") {
                                liger.get("idCopy").setValue(stringToboolean(memberData.memAttributes[i].value));
                                id_copy_flag = true;
                            } else if (memberData.memAttributes[i].attribute == "application_form") {
                                liger.get("applicationForm").setValue(stringToboolean(memberData.memAttributes[i].value));
                                applicationForm_flag = true;
                            } else if (memberData.memAttributes[i].attribute == "banck_account_copy") {
                                liger.get("banckAccountCopy").setValue(stringToboolean(memberData.memAttributes[i].value));
                                banckAccountCopy_flag = true;
                            } else if (memberData.memAttributes[i].attribute == "confidentiality_agreement") {
                                liger.get("confiAgreement").setValue(stringToboolean(memberData.memAttributes[i].value));
                                confiAgreement_flag = true;
                            } else if (memberData.memAttributes[i].attribute == "card_pass") {
                                liger.get("cardPass").setValue(stringToboolean(memberData.memAttributes[i].value));
                            }
                        }
                        if(!id_copy_flag){
                            memberData.memAttributes.push({memberId : null, attributeId : null, attribute : "id_copy", value : null});
                        }
                        if(!applicationForm_flag){
                            memberData.memAttributes.push({memberId : null, attributeId : null, attribute : "application_form", value : null});
                        }
                        if(!banckAccountCopy_flag){
                            memberData.memAttributes.push({memberId : null, attributeId : null, attribute : "banck_account_copy", value : null});
                        }
                        if(!confiAgreement_flag){
                            memberData.memAttributes.push({memberId : null, attributeId : null, attribute : "confidentiality_agreement", value : null});
                        }
                    }
                }


                /**
                 * 初始化Tab4
                 */
                if (index == 4) {
                    if (memberData.travelPlanMonth != null) {
                        memberData.travelPlanMonth= memberData.travelPlanMonth.parseDate('yyyyMM');
                    }
                    var memberRole = liger.get('memberRole').getValue();
                    //会员角色为VIP时,接收奖金为否并且不可点击
                    if(memberRole=='VIP'){
                        memberData.acceptBonus = 'N';
                        liger.get('acceptBonus').setDisabled();
                    }
                    //旅游次数：分配了此会员的、状态为“有效”的、类型为“旅游”的活动的数量
                    memberData.travelCount = getTravelCount(memberData.memberId);
                    //初始化数据-会员信息
                    $("#tab4_form").ligerForm().setData(memberData);

                    //新增会员
                <#if isedit == '0'>
                    //更改所有权，不可以输入推荐人，加入日期审批日期由原会员复制
                    <#if isChangeOwnership == '1'>
                    liger.get('sponsorNo').setDisabled();
                    window.tab4FormObj.setFieldValidate("sponsorNo", {required : false});
                <#else>
                    $.ligerui.get('jointDate').setValue(new Date(${.now?long}));
                </#if>
                </#if>
                }

                /**
                 * 初始化Tab5
                 */
                if (index == 5) {
                    if (isedit == '1') {
                        $("#tab5_form").ligerForm().setData(memberData.memAccounts[0]);
                        //保存银行账户信息原值
                        oldAccountNumber = memberData.memAccounts[0].accountNumber||'';
                        oldBankId = memberData.memAccounts[0].bankId||'';
                        oldAccountHolder = memberData.memAccounts[0].accountHolder||'';
                        oldAccountIdNumber = memberData.memAccounts[0].idNumber||'';
                        oldRemark = memberData.memAccounts[0].comments||'';
                        oldBankBranchId = memberData.memAccounts[0].bankBranchId||'';
                    }

                    if (spmParamMemberBankBranch == 'Y') {
                        if (memberData.memAccounts == null || memberData.memAccounts[0].bankId == null || memberData.memAccounts[0].bankName == null) {
                            liger.get("bankBranchId").setDisabled();
                        }
                    }
                }

                //只读模式则禁用所有操作组件
            <#if accessService.access("EDITABLE") == false>
                    if (index == 1) {
                        liger.get("tab1_form").setEditable(false);
                    } else if (index == 2) {
                        liger.get("tab2_form").setEditable(false);
                    } else if (index == 4) {
                        liger.get("tab4_form").setEditable(false);
                    } else if (index == 3) {
                        tab3GridObj.setEditable(false);
                        liger.get('tab3_grid_toolbar').setEditable(false);
                    } else if (index == 5) {
                        window.tab5Grid1Obj.options.enabledEdit=false;
                        liger.get("tab5_form").setEditable(false);
                        window.tab5Grid2Obj.options.enabledEdit=false;
                        liger.get('tab5_grid1_toolbar').setEditable(false);
                        liger.get('tab5_grid2_toolbar').setEditable(false);
                    }
            </#if>
//             //TODO:待加入市场
//             <#if accessService.access("UC_APPLY_ENABLE") == false>
//                 $.ligerui.get('change_upstream_btn').setDisabled();
//             </#if>
//             <#if accessService.access("WD_APPLY_ENABLE") == false>
//                 $.ligerui.get('withdraw_btn').setDisabled();
//             </#if>
            }

            /**
             * 初始化数据
             */
            function initData() {
                //新增会员默认值
            <#if isedit == '0'>
                //freemark从session中获得当前销售组织
                getDefaultCountry();
                memberData.salesOrgId = currentSalesOrgId;
                memberData.jointSiteType = 'DSIS';
                memberData.jointSite = currentSalesOrgId;
                memberData.jointSiteCode = currentSalesOrgCode;
                memberData.memberType = 'IDV';
                memberData.memberRole = 'DIS';
                memberData.idType = 'IC';
                if(memberData.marketCode == 'TW'){
                    memberData.areaCode = '886';
//                 	$("#areaCode").ligerText().setDisabled();
                }
                //memberData.country = 'CN';
                memberData.adOptIn = 'Y';
                memberData.sysMsgIn = 'Y';
                memberData.nhiTaxExcluded = 'N';
                memberData.acceptBonus = 'Y';
                memberData.bonusRcvMethod = 'BANK';
                memberData.country = defaultCountry;
                var nowDate = new Date();
                //默认取当前日期YYYYMM
                memberData.travelPlanMonth = '' + nowDate.getFullYear() + (nowDate.getMonth() + 1);
                //有维护在快码，则取快码
                for (i in travelPlanMonthLOV) {
                    if (memberData.marketCode == travelPlanMonthLOV[i].value) {
                        memberData.travelPlanMonth = travelPlanMonthLOV[i].meaning;
                    }
                }

                //更改所有权，预存的临时会员卡号为原卡号_T
            <#if isChangeOwnership == '1'>
                memberData.isChangeOwnership = true;
                memberData.memberCode = ${RequestParameters.sourceMemberCode} + '_T';
                memberData.isSponsorVerify = true; //不需要保存推荐人
                var jointDate = '${RequestParameters.jointDate}';
                var approvalDate = '${RequestParameters.approvalDate}';
                memberData.jointDate = jointDate.parseDate('yyyy-MM-dd');
                memberData.approvalDate = approvalDate.parseDate('yyyy-MM-dd');
                //更改所有权会员状态为待变更
                for (i in memberStatus) {
                    if (memberStatus[i].value == 'WCHG') {
                        memberData.status = 'WCHG';
                        memberData.statusDesc = memberStatus[i].meaning;
                    }
                }
            </#if>
            </#if>
            }

            /**
             * 整合tab数据
             */
            function validate() {
                var validateStatus = false;


//            if (isedit == '0') {
//                //校验当前所属组织、公司、市场
//                if (currentSalesOrgCode == '') {
//                    Hap.showError('<@spring.message "msg.error.member.get_current_comp_market_error"/>');
//                    return false;
//                }
//
//                //新增会员要求推荐人即时鉴别
//                if (!memberData.isSponsorVerify) {
//                    tab.selectTabItem('tab4');
//                    Hap.showError('<@spring.message "msg.error.member.memberdetails.sponsorverifyerror"/>');
//                    return false;
//                }
//            }

                /********************************
                 * tab1会员信息
                 *********************************/
                if (!tab1FormObj) {
                    //新增模式要求输入
                    if (isedit == '0') {
                        tab.selectTabItem('tab1');
                        Hap.showError("<@spring.message 'msg.error.member.member_information_not_input'/>");
                        return false;
                    }
                } else {
                    validateStatus = Hap.validateForm([tab1FormObj]);
                    if (!validateStatus) {
                        tab.selectTabItem('tab1');
                        return false;
                    }

                    //校验商业注册码长度
                    var brNumberLength = $.ligerui.get('brNumber').getValue().length;
                    for (i in brNumberLengthLOV) {
                        if (memberData.marketCode == brNumberLengthLOV[i].value && brNumberLength > brNumberLengthLOV[i].description) {
                            tab.selectTabItem('tab1');
                            Hap.showError("<@spring.messageArgs 'msg.error.member.br_number_length_error' ,['" + brNumberLengthLOV[i].description +  "','" + brNumberLength +  "']/>");
                            return false;
                        }
                    }

                    //Mclin添加
                    var tab1FormData =  tab1FormObj.getData();
                    if(tab1FormData.memberType == 'COMP'){//会员类型为公司的时候才验证
                        tab1FormData.refCompany = tab1FormData.refCompany||'';
                        tab1FormData.refCompanyEn = tab1FormData.refCompanyEn||'';

                        //公司中英文名称至少填一个
                        if (tab1FormData.refCompany == '' && tab1FormData.refCompanyEn == '') {
                            tab.selectTabItem('tab1');
                            Hap.showError('<@spring.message "msg.error.member.company_name_require_one"/>');
                            return false;
                        }
                    }
                }

                /********************************
                 * tab2联系人信息
                 *********************************/
                if (!window.tab2FormObj) {
                    //新增模式要求输入
                    if (isedit == '0') {
                        tab.selectTabItem('tab2');
                        Hap.showError("<@spring.message 'msg.error.member.member_contact_not_input'/>");
                        return false;
                    }
                } else {
                    validateStatus = Hap.validateForm(tab2FormObj);
                    if (!validateStatus) {
                        tab.selectTabItem('tab2');
                        return false;
                    }

                    var tab2FormData =  tab2FormObj.getData();
                    tab2FormData.chineseLastName = tab2FormData.chineseLastName||'';
                    tab2FormData.englishLastName = tab2FormData.englishLastName||'';

                    /**************校验会员姓名 start**************/
                    //会员中英文姓名至少填一个
                    if (tab2FormData.chineseFirstName == '' && tab2FormData.englishFirstName == '') {
                        tab.selectTabItem('tab2');
                        Hap.showError('<@spring.message "msg.error.member.member_name_require_one"/>');
                        return false;
                    }

                    //会员姓和名需全
                    if (spmParamMemberLastNameEditable == 'Y') {
                        //校验姓名
                        if (tab2FormData.chineseFirstName != '' && tab2FormData.chineseLastName == '' ||
                            tab2FormData.chineseFirstName == '' && tab2FormData.chineseLastName != '') {
                            tab.selectTabItem('tab2');
                            Hap.showError('<@spring.message "msg.error.member.member_first_and_last_name_required"/>');
                            return false;
                        }
                        if (tab2FormData.englishFirstName != '' && tab2FormData.englishLastName == '' ||
                            tab2FormData.englishFirstName == '' && tab2FormData.englishLastName != '') {
                            tab.selectTabItem('tab2');
                            Hap.showError('<@spring.message "msg.error.member.member_first_and_last_name_required"/>');
                            return false;
                        }
                    }

//                 //中文姓和名总长度不超过16位汉字
//                 if ((tab2FormData.chineseFirstName||'').length + (tab2FormData.chineseLastName||'').length > 16) {
//                     tab.selectTabItem('tab2');
//                     Hap.showError('<@spring.message "msg.error.member.chinese_name_length_error"/>');
//                     return false;
//                 }

//                 //英文姓和名总长度不超过48位
//                 if ((tab2FormData.englishFirstName||'').length + (tab2FormData.englishLastName.length||'') > 48) {
//                     tab.selectTabItem('tab2');
//                     Hap.showError('<@spring.message "msg.error.member.english_name_length_error"/>');
//                     return false;
//                 }
                    /**************校验会员姓名 end**************/

                        //校验年龄
//                    var dob,nowDate = new Date();
//                    if(typeof(tab2FormData.dob) == 'string'){
//                        dob = tab2FormData.dob.parseDate('yyyy-MM-dd')
//                    }else{
//                        dob = tab2FormData.dob;
//                    }
//
//                    //年
//                    var age = nowDate.getFullYear() - dob.getFullYear();
//                    //月不足则扣1年
//                    if (nowDate.getMonth() - dob.getMonth() < 0) {
//                        age = age - 1;
//                        //月相同日不足则扣1年
//                    } else if (nowDate.getMonth() - dob.getMonth() == 0) {
//                        if (nowDate.getDate() - dob.getDate() < 0) {
//                            age = age - 1;
//                        }
//                    }

                    // 小于18则报错
//                    if (age < 18) {
//                        Hap.showError("<@spring.message 'msg.error.member.age_less_than_limit'/>");
//                        tab.selectTabItem('tab2');
//                        return false;
//                    }
                    // 小于市场参数提醒值则警告
//                    if (age < spmParamMemberAgeAlert) {
//                        warningTab = 'tab2';
//                        warningMsg = "<@spring.messageArgs 'msg.warn.member.age_less_than_param' ,['" + spmParamMemberAgeAlert + "']/>";
//                    }
//
//                    //校验身份证类型证件编码长度
//                    var idNumberLength = tab2FormData.idNumber.length;
//                    if (tab2FormData.idType == 'IC') {
//                        for (i in idNumberLengthLOV) {
//                            if (memberData.marketCode == idNumberLengthLOV[i].value && idNumberLength > idNumberLengthLOV[i].description) {
//                                tab.selectTabItem('tab2');
//                                Hap.showError("<@spring.messageArgs 'msg.error.member.id_number_length_error' ,['" + idNumberLengthLOV[i].description +  "','" + idNumberLength +  "']/>");
//                                return false;
//                            }
//                        }
//                    }
//                    //校验长期居台证件编码长度
//                    if (tab2FormData.idType == 'LPT') {
//                        if (idNumberLength > 10) {
//                            tab.selectTabItem('tab2');
//                            Hap.showError("<@spring.messageArgs 'msg.error.member.id_number_length_error' ,['10','" + idNumberLength +  "']/>");
//                            return false;
//                        }
//                    }

                    //gstID编码和gst地址要么都有值，要么都没值
                    if (!((tab2FormData.gstIdNumber == '' && tab2FormData.gstLocation == '')
                        || (tab2FormData.gstIdNumber != '' && tab2FormData.gstLocation != ''))) {
                        tab.selectTabItem('tab2');
                        Hap.showError('<@spring.message "msg.error.member.gst_id_location_validate"/>');
                        return false;
                    }

                    //GST注册地址的填的最低层级（国家或州省或城市)上，“税率”字段是否为空，若为空，则提示报错 “GST注册地址的税率为空，无法保存”；
                    if(tab2FormData.gstIdNumber != '' && tab2FormData.gstLocation != ''){
                        if(memberData.gstSpmLocation != null && memberData.gstSpmLocation != undefined){
                            var tax_validate = true;
                            if(memberData.gstSpmLocation.cityCode != null && memberData.gstSpmLocation.cityCode!=''){
                                $.ajax({
                                    url: '${base.contextPath}/spm/city/get',
                                    type:"GET",
                                    dataType:"json",
                                    contentType : "application/json",
                                    async: false,
                                    data : {cityCode:memberData.gstSpmLocation.cityCode},
                                    success : function(json) {
                                        if(json.success){
                                            var taxRate = json.rows[0].taxRate;
                                            if(taxRate == null || taxRate== ''){
                                                tab.selectTabItem('tab2');
                                                Hap.showError('<@spring.message "msg.error.member.gst_location_tax_not_null"/>');
                                                tax_validate = false;
                                            }
                                        }
                                    },
                                    error : function() {
                                    }
                                })
                            }else if(memberData.gstSpmLocation.stateCode != null && memberData.gstSpmLocation.stateCode!=''){
                                $.ajax({
                                    url: '${base.contextPath}/spm/state/queryforlocation',
                                    type:"GET",
                                    dataType:"json",
                                    contentType : "application/json",
                                    async: false,
                                    data : {stateCode:memberData.gstSpmLocation.stateCode},
                                    success : function(json) {
                                        if(json.success){
                                            var taxRate = json.rows[0].taxRate;
                                            if(taxRate == null || taxRate== ''){
                                                tab.selectTabItem('tab2');
                                                Hap.showError('<@spring.message "msg.error.member.gst_location_tax_not_null"/>');
                                                tax_validate = false;
                                            }
                                        }
                                    },
                                    error : function() {
                                    }
                                })
                            }else if(memberData.gstSpmLocation.countryCode!=null && memberData.gstSpmLocation.countryCode!=''){
                                $.ajax({
                                    url: '${base.contextPath}/spm/country/queryDetail',
                                    type:"GET",
                                    dataType:"json",
                                    contentType : "application/json",
                                    async: false,
                                    data : {countryCode:memberData.gstSpmLocation.countryCode},
                                    success : function(json) {
                                        if(json.success){
                                            var taxRate = json.rows[0].taxRate;
                                            if(taxRate == null || taxRate== ''){
                                                tab.selectTabItem('tab2');
                                                Hap.showError('<@spring.message "msg.error.member.gst_location_tax_not_null"/>');
                                                tax_validate = false;
                                            }
                                        }
                                    },
                                    error : function() {
                                    }
                                })
                            }
                            return tax_validate;
                        }

                    }

                    //校验申请列表至少勾选一项
                    /* if (spmParamMemberApplicitionList == 'Y') {
                     var idCopy = liger.get("idCopy").getValue();
                     var applicationForm = liger.get("applicationForm").getValue();
                     var banckAccountCopy = liger.get("banckAccountCopy").getValue();
                     var confiAgreement = liger.get("confiAgreement").getValue();
                     //全false
                     if (!(idCopy || applicationForm || banckAccountCopy || confiAgreement)) {
                     tab.selectTabItem('tab2');
                     Hap.showError("<@spring.message 'msg.error.member.application_list_required_one'/>");
                     return false;
                     }
                     } */
                }

                /********************************
                 * tab3相关人信息
                 *********************************/
                if (!window.tab3GridObj) {
                    //新增模式要求输入
                    /*if (isedit == '0') {
                     tab.selectTabItem('tab3');
                     Hap.showError("<@spring.message 'msg.error.member.member_relationship_not_input'/>");
                     return false;
                     }*/
                } else {
                    validateStatus = Hap.validateGrid([tab3GridObj]);
                    if (!validateStatus) {
                        tab.selectTabItem('tab3');
                        return false;
                    }

                    var tab3GridData =  tab3GridObj.getData();
                    var spouseCount = 0;
                    var beneficiaryCount = 0;

                    var memIdType;
                    var memIdNumber;
                    if (!window.tab2FormObj) {
                        memIdType = memberData.idType;
                        memIdNumber = memberData.idNumber;
                    } else {
                        memIdNumber = tab2FormObj.getData().idNumber;
                        memIdType = tab2FormObj.getData().idType;
                    }

                    /**
                     * 相关人校验
                     * 1. 配偶信息（没有配偶时不填，最多允许有一个）
                     * 2. 受益人信息（只允许有一个）
                     */
                    for (i in tab3GridData) {
                        if (tab3GridData[i].relType == 'SPOUS') {
                            spouseCount = spouseCount + 1;
                        } else if (tab3GridData[i].relType == 'BENF') {
                            beneficiaryCount = beneficiaryCount + 1;
                        }

                        //本会员的证件编号不能喝相关人的证件编号相同
                        if (tab3GridData[i].idType == memIdType && tab3GridData[i].idNumber == memIdNumber) {
                            tab.selectTabItem('tab3');
                            Hap.showError("<@spring.message 'msg.error.member.mem_id_num_must_diff_from_relationship'/>");
                            return false;
                        }
                    }

                    if (spouseCount > 1) {
                        tab.selectTabItem('tab3');
                        Hap.showError("<@spring.message 'msg.error.member.spouse_only_one'/>");
                        return false;
                    }

                    if (beneficiaryCount > 1) {
                        tab.selectTabItem('tab3');
                        Hap.showError("<@spring.message 'msg.error.member.beneficiary_only_one'/>");
                        return false;
                    }
                }

                /********************************
                 * tab4会员身份
                 *********************************/
                if (!window.tab4FormObj) {
                    //新增模式要求输入
                    if (isedit == '0') {
                        tab.selectTabItem('tab4');
                        //  Hap.showError("<@spring.message 'msg.error.member.member_identity_not_input'/>");
                        return false;
                    }
                } else {
                    validateStatus = Hap.validateForm([tab4FormObj]);
                    if (!validateStatus) {
                        tab.selectTabItem('tab4');
                        return false;
                    }
                }

                /********************************
                 * tab5账户信息未录入
                 *********************************/
                if (!window.tab5Grid1Obj) {
                    //新增模式要求输入
                    if (isedit == '0') {
                        tab.selectTabItem('tab5');
                        Hap.showError("<@spring.message 'msg.error.member.member_account_not_input'/>");
                        return false;
                    }
                } else {
                    validateStatus = Hap.validateGrid([tab5Grid1Obj]);
                    if (!validateStatus) {
                        tab.selectTabItem('tab5');
                        return false;
                    }

                    /**
                     * 账单信息校验
                     * 1. 账单地点必输且只允许有一个默认
                     * 2. 配送地点地点必输且只允许有一个默认
                     */
                    var tab5Grid1Data =  tab5Grid1Obj.getData();
                    var billSiteCount = 0;
                    var shipSiteCount = 0;
                    var billSiteDefaulatCount = 0;
                    var shipSiteDefaulatCount = 0;

                    if (tab5Grid1Data.length == 0) {
                        tab.selectTabItem('tab5');
                        Hap.showError("<@spring.message 'msg.error.member.bill_site_require_only_one_default'/>");
                        return false;
                    }

                    for (i in tab5Grid1Data) {
                        if (tab5Grid1Data[i].siteUseCode == 'BILL') {
                            billSiteCount = billSiteCount + 1;

                            if (tab5Grid1Data[i].defaultFlag == 'Y') {
                                billSiteDefaulatCount = billSiteDefaulatCount + 1;
                            }
                        } else if (tab5Grid1Data[i].siteUseCode == 'SHIP') {
                            shipSiteCount = shipSiteCount + 1;

                            if (tab5Grid1Data[i].defaultFlag == 'Y') {
                                shipSiteDefaulatCount = shipSiteDefaulatCount + 1;
                            }
                        }
                    }

                    if (billSiteCount == 0 || billSiteDefaulatCount == 0 || billSiteDefaulatCount > 1) {
                        tab.selectTabItem('tab5');
                        Hap.showError("<@spring.message 'msg.error.member.bill_site_require_only_one_default'/>");
                        return false;
                    }

                    if (shipSiteCount == 0 || shipSiteDefaulatCount == 0 || shipSiteDefaulatCount > 1) {
                        tab.selectTabItem('tab5');
                        Hap.showError("<@spring.message 'msg.error.member.ship_site_require_only_one_default'/>");
                        return false;
                    }

                    //只有非ipoint用户才启用银行账户和银行卡
                    if (isIpoint == '0') {
                        /**
                         * 银行账户信息校验
                         */
                        validateStatus = Hap.validateForm([tab5FormObj]);
                        if (!validateStatus) {
                            tab.selectTabItem('tab5');
                            return false;
                        }

                        /**
                         * 银行账户信息完整性校验
                         */
                            // 当银行账户信息的字段有一个填入，则必须将银行账户信息中可编辑的字段全部填入，否则报错：银行账户信息不完整；当银行账户信息下的字段都为空，则不会报错。
                        var tab5FormObjData =  tab5FormObj.getData();
                        var allNullFlag = false;
                        var allNotNullFlag = false;

                        //判断输入字段全部为空: 拼接字段==''则表示全空
                        if (((tab5FormObjData.bankId||'') +
                            (tab5FormObjData.bankBranchId||'') +
                            (tab5FormObjData.accountNumber||'') +
                            (tab5FormObjData.accountHolder||'') +
                            (tab5FormObjData.idNumber||''))
                            == '') {
                            allNullFlag = true;
                        }

                        //判断输入字段全部不为空
                        if ((tab5FormObjData.bankId||'') != '' &&
                            ((tab5FormObjData.bankBranchId||'') != '' || spmParamMemberBankBranch == 'N') && //不启用支行则跳过校验支行字段
                            (tab5FormObjData.accountNumber||'') != '' &&
                            (tab5FormObjData.accountHolder||'') != '' &&
                            (tab5FormObjData.idNumber||'') != '') {
                            allNotNullFlag = true;
                        }

                        // 非（全空或全不空）的情况则报错银行账户信息不完整
                        if (!(allNullFlag || allNotNullFlag)) {
                            tab.selectTabItem('tab5');
                            Hap.showError("<@spring.message 'msg.error.member.memberdetail.memaccount_info_incomplete'/>");
                            return false;
                        }

                        //校验字段必输
                        validateStatus = Hap.validateGrid([tab5Grid2Obj]);
                        if (!validateStatus) {
                            tab.selectTabItem('tab5');
                            return false;
                        }

                        /**
                         * 银行卡信息校验
                         * 1. 银行卡只允许有一个默认
                         */
                        var tab5Grid2Data =  tab5Grid2Obj.getData();
                        var cardDefaulatCount = 0;
                        for (i in tab5Grid2Data) {
                            if (tab5Grid2Data[i].defaultFlag == 'Y') {
                                cardDefaulatCount = cardDefaulatCount + 1;
                            }
                        }

                        if (cardDefaulatCount > 1) {
                            tab.selectTabItem('tab5');
                            Hap.showError("<@spring.message 'msg.error.member.card_only_one_default'/>");
                            return false;
                        }

                    }
                }

                return true;
            }

            /**
             * 整合tab数据
             */
            function mergerData() {
                submitMemberData = memberData;

            <#if isedit == '1'>

                //仅查询数据
                submitMemberData.memDownLines = null;
                submitMemberData.memAccountingBalances = null;
                submitMemberData.memAccountingTrxs = null;
                submitMemberData.memRanks = null;
                submitMemberData.memWithdraws = null;

                //可编辑数据
                submitMemberData.memRelationships = null;
                submitMemberData.memSites = null;
                submitMemberData.memCards = null;
            </#if>

                //更改所有权传递原会员表Id
            <#if isChangeOwnership == '1' && sourceMemberId != ''>
                submitMemberData.isChangeOwnership = true;
                submitMemberData.sourceMemberId = ${RequestParameters.sourceMemberId};
                submitMemberData.isChangeOwnership = true;
            </#if>

                //整合tab1数据
                tab1FormData =  tab1FormObj.getData();
                submitMemberData.marketId = tab1FormData.marketId;
                submitMemberData.marketName = tab1FormData.marketName;
                submitMemberData.companyId = tab1FormData.companyId;
                submitMemberData.companyName = tab1FormData.companyName;
                submitMemberData.memberId = tab1FormData.memberId;
                submitMemberData.memberCode = tab1FormData.memberCode;
                submitMemberData.memberType = tab1FormData.memberType;
                submitMemberData.status = tab1FormData.status;
                submitMemberData.statusDesc = tab1FormData.statusDesc;
                submitMemberData.memberRole = tab1FormData.memberRole;
                submitMemberData.tempPassword = tab1FormData.tempPassword;
                submitMemberData.brNumber = tab1FormData.brNumber;
                submitMemberData.refCompany = tab1FormData.refCompany;
                //Mclin添加
                submitMemberData.refCompanyEn = tab1FormData.refCompanyEn;
                submitMemberData.warningMsg = tab1FormData.warningMsg;
                submitMemberData.remark = tab1FormData.remark;
            <#if isedit = '0'>
                submitMemberData.memAttributes = [];
                if(liger.get("cardPass").getValue()!=""){
                    submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "card_pass", value : liger.get("cardPass").getValue()});
                }
            </#if>
                if(liger.get("cardPass").getValue()!=""){
                    var existCardPass = false;
                    for (var i in submitMemberData.memAttributes) {
                        if (submitMemberData.memAttributes[i].attribute == "card_pass"){
                            submitMemberData.memAttributes[i].value = liger.get("cardPass").getValue();
                            existCardPass = true;
                        }
                    }
                    if(!existCardPass){
                        submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "card_pass", value : liger.get("cardPass").getValue()});
                    }
                }

                //整合tab2数据
                if (window.tab2FormObj) {
                    tab2FormData =  tab2FormObj.getData();
                    submitMemberData.chineseFirstName = tab2FormData.chineseFirstName;
                    submitMemberData.chineseLastName = tab2FormData.chineseLastName;
                    submitMemberData.englishFirstName = tab2FormData.englishFirstName;
                    submitMemberData.englishLastName = tab2FormData.englishLastName;
                    submitMemberData.chineseName = tab2FormData.chineseName;
                    submitMemberData.englishName = tab2FormData.englishName;
                    submitMemberData.gender = tab2FormData.gender;
                    submitMemberData.dob = tab2FormData.dob;
                    submitMemberData.idType = tab2FormData.idType;
                    submitMemberData.idNumber = tab2FormData.idNumber;
                    submitMemberData.phoneNo = tab2FormData.phoneNo;
                    if(memberData.areaCode && !memberData.phoneNo) {
                        submitMemberData.areaCode = '';
                        liger.get('areaCode').setValue('');
                    }
                    submitMemberData.othPhoneNo = tab2FormData.othPhoneNo;
                    if(memberData.othAreaCode && !memberData.othPhoneNo) {
                        submitMemberData.othAreaCode = '';
                        liger.get('othAreaCode').setValue('');
                    }
                    submitMemberData.email = tab2FormData.email;
                    submitMemberData.homeLocationId = tab2FormData.homeLocationId;
                    submitMemberData.contactLocationId = tab2FormData.contactLocationId;
                    submitMemberData.nationality = tab2FormData.nationality;
                    submitMemberData.country = tab2FormData.country;
                    submitMemberData.language = tab2FormData.language;
                    submitMemberData.race = tab2FormData.race;
                    submitMemberData.education = tab2FormData.education;
                    submitMemberData.nhiTaxExcluded = tab2FormData.nhiTaxExcluded;
                    submitMemberData.gstIdNumber = tab2FormData.gstIdNumber;
                    submitMemberData.signature = tab2FormData.signature;
                    submitMemberData.adOptIn = tab2FormData.adOptIn;
                    submitMemberData.sysMsgIn = tab2FormData.sysMsgIn;
                    submitMemberData.idCopy = tab2FormData.idCopy;
                    submitMemberData.applicationForm = tab2FormData.applicationForm;
                    submitMemberData.banckAccountCopy = tab2FormData.banckAccountCopy;
                    submitMemberData.confiAgreement = tab2FormData.confiAgreement;
                    submitMemberData.gstLocationId = tab2FormData.gstLocationId;

                <#if spmParamMemberApplicitionList == 'Y'>
                    //获取联系人申请清单
                    <#if isedit = '0'>
                        submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "id_copy", value : null});
                    submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "application_form", value : null});
                    submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "banck_account_copy", value : null});
                    submitMemberData.memAttributes.push({memberId : null, attributeId : null, attribute : "confidentiality_agreement", value : null});
                </#if>

                    for (var i in submitMemberData.memAttributes) {
                        if (submitMemberData.memAttributes[i].attribute == "id_copy"){
                            submitMemberData.memAttributes[i].value = booleanToString(liger.get("idCopy").getValue());
                        } else if (submitMemberData.memAttributes[i].attribute == "application_form"){
                            submitMemberData.memAttributes[i].value = booleanToString(liger.get("applicationForm").getValue());
                        } else if (submitMemberData.memAttributes[i].attribute == "banck_account_copy"){
                            submitMemberData.memAttributes[i].value = booleanToString(liger.get("banckAccountCopy").getValue());
                        } else if (submitMemberData.memAttributes[i].attribute == "confidentiality_agreement"){
                            submitMemberData.memAttributes[i].value = booleanToString(liger.get("confiAgreement").getValue());
                        }
                    }
                </#if>

                    //获取地址
                    submitMemberData.homeSpmLocation = memberData.homeSpmLocation;
                    submitMemberData.contactSpmLocation = memberData.contactSpmLocation;

                }

                //整合tab3数据
                if (window.tab3GridObj) {
                    var data = tab3GridObj.getData();
                    for(var i in data){
                        if(data[i].relType == 'BENF') {
                            if( data[i].idType == "" || data[i].idType == null ||
                                data[i].idNumber == "" || data[i].idNumber == null ||
                                data[i].relDesc == "" || data[i].relDesc == null ||
                                data[i].dob == "" || data[i].dob == null) {
                                tab.selectTabItem('tab3');
                                Hap.showError('<@spring.message "msg.warning.member.memberdetails.requiredmissing"/>');
                                return false;
                            }
                        }
                    }
                    submitMemberData.memRelationships = tab3GridObj.getChanges();
                }

                //整合tab4数据
                if (window.tab4FormObj) {
                    tab4FormData =  tab4FormObj.getData();
                    submitMemberData.jointSite = tab4FormData.jointSite;
                    submitMemberData.jointDate = tab4FormData.jointDate;
                    submitMemberData.approvalDate = tab4FormData.approvalDate;
//                submitMemberData.sponsorNo = tab4FormData.sponsorNo;
//                submitMemberData.sponsorChineseName = tab4FormData.sponsorChineseName;
//                submitMemberData.sponsorEnglishName = tab4FormData.sponsorEnglishName;
                    submitMemberData.rank = tab4FormData.rank;
                    submitMemberData.acceptBonus = tab4FormData.acceptBonus;
                    submitMemberData.salePoint = tab4FormData.salePoint;
                    submitMemberData.travelCount = tab4FormData.travelCount;
                    submitMemberData.tripPoint = tab4FormData.tripPoint;
                    //submitMemberData.travelPlanMonth = tab4FormData.travelPlanMonth.format('yyyyMM');
                    submitMemberData.bonusRcvMethod = tab4FormData.bonusRcvMethod;
                    submitMemberData.terminationDate = tab4FormData.terminationDate;
                }

                //整合tab5数据
                if (window.tab5Grid1Obj) {
                    var tmpData = tab5Grid1Obj.getChanges();
                    for(var i in tmpData){
                        if(tmpData[i].areaCode && !tmpData[i].phone){
                            tmpData[i].areaCode = '';
                        }
                    }
                    submitMemberData.memSites = tmpData;
                }

                if (window.tab5FormObj) {
                    tab5FormData =  tab5FormObj.getData();
                    submitMemberData.memAccounts = [{
                        accountId : tab5FormData.accountId,
                        memberId : submitMemberData.memberId,
                        bankId : tab5FormData.bankId,
                        bankBranchId : tab5FormData.bankBranchId,
                        accountNumber : tab5FormData.accountNumber,
                        accountHolder : tab5FormData.accountHolder,
                        idNumber : tab5FormData.idNumber,
                        comments : tab5FormData.comments
                    }];
                }

                if (window.tab5Grid2Obj) {
                    submitMemberData.memCards = tab5Grid2Obj.getChanges();
                }
                return true;
            }

            /**
             * 下线树选择会员初始化查询字段
             * @param memberId
             */
            function setDowmLineQueryData(node){
                //顶层会员
                /* if (memberData.memberId == memberId) {
                 $("#tab9_form").ligerForm().setData({
                 memberId : memberId,
                 memberCode : memberData.memberCode,
                 memberName : memberData.memberName,
                 areaCode : memberData.areaCode,
                 phoneNo : memberData.phoneNo,
                 statusDesc : memberData.statusDesc,
                 jointDate : memberData.jointDate,
                 deadline : memberData.deadline
                 });
                 } */

                //下线会员
                $("#tab9_form").ligerForm().setData({
                    memberId : node.data.memberId||'',
                    memberCode : node.data.memberCode||'',
                    memberName : node.data.memberName||'',
                    areaCode : node.data.areaCode||'',
                    phoneNo : node.data.phoneNo||'',
                    status : node.data.status||'',
                    statusDesc : node.data.statusDesc||'',
                    jointDate : node.data.jointDate||'',
                    deadline : node.data.deadline||'0'
                });
            }

            /**
             * 复制家庭地址至联系地址
             */
            function copyLocation() {
                var tab2_form_manager = $("#tab2_form").ligerForm();
                var homeLocation = $.ligerui.get('homeLocation').getValue();
                if (homeLocation != undefined && homeLocation != '') {
                    //保留联系地址原locationId、locationCode、name，复制地址内容
                    memberData.contactSpmLocation = memberData.contactSpmLocation||{};
                    memberData.contactSpmLocation = {
                        locationId : memberData.contactSpmLocation.locationId,
                        countryCode : memberData.homeSpmLocation.countryCode,
                        stateCode : memberData.homeSpmLocation.stateCode,
                        cityCode : memberData.homeSpmLocation.cityCode,
                        locationCode : memberData.contactSpmLocation.locationCode,
                        name : memberData.contactSpmLocation.name,
                        description : memberData.homeSpmLocation.description,
                        addressLine1 : memberData.homeSpmLocation.addressLine1,
                        addressLine2 : memberData.homeSpmLocation.addressLine2,
                        addressLine3 : memberData.homeSpmLocation.addressLine3,
                        addressLine4 : memberData.homeSpmLocation.addressLine4,
                        addressLine5 : memberData.homeSpmLocation.addressLine5,
                        address : memberData.homeSpmLocation.address,
                        zipCode : memberData.homeSpmLocation.zipCode
                    };

                    //显示复制后的地址
                    $.ligerui.get('contactLocation').setValue(homeLocation);
                }
            }

            /**
             * 复制联系地址至账户信息地址
             */
            function copyContactLocation(id) {
                if (memberData.contactSpmLocation.address != null) {
                    //复制姓名和电话
                    var tab2FormData;
                    if (window.tab2FormObj != undefined) {
                        tab2FormData =  tab2FormObj.getData();
                    } else {
                        tab2FormData = memberData;
                    }
                    var chineseName = tab2FormData.chineseFirstName||'';
                    if (spmParamMemberLastNameEditable == 'Y') {
                        chineseName = tab2FormData.chineseLastName + chineseName;
                    }

                    var englishName = tab2FormData.englishFirstName||'';
                    if (spmParamMemberLastNameEditable == 'Y' && tab2FormData.englishLastName != '') {
                        englishName = englishName + ' ' + tab2FormData.englishLastName;
                    }

                    var areaCode = tab2FormData.areaCode;
                    var phoneNo = tab2FormData.phoneNo;
                    $.ligerui.get('tab5_grid1').updateCell("name", chineseName || englishName, id);
                    $.ligerui.get('tab5_grid1').updateCell("areaCode", areaCode, id);
                    $.ligerui.get('tab5_grid1').updateCell("phone", phoneNo, id);

                    //复制联系地址
                    $.ligerui.get('tab5_grid1').updateCell("address", memberData.contactSpmLocation.address, id);
                    var locationId;
                    if ($.ligerui.get('tab5_grid1').getRow(id).spmLocation != undefined) {
                        locationId = $.ligerui.get('tab5_grid1').getRow(id).spmLocation.locationId;
                    }
                    $.ligerui.get('tab5_grid1').getRow(id).spmLocation = $.extend({},memberData.contactSpmLocation);
                    $.ligerui.get('tab5_grid1').getRow(id).spmLocation.locationId = locationId;
                    $.ligerui.get('tab5_grid1').getRow(id).spmLocation.locationCode = locationId;
                    $.ligerui.get('tab5_grid1').getRow(id).spmLocation.name = locationId;
                }

            }

            /**
             * 上传签名
             */
            function uploadSignature() {
                if (memberData.memberId == null) {
                    Hap.showError('<@spring.message "msg.warning.member.memberdetails.saveandimport"/>');
                    return;
                }

                $.ligerDialog.open({
                    height:200,
                    width: 300,
                    title : '<@spring.message "type.com.lkkhpg.dsis.common.member.btn.memberdetails.upload"/>',
                    url: 'mm_member_edit_upload.html?memberId=' + memberData.memberId,
                    showMax: false,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    slide: false,
                    buttons: [
                        { text: $l("sys.hand.btn.ok"),
                            onclick: function (item, dialog) {
                                dialog.close();
                            }
                        },
                        { text: $l("sys.hand.btn.cancel"),
                            onclick: function (item, dialog) {dialog.close();
                            }
                        }

                    ]
                });
            }


            /**
             * 推荐人即时鉴别
             */
            function verifySponsor(sponsorMemberCode) {
                if (sponsorMemberCode == null) {
                    sponsorMemberCode = $.ligerui.get('sponsorNo').getValue();
                }

                if (sponsorMemberCode == "") {
                    Hap.showError('<@spring.message "msg.error.member.memberdetails.sponsorrequired"/>');
                    return;
                }

                if (sponsorMemberCode.length != 9) {
                    Hap.showError('<@spring.message "msg.error.member.memberdetails.sponsornolength"/>');
                    return;
                }

                var manager = $.ligerDialog.waitting('<@spring.message "msg.info.member.memberdetails.sponsorverifying"/>');
                Hap.ajax({
                    url: '${base.contextPath}/mm/member/sponsorVerify?memberCode=' + sponsorMemberCode,
                    success : function(json) {
                        Hap.showSuccess('<@spring.message "msg.info.member.memberdetails.sponsorverifysuccess"/>');
                        memberData.isSponsorVerify = true;
                        $.ligerui.get('sponsorChineseName').setValue(json.rows[0].sponsorChineseName);
                        $.ligerui.get('sponsorEnglishName').setValue(json.rows[0].sponsorEnglishName);
                    }
                });
            }

            /**
             * 信用卡类型必输
             */
            jQuery.validator.addMethod("validateCardSubType", function(value, element) {
                if (element.row != undefined && element.row.cardType == 'DEBIT') {
                    return true;
                }
                //return this.optional(element);
                if (value == '') {
                    return false;
                } else {
                    return true;
                }
            }, '<@spring.message "msg.error.member.credit_card_sub_type_required"/>');

            /**
             * 会员中英文姓名至少填一个
             */
            jQuery.validator.addMethod("validateMemberName", function(value, element) {
                var tab2FormData =  tab2FormObj.getData();
                tab2FormData.chineseLastName = tab2FormData.chineseLastName||'';
                tab2FormData.englishLastName = tab2FormData.englishLastName||'';
                //校验姓名
                if (tab2FormData.chineseFirstName == '' && tab2FormData.chineseLastName == '' &&
                    tab2FormData.chineseFirstName == '' && tab2FormData.englishLastName == '') {
                    return false;
                }

                //校验通过，则校验关联字段
                /* if (element.name == "chineseFirstName") {
                 tab2FormObj.validField("chineseLastName")
                 } else if (element.name == "chineseLastName") {
                 tab2FormObj.validField("chineseFirstName")
                 } else if (element.name == "englishFirstName") {
                 tab2FormObj.validField("englishLaststName")
                 } else if (element.name == "englishLaststName") {
                 tab2FormObj.validField("englishFirstName")
                 } */

                return true;

            }, '<@spring.message "msg.error.member.member_name_require_one"/>');

            /**
             * 会员姓和名需全
             */
            jQuery.validator.addMethod("validateFirstAndLastName", function(value, element) {
                var tab2FormData =  tab2FormObj.getData();
                tab2FormData.chineseLastName = tab2FormData.chineseLastName||'';
                tab2FormData.englishLastName = tab2FormData.englishLastName||'';

                //启用会员名则校验姓名需全
                if (spmParamMemberLastNameEditable == 'Y') {
                    //校验姓名
                    if (tab2FormData.chineseFirstName != '' && tab2FormData.chineseLastName == '' ||
                        tab2FormData.chineseFirstName == '' && tab2FormData.chineseLastName != '') {
                        return false;
                    }
                    if (tab2FormData.englishFirstName != '' && tab2FormData.englishLastName == '' ||
                        tab2FormData.englishFirstName == '' && tab2FormData.englishLastName != '') {
                        return false;
                    }
                }

                return true;

            }, '<@spring.message "msg.error.member.member_first_and_last_name_required"/>');

            //          /**
            //           * 中文姓和名总长度不超过16位汉字
            //           */
            //          jQuery.validator.addMethod("validateChineseNameLength", function(value, element) {
            //             var tab2FormData =  tab2FormObj.getData();
            //             tab2FormData.chineseLastName = tab2FormData.chineseLastName||'';
            //             tab2FormData.englishLastName = tab2FormData.englishLastName||'';
            //              if (tab2FormData.chineseFirstName.length + tab2FormData.chineseLastName.length > 16) {
            //                  return false;
            //              }

            //              return true;
            //          }, '<@spring.message "msg.error.member.chinese_name_length_error"/>');

            //          /**
            //           * 英文姓和名总长度不超过48位
            //           */
            //          jQuery.validator.addMethod("validateEnglisehNameLength", function(value, element) {
            //             var tab2FormData =  tab2FormObj.getData();
            //             tab2FormData.chineseLastName = tab2FormData.chineseLastName||'';
            //             tab2FormData.englishLastName = tab2FormData.englishLastName||'';
            //              if (tab2FormData.englishFirstName.length + tab2FormData.englishLastName.length > 48) {
            //                  return false;
            //              }

            //              return true;
            //          }, '<@spring.message "msg.error.member.english_name_length_error"/>');

            /**
             * 相关人中英文至少填一个
             */
            jQuery.validator.addMethod("validateRelationshipName", function(value, element) {
                if (element.row != undefined &&
                    (element.row.chineseName == null || element.row.chineseName == '') &&
                    (element.row.englishName == null || element.row.englishName == '')) {
                    return false;
                } else {
                    return true;
                }
            }, '<@spring.message "msg.error.member.member_name_require_one"/>');

            /**
             * 公司中英文名称至少填一个Mclin添加
             */
            jQuery.validator.addMethod("validateCompanyName", function(value, element) {
                var tab1FormData =  tab1FormObj.getData();
                tab1FormData.refCompany = tab1FormData.refCompany||'';
                tab1FormData.refCompanyEn = tab1FormData.refCompanyEn||'';
                //校验姓名
                if (tab1FormData.refCompany == '' && tab1FormData.refCompanyEn == '') {
                    return false;
                }
                return true;
            }, '<@spring.message "msg.error.member.company_name_require_one"/>');
            /**
             * 校验推荐人卡号
             */
            jQuery.validator.addMethod("validateSponsor", function(value) {
                //只有新建模式，且非变更所有权，才需要校验
                <#if isedit = '0' && isChangeOwnership != '1'>
                    if (value.length != 9) {
                        return false;
                    }
                </#if>

                return true;
            }, '<@spring.message "msg.error.member.sponsorno_length_not_match"/>');

            jQuery.validator.addMethod("validatePhoneNo", function(value, element) {
                if(tab2ValidateFlag){
                    var tab2FormData =  tab2FormObj.getData();
                    tab2FormData.phoneNo = tab2FormData.phoneNo||'';
                    tab2FormData.areaCode = tab2FormData.areaCode||'';

                    //联系号码和区号需全
                    if (tab2FormData.phoneNo != '' && tab2FormData.areaCode == '') {
                        return false;
                    }
                }
                return true;
            }, '<@spring.message "msg.error.member.member_areacode_and_phoneno_required"/>');

            jQuery.validator.addMethod("validateOthPhoneNo", function(value, element) {
                if(tab2ValidateFlag){
                    var tab2FormData =  tab2FormObj.getData();
                    tab2FormData.othPhoneNo = tab2FormData.othPhoneNo||'';
                    tab2FormData.othAreaCode = tab2FormData.othAreaCode||'';

                    //其它联系号码和区号需全
                    if (tab2FormData.othPhoneNo != '' && tab2FormData.othAreaCode == '') {
                        return false;
                    }
                }
                return true;
            }, '<@spring.message "msg.error.member.member_areacode_and_phoneno_required"/>');

            jQuery.validator.addMethod("validateAddrPhoneNo", function(value, element) {
                if(tab5ValidateFlag){
                    var phone = element.row.phone||''
                    var areaCode = element.row.areaCode||'';
                    if(phone!=''&&areaCode==''){
                        return false;
                    }
                }
                return true;
            }, '<@spring.message "msg.error.member.member_areacode_and_phoneno_required"/>');

            /**
             * boolean转换为Y/N
             */
            function booleanToString(item) {
                if (item) {
                    return 'Y';
                } else {
                    return 'N';
                }
            }

            /**
             * String转换为boolean
             */
            function stringToboolean(item) {
                if (item == 'Y') {
                    return true;
                } else {
                    return false;
                }
            }

            function getTravelCount(memberId){
                $.ajax({
                    url: '${base.contextPath}/em/event/getTravelCountByMember',
                    type:"GET",
                    dataType:"json",
                    contentType : "application/json",
                    async: false,
                    data : {memberId:memberId},
                    success : function(json) {
                        if(json.success){
                            $("#tab4_form").ligerForm().setData({travelCount:json.rows[0]})
                            return json.rows[0];
                        }
                    },
                    error : function() {
                    }
                })
            }

            function getDefaultCountry(){
                $.ajax({
                    url: '${base.contextPath}/spm/market/query',
                    type:"GET",
                    dataType:"json",
                    contentType : "application/json",
                    async: false,
                    data : {marketId:_marketId},
                    success : function(json) {
                        if(json.success){
                            var marketCode = json.rows[0].code;
                            for(var index in countryList){
                                if(marketCode == countryList[index].value){
                                    defaultCountry = countryList[index].meaning;

                                }
                            }
                        }
                    },
                    error : function() {
                    }
                })

            }
            //获取可访问的会员类别列表
            function getAccessableMemberType(){
                window.accessableMemberType = [];
                //遍历会员类型
                for (i in memberType) {
                    //遍历会员类型可访问控制
                    for (j in memberTypeAccess) {
                        if (memberType[i].value == memberTypeAccess[j].value) {
                            //如果当前会员类别可以ALL访问则添加到列表
                            if (memberTypeAccess[j].meaning == 'ALL') {
                                accessableMemberType.push(memberType[i]);

                                //如果当前会员类别为PART访问，且描述里包含{当前marketCode}则添加到列表
                            } else if (memberTypeAccess[j].meaning == 'PART' && memberTypeAccess[j].description.indexOf('{' + memberData.marketCode + '}') >= 0) {
                                accessableMemberType.push(memberType[i]);
                            }
                        }
                    }
                }
            }

            function gst_location_edit(contextpath, locationObj, callback) {
                $.ligerDialog.open({
                    height : 240,
                    width : 550,
                    title :"地址信息",
                    url : contextpath+'/mm/mm_gstlocation_edit.html', //
                    showMax : false,
                    //showToggle : true,
                    showMin : false,
                    isResize : true,
                    slide : false,
                    data : locationObj,// document.activeElement.obj_location,
                    buttons : [ {
                        text : $l("sys.hand.btn.ok"),
                        onclick : function(item, dialog) {
                            var form = dialog.frame.gst_location_form_o;
                            if (form.valid()) {
                                var return_data = dialog.frame.init_return_data();
                                if(return_data.cityCode != ""){
                                    if(return_data.stateCode == ""){
                                        $.ligerDialog.error('<@spring.message "msg.error.member.location_not_complete"/>');
                                        return ;
                                    }
                                }
                                if(return_data.stateCode != ""){
                                    if(return_data.countryCode == ""){
                                        $.ligerDialog.error('<@spring.message "msg.error.member.location_not_complete"/>');
                                        return ;
                                    }
                                }
                                callback(return_data);
                                dialog.close();
                            }
                        }
                    }, {
                        text : $l("sys.hand.btn.cancel"),
                        onclick : function(item, dialog) {
                            dialog.close();
                        }
                    }

                    ]
                })
            }
            function synToGds(data) {
                manager = $.ligerDialog.waitting('<@spring.message "msg.info.member.member_save_success_and_sysc"/>');
                //保存成功
                if (data.rows != undefined && data.rows[0] != null) {
                    //变更所有权操作不同步GDS
                    if (memberData.isChangeOwnership) {
                        Hap.showSuccess('<@spring.message "msg.info.member.member_save_success"/>');
                        window.top.f_removeTab('MEMBER_DETAIL');
                        window.top.f_addTab('MEMBER_DETAIL', '<@spring.message "type.com.lkkhpg.dsis.common.member.memberdetail"/>', 'mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId);
                        window.top.f_removeTab('MEMBER_CHANGE_OWNERSHIP');
                        return;
                    }
                    //同步会员至GDS
                    Hap.ajax({
                        url: '${base.contextPath}/mm/member/sync?memberId=' + data.rows[0].memberId,
                        success : function(result) {
                            Hap.showSuccess('<@spring.message "msg.info.member.member_save_success"/>',
                                //显示保存成功后回调刷新界面
                                function() {
                                    if (isedit == '0') {
                                        window.top.f_removeTab("MEMBER_DETAIL");
                                        window.top.f_addTab('MEMBER_DETAIL', '<@spring.message "type.com.lkkhpg.dsis.common.member.memberdetail"/>', 'mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId);
                                        window.top.f_removeTab('MEMBER_CREATE');
                                    } else {
                                        window.location.href = '${base.contextPath}/mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId;
                                        //window.top.f_removeTab('MEMBER_DETAIL');
                                    }
                                    //window.top.f_addTab('MEMBER_DETAIL', '<@spring.message "type.com.lkkhpg.dsis.common.member.membercreate"/>', 'mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId);
                                    //window.location.href = '${base.contextPath}/mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId;
                                }
                            );

                        },
                        failure : function(result) {
                            Hap.showError(result.message,
                                //显示报错信息后回调刷新界面
                                function() {window.location.href = '${base.contextPath}/mm/mm_member_edit.html?isedit=1&memberId=' + data.rows[0].memberId;}
                            );
                        }
                    });
                }
            }

            var lovCheckPassword;
            function checkBankCard(){
                if(!lovCheckPassword){
                    window['checkform'] = $("#checkform").ligerForm({
                        prefixID:'checkform_',
                        fields : [
                            {name : "memberId",type : "hidden",newline : false,
                                options:{
                                    value:memberData.memberId
                                }
                            },{
                                display : '<@spring.message "type.com.lkkhpg.dsis.common.member.dto.memberdetails.cardpass"/>',
                                name : "value",
                                newline: true,
                                type : "password",
                                validate:{
                                    required: true
                                }
                            }]
                    });
                    lovCheckPassword = $.ligerDialog.open({
                        height:150,
                        width: 350,
                        allowClose:false,
                        title : '<@spring.message "type.com.lkkhpg.dsis.common.order.dto.orderpayment.inputpass"/>',
                        target: $("#checkform"),
                        buttons: [{
                            text: $l('sys.hand.btn.ok'),
                            onclick: function(item, dialog) {
                                if(Hap.validateForm(checkform)){
                                    dialog.hide();
                                    var options1 = {
                                        url: _basePath + "/om/payment/checkBank",
                                        data:checkform.getData(),
                                        success:function(data){
                                            if ('empty' == data.rows[0]) {
                                                $.ligerDialog.error('<@spring.message "type.com.lkkhpg.dsis.common.order.dto.orderpayment.cardauthority"/>');
                                                dialog.hide();
                                                clearPassword();
                                            } else if ('error' == data.rows[0]) {
                                                $.ligerDialog.error('<@spring.message "type.com.lkkhpg.dsis.common.order.dto.orderpayment.password_error"/>');
                                                dialog.hide();
                                                clearPassword();
                                            } else if ('true' == data.rows[0]) {
                                                queryBankCard();
                                                dialog.hide();
                                                clearPassword();
                                            }
                                        }
                                    }
                                    Hap.ajax(options1);
                                }
                            }
                        },
                            {
                                text: '<@spring.message "sys.hand.btn.cancel"/>',
                                onclick: function(item, dialog) {
                                    dialog.hide();
                                    clearPassword();
                                }
                            }]
                    });
                }
                lovCheckPassword.show();
            }
            function clearPassword(){
                checkform.setData({
                    value:""
                });
            }
            function queryBankCard(){
                $.ajax({
                        type : 'POST',
                    <#if isedit == '1' >
                url : _basePath + "/mm/query/bankInfo?memberId=${RequestParameters.memberId}",
            </#if>
                success : function(data) {
                    //showBankInfo(data.rows);
                    var sourceBankInfo = window.tab5Grid2Obj.currentData.rows;
                    for(var i in data.rows){
                        sourceBankInfo[i].maskedCardNumber = data.rows[i].cardNumber;
                    }
                    window.tab5Grid2Obj.currentData.rows = sourceBankInfo;
                    window.tab5Grid2Obj.reRender();
                }
            });
            }
            function copyAccount() {
//         	if(isFirstBonusWaring && isedit=='1'){
//         		  isBonusDay_AccountInfo();
//         	}
//         	if (isBonusDay_AccountInfo()) {
                if (!memberData.memAccounts || memberData.memAccounts.length <= 0) {
                    memberData.memAccounts = [{accountHolder:'',idNumber:''}];
                }
                if(memberData.memberType == 'COMP') {
                    var rce = $.ligerui.get('refCompanyEn').getValue();
                    if(rce) {
                        memberData.memAccounts[0].accountHolder = rce||''
                        $.ligerui.get('accountHolder').setValue(rce||'');
                    } else {
                        var rc = $.ligerui.get('refCompany').getValue();
                        memberData.memAccounts[0].accountHolder = rc;
                        $.ligerui.get('accountHolder').setValue(rc);
                    }
                } else {
                    var cfn = $('#tab2_form').ligerForm().getData().chineseFirstName;
                    var cln = $('#tab2_form').ligerForm().getData().chineseLastName;
                    var efn = $('#tab2_form').ligerForm().getData().englishFirstName;
                    var eln = $('#tab2_form').ligerForm().getData().englishLastName;
                    if(!cfn){
                        cfn = memberData.chineseFirstName||'';
                    }
                    if(!cln){
                        cln = memberData.chineseLastName||'';
                    }
                    if(!efn){
                        efn = memberData.englishFirstName||'';
                    }
                    if(!eln){
                        eln = memberData.englishLastName||'';
                    }
                    if (spmParamMemberLastNameEditable == 'Y') {
                        if(efn && eln){
                            var memberEngName = eln + ' ' + efn;
                            memberData.memAccounts[0].accountHolder = memberEngName;
                            $.ligerui.get('accountHolder').setValue(memberEngName);
                        } else if (!efn && eln) {
                            memberData.memAccounts[0].accountHolder = eln;
                            $.ligerui.get('accountHolder').setValue(eln);
                        } else if (!eln && efn) {
                            memberData.memAccounts[0].accountHolder = efn;
                            $.ligerui.get('accountHolder').setValue(efn);
                        } else {
                            var memberChnName = cln + cfn;
                            memberData.memAccounts[0].accountHolder = memberChnName||'';
                            $.ligerui.get('accountHolder').setValue(memberChnName||'');
                        }
                    } else {
                        if(efn) {
                            memberData.memAccounts[0].accountHolder = efn;
                            $.ligerui.get('accountHolder').setValue(efn);
                        } else {
                            memberData.memAccounts[0].accountHolder = cfn;
                            $.ligerui.get('accountHolder').setValue(cfn);
                        }
                    }
                }
                var idNumber = $('#tab2_form').ligerForm().getData().idNumber||'';
                memberData.memAccounts[0].idNumber = idNumber||'';
                $.ligerui.get('accountIdNumber').setValue(memberData.idNumber||'');
//         	}
            }
            /*跳转至推荐人会员详情页(不关闭原来标签页)*/
            function toSponsorDetailsHtml(data){
                if(memberData.marketCode == memberData.sponsorMarketCode) {
                    window.top.f_addTab("MEMBER_DETAIL"+data,
                        "<@spring.message 'type.com.lkkhpg.dsis.common.member.memberdetail'/>",
                        "mm/mm_member_edit.html?isedit=1&memberId="+data);
                } else {
                    $.ligerDialog.error('<@spring.message "msg.error.member.sponsor_not_in_current_market"/>');
//                 return '<a href="javascript:void(0);">'+memberData.sponsorNo+'</a>';
                }
//         	window.top.f_removeTab("MEMBER_DETAIL");
// window.open('${base.contextPath}/mm/mm_member_edit.html?memberId=' + memberData.memberId)
            }

            //         function isBonusDay_MemberInfo() {
            //         	var today = new Date();
            //         	var date = today.getDate();
            //         	if(date == '3' || date == '12') {
            //         		$.ligerDialog.alert('<@spring.message "msg.error.member.cannot_change_info_util_bonus_calculation_done"/>');
            // //                 $.ligerui.get('chineseFirstName').setDisabled();
            // //                 $.ligerui.get('chineseLastName').setDisabled();
            // //                 $.ligerui.get('englishFirstName').setDisabled();
            // //                 $.ligerui.get('englishLastName').setDisabled();
            //                 isFirstBonusWaring = false;
            //         		return false;
            //         	} else {
            // //         		$.ligerui.get('chineseFirstName').setEnabled();
            // //                 $.ligerui.get('chineseLastName').setEnabled();
            // //                 $.ligerui.get('englishFirstName').setEnabled();
            // //                 $.ligerui.get('englishLastName').setEnabled();
            //                 isFirstBonusWaring = false;
            //                 return true;
            //         	}
            //         }

            //         function isBonusDay_AccountInfo() {
            //             var today = new Date();
            //             var date = today.getDate();
            //             if(date == '3' || date == '12') {
            //                 $.ligerDialog.alert('<@spring.message "msg.error.member.cannot_change_info_util_bonus_calculation_done"/>');
            // //                 liger.get("tab5_form").setEditable(false);
            //                 isFirstBonusWaring = false;
            //                 return false;
            //             } else {
            // //             	liger.get("tab5_form").setEditable(true);
            //                 isFirstBonusWaring = false;
            //                 return true;
            //             }
            //         }
            function toBonusHtml(bonusId,marketId){
                $.ajax({
                    url: '${base.contextPath}/mm/member/isRoleAssignBonusFinal',
                    type:"POST",
                    dataType:"json",
                    contentType : "application/json",
                    data : {roleId:${Session.roleId}},
                    success : function(json) {
                        if(json&&json.code == "Y"){
                            window.top.f_removeTab('BONUS_FINAL');
                            window.top.f_addTab('BONUS_FINAL', '<@spring.message "sys.hand.tab.finalbonus"/>', '${base.contextPath}/bm/bm_final_bonus.html?bonusId=' + bonusId + '&marketId=' + marketId);
                        } else {
                            $.ligerDialog.error('<@spring.message "msg.warning.member.current_user_not_allow_to_access_function"/>');
                        }
                    },
                    error : function() {
                        Hap.showError('<@spring.message "msg.warning.member.failed_to_query_permission"/>');
                    }
                })
            }

            function isBonusDayAndModify(){
                var today = new Date();
                var date = today.getDate();
                if(isedit == '1'){
                    if(date == '3' || date == '12') {
                        if(window.tab2FormObj){
                            var chnFirstName = liger.get('chineseFirstName').getValue();
                            var chnLastName = '';
                            var engLastName = '';
                            var engFirstName = liger.get('englishFirstName').getValue();
                            if (spmParamMemberLastNameEditable == 'Y') {
                                chnLastName = liger.get('chineseLastName').getValue();
                                engLastName = liger.get('englishLastName').getValue();
                            } else {
                                oldChnLastName = '';
                                oldEngLastName = '';
                            }
                            if(chnFirstName!=oldChnFirstName || chnLastName!=oldChnLastName || engFirstName!=oldEngFirstName || engLastName!=oldEngLastName){
                                return true;
                            }
                        }
                        if(window.tab5FormObj){
                            var accountNumber = liger.get('accountNumber').getValue();
                            var accountHolder = liger.get('accountHolder').getValue();
                            var bankId = liger.get('bankId').getValue();
                            var idNumber = liger.get('accountIdNumber').getValue();
                            var comments = liger.get('comments').getValue();
                            var bankBranchId = '';
                            if (spmParamMemberBankBranch == 'Y') {
                                bankBranchId = liger.get('bankBranchId').getValue();
                            } else {
                                oldBankBranchId = '';
                            }
                            if(accountNumber!=oldAccountNumber || accountHolder!=oldAccountHolder || bankId!=oldBankId || idNumber!=oldAccountIdNumber || comments!=oldRemark || bankBranchId!=oldBankBranchId){
                                return true;
                            }
                        }
                    }
                }
                return false;
            }
        </script>

        </body>
        </html>
