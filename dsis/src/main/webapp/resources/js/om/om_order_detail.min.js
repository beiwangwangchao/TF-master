function o_paymentShow(a){var b={columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),name:"paymentMethod",type:"select",render:function(d){for(var c in allPayMethod){if(d.paymentMethod==allPayMethod[c].value){return allPayMethod[c].meaning}}}},{display:$l("type.com.lkkhpg.dsis.common.inv.dto.transaction.totalprice"),name:"paymentAmount"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark"}],showTitle:false,width:"99%",url:_basePath+"/om/orderinfo/queryPayments?headerId="+a,detail:{onShowDetail:f_showPayment,height:"auto"}};return b}function o_paymentOptions(a){var b={columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),name:"paymentMethod",type:"select",render:function(d){for(var c in allPayMethod){if(d.paymentMethod==allPayMethod[c].value){return allPayMethod[c].meaning}}}},{display:$l("type.com.lkkhpg.dsis.common.inv.dto.transaction.totalprice"),name:"paymentAmount",render:function(c){return Number(c.paymentAmount).toFixed(summary.precision)}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark"}],showTitle:false,width:"99%",url:_basePath+"/om/order/queryPaymentRefund?headerId="+a,detail:{onShowDetail:f_showPayment,height:"auto"}};return b}function f_showPayment(e,b,f){var d=e.paymentMethod;var a;if("CHEQU"==d||"REMIT"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.bank"),readonly:true,name:"bankCode",type:"text",},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}else{if("CREDI"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.bank"),readonly:true,name:"bankCode",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditcardtype"),readonly:true,name:"creditCardType",type:"combobox",options:{valueField:"value",textField:"meaning",data:creditCardType,}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.tailnumber"),readonly:true,name:"tailNumber"},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.pos"),readonly:true,name:"paymentMethodInfo",type:"select",options:{valueField:"value",textField:"meaning",data:posSelectData}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}else{if("DBCRD"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.bank"),readonly:true,name:"bankCode",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditcardtype"),readonly:true,name:"creditCardType",type:"combobox",options:{valueField:"value",textField:"meaning",data:creditCardType,}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.tailnumber"),readonly:true,name:"tailNumber"},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.pos"),readonly:true,name:"paymentMethodInfo",type:"select",options:{valueField:"value",textField:"meaning",data:posSelectData}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}else{if("ECUP"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.ecupon.name"),readonly:true,name:"name",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.ecupon.discountvalue"),readonly:true,name:"discountValue"}]}else{if("ONLPA"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.atttibute1"),readonly:true,name:"attribute1",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.tailnumber"),readonly:true,name:"tailNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),readonly:true,name:"attribute2",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.atttibute3"),readonly:true,name:"attribute3",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),readonly:true,name:"remark",type:"text"}]}}}}}var c=document.createElement("div");$(b).append(c);$(c).css("margin",10).ligerForm({width:"90%",data:e,fields:a})}function confirmReceive(){$.ligerDialog.confirm($l("msg.warn.isconfirmreceive"),function(c){if(c){var a=om_oc_form.getData();var b={headerId:a.headerId,remark:a.remark,orderStatus:"COMP"};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(b),success:function(d){location.reload()},contentType:"application/json; charset=utf-8"})}})}function o_omDetailFormOptions(){var a={fields:[{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.createuserid"),name:"createUserId",textField:"createUserName",newline:false,readonly:true,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderinfo")},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesmarket"),name:"salesMarketId",cancelable:false,newline:false,readonly:true},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesorgid"),name:"salesOrgId",newline:false,cancelable:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.currency"),name:"currency",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.ordernumber"),name:"orderNumber",newline:true,readonly:true},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderstatus"),name:"orderStatus",newline:false,readonly:true},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderdate"),newline:false,readonly:true,name:"orderDate"},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paydate"),newline:false,readonly:true,name:"payDate"},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.ordertype"),name:"orderType",newline:true,readonly:true,options:{valueFieldID:"orderType",valueField:"value",textField:"meaning",data:orderTypeData,cancelable:false,onselected:function(d){cleanMember();reSetLine(false,true,false);var b=d;var c=true;if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="SHIPP"){c=false}if(b){switch(b){case"DIRP":case"STFP":case"CONP":case"CONPT":case"STFPT":if(linegrid){linegrid.set({columns:o_getLineColumns(true,false,c)})}liger.get("memberId").set({readonly:true});liger.get("memberId").setPlaceholder("   ");f_changeMemberShow(false);if(b=="STFP"||b=="STFPT"){f_changeStaffShow(true)}else{f_changeStaffShow(false)}var e="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderamt")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(e);break;case"RDEM":if(linegrid){linegrid.set({columns:o_getLineColumns(true,true,c)})}f_changeMemberShow(true);f_changeStaffShow(false);liger.get("memberId").setEnabled();liger.get("memberId").set({readonly:false});liger.get("memberId").set({validate:{required:true}});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"));var e="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salespointsummary")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(e);break;default:if(linegrid){linegrid.set({columns:o_getLineColumns(true,false,c)})}liger.get("memberId").setEnabled();liger.get("memberId").set({readonly:false});liger.get("memberId").set({validate:{required:true}});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"));f_changeMemberShow(true);f_changeStaffShow(false);var e="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderamt")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(e);break}}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.channel"),name:"channel",newline:false,readonly:true,options:{valueFieldID:"channel",valueField:"value",textField:"meaning",cancelable:false,data:channelData,onSelected:function(c,d,b){if(c=="SRVC"){liger.get("serviceCenterId").set({readonly:false});liger.get("serviceCenterId").set({validate:{required:true}});liger.get("memberId").set({readonly:true});liger.get("memberId").setPlaceholder("   ");liger.get("serviceCenterId").setPlaceholder($l("msg.warn.order.om_sales_order.fullservicecentercode"))}else{liger.get("serviceCenterId").set({readonly:true});liger.get("serviceCenterId").setPlaceholder("   ");liger.get("memberId").set({readonly:false});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"))}reSetLine(false,true,false)},render:function(c){for(var b in channelData){if(channelData[b].value==c){return channelData[b].meaning}}}},render:function(c){for(var b in channelData){if(channelData[b].value==c){return channelData[b].meaning}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),name:"period",newline:false,cancelable:false,options:{valueField:"value",textField:"meaning",onBeforeSelect:function(b){return confirm($l("msg.info.order.period")+b)}}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invoicenumber"),name:"invoiceNumber",readonly:true,newline:false},{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberId",type:"popup",textField:"memberCode",readonly:true,newline:true,cancelable:false,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.memberinfo")},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"cnName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.exchangebalance"),name:"exchangeBalance",width:150,labelWidth:120,newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"enName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.remainingbalance"),name:"remainingBalance",width:150,labelWidth:120,newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.satffnumber"),name:"staffNum",type:"text",newline:true,readonly:true,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.satffinfo")},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.satffname"),name:"staffName",newline:false,readonly:true},{type:"textarea",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:false,readonly:true,width:300,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remarkinfo")},{type:"textarea",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.internalremark"),name:"internalRemark",newline:false,readonly:false,validate:{stringMaxLength:240},width:300},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.channelreference"),name:"channelReference",readonly:true,newline:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.sourcekey"),name:"sourceKey",readonly:true,newline:false},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.batchnumber"),name:"batchNumber",readonly:true,newline:false},{type:"hidden",name:"headerId"},{type:"hidden",name:"logisticsId"},{type:"hidden",name:"periodId"},{type:"hidden",name:"billSiteId"},{type:"hidden",name:"deliverySiteId"},{type:"hidden",name:"salesOrgCode"}]};return a}function o_getLineColumns(b,o,c,m,g){var l={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitorigprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(p){if(!p||!p.itemId){return}if(!p.unitOrigPrice){p.unitOrigPrice=0;return summary.zero}if(p.itemSalesType&&p.itemSalesType=="FREE"){p.unitOrigPrice=0;return summary.zero}return Number(p.unitOrigPrice).toFixed(summary.precision)}};var h={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(p){if(!p||!p.itemId){return}if(!p.quantity){p.quantity=1}if(!p.unitSellingPrice){p.unitSellingPrice=0}if(p.itemSalesType&&p.itemSalesType=="FREE"){p.unitSellingPrice=0}return Number(p.unitSellingPrice*p.quantity).toFixed(summary.precision)}};var k={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitsellingprice"),name:"unitSellingPrice",align:"center",type:"float",render:function(p){if(!p||!p.itemId){return}if(!p.unitSellingPrice){p.unitSellingPrice=0;return summary.zero}if(p.itemSalesType&&p.itemSalesType=="FREE"){p.unitSellingPrice=0;return summary.zero}return Number(p.unitSellingPrice).toFixed(summary.precision)}};var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(p){if(!p){return}for(var q in productSalesTypeData){if(p.itemSalesType==productSalesTypeData[q].value){return productSalesTypeData[q].meaning}}},validate:{required:true}};if(o){l={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitredeempoint"),name:"unitRedeemPoint",align:"center",type:"text"};h={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.quantity){p.quantity=1}if(!p.unitRedeemPoint){p.unitRedeemPoint=0}return Number(p.unitRedeemPoint*p.quantity).toFixed(summary.precision)}}}var f=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:120,type:"text",render:function(q){if(!q){return}for(var p in invOrgs){if(q.defaultInvOrgId==invOrgs[p].invOrgId){return invOrgs[p].name}}}},e,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",align:"center",width:100,textField:"itemNumber",validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",align:"center",width:260,type:"text"},l,k,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"int",validate:{required:true,digits:true,min:1,max:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountprice"),name:"discountAmt",align:"center",type:"float",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt||p.discountAmt==0){return"0"}return p.discountAmt}},h];if(summary.enableTax&&!summary.priceIncludeTax){var d={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"tax",align:"center",type:"float",render:function(p){if(!p||!p.itemId){return}p.tax=p.unitSellingPrice-p.unitOrigPrice- -p.discountAmt;return Number(p.tax).toFixed(summary.precision)}};f.splice(6,0,d);var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountafterpv"),name:"discountAfterPv",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt){return}if(!p.discountPv){p.discountPv=0}return p.pv}};var i={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountafterprice"),name:"discountAfterPrice",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt){return}if(!p.discountTax){p.discountTax=0}return(Number(p.unitOrigPrice.sub(p.discountAmt))- -p.discountTax).toFixed(summary.precision)}};var a={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountaftertax"),name:"discountAfterTax",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt){return}if(!p.discountTax){p.discountTax=0}return p.taxAmount.sub(p.discountTax)}};f.splice(7,0,j);f.splice(8,0,i);f.splice(9,0,a)}else{var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountafterpv"),name:"discountAfterPv",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt){return}if(!p.discountPv){p.discountPv=0}return p.pv.sub(p.discountPv)}};var i={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountafterprice"),name:"discountAfterPrice",align:"center",type:"text",render:function(p){if(!p||!p.itemId){return}if(!p.discountAmt){return}return Number(p.unitSellingPrice).toFixed(summary.precision)}};f.splice(6,0,j);f.splice(7,0,i)}var n={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverystatus"),name:"status",width:100,type:"select",render:function(p){for(var q in linesdeliverystatus){if(p.status==linesdeliverystatus[q].value){return linesdeliverystatus[q].meaning}}}};if(liger.get("orderStatus").getValue()=="COMP"){f.unshift(n)}return f}function o_ligerGridOptions(b){var a={detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},columns:o_getLineColumns(true,false,true,b,false),usePager:false,width:"98%",onBeforeShowData:function(c){if("PROD"==applyOn){if(linegrid){linegrid.set({columns:o_getLineColumns(true,false,true,b,true)})}}}};return a}function o_addressGridOptions(c){var a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivebillsname");if(c){a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivegoodsname")}var b={usePager:false,checkbox:false,enabledEdit:false,width:"98%",columns:[{display:a,name:"name",type:"text",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.phone"),name:"phone",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.address"),name:"address",align:"center",width:400,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.spmlocation.zipcode"),name:"spmLocation.zipCode",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.defaultflag"),name:"defaultFlag",align:"center",type:"text"}]};return b}function validatePeriod(){var c=new Date();var g=c.getMonth()+1;var d=c.getFullYear();var h=liger.get("period");var b="";var f="";if(g==1){b=d+"01";f=(d-1)+"12"}else{if(g<10){b=d+"0"+g;f=d+"0"+g-1}else{if(g==10){b=d+"10";f=d+"09"}else{b=d.toString()+g;f=d.toString()+(g-1)}}}h.setData([{meaning:b,value:b},{meaning:f,value:f}]);h.setValue(b);var h=liger.get("period");var e=liger.get("orderStatus").getValue();switch(e){case"SAV":case"WPAY":case"FAIL":case"COMP":break;default:h.set({readonly:true});return}var a=c.getDate();if(a>3){h.set({readonly:true});return}h.set({readonly:false})}function validateDeliver(b){var c=liger.get("deliveryType");type=c.getValue();var a=false;if(liger.get("orderType")&&liger.get("orderType").getValue()=="RDEM"){a=true}if(type=="PCKUP"){$("#addressPanel").hide();if(linegrid){if(applyOn=="PROD"){linegrid.set({columns:o_getLineColumns(true,a,true,b,true)})}else{linegrid.set({columns:o_getLineColumns(true,a,true,b)})}linegrid.reRender()}liger.get("isCod").setValue(false);$("#actrualPayAmt").text(Number(summary.currency- -summary.adjustMents).toFixed(summary.precision))}else{if(type=="SHIPP"){if(linegrid){if(applyOn=="PROD"){linegrid.set({columns:o_getLineColumns(true,a,true,b,true)})}else{linegrid.set({columns:o_getLineColumns(true,a,true,b)})}linegrid.reRender()}reSetLine(false,false,true);$("#addressPanel").show();$("#actrualPayAmt").text(Number(summary.currency- -summary.shippingTier- -summary.adjustMents-summary.discountAmt).toFixed(summary.precision))}}}function validate(a){if(!a){validatePeriod()}validateDeliver(a)}function init(a){$("#deliveryType").ligerComboBox({css:"combobox",data:deliveryTypeData,valueField:"value",textField:"meaning",readonly:true,cancelable:false,onSelected:function(e){validateDeliver(a)}});var d="SHIPP";if(!a){d="PCKUP"}for(var b in deliveryTypeData){if(deliveryTypeData[b].value==d){liger.get("deliveryType").setValue(d);liger.get("deliveryType").setText(deliveryTypeData[b].meaning);break}}$("#deliveryCompany").ligerComboBox({css:"combobox",valueField:"shippingTierId",textField:"shippingTierName",cancelable:false,readonly:true,onSelected:function(h,j,g){var f=Number.MAX_VALUE;if(g){for(var e in g.shippingTierDtls){if(g.shippingTierDtls[e].shippingFee<f&&summary.currency>=g.shippingTierDtls[e].invAmountFrom&&(!g.shippingTierDtls[e].invAmountTo||summary.currency<=g.shippingTierDtls[e].invAmountTo)){summary.shippingTier=g.shippingTierDtls[e].shippingFee;$("#shippingTier").text(summary.shippingTier);$("#actrualPayAmt").text(summary.currency- -summary.shippingTier- -summary.adjustMents)}}}}});if(!a){$("#payAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.adjustment"),width:"98%",height:"auto"});liger.get("payAdjust").collapse();$("#coupons").ligerComboBox({css:"combobox",valueField:"value",textField:"meaning",readonly:true,cancelable:false});$("#adjustType").ligerComboBox({width:120,data:adjustTypeData,readonly:true,valueField:"value",textField:"meaning",cancelable:false});liger.get("serviceCenterId").setDisabled();liger.get("adjustType").setValue("add");for(var b in adjustTypeData){if(adjustTypeData[b].value=="add"){liger.get("adjustType").setText(adjustTypeData[b].meaning)}}if(liger.get("orderStatus").getValue()!="COMP"){var c=new Array();c.push("sourceKey");c.push("batchNumber");om_oc_form.setVisible(c,false)}}$("#isCod").ligerCheckBox({readonly:true});$("#freeShipping").ligerCheckBox({readonly:true});validate(a)}function f_printList(){var a=om_oc_form.getData().salesOrganization.market.code;if(a=="TH"){$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:300,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog_th.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var b=liger.get("orderNumber").getValue();if(!b){return}else{var e=f.frame.report_type_form;var h=e.getData().docType;var g=e.getData().lange;if(e.valid()){f.close();window.open(_basePath+"/report/run?docType="+h+"&reportProgramCode=RPT-PACKING-LIST-"+a+"&lange="+g+"&orderNumber="+b+"&deliveryNumber=")}}}},{text:$l("sys.hand.btn.cancel"),onclick:function(b,c){c.hide()}}]})}else{if(a=="CA"){$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:300,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog_fr_ca.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var b=liger.get("orderNumber").getValue();if(!b){return}else{var e=f.frame.report_type_form;var h=e.getData().docType;var g=e.getData().lange;if(e.valid()){f.close();window.open(_basePath+"/report/run?docType="+h+"&reportProgramCode=RPT-PACKING-LIST-"+a+"&lange="+g+"&orderNumber="+b+"&deliveryNumber=")}}}},{text:$l("sys.hand.btn.cancel"),onclick:function(b,c){c.hide()}}]})}else{$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:300,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var b=liger.get("orderNumber").getValue();if(!b){return}else{var e=f.frame.report_type_form;var g=e.getData().docType;if(e.valid()){if(a=="HK"){$.ajaxSetup({async:false});$.ajax({type:"POST",url:_basePath+"/om/pageList/printTime/update?orderNumber="+b,success:function(d){return true}});$.ajaxSetup({async:true})}f.close();window.open(_basePath+"/report/run?docType="+g+"&reportProgramCode=RPT-PACKING-LIST-"+a+"&orderNumber="+b+"&deliveryNumber=")}}}},{text:$l("sys.hand.btn.cancel"),onclick:function(b,c){c.hide()}}]})}}}function f_printInvoice(){var b=$("#headerId").val();var a=om_oc_form.getData().salesOrganization.market.code;if(!b){retrun}if(a=="TH"){$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:400,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog_th.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var e=f.frame.report_type_form;var h=e.getData().docType;var g=e.getData().lange;if(e.valid()){f.close();window.open(_basePath+"/report/run?docType="+h+"&reportProgramCode=TMPL_"+a+"_INVOICE&lange="+g+"&headerId="+b)}}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){e.hide()}}]})}else{if(a=="CA"){$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:400,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog_fr_ca.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var e=f.frame.report_type_form;var h=e.getData().docType;var g=e.getData().lange;if(e.valid()){f.close();window.open(_basePath+"/report/run?docType="+h+"&reportProgramCode=TMPL_"+a+"_INVOICE&lange="+g+"&headerId="+b)}}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){e.hide()}}]})}else{$.ajax({type:"POST",url:_basePath+"/om/print_invoice?orderId="+b,success:function(c){if(!c||!c.rows||!c.rows[0].attachmentId){f_printEinvoice(b,null,null)}else{if(c.rows[0].einvoiceFlag&&c.rows[0].einvoiceFlag=="Y"){f_printEinvoice(b,c.rows[0].getInvoiceMethod,c.rows[0].invoiceNumber)}else{window.open(_basePath+"/report/run?docType=PDF&reportProgramCode=TMPL_"+a+"_INVOICE&headerId="+b)}}},error:function(c){}})}}}function f_save(c,b){var a=om_oc_form.getData();$.ajax({type:"POST",url:_basePath+"/om/order/saveHead",data:JSON2.stringify(a),success:function(d){if(d.success){Hap.showSuccess()}},contentType:"application/json; charset=utf-8"})}function initButton(b){$("#printList").hide();$("#pickItem").hide();$("#saveBtn").hide();$("#submitBtn").hide();$("#paymentBtn").hide();$("#deliveryPackage").hide();$("#cancle").hide();$("#invalid").hide();$("#editPaymentBtn").hide();$("#printInvoice").hide();var a=liger.get("orderStatus").getValue();if(a=="COMP"){$("#editPaymentBtn").ligerButton({click:getPaymentOfEditPaymentMth,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paymentinfo")});$("#editPaymentBtn").show()}if(!b){var c=liger.get("orderStatus").getValue();if(c=="WPAY"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_save(false,true)},text:$l("sys.hand.btn.submit")});$("#paymentBtn").ligerButton({click:function(){var d=$("#headerId").val();toPaymentPage(d)},text:$l("sys.hand.btn.payment")});$("#cancle").ligerButton({click:function(){$.ligerDialog.confirm($l("msg.warn.iscancel"),function(e){if(e){var d={orderStatus:"CANCL",headerId:$("#headerId").val()};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(d),success:function(g){if(g.success){liger.get("orderStatus").setValue("CANCL");for(var f in orderStatusData){if(orderStatusData[f].value=="CANCL"){liger.get("orderStatus").setText(orderStatusData[f].meaning);break}}$("#saveBtn").hide();$("#submitBtn").hide();$("#paymentBtn").hide();$("#cancle").hide()}},contentType:"application/json; charset=utf-8"})}})},text:$l("sys.hand.btn.cancel")});$("#saveBtn").show();$("#cancle").show();$("#paymentBtn").show()}else{if(c=="NEW"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_save(false,true)},text:$l("sys.hand.btn.submit")})}else{if(c=="SAV"){$("#submitBtn").ligerButton({click:function(){f_save(false,true)},text:$l("sys.hand.btn.submit")})}else{if(c=="COMP"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#periodBtn").hide();$("#printList").ligerButton({click:function(){f_printList()},text:$l("msg.info.order.printlist")});$("#pickItem").ligerButton({click:function(){window.top.f_addTab(null,$l("msg.info.order.pick_release"),_basePath+"/dm/dm_delivery_pick_release.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("msg.info.order.pick_release")});$("#deliveryPackage").ligerButton({click:function(){window.top.f_addTab(null,$l("msg.info.order.delivery"),_basePath+"/dm/dm_delivery_query.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("msg.info.order.delivery")});$("#printInvoice").ligerButton({click:function(){f_printInvoice()},text:$l("msg.info.order.printinvoice")});$("#printInvoice").show();$("#deliveryPackage").show();$("#printList").show();$("#pickItem").show();$("#invalid").ligerButton({click:getMarket,text:$l("msg.info.order.invalid")});$("#invalid").show();$("#saveBtn").show()}else{if(c=="CONF"){$("#pickItem").ligerButton({click:function(){window.top.f_addTab(null,$l("msg.info.order.pick_release"),_basePath+"/dm/dm_delivery_pick_release.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("msg.info.order.pick_release")});$("#deliveryPackage").ligerButton({click:function(){window.top.f_addTab(null,$l("msg.info.order.delivery"),_basePath+"/dm/dm_delivery_query.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("msg.info.order.delivery")});$("#printInvoice").ligerButton({click:function(){alert($l("msg.info.order.printinvoice"))},text:$l("msg.info.order.printinvoice")});$("#printInvoice").show();$("#deliveryPackage").show();$("#pickItem").show();$("#invalid").ligerButton({click:getMarket,text:$l("msg.info.order.invalid")});$("#invalid").show();$("#confirmReceive").ligerButton({click:confirmReceive,text:$l("msg.info.order.confirmreceipt")});$("#confirmReceive").show()}else{if(c=="VOID"){$("#printInvoice").ligerButton({click:function(){f_printInvoice()},text:$l("msg.info.order.printinvoice")});$("#printInvoice").show()}}}}}}}if(b){$("#activeBtn").ligerButton({click:function(){f_updateAutoShipStatus("active")},text:$l("msg.info.order.activation")});$("#stopBtn").ligerButton({click:function(){f_updateAutoShipStatus("suspend")},text:$l("msg.info.order.suspend")});$("#endBtn").ligerButton({click:function(){f_updateAutoShipStatus("termination")},text:$l("type.com.lkkhpg.dsis.common.member.btn.memberdetails.terminate")});$("#autoShipsaveBtn").ligerButton({text:$l("sys.hand.btn.submit"),click:f_sumbitAutoShip});$("#addCreditCar").ligerButton({click:function(){$.ligerDialog.open({target:$("#addCredit"),title:$l("msg.info.order.add_your_credit_card"),width:650})},text:$l("sys.hand.btn.new")})}$("#copyBtn").hide()}function f_memberAddress(a){if(!a){return}if(liger.get("deliveryType").getValue()!="SHIPP"){return}$.ajax({type:"POST",url:_basePath+"/mm/site/query?memberId="+a,success:function(d){if(d.success){var e={};var f=new Array();var b=new Array();for(var c in d.rows){if(d.rows[c].siteUseCode=="BILL"){f.push(d.rows[c])}else{if(d.rows[c].siteUseCode=="SHIP"){b.push(d.rows[c])}}}e.rows=f;addressgrid.set({data:e});e.rows=b;deliveryaddress.set({data:e})}}})}function f_memberAccount(a){if(!a){return}$.ajax({type:"POST",url:_basePath+"/mm/accountingbalance/query?memberId="+a,success:function(b){if(b.success){f_setMemberAccount(b.rows)}}})}function f_setMemberAccount(a){for(var b in a){if(a[b].accountingType=="EB"){liger.get("exchangeBalance").setValue(a[b].balance);$("#exchangeBalance").text(a[b].balance)}else{if(a[b].accountingType=="RB"){liger.get("remainingBalance").setValue(a[b].balance);$("#remainingBalance").text(a[b].balance)}else{if(a[b].accountingType=="SP"){liger.get("currentPoints").setValue(a[b].balance)}}}}}function f_calculateLinePrice(d){var e=linegrid.getData();summary.currency=0;summary.exchange=0;summary.points=0;summary.tax=0;var b;if(liger.get("orderType")){b=liger.get("orderType").getValue()}else{b="STDP"}var c=(b=="RDEM");for(var a in e){if(!e[a].redeemPoint){e[a].redeemPoint=0}if(!e[a].unitOrigPrice){e[a].unitOrigPrice=0}if(!e[a].unitDiscountPrice){e[a].unitDiscountPrice=0}if(!e[a].amount){e[a].amount=0}if(!e[a].PVSum){e[a].PVSum=0}if(!e[a].quantity){e[a].quantity=1}e[a].amount=Number(e[a].unitSellingPrice*e[a].quantity);if(e[a].itemSalesType=="EXCH"){summary.exchange+=Number(e[a].amount)}summary.points+=Number(e[a].redeemPoint);if(e[a].itemSalesType!="FREE"){summary.currency+=Number(e[a].amount)}}if(c){$("#beforeTax").text(summary.zero);$("#tax").text(summary.zero);$("#afterTax").text(summary.zero);$("#TotalCurrency").text(Number(summary.points));if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="SHIPP"){$("#actrualPayAmt").text(Number((summary.shippingTier- -summary.adjustMents).toFixed(summary.precision)))}else{$("#actrualPayAmt").text(Number((summary.adjustMents).toFixed(summary.precision)))}}else{if(summary.enableTax){if(summary.priceIncludeTax){summary.tax=Number((summary.currency/(1+Number(summary.taxRate))*summary.taxRate).toFixed(summary.precision))}else{if(d&&d.taxAmt){summary.tax=d.taxAmt}}}else{summary.tax=0}$("#beforeTax").text(Number(summary.currency-summary.tax).toFixed(summary.precision));$("#tax").text(Number(summary.tax).toFixed(summary.precision));$("#TotalCurrency").text(Number(summary.currency).toFixed(summary.precision));$("#afterTax").text(Number(summary.currency).toFixed(summary.precision));if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){$("#actrualPayAmt").text(Number((summary.currency- -summary.adjustMents-summary.discountAmt).toFixed(summary.precision)))}else{$("#actrualPayAmt").text(Number((summary.currency- -summary.shippingTier+summary.adjustMents-summary.discountAmt).toFixed(summary.precision)))}$("#exchange").text(Number(summary.exchange.toFixed(summary.precision)));if($("#getsalespoint")&&ordertype=="autoship"&&pointRate){if(pointLimit&&(Number($("#actrualPayAmt").text())*pointRate>pointLimit)){$("#getsalespoint").text(pointLimit)}else{$("#getsalespoint").text(Number((Number($("#actrualPayAmt").text())*pointRate).toFixed(summary.precision)))}}}}function f_payMentAdjust(f,e){var g=/^-?\d*\.?\d*$/;if(!g.test(f.value)){$(f).addClass("l-text-invalid");$(f).attr("title",$l("type.com.lkkhpg.dsis.common.order.payadjustment.number")).ligerTip({distanceX:5,distanceY:-3,auto:true});$(f).val("");return}else{if($(f).hasClass("l-text-invalid")){$(f).removeClass("l-text-invalid");$(f).removeAttr("title").ligerHideTip()}}if(f.value<0){$(f).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.minus"));return}var h;if(f){h=f.id+"Text";f.tempValue=Number($("#"+h).text());if(f.id=="adjust"){var c=$(f).parents("tr");if(!f.value){c.find("#adjustText").text("0")}else{if(c.find("input[type='hidden']:eq(0)").val()=="subs"){c.find("#adjustText").text("-"+f.value)}else{c.find("#adjustText").text(f.value)}}}else{$("#"+h).text(f.value)}}if(e){}var b=0;var d=$("#payAdjust table tr").length;var a=$("#payAdjust table tr:lt("+(d-1)+")");$.each(a,function(){if(Number($(this).find("#adjust").val())>0){if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){b-=Number($(this).find("#adjust").val())}else{b+=Number($(this).find("#adjust").val())}}});if((Number(summary.currency)+b)<0){if(f.id=="adjust"){var c=$(f).parents("tr");c.find("#adjustText").text("0")}else{$("#"+h).text("0")}$(f).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.adjustbiggerthenorder"));return}else{$("#afterAdjust").text(b);summary.adjustMents=b;if(liger.get("deliveryType").getValue()!="SHIPP"){$("#actrualPayAmt").text(summary.currency- -b-summary.discountAmt)}else{$("#actrualPayAmt").text(summary.currency- -summary.shippingTier- -b-summary.discountAmt)}}return}function f_setOrderDetai(c){var d=liger.get("memberId").getText();om_oc_form.setData(c);liger.get("memberId").setText(d);liger.get("period").setText(c.period);if(c.salesOrganization){f_setMarketAndCurrency(c.salesOrganization.market,c.spmCurrency);liger.get("salesOrgId").setValue(c.salesOrganization.salesOrgId);liger.get("salesOrgId").setText(c.salesOrganization.name);$("#salesOrgCode").val(c.salesOrganization.code)}for(var b in orderStatusData){if(orderStatusData[b].value==c.orderStatus){liger.get("orderStatus").setText(orderStatusData[b].meaning);break}}for(var b in orderTypeData){if(orderTypeData[b].value==c.orderType){liger.get("orderType").setText(orderTypeData[b].meaning);break}}for(var b in channelData){if(channelData[b].value==c.channel){liger.get("channel").setText(channelData[b].meaning);break}}if(c.codFlag=="Y"){liger.get("isCod").setValue(true)}if(c.freeShipping=="Y"){liger.get("freeShipping").setValue(true)}var a={};a.rows=c.lines;linegrid.set({data:a});summary.currency=c.orderAmt;if(c.adjustMents){f_setDefaultAdjustMents(c.adjustMents)}if(c.member){if(c.member.memAccountingBalances){f_setMemberAccount(c.member.memAccountingBalances)}a.rows=c.member.memSites;liger.get("cnName").setValue(c.member.chineseName);liger.get("enName").setValue(c.member.englishName);liger.get("memberId").setValue(c.member.memberId);if(c.member.memberCode){liger.get("memberId").setText(c.member.memberCode)}if(c.member.exchangeBalance){liger.get("exchangeBalance").setValue(c.member.exchangeBalance);$("#exchangeBalance").text(c.member.exchangeBalance)}if(c.member.remainingBalance){liger.get("remainingBalance").setValue(c.member.remainingBalance);$("#remainingBalance").text(c.member.remainingBalance)}liger.get("currentPoints").setValue(c.member.salesPiont);memberStatus=c.member.status;memberType=c.member.memberType}var e=c.appliedCoupon;$("#couponsText").text(c.discountAmt);$("#couponsText").val(c.discountAmt);for(var b in e){liger.get("coupons").setValue(e[b].assignCode);liger.get("coupons").setText(e[b].name);if(e[b].applyOn=="PROD"){$("#couponsText").val("");$("#couponsText").text("");applyOn=e[b].applyOn;linegrid.set({columns:o_getLineColumns(true,false,true,false,true)});linegrid.reRender()}}f_setDelivery(c.salesSites,c.logistics);liger.get("deliveryType").setValue(c.deliveryType);for(var b in deliveryTypeData){if(deliveryTypeData[b].value==c.deliveryType){liger.get("deliveryType").setText(deliveryTypeData[b].meaning);validateDeliver();break}}f_setDefaultAddress(c.salesSites);f_calculateLinePrice(c);$("#actrualPayAmt").text(c.actrualPayAmt.toFixed(summary.precision));selectMethod=c.getEinvoiceMethod}function f_setDefaultAdjustMents(a){if(!a||!liger.get("adjustType")){return}var h=$("#payAdjust table tr:eq(0)");var b=$("#payAdjust table tr").length;var k=$("#payAdjust table tr:lt("+(b-3)+"):gt(0)");$.each(k,function(){if($(this).find("#adjustid").length>0){$(this).remove()}});var d=0;var l=liger.get("adjustType").options.data;for(var f in a){var e=new Object();e.value=Math.abs(a[f].adjustmentAmount);if("AD"==a[f].adjustmentType){d++;e.id="adjust";if(d>1){var g=h.clone();g.find("#adjustType_val").attr("id","adjustType"+d+"_val");g.find("#adjustType").attr("id","adjustType"+d);if(Number(a[f].adjustmentAmount)>0){g.find("#adjustType"+d+"_val").val("add");for(var c in l){if(l[c].value=="add"){g.find("#adjustType"+d).val(l[c].meaning);g.find("#adjustText").html(e.value);break}}}else{g.find("#adjustType"+d+"_val").val("subs");for(var c in l){if(l[c].value=="subs"){g.find("#adjustType"+d).val(l[c].meaning);g.find("#adjustText").html("-"+e.value);break}}}g.find("#adjust").val(e.value);g.find("#remarks").val(a[f].remark);g.find("#adjustid").val(a[f].salesAdjustmentId);g.find(".addArtificial").hide();g.find(".subArtificial").show();h.after(g)}else{if(Number(a[f].adjustmentAmount)>0){h.find("#adjustType_val").val("add");for(var c in l){if(l[c].value=="add"){h.find("#adjustType").val(l[c].meaning);h.find("#adjustText").html(e.value);break}}}else{h.find("#adjustType_val").val("subs");for(var c in l){if(l[c].value=="subs"){h.find("#adjustType").val(l[c].meaning);h.find("#adjustText").html("-"+e.value);break}}}h.find("#adjust").val(e.value);h.find("#remarks").val(a[f].remark);h.find("#adjustid").val(a[f].salesAdjustmentId)}f_payMentAdjust(e)}}}function f_setMarketAndCurrency(b,a){if(b){liger.get("salesMarketId").setValue(b.marketId);liger.get("salesMarketId").setText(b.name)}}function f_getPriceType(){var a;if(liger.get("orderType")){a=liger.get("orderType").getValue()}else{a="STDP"}var b;if(a=="DIRP"||a=="STFP"){b="STU"}else{if(a=="STDP"||a=="NMDP"){b="DIS"}else{if(a=="CONP"){b="RE"}else{if(a=="CONPT"){b="DIS"}else{if(a=="BIGF"){b="0"}else{b="RP"}}}}}return b}function f_getAdjustMents(){var b=new Array();if($("#extra").val()){b.push({adjustmentType:"EX",adjustmentAmount:$("#extra").val(),headerId:$("#headerId").val(),salesAdjustmentId:$("#extraid").val()})}var a=$("#payAdjust table tr:gt(1)");$.each(a,function(){if($(this).find("#adjust").val()){var c=$(this).find("#adjust").val();if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){c=-Number($(this).find("#adjust").val())}b.push({adjustmentType:"AD",adjustmentAmount:c,headerId:$("#headerId").val(),remark:$(this).find("#remarks").val(),salesAdjustmentId:$(this).find("#adjustid").val()})}});return b}function f_getLogistics(){if(!liger.get("deliveryCompany").getValue()){return null}var a=new Object();a.logisticsId=$("#logisticsId").val();a.headerId=$("#headerId").val();a.shippingTierId=liger.get("deliveryCompany").getValue();a.shippingFee=$("#shippingTier").text();a.salesOrgId=liger.get("salesOrgId").getValue();a.autoshipFlag="N";if(liger.get("isCod")&&liger.get("isCod").getValue()){a.codFlag="Y"}else{a.codFlag="N"}return a}function f_queryShippingTier(a){var b={currency:liger.get("currency").getValue()};if(liger.get("memberId").getValue()){b.countryCode=a.spmLocation.countryCode;b.cityCode=a.spmLocation.cityCode;b.stateCode=a.spmLocation.stateCode}else{b.countryCode=a.countryCode;b.cityCode=a.cityCode;b.stateCode=a.stateCode}$.post(_basePath+"/dm/shippingTierDtl/queryByLocation",b,function(h){liger.get("deliveryCompany").set({data:h.rows});var f={};f.price=Number.MAX_VALUE;for(var e in h.rows){var g=h.rows[e];for(var d in g.shippingTierDtls){var c=g.shippingTierDtls[d];if(summary.currency>c.invAmountFrom&&(!c.invAmountTo||summary.currency<=c.invAmountTo)){if(f.price>c.shippingFee){f.price=c.shippingFee;f.name=g.shippingTierName;f.value=g.shippingTierId}}}}if(f.price==Number.MAX_VALUE){f.price=0}summary.shippingTier=f.price;liger.get("deliveryCompany").setValue(f.value);liger.get("deliveryCompany").setText(f.name);$("#shippingTier").text(f.price);return h.rows})}function f_setDelivery(f,b){if(!f){return}var e={};var g=new Array();var c=new Array();for(var d in f){if(f[d].siteType=="BILL"){g.push(f[d])}else{if(f[d].siteType=="SHIP"){c.push(f[d])}}}e.rows=g;addressgrid.set({data:e});e.rows=c;deliveryaddress.set({data:e});if(b){var a=liger.get("deliveryCompany").data;$("#shippingTier").text(Number(b.shippingFee).toFixed(summary.precision));$("#logisticsId").val(b.logisticsId);summary.shippingTier=b.shippingFee;if(b.taxAmount){$("#shippingTierTax").text(Number(b.taxAmount).toFixed(summary.precision))}else{$("#shippingTierTax").parent().hide()}liger.get("deliveryCompany").setValue(b.shippingTierId);liger.get("deliveryCompany").setText(b.shippingTierName)}}function valideBefore(){var a=liger.get("orderType").getValue();if(!liger.get("orderType").getValue()||!liger.get("channel").getValue()||!liger.get("salesOrgId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.miss"));return false}if(liger.get("deliveryType").getValue()=="SHIPP"){if(!deliveryaddress.getSelectedRow()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.delivery_not_null"));return false}if(!liger.get("deliveryCompany").getValue()){$.ligerDialog.error($l("msg.error.order.deliverycompany_null"));return false}}if(liger.get("channel")=="SRVC"&&!liger.get("serviceCenterId")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.servicecenter_not_null"));return false}var c=linegrid.getData();for(var b in c){if(!c[b].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}}if(a=="DIRP"||a=="STFP"||a=="CONP"||a=="CONPT"){return true}else{if(!liger.get("memberId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.not_member"));return false}return true}}function cleanMember(){liger.get("memberId").setValue("");liger.get("memberId").setText("");liger.get("cnName").setValue("");liger.get("enName").setValue("");liger.get("exchangeBalance").setValue("");liger.get("remainingBalance").setValue("");liger.get("currentPoints").setValue("");if(liger.get("deliveryCompany")){liger.get("deliveryCompany").setValue("");liger.get("deliveryCompany").setText("");$("#shippingTier").html("")}var a={};a.rows=[];if(addressgrid){addressgrid.set({data:a})}if(deliveryaddress){deliveryaddress.set({data:a})}}function reSetLine(f,h,e){if(!linegrid){return}var k=linegrid.getData();if(f){for(var d in k){k[d].lineId="";k[d].headerId="";k[d].unitOrigPrice="";k[d].unitDiscountPrice="";k[d].unitSellingPrice="";k[d].amount="";k[d].unitRedeemPoint="";k[d].redeemPoint=""}var l={};l.rows=k;linegrid.set({data:l});f_calculateLinePrice();return}if(e){if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="PCKUP"){for(var d in k){if(!k[d].defaultInvOrgId){k[d].defaultInvOrgId=defaultInvOrg}}}else{for(var d in k){k[d].defaultInvOrgId=""}}var l={};l.rows=k;linegrid.set({data:l});return}var b=f_getPriceType();var g=liger.get("orderType");if(h){var b=f_getPriceType();var g=liger.get("orderType");for(var d in k){var a=k[d];for(var c in a.priceDetail){if(a.priceDetail[c].priceType=="PV"){if(g&&g.getValue()=="STDP"&&l.itemSalesType=="PURC"){a.pv=a.priceDetail[c].unitPrice}else{if(!g){a.pv=a.priceDetail[c].unitPrice}else{a.pv=0}}}else{if(a.priceDetail[c].priceType==b){if(b=="RP"){a.unitRedeemPoint=a.priceDetail[c].unitPrice}else{a.unitOrigPrice=a.priceDetail[c].unitPrice}}}}if(!a.pv){a.pv=0}if(!a.unitOrigPrice){a.unitOrigPrice=0}if(!a.unitDiscountPrice){a.unitDiscountPrice=0}if(!a.unitRedeemPoint){a.unitRedeemPoint=0}a.favorableSum=a.quantity*a.unitDiscountPrice;a.redeemPoint=a.unitRedeemPoint*a.quantity;a.amount=a.unitOrigPrice*a.quantity-a.favorableSum;a.PVSum=a.quantity*a.pv;a.tax=summary.taxRate*a.unitOrigPrice}f_calculateLinePrice();return}}function f_getItemPackageDetail(c,a,d){if(c.itemType!="PACKG"&&c.itemType!="VN"&&c.itemType!="VY"){return}var b=document.createElement("div");$(a).append(b);$(b).css("margin",10).ligerGrid({columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity"}],isScroll:false,showToggleColBtn:false,width:500,url:_basePath+"/inv/item/queryHierarchyForOrderDetail?lineId="+c.lineId,showTitle:false,usePager:false,onAfterShowData:d,frozen:false})}function f_changeMemberShow(a){if(a){if($(".l-group:eq(1) div").hasClass("togglebtn-down")){$(".l-group:eq(1) div").click()}$(".l-group:eq(1)").show()}else{liger.get("memberId").clear();if(!$(".l-group:eq(1) div").hasClass("togglebtn-down")){$(".l-group:eq(1) div").click()}$(".l-group:eq(1)").hide()}}function f_changeStaffShow(a){if(a){if($(".l-group:eq(2) div").hasClass("togglebtn-down")){$(".l-group:eq(2) div").click()}$(".l-group:eq(2)").show()}else{if(!$(".l-group:eq(2) div").hasClass("togglebtn-down")){$(".l-group:eq(2) div").click()}$(".l-group:eq(2)").hide()}}function f_setDefaultAddress(c){if(!c){return}for(var a in c){if(c[a].siteType=="BILL"){$("#billSiteId").val(c[a].salesSiteId);c[a].spmLocation={};c[a].spmLocation.zipCode=c[a].zipCode;c[a].defaultFlag="Y";var b={};b.rows=[];b.rows.push(c[a]);addressgrid.set({data:b})}else{if(c[a].siteType=="SHIP"){$("#deliverySiteId").val(c[a].salesSiteId);liger.get("deliveryType").setValue("SHIPP");c[a].spmLocation={};c[a].spmLocation.zipCode=c[a].zipCode;c[a].defaultFlag="Y";var b={};b.rows=[];b.rows.push(c[a]);deliveryaddress.set({data:b})}}}}function toPaymentPage(b){var a=window.top.tab.getSelectedTabItemID();window.top.f_removeTab(a);window.top.f_addTab("ORDER_CREATE",$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderpayment"),_basePath+"/om/om_order_payment.html?orderId="+b)}function initUpdatePeriod(){if(liger.get("orderStatus").getValue()!="WPAY"){return}var a=new Date().getDate();if($.inArray(a+"",bonusDate)<0){$("#periodBtn").hide();return}var b;$.getJSON(_basePath+"/om/check_order_period?orderId="+$("#headerId").val(),function(c){if(c.success){b=c.rows}});if(!b||b.length<2){$("#periodBtn").hide();return}$("#updatePeriodFrom").ligerForm({fields:[{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paydate"),name:"updatePayDate",format:"yyyy-MM-dd",width:100,options:{onChangeDate:function(c){selectPayDate(this)}},validate:{required:true},newline:false},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),name:"updatePeriod",newline:false,width:100,options:{valueFieldID:"updatePeriod",valueField:"periodId",textField:"periodName",cancelable:false,data:b},validate:{required:true}},{type:"hidden",name:"updateHeaderId"}],space:10});$("#periodBtn").ligerButton({click:function(){liger.get("updatePayDate").setValue(new Date());liger.get("updatePeriod").setValue($("#periodId").val());liger.get("updatePeriod").setText(liger.get("period").getText());$("#updateHeaderId").val($("#headerId").val());$.ligerDialog.open({target:$("#updatePeriod"),title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),width:500,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,e){if(!Hap.validateForm($("#updatePeriodFrom"))){return}$.ligerDialog.confirm($l("msg.warning.member.confirm_tip"),function(f){if(f){var d={};d.headerId=$("#updateHeaderId").val();d.periodId=liger.get("updatePeriod").getValue();d.payDate=liger.get("updatePayDate").getValue();$.ajax({url:_basePath+"/om/update_period_paydate",type:"POST",dataType:"json",data:d,success:function(g){if(g.success){liger.get("payDate").setValue(d.payDate);liger.get("period").setText(liger.get("updatePeriod").getText());$("#periodId").val(d.periodId);$.ligerDialog.success($l("sys.hand.tip.success"),function(){location.reload()});e.hide()}}})}})}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){e.hide()}}]})},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period")})}function selectPayDate(b){var f=liger.get("updatePeriod").data;var c=new Date().getTime();if(b.getValue().getTime()>c||b.getValue().getTime()<getLastMonthFirstDay()){Hap.showError($l("msg.error.payment_date_can_be_modified_to_last_months_one_to_the_current_date"));if(liger.get("payDate").getValue()){liger.get("updatePayDate").setValue(new Date(liger.get("payDate").getValue()))}else{liger.get("updatePayDate").setValue(new Date())}}var a=liger.get("updatePayDate").currentDate;var d=a.year;if(a.month<10){d+="0"+a.month}else{d+=""+a.month}var g=false;for(var e in f){if(f[e].periodName==d){g=true;liger.get("updatePeriod").setValue(f[e].periodId);liger.get("updatePeriod").setText(d);break}}if(!g){liger.get("updatePayDate").setValue(new Date(liger.get("payDate").getValue()))}}function getLastMonthFirstDay(){var a=new Date();var c=a.getFullYear();var d=a.getMonth();var b=new Date(c,d-1,1);return b}function initEinvoice(){liger.get("paperInvoice").setDisabled(true);liger.get("recordedInVehicle").setDisabled(true);liger.get("phoneCode").setDisabled(true);liger.get("phoneCodeText").set({disabled:true});liger.get("phoneCodeText").set({disabled:true});liger.get("naturalPersonCode").setDisabled(true);liger.get("naturalPersonCodeText").set({disabled:true});liger.get("donateCode").set({disabled:true});liger.get("donatedInvoice").setDisabled(true)}var printEinvoiceWin;function f_printEinvoice(a,b,c){if(b==null||b==""){b=1}if(!printEinvoiceWin){initPrintEinvoiceForm();printEinvoiceWin=$.ligerDialog.open({title:$l("msg.info.order.printinvoice"),target:$("#om_print_einvoice_form"),height:160,width:360,showClose:true,buttons:[{text:$l("msg.info.stockio.printlist"),onclick:function(e,d){var f=om_print_einvoice_form.getData();if(f.reprint==false||(f.reprint==true&&reprintValidate(a))){printEinvoice(a)}}},{text:$l("sys.hand.btn.cancel"),onclick:function(e,d){d.hide()}}]})}if(!c){om_print_einvoice_form.setData({certificate:false,reprint:false,detail:true});$.ligerui.get("certificate").set("disabled",true);$.ligerui.get("reprint").set("disabled",true);liger.get("detail").set({readonly:true})}else{if(memberType=="COMP"){om_print_einvoice_form.setData({certificate:true,reprint:false,detail:true});liger.get("certificate").set({readonly:true});liger.get("detail").set({readonly:true})}else{if(b==1){om_print_einvoice_form.setData({certificate:true,reprint:false,detail:false})}else{om_print_einvoice_form.setData({certificate:false,reprint:false,detail:true});$.ligerui.get("certificate").set("disabled",true);$.ligerui.get("reprint").set("disabled",true);liger.get("detail").set({readonly:true})}}}printEinvoiceWin.show()}function initPrintEinvoiceForm(){window.om_print_einvoice_form=$("#om_print_einvoice_form").ligerForm({fields:[{display:$l("msg.info.order.einvoice_certificate"),name:"certificate",type:"checkbox",width:30,labelWidth:90,labelAlign:"right",newline:false,options:{onClick:function(){var a=$.ligerui.get("certificate").getValue();if(a){$.ligerui.get("reprint").set("disabled",false)}else{$.ligerui.get("reprint").setValue(false);$.ligerui.get("reprint").set("disabled",true)}}}},{display:$l("msg.info.order.einvoice_reprint"),name:"reprint",type:"checkbox",width:30,labelWidth:60,labelAlign:"right",newline:false},{display:$l("msg.info.order.einvoice_detail"),name:"detail",type:"checkbox",width:30,labelWidth:90,labelAlign:"right",newline:true}]})}function reprintValidate(b){if(reprintFlag){return true}else{var a;if(!a){initReprintValidateForm();a=$.ligerDialog.open({title:$l("msg.info.order.enter_username_and_password_with_permission"),target:$("#om_reprint_validate_from"),height:160,width:360,async:false,showClose:true,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(g,f){var i=om_reprint_validate_from.getData();var d="om/om_order_detail";var e="REPRINT_INVOICE";var h=i.loginName;var c=i.password;if(Hap.validateForm(om_reprint_validate_from)){$.ajax({url:_basePath+"/om/reprint_valid?url="+d+"&accessCode="+e+"&loginName="+h+"&password="+c,type:"POST",dataType:"json",contentType:"application/json",success:function(j){if(j&&j.success){printEinvoice(b);f.hide()}}})}}},{text:$l("sys.hand.btn.cancel"),onclick:function(d,c){c.hide()}}]})}a.show()}}function initReprintValidateForm(){window.om_reprint_validate_from=$("#om_reprint_validate_from").ligerForm({fields:[{display:$l("msg.info.order.username"),name:"loginName",type:"text",width:160,align:"center",labelWidth:80,labelAlign:"right",validate:{required:true},newline:false},{display:$l("msg.info.order.password"),name:"password",type:"password",width:160,align:"center",labelWidth:80,labelAlign:"right",validate:{required:true},newline:true}]})}function printEinvoice(a){var c=om_print_einvoice_form.getData();var b;if(c.certificate==true&&c.detail==true){b="RPT-00019-2"}else{if(c.certificate==true&&c.detail==false){b="Einvoice-Certificate"}else{if(c.certificate==false&&c.detail==true){b="RPT-00019-1"}else{Hap.showError($l("msg.error.order.print_content_cannot_be_empty"))}}}if(b){window.open(_basePath+"/report/run?docType=PDF&reportProgramCode="+b+"&headerId="+a+"&reprint="+c.reprint)}};