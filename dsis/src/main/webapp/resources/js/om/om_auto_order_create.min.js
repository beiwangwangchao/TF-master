DsisOrderCreate={version:"1.0",copyOrder:function(){$("#copyModelDialog").parent().hide();clearForm("om_oc_form");clearGrid("linegrid");liger.get("copyModelDialog").trigger("buttonClick")},summary:{pv:0,tax:0,currency:0,taxRate:0.1,shippingTier:0,discountAmt:0,adjustMents:0,points:0,exchange:0},editLineIndex:0};jQuery.validator.addMethod("stringMaxLength",function(d,b,e){var c=d.length;for(var a=0;a<d.length;a++){if(d.charCodeAt(a)>127){c=c+2}}return this.optional(b)||(c<=e)},$l("sys.hand.validate.maxlength"));function f_copy(){$("#copyModelDialog").parent().hide();clearForm("om_oc_form");clearGrid("linegrid");liger.get("copyModelDialog").trigger("buttonClick")}function clearForm(a){$("#"+a+" :input").each(function(b){$(this).val("")})}function clearGrid(a){a=liger.get(a);if(a.currentData!=null&&a.currentData.rows.length>0){var b=a.currentData.rows;b.splice(0,b.length);a.reRender()}}function chargeMemberPupop(){if(userType=="IPONT"){return o_ipointMemberPupop()}else{return o_memberPupop()}}function o_memberPupop(){var a={readonly:false,cancelable:false,autocomplete:true,placeholder:$l("msg.warn.order.om_sales_order.fullmembercode"),valueField:"memberId",textField:"memberCode",grid:{delayLoad:true,isSingleCheck:true,columns:f_getMemberPupopColumns(_salesOrgType),url:_basePath+"/mm/member/queryMembersForOrder",onLoadData:function(){if(liger.get("orderType")&&liger.get("orderType").getValue()!="NMDP"){this.setParm("marketId",liger.get("marketId").getValue());if(igiMarketId){this.setParm("igiMarketId",igiMarketId)}}else{if(!liger.get("orderType")){this.setParm("marketId",liger.get("marketId").getValue())}}if(liger.get("orderType")&&liger.get("orderType").getValue()=="VIPP"){this.setParm("memberRole","VIP")}else{if(liger.get("orderType")&&liger.get("orderType").getValue()=="NMDP"){this.setParm("orderType","NMDP")}else{this.setParm("memberRole","DIS")}}this.setParm("isActive","Y")}},condition:{inputWidth:130,labelWidth:70,fields:[{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberCode",isAutoComplete:true,newline:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.membername"),name:"memberName",newline:false,isAutoComplete:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.marketchange.registercode"),name:"registerCode",isAutoComplete:false,newline:true,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"),name:"phoneNo",align:"center",newline:false,isAutoComplete:false}]},onselect:function(b){f_setMember(b.data[0])},onChangeValue:function(b){if(!b){cleanMember()}}};return a}function f_getMemberPupopColumns(h){var f={display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberCode",align:"center",isAutoComplete:true,autocompleteField:true};var d={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.membername"),name:"memberName",isAutoComplete:false,align:"center"};var c={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"),name:"phoneNo",align:"center",isAutoComplete:false};var g={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.email"),name:"email",isAutoComplete:false,align:"center"};var i={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.memberstatus"),name:"status",isAutoComplete:false,align:"center",render:function(m,j,l){for(var k=0;k<memberStatusData.length;k++){if(memberStatusData[k].value==l){return memberStatusData[k].meaning}}return l}};var b={display:$l("type.com.lkkhpg.dsis.common.member.dto.marketchange.registercode"),name:"idNumber",isAutoComplete:false,align:"center"};var e={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"englishName",isAutoComplete:false,align:"center"};var a={display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"chineseName",isAutoComplete:false,align:"center"};if(h=="INTEL"){return[f,d,c,g,i]}else{if(h=="IPONT"){return[f,b,e]}else{return[f,d,i]}}}function o_ipointMemberPupop(){var a={readonly:false,cancelable:false,autocomplete:true,placeholder:$l("msg.warn.order.om_sales_order.fullmembercode"),valueField:"memberId",textField:"memberCode",grid:{delayLoad:true,isSingleCheck:true,columns:f_getMemberPupopColumns("IPONT"),url:_basePath+"/mm/member/queryMembersForIpointOrder",onLoadData:function(){if(liger.get("orderType")&&liger.get("orderType").getValue()!="NMDP"){this.setParm("marketId",liger.get("marketId").getValue());if(igiMarketId){this.setParm("igiMarketId",igiMarketId)}}else{if(!liger.get("orderType")){this.setParm("marketId",liger.get("marketId").getValue())}}if(liger.get("orderType")&&liger.get("orderType").getValue()=="VIPP"){this.setParm("memberRole","VIP")}else{if(liger.get("orderType")&&liger.get("orderType").getValue()=="NMDP"){this.setParm("orderType","NMDP")}else{this.setParm("memberRole","DIS")}}this.setParm("isActive","Y")}},condition:{inputWidth:130,labelWidth:70,fields:[{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberCode",isAutoComplete:true,newline:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.marketchange.registercode"),name:"registerCode",isAutoComplete:false,newline:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"englishName",type:"text",newline:true,isAutoComplete:false}]},onselect:function(b){f_setMember(b.data[0])},onChangeValue:function(b){if(!b){cleanMember()}}};return a}function o_serviceCenterPupop(){var a={readonly:false,valueField:"serviceCenterId",textField:"name",autocomplete:true,cancelable:false,placeholder:"",grid:{columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.code"),name:"code",isAutoComplete:true,autocompleteField:true,type:"int"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.name"),name:"name",isAutoComplete:false,autocompleteField:false,align:"left",width:200},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.chargememberid"),name:"chargeMemberId",isAutoComplete:false,autocompleteField:false,align:"right"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.phone"),isAutoComplete:false,autocompleteField:false,name:"phone",align:"right"}],url:_basePath+"/spm/serviceCenterAndMember/query",onLoadData:function(){if(liger.get("orderType")&&liger.get("orderType").getValue()!="NMDP"){this.setParm("marketId",liger.get("marketId").getValue())}else{if(!liger.get("orderType")){this.setParm("marketId",liger.get("marketId").getValue())}}this.setParm("status","ALED")}},condition:{inputWidth:150,labelWidth:100,fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.code"),name:"code",newline:true,isAutoComplete:true,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter.name"),name:"name",newline:false,isAutoComplete:false,type:"text"}]},onselect:function(b){},validate:{required:true}};return a}function o_autoshipCreateFormOptions(){var b=true;if(marketCode=="US"){b=false}var a={fields:[{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.autoshipordernumber"),name:"autoshipNumber",newline:false,readonly:true,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderinfo")},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.autoshiporderstatus"),name:"autoshipStatus",width:150,labelWidth:120,newline:false,cancelable:false,readonly:true,render:function(d){for(var c in autoShipStatusData){if(autoShipStatusData[c].value==d){return autoShipStatusData[c].meaning}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesmarket"),name:"marketId",newline:false,readonly:true,validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesorgid"),name:"salesOrgId",newline:false,cancelable:false,readonly:false,options:{valueField:"salesOrgId",textField:"name",url:_basePath+"/sys/salesOrg/queryOrg",isShowCheckBox:false,isMultiSelect:false,onSelected:function(f,g){var e=this.selected;defaultSaleOrg=f;if(!e){return}var c=window.top.tab.getSelectedTabItemID();var d=$("#headerId").val();window.top.f_removeTab(c);window.top.f_addTab(null,$l("type.com.lkkhpg.dsis.common.order.dto.automatically.create.orders"),_basePath+"/om/om_autoship_create.html?salesOrgId="+f)}},validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.executetype"),name:"executeType",newline:true,readonly:true,options:{valueFieldID:"executeType",valueField:"value",textField:"meaning",cancelable:false,data:executeTypeData,value:executeTypeData[0].value,text:executeTypeData[0].meaning,readonly:true,render:function(d){if(!d){return}for(var c in executeTypeData){if(executeTypeData[c].value==d){return executeTypeData[c].meaning}}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.executedate"),name:"executeDate",newline:false,readonly:b,options:{valueFieldID:"executeDate",valueField:"value",textField:"meaning",cancelable:false,data:execuDate,value:execuDate[0].value,text:execuDate[0].meaning,readonly:b,render:function(d){if(!d){return}for(var c in execuDate){if(execuDate[c].value==d){return execuDate[c].meaning}}}},validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.createuserid"),name:"createUserId",textField:"createUserName",newline:false,readonly:true,validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.currency"),name:"currency",newline:false,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.last_executedate"),name:"latestExecuteDate",newline:true,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.batchnumber"),name:"latestBatchNumber",newline:false,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.last_update_member"),name:"lastUpdatedName",newline:false,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.last_update_date"),name:"lastUpdateDate",newline:false,readonly:true,validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberId",type:"popup",newline:true,options:chargeMemberPupop(),validate:{required:true},group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.memberinfo")},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"cnName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.exchangebalance"),name:"exchangeBalance",width:150,labelWidth:120,newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.shortcut_operation.currentmoneypv"),name:"currentPV",newline:false,readonly:true},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderdate"),newline:true,cancelable:false,readonly:true,format:"yyyy/dd/MM",name:"autoshipCreateDate",validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"enName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.remainingbalance"),name:"remainingBalance",width:150,labelWidth:120,newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.salesscore"),name:"currentPoints",newline:false,readonly:true},{type:"textarea",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:true,width:500,group:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remarkinfo")},{type:"hidden",name:"creditCardId",newline:false,readonly:true},{type:"hidden",name:"autoshipId",newline:false,readonly:true},{type:"hidden",name:"logisticsId"},{type:"hidden",name:"billSiteId"},{type:"hidden",name:"deliverySiteId"}]};return a}function setAutoVisible(){var a=om_oc_form.getData().autoshipStatus;if("TER"==a){om_oc_form.setVisible(["lastUpdatedName"],true);om_oc_form.setVisible(["lastUpdateDate"],true)}else{om_oc_form.setVisible(["lastUpdatedName"],false);om_oc_form.setVisible(["lastUpdateDate"],false)}}function o_itemPupop(){var a={type:"popup",cancelable:false,autocomplete:true,valueField:"itemNumber",textField:"itemNumber",grid:{isSingleCheck:true,columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",isAutoComplete:true,autocompleteField:true,align:"left",width:200},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",isAutoComplete:false,autocompleteField:true,align:"right",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.product.invitem.dto.description"),name:"description",isAutoComplete:false,autocompleteField:true,align:"right",type:"text"}],url:_basePath+"/inv/item/queryForOrder",onLoadData:function(){if(liger.get("channel")){this.setParm("isActive","Y");var b=liger.get("channel").getValue();if(b=="FAX"){this.setParm("channel","STORE")}else{if(b=="DISWB"){this.setParm("channel","WEB")}else{if(b=="DISAP"){this.setParm("channel","APP")}else{if(b=="AUTOS"){this.setParm("channel","AUTOS")}else{this.setParm("channel","STORE")}}}}}else{this.setParm("channel","AUTOS")}var c=f_getPriceType();if(c!="0"){this.setParm("priceType",c);this.setParm("currency",liger.get("currency").getValue())}if(c=="RP"){this.setParm("redeemFlag","Y")}this.setParm("salesOrgId",liger.get("salesOrgId").getValue());if(linegrid.editor.editParm.record.defaultInvOrgId){this.setParm("organizationId",linegrid.editor.editParm.record.defaultInvOrgId)}}},condition:{inputWidth:150,labelWidth:70,fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",isAutoComplete:true,newline:true,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",isAutoComplete:false,newline:false,type:"text"}]},onselect:function(f){var c=DsisOrderCreate.editLineIndex;var d=linegrid.getRow(c);if(!d){return}var b=f_setLine(d,f.data[0]);var g=this.options,e=$(g.host_grid.getRowObj(g.host_grid_row));e.next("tr.l-grid-detailpanel").remove();e.find(".l-grid-row-cell-detailbtn").removeClass("l-open");f_summaryTotal();return b},onChangeValue:function(c){if(!c){if(!linegrid.editor.editParm||!linegrid.editor.editParm.record){return}var b=linegrid.editor.editParm.record;linegrid.updateRow(b,{itemId:null,itemNumber:null,barCode:null,itemName:null,description:null,starterAid:null,starterAidField:null,countStockFlag:null,quantityCountType:null,minOrderQuantity:null,itemType:null,uomCode:null,publishStatus:null,publishStatusDesc:null,lotCtrlFlag:null,categoryId:null,invCategory:null,categoryDesc:null,categoryIdList:null,inStore:null,fax:null,agencyWeb:null,agencyApp:null,autoDeliver:null,channel:null,isActive:null,salesOrgId:null,currency:null,priceType:null,organizationId:null,priceListDetails:null,mode:null,uomName:null,quantity:null,organization:null,countItemName:null,countItemNumber:null,packageQuantity:null,savePropertyFlag:null,unitDiscountPrice:null,priceDetail:null,pv:null,unitOrigPrice:null,unitRedeemPoint:0,favorableSum:0,redeemPoint:0,PVSum:0,tax:0,unitSellingPrice:0,amount:0});f_calculateLinePrice(true)}}};return a}function o_getLineColumns(a,o,b,c){defaultItemSalesType="PURC";var m={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitsellingprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.unitOrigPrice){i.unitOrigPrice=0;return"0"}if(i.itemSalesType&&i.itemSalesType=="FREE"){i.unitOrigPrice=0;return"0"}i.tax=i.unitOrigPrice*summary.taxRate;return Number(i.unitOrigPrice).toFixed(summary.precision)}};var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.quantity){i.quantity=1}if(!i.unitOrigPrice){i.unitOrigPrice=0}if(i.itemSalesType&&i.itemSalesType=="FREE"){i.unitOrigPrice=0}return Number(i.unitOrigPrice*i.quantity).toFixed(summary.precision)}};var f={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(i){if(!i){return}for(var p in productSalesTypeData){if(i.itemSalesType==productSalesTypeData[p].value){return productSalesTypeData[p].meaning}}},validate:{required:true}};if(!c){var k=new Array();var d=new Array();var l=liger.get("orderType").getValue();switch(l){case"STDP":d.push("PURC");d.push("EXCH");d.push("FREE");defaultItemSalesType="PURC";break;case"BIGF":d.push("GIFT");defaultItemSalesType="GIFT";break;case"RDEM":d.push("REDE");defaultItemSalesType="REDE";break;default:d.push("PURC");defaultItemSalesType="PURC";break}for(var h in productSalesTypeData){if($.inArray(productSalesTypeData[h].value,d)>=0){k.push(productSalesTypeData[h])}}f.editor={type:"select",valueField:"value",textField:"meaning",cancelable:false,data:k,value:k[0].value,text:k[0].meaning,onChanged:function(r){if(l=="STDP"&&r.record.itemSalesType=="PURC"){if(r.record.pv){return}var q=r.record.priceDetail;if(!q){var s={itemId:r.record.itemId,currency:liger.get("currency").getValue(),uomCode:r.record.uomCode,salesOrgId:defaultSaleOrg};$.getJSON(_basePath+"/inv/price/queryPriceByItemId?",s,function(u){q=u.rows;r.record.priceDetail=u.rows;for(var t in q){if(q[t].priceType=="PV"){r.record.pv=q[t].unitPrice}}})}else{for(var p in q){if(q[p].priceType=="PV"){r.record.pv=q[p].unitPrice}}}}else{if(r.record.itemSalesType=="FREE"){r.record.unitOrigPrice=0}}f_setLinePrice(r.record)}}}if(o){m={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitredeempoint"),name:"unitRedeemPoint",align:"center",type:"text"};j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",align:"center",type:"text",render:function(i){if(!i||!i.itemId){return}if(!i.quantity){i.quantity=1}if(!i.unitRedeemPoint){i.unitRedeemPoint=0}return Number(i.unitRedeemPoint*i.quantity).toFixed(summary.precision)}}}var g=[f,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",align:"center",width:200,textField:"itemNumber",editor:o_itemPupop(),validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pv"),name:"pv",align:"center",type:"text",render:function(s){if(!s||!s.itemId){return}if(!s.pv){s.pv=0;return}var p="STDP";if(liger.get("orderType")){p=liger.get("orderType").getValue()}if(p=="STDP"&&s.itemSalesType=="PURC"){if(s.pv){return s.pv}var r=s.priceDetail;if(!r){var t={itemId:s.itemId,currency:liger.get("currency").getValue(),uomCode:s.uomCode,salesOrgId:defaultSaleOrg};$.getJSON(_basePath+"/inv/price/queryPriceByItemId?",t,function(v){r=v.rows;s.priceDetail=v.rows;for(var u in r){if(r[u].priceType=="PV"){s.pv=r[u].unitPrice}}})}else{for(var q in r){if(r[q].priceType=="PV"){s.pv=r[q].unitPrice}}}if(s.pv==0){return"0"}return Number(s.pv).toFixed(summary.precision)}else{s.pv=0;return"0"}}},m,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitdiscountprice"),name:"unitDiscountPrice",align:"center",type:"float",editor:{type:"select",valueField:"value",textField:"meaning"},render:function(i){if(!i||!i.itemId){return}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"int",editor:{type:"int",onChange:function(i){if(i.value>99999){i.record.quantity=99999;i.value=99999}else{if(i.value<1){i.record.quantity=1;i.value=1}}if(i.value>i.record.quantity){if(i.record.unitRedeemPoint){summary.points+=(i.record.quantity-i.value)*i.record.unitRedeemPoint}}},onChanged:function(i){f_setLinePrice(i.record)}},validate:{required:true,digits:true,min:1,max:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountprice"),name:"favorableSum",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.favorableSum||i.favorableSum==0){return"0"}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pvsum"),name:"PVSum",align:"center",type:"text",render:function(i){if(!i||!i.itemId){return}if(!i.pv){i.pv=0;return}if(!i.quantity){i.quantity=1}i.PVSum=i.pv*i.quantity;if(!i.PVSum||i.PVSum==0){return"0"}return Number(i.PVSum).toFixed(summary.precision)}},j];if(a){var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"tax",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(i.disableTaxFlag=="Y"){if(marketCode=="CA"&&i.itemNumber=="15160502"){i.tax=i.unitOrigPrice*0.07}else{i.tax=i.unitOrigPrice*summary.taxRate}}else{i.tax=0}return Number(i.tax).toFixed(summary.precision)}};g.splice(5,0,e)}if(!c){var n={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:200,type:"text",render:function(q){if(!q){return}for(var p in invOrgs){if(q.defaultInvOrgId==invOrgs[p].invOrgId){return invOrgs[p].name}}}};if(b){n.editor={type:"select",valueField:"invOrgId",textField:"name",cancelable:false,staticOptions:function(i){i.column.editor.data=invOrgs}};n.validate={required:true}}g.unshift(n)}return g}function o_ligerGridOptions(b,d){var c=_basePath+"/om/order/line/remove";if(b){c=_basePath+"/om/autoship/deleteLine"}var a={columns:o_getCreateLineColumns(b,false,true,d),detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},enabledEdit:true,usePager:false,frozen:false,width:"98%",checkbox:true,onAfterEdit:function(f){if(f.column.columnname=="itemSalesType"){if(f.record.itemNumber!=undefined&&f.record.itemNumber!=""){f_setLine(linegrid.getRow(f.rowindex),linegrid.getRow(f.rowindex))}}},onBeforeEdit:function(f){DsisOrderCreate.editLineIndex=f.rowindex;if(f.column.columnname=="calPvFlag"){if(f.record.calPvFlag=="N"){liger.get("linegrid").updateCell("pv","0",f.record)}}if(f.record.freeFlag=="Y"){liger.get("linegrid").updateCell("unitOrigPrice","0",f.record);liger.get("linegrid").updateCell("pv","0",f.record)}},toolbar:{items:[{text:$l("sys.hand.btn.new"),disable:addLineBtnDisabled,id:"addLineBtn",click:function(){addLine(b)},icon:"add"},{line:true},{text:$l("sys.hand.btn.delete"),disable:addLineBtnDisabled,id:"deleteLineBtn",click:function(){deleteLineData(c)},icon:"delete"}]}};return a}function deleteLineData(b){var a=linegrid.getSelectedRows();if(a==null||a==undefined||a.length<1){Hap.showError($l("msg.error.config.country.selectrecord"))}else{$.ligerDialog.confirm($l("msg.alert.pub.delete_or_not"),function(c){if(c){$.ajax({url:b,data:JSON2.stringify(a),type:"post",dataType:"json",contentType:"application/json",success:function(d){if(d.success==true){linegrid.deleteRange(a);f_calculateLinePrice(true)}else{f_calculateLinePrice(true)}},error:function(){f_calculateLinePrice(true)}})}})}}function o_addressGridOptions(c){var a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivegoodsname");if(c){a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivebillsname")}var b={unSetValidateAttr:false,usePager:false,checkbox:true,isSingleCheck:true,enabledEdit:false,width:"98%",columns:[{display:a,name:"name",type:"text",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.phone"),name:"phone",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.address"),name:"address",align:"center",width:400,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.spmlocation.zipcode"),name:"spmLocation.zipCode",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.defaultflag"),name:"defaultFlag",align:"center",type:"text",render:function(f,d,e){if(!e||e=="N"){return""}else{return e}}},{display:$l("sys.hand.btn.action"),name:"UnitsInStock3",align:"center",type:"text",render:function(g,d,f){var e="";e+="<a href='javascript:beginEdit("+c+","+d+")'>"+$l("sys.hand.btn.edit")+"</a> ";e+="<a href='javascript:deleteRow("+c+","+d+")'>"+$l("sys.hand.btn.delete")+"</a> ";return e}}],isChecked:function(d){if(d.select){if(((d.siteUseCode&&d.siteUseCode=="BILL")||(d.siteType&&d.siteType=="BILL"))&&$("#billSiteId").val()){return true}else{if(((d.siteUseCode&&d.siteUseCode=="SHIP")||(d.siteType&&d.siteType=="SHIP"))&&$("#deliverySiteId").val()){return true}}return false}else{if(d.defaultFlag&&d.defaultFlag=="Y"){if(((d.siteUseCode&&d.siteUseCode=="BILL")||(d.siteType&&d.siteType=="BILL"))&&!$("#billSiteId").val()){return true}else{if(((d.siteUseCode&&d.siteUseCode=="SHIP")||(d.siteType&&d.siteType=="SHIP"))&&!$("#deliverySiteId").val()){return true}}return false}}return false}};if(c){b.toolbar={items:[{text:$l("sys.hand.btn.new"),disable:addLineBtnDisabled,id:"addLineBtn",click:function(){if(liger.get("memberId").getValue()){om_location_edit(_basePath,{},function(e){f_addAddressWithMember(e,c,addressgrid)},liger.get("salesOrgId").getValue())}else{om_location_edit(_basePath,{},function(e){f_addAddressWithoutMember(e,c,addressgrid)},liger.get("salesOrgId").getValue())}},icon:"add"},{line:true}]}}else{b.toolbar={items:[{text:$l("sys.hand.btn.new"),disable:addLineBtnDisabled,id:"addLineBtn",click:function(){if(liger.get("memberId").getValue()){om_location_edit(_basePath,{},function(e){f_addAddressWithMember(e,c,deliveryaddress)},liger.get("salesOrgId").getValue())}else{om_location_edit(_basePath,{},function(e){f_addAddressWithoutMember(e,c,deliveryaddress)},liger.get("salesOrgId").getValue())}},icon:"add"},{line:true}]};b.onSelectRow=f_queryShippingTier}return b}function f_addAddressWithoutMember(b,f,e){var d=_basePath+"/om/sites/submit";var a="SHIP";if(f){a="BILL"}var c={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:a,name:b.memberName,phone:b.phoneNumber,cityCode:b.cityCode,stateCode:b.stateCode,countryCode:b.countryCode,address:b.address,areaCode:b.areaCode,zipCode:b.zipCode,autoshipFlag:"N",address1:b.addressLine1,address2:b.addressLine2,address3:b.addressLine3};if(f){c.salesSiteId=$("#billSiteId").val()}else{c.salesSiteId=$("#deliverySiteId").val()}Hap.ajax({url:d,data:c,success:function(h){var g=h.rows[0];g.spmLocation={};g.spmLocation.zipCode=h.rows[0].zipCode;g.defaultFlag="Y";e.addRow(g);e.select(g);if(f){$("#billSiteId").val(g.salesSiteId)}else{$("#deliverySiteId").val(g.salesSiteId)}}})}function f_addAddressWithMember(b,g,d){var c=_basePath+"/mm/memsite/save";var e="N";if(b.save){e="Y"}var a="SHIP";if(g){a="BILL"}var f=[{memberId:liger.get("memberId").getValue(),siteUseCode:a,name:b.memberName,phone:b.phoneNumber,defaultFlag:e,address:b.address,areaCode:b.areaCode,spmLocation:{countryCode:b.countryCode,countryName:b.countryName,stateName:b.stateName,stateCode:b.stateCode,cityCode:b.cityCode,cityName:b.cityName,addressLine1:b.addressLine1,addressLine2:b.addressLine2,addressLine3:b.addressLine3,zipCode:b.zipCode}}];Hap.ajax({url:c,data:f,success:function(k){if(k.rows[0].defaultFlag=="Y"){var j=d.records;for(var h in j){if(j[h].defaultFlag=="Y"){j[h].defaultFlag="N";d.updateRow(j[h]);break}}}d.addRow(k.rows[0]);d.reRender()}})}function f_editAddressWithMember(e,a){var d;if(e){d=addressgrid.getRow(a)}else{d=deliveryaddress.getRow(a)}var c;if(d.defaultFlag&&d.defaultFlag=="Y"){c=true}else{c=false}var b={memberId:d.memberId,memberName:d.name,phoneNumber:d.phone,countryCode:d.spmLocation.countryCode,stateCode:d.spmLocation.stateCode,cityCode:d.spmLocation.cityCode,addressLine1:d.spmLocation.addressLine1,addressLine2:d.spmLocation.addressLine2,addressLine3:d.spmLocation.addressLine3,zipCode:d.spmLocation.zipCode,save:c,address:d.address,areaCode:d.areaCode};om_location_edit(_basePath,b,function(h){var g="N";if(h.save){g="Y"}var f=_basePath+"/mm/memsite/save";if(!d.memberId){d.memberId=liger.get("memberId").getValue()}d.name=h.memberName;d.phone=h.phoneNumber;d.defaultFlag=g;d.address=h.address;d.spmLocation.countryCode=h.countryCode;d.spmLocation.countryName=h.countryName;d.spmLocation.stateName=h.stateName;d.spmLocation.stateCode=h.stateCode;d.spmLocation.cityCode=h.cityCode;d.spmLocation.cityName=h.cityName;d.spmLocation.addressLine1=h.addressLine1;d.spmLocation.addressLine2=h.addressLine2;d.spmLocation.addressLine3=h.addressLine3;d.spmLocation.zipCode=h.zipCode;d.areaCode=h.areaCode;if(e){d.siteUseCode="BILL"}else{d.siteUseCode="SHIP"}var i=[d];$.ajax({url:f,type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(i),success:function(k){k.rows[0].__index=d.__index;k.rows[0].__id=d.__id;k.rows[0].__nextid=d.__nextid;k.rows[0].__previd=d.__previd;if(e){if(k.rows[0].defaultFlag=="Y"){var l=addressgrid.rows;for(var j in l){if(l[j].defaultFlag=="Y"&&j!=a){l[j].defaultFlag="N";addressgrid.updateRow(l[j])}}}addressgrid.updateRow(k.rows[0].__id,k.rows[0]);addressgrid.reRender()}else{if(k.rows[0].defaultFlag=="Y"){var l=deliveryaddress.rows;for(var j in l){if(l[j].defaultFlag=="Y"&&j!=a){l[j].defaultFlag="N";deliveryaddress.updateRow(l[j])}}}deliveryaddress.updateRow(k.rows[0].__id,k.rows[0]);deliveryaddress.reRender()}},error:function(){$.ligerDialog.closeWaitting()}})},liger.get("salesOrgId").getValue())}function f_editAddressWithOutMember(e,a){var d;if(e){d=addressgrid.getRow(a)}else{d=deliveryaddress.getRow(a)}var c=true;var b={memberName:d.name,phoneNumber:d.phone,countryCode:d.countryCode,stateCode:d.stateCode,cityCode:d.cityCode,zipCode:d.zipCode,save:c,addressLine1:d.address1,addressLine2:d.address2,addressLine3:d.address3,address:d.address,areaCode:d.areaCode};om_location_edit(_basePath,b,function(g){var j="Y";var i=_basePath+"/om/sites/submit";var f="SHIP";if(e){f="BILL"}var h={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:f,salesSiteId:d.salesSiteId,name:g.memberName,phone:g.phoneNumber,cityCode:g.cityCode,stateCode:g.stateCode,countryCode:g.countryCode,address:g.address,areaCode:g.areaCode,zipCode:g.zipCode,address1:g.addressLine1,address2:g.addressLine2,address3:g.addressLine3};if($("#autoshipId")){h.autoshipFlag="Y"}else{h.autoshipFlag="N"}$.ajax({url:i,type:"POST",dataType:"json",async:false,contentType:"application/json",data:JSON2.stringify(h),success:function(k){k.rows[0].__index=d.__index;k.rows[0].__id=d.__id;k.rows[0].__nextid=d.__nextid;k.rows[0].__previd=d.__previd;k.rows[0].spmLocation={};k.rows[0].spmLocation.zipCode=k.rows[0].zipCode;k.rows[0].defaultFlag="Y";if(e){addressgrid.updateRow(k.rows[0].__id,k.rows[0]);addressgrid.reRender()}else{deliveryaddress.updateRow(k.rows[0].__id,k.rows[0]);deliveryaddress.reRender()}},error:function(){$.ligerDialog.closeWaitting()}})},liger.get("salesOrgId").getValue())}function beginEdit(c,a){var b;if(c){b=addressgrid.getRow(a)}else{b=deliveryaddress.getRow(a)}if(liger.get("memberId").getValue()&&b.memberId){f_editAddressWithMember(c,a)}else{f_editAddressWithOutMember(c,a)}}function deleteRow(b,a){$.ligerDialog.confirm($l("sys.hand.tip.delete_confirm"),$l("sys.hand.tip.info"),function(f){if(f){var c=_basePath+"/mm/memsite/delete";if(!liger.get("memberId").getValue()){c=_basePath+"/om/sites/delete";var e;if(b){e=addressgrid.getRow(a).salesSiteId}else{e=deliveryaddress.getRow(a).salesSiteId}c=c+"?siteId="+e}else{var d;if(b){d=addressgrid.getRow(a).siteId}else{d=deliveryaddress.getRow(a).siteId}c=c+"?memSiteId="+d}Hap.ajax({url:c,success:function(g){if(g.success){if(b){addressgrid.remove(addressgrid.getRow(a))}else{deliveryaddress.remove(deliveryaddress.getRow(a))}}}})}})}function addLine(b){var a={itemSalesType:"PURC",calPvFlag:calPvFlag};if(!b){a.defaultInvOrgId=defaultInvOrg}linegrid.addRow(a)}function addRows(b,a){if(!a){lineNumer=1}for(var c=0;c<a;c++){addLine(b)}}function validatePeriod(){var c=new Date();var g=c.getMonth()+1;var d=c.getFullYear();var h=liger.get("period");var b="";var f="";if(g==1){b=d+"01";f=(d-1)+"12"}else{if(g<10){b=d+"0"+g;f=d+"0"+g-1}else{if(g==10){b=d+"10";f=d+"09"}else{b=d.toString()+g;f=d.toString()+(g-1)}}}h.setData([{meaning:b,value:b},{meaning:f,value:f}]);h.setValue(b);var h=liger.get("period");var e=liger.get("orderStatus").getValue();switch(e){case"SAV":case"WPAY":case"FAIL":case"COMP":break;default:h.set({readonly:true});return}var a=c.getDate();if(a>3){h.set({readonly:true});return}h.set({readonly:true})}function validateDeliver(b){var c=liger.get("deliveryType");type=c.getValue();var a=false;if(liger.get("orderType")&&liger.get("orderType").getValue()=="RDEM"){a=true}if(type=="PCKUP"){$("#addressPanel").hide();pickUpChange()}else{if(type=="SHIPP"){$("#addressPanel").show();if(deliveryaddress){deliveryaddress.reRender()}f_queryShippingTier(deliveryaddress.getSelectedRow());f_summaryItem();f_summaryTotal()}}}function validate(a){if(!a){validatePeriod()}else{for(var b in autoShipStatusData){if(autoShipStatusData[b].value=="NEW"){liger.get("autoshipStatus").setText(autoShipStatusData[b].meaning);break}}}if(liger.get("deliveryType")){validateDeliver(a)}}function init(a){initButton(a);$("#deliveryType").ligerComboBox({css:"l-text-required",data:deliveryTypeData,valueField:"value",textField:"meaning",cancelable:false,focusWhenSetValue:false,readonly:false,onChangeValue:function(e){validateDeliver(true)},validate:{required:true},render:function(f){if(!f){return}for(var e in deliveryTypeData){if(deliveryTypeData[e].value==f){return deliveryTypeData[e].meaning}}}});var d="SHIPP";if(!a){d="PCKUP"}for(var b in deliveryTypeData){if(deliveryTypeData[b].value==d){liger.get("deliveryType").setValue(d);liger.get("deliveryType").setText(deliveryTypeData[b].meaning);break}}$("#deliveryCompany").ligerComboBox({css:"combobox",valueField:"shippingTierId",textField:"shippingTierName",cancelable:false,focusWhenSetValue:false,onSelected:function(o,p,k){if(k){var m=Number.MAX_VALUE;if(k.feeCalcluateType=="WEG"){var g=0;var h=linegrid.rows;for(var l=0;l<h.length;l++){g=g+h[l].weight*h[l].quantity}for(var l in k.shippingTierWeights){if(g>=k.shippingTierWeights[l].weightFrom&&(!k.shippingTierWeights[l].weightTo||g<k.shippingTierWeights[l].weightTo)){summary.shippingTier=k.shippingTierWeights[l].afterTaxShippingFee;summary.shippingTierTax=k.shippingTierWeights[l].taxShippingFee;$("#shippingTier").text(summary.shippingTier);$("#shippingTierTax").text(summary.shippingTierTax);if(k.shipIncludeTax=="NO"){$("#shippingTierTax").parent().hide()}else{$("#shippingTierTax").parent().show()}}}f_summaryTotal()}else{var n;if(k.privilegeFlag=="Y"){if(k.calculationType=="AFTAX"){n=$("#beforeTax").text()-summary.discountAmt}else{n=$("#afterTax").text()-summary.discountAmt}}else{if(k.calculationType=="AFTAX"){n=$("#beforeTax").text()}else{n=$("#afterTax").text()}}for(var l in k.shippingTierDtls){if(k.shippingTierDtls[l].afterTaxShippingFee<m&&n>=k.shippingTierDtls[l].invAmountFrom&&(!k.shippingTierDtls[l].invAmountTo||n<k.shippingTierDtls[l].invAmountTo)){summary.shippingTier=k.shippingTierDtls[l].afterTaxShippingFee;summary.shippingTierTax=k.shippingTierDtls[l].taxShippingFee;$("#shippingTier").text(summary.shippingTier);$("#shippingTierTax").text(summary.shippingTierTax);if(k.shipIncludeTax=="NO"){$("#shippingTierTax").parent().hide()}else{$("#shippingTierTax").parent().show()}}}f_summaryTotal()}if(!validateZipCode()){if(taxRateList){for(var l in taxRateList){taxRateList[l].taxRate=0}}f_calculateLinePrice(false);var f=0;var e;var j=k.shippingTierId;for(var l in shippingTierList){if(j==shippingTierList[l].shippingTierId){e=shippingTierList[l].shipIncludeTax}}if(e=="AFTER"){f=$("#shippingTier").text()}else{if(e=="PRE"){f=$("#shippingTier").text()-$("#shippingTierTax").text()}else{f=$("#shippingTier").text()}}$("#shippingTier").text(f);$("#shippingTierTax").text(0);if(e!="NO"){$("#shippingTierTax").parent().hide()}}}}});$("#creditCardId").ligerComboBox({css:"combobox",valueField:"cardId",textField:"bankCode",cancelable:false,focusWhenSetValue:false,onSelected:function(g,h,f){if(f){for(var e=0;e<creditCardType.length;e++){if(creditCardType[e].value==f.cardSubType){$("#bankType").text(creditCardType[e].meaning)}}}}});if(!a){$("#payAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.adjustment"),width:"98%",height:"auto"});liger.get("payAdjust").collapse();$("#coupons").ligerComboBox({css:"combobox",valueField:"value",textField:"meaning",cancelable:false});$("#adjustType").ligerComboBox({width:120,data:adjustTypeData,valueField:"value",textField:"meaning",cancelable:false});liger.get("serviceCenterId").set({readonly:true});liger.get("adjustType").setValue("add");for(var b in adjustTypeData){if(adjustTypeData[b].value=="add"){liger.get("adjustType").setText(adjustTypeData[b].meaning)}}if(liger.get("orderStatus").getValue()!="COMP"){var c=new Array();c.push("sourceKey");c.push("batchNumber");om_oc_form.setVisible(c,false)}}validate(a)}function toPaymentPage(b){var a=window.top.tab.getSelectedTabItemID();window.top.f_removeTab(a);window.top.f_addTab("ORDER_CREATE",$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderpayment"),_basePath+"/om/om_order_payment.html?orderId="+b)}function f_sumbitAutoShip(){if(!validateAutoship()){return}var d=om_oc_form.getData();var g=deliveryaddress.getSelectedRow();if(d.autoshipStatus=="NEW"){d.autoshipStatus=="ACV"}var b=linegrid.getData();d.lines=b;d.deliveryType=liger.get("deliveryType").getValue();d.orderAmt=$("#afterTax").text();d.discountAmt=summary.discountAmt;d.taxAmt=$("#tax").text();d.actrualPayAmt=$("#actrualPayAmt").text();d.roundingAdj=$("#roundingAmt").text();d.logistics=f_getLogistics();d.salesScore=$("#getsalespoint").text();d.salesSites=getOrderSites();d.member=null;d.spmSalesOrganization=null;d.creditCardId=liger.get("creditCardId").getValue();if(summary.enableTax){d.itemRateList=taxRateList}var c=liger.get("deliveryCompany").getValue();for(var e in shippingTierList){if(c==shippingTierList[e].shippingTierId){d.shippingTier=shippingTierList[e]}}if($("#donatedInvoice").ligerRadio().getValue()){d.getEinvoiceMethod="3"}else{if($("#recordedInVehicle").ligerRadio().getValue()){d.getEinvoiceMethod="2"}else{d.getEinvoiceMethod="1"}}d.einvoiceCarrier=f_getEinvoiceCarrier(d);if(!validateZipCode()){if(taxRateList){for(var e in taxRateList){taxRateList[e].taxRate=0}}f_calculateLinePrice(false);var a=0;var f=d.shippingTier.shipIncludeTax;if(f=="AFTER"){a=$("#shippingTier").text()}else{if(f=="PRE"){a=$("#shippingTier").text()-$("#shippingTierTax").text()}else{a=$("#shippingTier").text()}}$("#shippingTier").text(a.toFixed(summary.precision));$("#shippingTierTax").text(0);$("#shippingTierTax").parent().hide()}else{$.ajax({type:"POST",async:false,url:_basePath+"/om/autoship/submit",data:JSON2.stringify(d),success:function(h){if(h.success){var i=h.rows[0];f_setAutoShipDetail(i);Hap.showSuccess();initButton(true)}else{$.ligerDialog.error(h.message)}},contentType:"application/json; charset=utf-8"})}}function initButton(a){if(!a){$("#pickItem").hide();$("#saveBtn").hide();$("#submitBtn").hide();$("#deliveryPackage").hide();$("#cancle").hide();$("#invalid").hide();$("#printInvoice").hide();$("#copyBtn").hide();var b=liger.get("orderStatus").getValue();if(b=="WPAY"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_sumbitSales()},text:$l("sys.hand.btn.submit")});$("#cancle").ligerButton({click:function(){$.ligerDialog.confirm($l("msg.warn.iscancel"),function(d){if(d){var c={orderStatus:"CANCL",headerId:$("#headerId").val()};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(c),success:function(f){if(f.success){liger.get("orderStatus").setValue("CANCL");for(var e in orderStatusData){if(orderStatusData[e].value=="CANCL"){liger.get("orderStatus").setText(orderStatusData[e].meaning);break}}var g=top.tab.getSelectedTabItemID();top.f_addTab("ORDER_DETAIL",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderDetail.headerId);top.tab.removeTabItem(g)}},contentType:"application/json; charset=utf-8"})}})},text:$l("sys.hand.btn.cancel")});$("#saveBtn").show();$("#cancle").show();$("#submitBtn").show()}else{if(b=="NEW"||b=="FAIL"||b=="SAV"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_sumbitSales()},text:$l("sys.hand.btn.submit")});$("#saveBtn").show();$("#submitBtn").show()}else{if(b=="COMP"){$("#pickItem").ligerButton({click:function(){window.top.f_addTab(null,$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverypickrelease"),_basePath+"/dm/dm_delivery_pick_release.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverypick")});$("#deliveryPackage").ligerButton({click:function(){window.top.f_addTab(null,$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.delivery_query"),_basePath+"/dm/dm_delivery_query.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.delivery")});$("#printInvoice").ligerButton({click:function(){alert($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.printinvoice"))},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.printinvoice")});$("#printInvoice").show();$("#deliveryPackage").show();$("#pickItem").show();$("#invalid").ligerButton({click:getMarket,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invalid")});$("#invalid").show()}else{if(b=="CONF"){$("#invalid").ligerButton({click:getMarket,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invalid")});$("#invalid").show()}}}}if(b=="WPAY"||b=="SAV"||b=="NEW"){$("#copyBtn").show()}$("#copyBtn").ligerButton({click:DsisOrderCreate.copyOrder,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.copytemplate")})}else{$("#activeBtn").ligerButton({click:function(){f_updateAutoShipStatus("ACV");autoshipActive()},text:$l("msg.warning.order.active")});$("#stopBtn").ligerButton({click:function(){f_updateAutoShipStatus("SUS");autoshipReadOnly()},text:$l("msg.hand.btn.pause")});$("#endBtn").ligerButton({click:function(){f_updateAutoShipStatus("TER");autoshipReadOnly()},text:$l("type.com.lkkhpg.dsis.common.member.btn.memberdetails.terminate")});$("#endBtn").hide();$("#stopBtn").hide();$("#activeBtn").hide();$("#autoShipsaveBtn").hide();if(liger.get("autoshipStatus").getValue()=="ACV"){$("#endBtn").show();$("#stopBtn").show();$("#autoShipsaveBtn").show();autoshipActive()}else{if(liger.get("autoshipStatus").getValue()=="NEW"){$("#autoShipsaveBtn").show()}else{if(liger.get("autoshipStatus").getValue()=="SUS"){$("#endBtn").show();$("#activeBtn").show()}}}$("#autoShipsaveBtn").ligerButton({text:$l("sys.hand.btn.submit"),click:f_sumbitAutoShip});$("#addCreditCar").ligerButton({click:function(){$.ligerDialog.open({target:$("#addCredit"),title:$l("msg.com.lkkhpg.dsis.common.order.addcredit"),width:500,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,e){if(!addCreditFrom.valid()){return}$.ajax({type:"POST",url:_basePath+"/om/creditCard/submit",data:addCreditFrom.getData(),success:function(d){var f=d.rows[0];$("#creditCardId").val(f.creditCardId);$("#cardNo").text(f.maskedCreditCardNum);$("#creditCardId").text(liger.get("bankCode").getText());$("input").ligerHideTip();e.hide()}})}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){$("input").ligerHideTip();e.hide()}}]})},text:$l("sys.hand.btn.new")})}if(enableEinvoice=="Y"){selectEinvoiceMethod(getEinvoiceMethod)}else{$("#getEinvoiceMethod").hide()}}function f_setMember(a){cleanMember();if(!a){return}memberStatus=a.status;memberRole=a.memberRole;f_valiItemMemberRole(memberRole,true,false,null);memberType=a.memberType;if(enableEinvoice=="Y"){selectEinvoiceMethod(getEinvoiceMethod)}if(memberStatus=="NEW"&&memberRole=="DIS"&&ordertype!="autoship"){$.ligerDialog.warn($l("msg.info.order.is_new_member"))}if(a.warningMsg){$.ligerDialog.warn(a.warningMsg)}if(ordertype!="autoship"){$.ajax({type:"POST",url:_basePath+"/mm/member/isMemberBirthdayMonth?memberId="+a.memberId,success:function(b){if(b&&b.rows){if(b.rows[0].brithday){$.ligerDialog.warn($l("msg.info.om.member_birthday_month"))}if(b.rows[0].brithdayOrder&&liger.get("orderType").getValue()=="BIGF"){$.ligerDialog.warn($l("msg.info.om.member_had_bgit_order"))}}}})}liger.get("cnName").setValue("");liger.get("enName").setValue("");liger.get("currentPoints").setValue("");liger.get("currentPV").setValue("");liger.get("exchangeBalance").setValue("");$("#exchangeBalance").text("0");liger.get("remainingBalance").setValue("");$("#remainingBalance").text("0");liger.get("cnName").setValue(a.chineseName);liger.get("enName").setValue(a.englishName);$("#memberRole").val(memberRole);if(a.exchangeBalance){liger.get("exchangeBalance").setValue(a.exchangeBalance);$("#exchangeBalance").text(a.exchangeBalance)}if(a.remainingBalance){liger.get("remainingBalance").setValue(a.remainingBalance);$("#remainingBalance").text(a.remainingBalance)}liger.get("currentPoints").setValue(a.salesPiont);liger.get("currentPV").setValue(a.currentPv);if(ordertype=="autoship"){$.ajax({type:"POST",url:_basePath+"/mm/card/autoquery?memberId="+a.memberId,success:function(d){liger.get("creditCardId").set("data",d.rows);for(var c=0;c<d.rows.length;c++){if(d.rows[c]&&d.rows[c].defaultFlag=="Y"){liger.get("creditCardId").setValue(d.rows[c].cardId);liger.get("creditCardId").setText(d.rows[c].bankCode);for(var b=0;b<creditCardType.length;b++){if(creditCardType[b].value==d.rows[c].cardSubType){$("#bankType").text(creditCardType[b].meaning)}}}}}});$.ajax({type:"POST",url:_basePath+"/om/autoship/checkByMemberId?memberId="+a.memberId,success:function(c){if(c.success){if(!c.rows||c.total==0){f_memberAddress(a.memberId);var e={};e.rows=[];linegrid.set({data:e});$("#creditCardId").val("");$("#autoshipId").val("");$("#logisticsId").val("");$("#creditCardId").text("");$("#cardNo").text("");liger.get("autoshipNumber").setValue("");liger.get("autoshipStatus").setValue("NEW");for(var b in autoShipStatusData){if(autoShipStatusData[b].value=="NEW"){liger.get("autoshipStatus").setText(autoShipStatusData[b].meaning);break}}f_calculateLinePrice(true);$("#getsalespoint").text(0);$("#shippingTier").text(0);$("#actrualPayAmt").text(0);$("#roundingAmt").text(0);$("#summaryPV").text(0);addLine(true)}else{var d={autoshipId:c.rows[0].autoshipId,salesOrgId:liger.get("salesOrgId").getValue()};$.getJSON(_basePath+"/om/autoship/detail",d,function(f){f_setAutoShipDetail(f.rows[0]);initButton(true)})}}}})}else{if(liger.get("deliveryType")){f_memberAddress(a.memberId)}}}function f_setLine(e,i){if(!e||!i){return}var f=liger.get("memberId").getValue();if(memberRole&&f){if(!f_valiItemMemberRole(memberRole,false,true,i)){return false}}var j=i;j.__id=e.__id;j.__previd=e.__previd;j.__index=e.__index;j.__nextid=e.__nextid;j.quantity=1;j.defaultInvOrgId=e.defaultInvOrgId;j.itemSalesType=e.itemSalesType;j.unitDiscountPrice=0;j.uomCode=i.uomCode;j.itemId=i.itemId;j.itemTaxType=i.itemTaxType;j.weight=i.weight;var d;var a;if(liger.get("deliveryType").getValue()=="PCKUP"){pickUpChange(e.itemSalesType)}else{if(liger.get("deliveryType").getValue()=="SHIPP"){queryItemTaxRate(true,e.itemSalesType)}}var c=priceStandard.priceType;var b=priceStandard.salesType[0].taxPrice;var h=liger.get("orderType");var g=0;$.ajax({type:"POST",async:false,url:_basePath+"/inv/price/queryPriceByItemId?itemId="+i.itemId+"&currency="+liger.get("currency").getValue()+"&uomCode="+i.uomCode+"&salesOrgId="+defaultSaleOrg,success:function(l){if(l.success){$.ajax({url:_basePath+"/om/autoship/selectBySalesOrgId?salesOrgId="+defaultSaleOrg+"&salesType="+e.itemSalesType,async:false,success:function(p){d=p.rows[0].calPvFlag;a=p.rows[0].freeFlag}});j.priceDetail=l.rows;var n=l.rows[0].disableTaxFlag;for(var k in l.rows){if(l.rows[k].priceType=="PV"){if(h&&(h.getValue()=="STDP"||h.getValue()=="VIPP")&&(j.itemSalesType=="PURC"||j.itemSalesType=="PUSU")){j.pv=l.rows[k].unitPrice}else{if(!h){j.pv=l.rows[k].unitPrice}else{j.pv=0}}if(d=="N"||a=="Y"){j.pv=0}}else{if(l.rows[k].priceType==c){if(c=="RP"){summary.points+l.rows[k].unitPrice;j.unitRedeemPoint=l.rows[k].unitPrice}else{j.unitOrigPrice=l.rows[k].unitPrice}if(a=="Y"){j.unitOrigPrice=0}}}if(l.rows[k].priceType==b){g=l.rows[k].unitPrice;j.unitTaxPrice=g;if(a=="Y"){j.unitTaxPrice=0}}}if(!j.pv){j.pv=0}if(!j.unitOrigPrice){j.unitOrigPrice=0}if(!j.unitDiscountPrice){j.unitDiscountPrice=0}if(!j.unitRedeemPoint){j.unitRedeemPoint=0}j.favorableSum=j.quantity*j.unitDiscountPrice;j.redeemPoint=j.unitRedeemPoint*j.quantity;j.PVSum=j.quantity*j.pv;j.disableTaxFlag=n;var o=0;j.taxAmt=0;if(summary.enableTax){for(var k in taxRateList){if(taxRateList[k].taxType==i.itemTaxType){o=o+taxRateList[k].taxRate/100}}var m;if(summary.priceIncludeTax){m=Number(g/(1+o)).toFixed(2)}else{m=g}for(var k in taxRateList){if(taxRateList[k].taxType==i.itemTaxType){j.taxAmt+=Number(Number(m*taxRateList[k].taxRate/100).toFixed(summary.precision))}}}j.taxAmt=Number(j.taxAmt.toFixed(summary.precision));if(summary.enableTax&&!summary.priceIncludeTax){j.unitSellingPrice=(Number(j.unitOrigPrice)+Number(j.taxAmt)-Number(j.unitDiscountPrice)).toFixed(summary.precision)}else{j.unitSellingPrice=(Number(j.unitOrigPrice)-Number(j.unitDiscountPrice)).toFixed(summary.precision)}j.amount=j.unitSellingPrice*j.quantity;linegrid.updateRow(e,j);f_calculateLinePrice(false);f_queryAndCalShipping(deliveryaddress.getSelectedRow());return j}}})}function f_getPriceType(){var a;if(liger.get("orderType")){a=liger.get("orderType").getValue()}else{a="STDP"}var b;if(a=="DIRP"||a=="STFP"){b="STU"}else{if(a=="STDP"){b="DIS"}else{if(a=="NMDP"){if($("#memberRole").val()&&$("#memberRole").val()=="VIP"){b="VIP"}else{b="DIS"}}else{if(a=="VIPP"){b="VIP"}else{if(a=="CONP"){b="RE"}else{if(a=="CONPT"){b="DIS"}else{if(a=="STFPT"){b="STU2"}else{if(a=="BIGF"){b="0"}else{b="RP"}}}}}}}}return b}function f_setLinePrice(a){if(!a){return}var b=a;if(!b.pv){b.pv=0}if(!b.unitOrigPrice){b.unitOrigPrice=0}if(!b.unitDiscountPrice){b.unitDiscountPrice=0}if(!b.unitRedeemPoint){b.unitRedeemPoint=0}b.favorableSum=Number(b.quantity*b.unitDiscountPrice);b.redeemPoint=b.unitRedeemPoint*b.quantity;b.PVSum=Number(b.quantity*b.pv);b.amount=Number(b.unitSellingPrice*b.quantity-b.favorableSum);linegrid.updateRow(a,b);f_calculateLinePrice(true);return}function f_memberAddress(a){if(!a){return}if(!liger.get("deliveryType")){return}$.ajax({type:"POST",url:_basePath+"/mm/site/query?memberId="+a,success:function(d){if(d.success){var e={};var f=new Array();var b=new Array();for(var c in d.rows){if(d.rows[c].siteUseCode=="BILL"){f.push(d.rows[c])}else{if(d.rows[c].siteUseCode=="SHIP"){b.push(d.rows[c])}}}e.rows=f;addressgrid.set({data:e});e.rows=b;deliveryaddress.set({data:e})}}})}function f_memberAccount(a){if(!a){return}$.ajax({type:"POST",url:_basePath+"/mm/accountingbalance/query?memberId="+a,success:function(b){if(b.success){f_setMemberAccount(b.rows)}}})}function f_setMemberAccount(a){for(var b in a){if(a[b].accountingType=="EB"){liger.get("exchangeBalance").setValue(a[b].balance);$("#exchangeBalance").text(a[b].balance)}else{if(a[b].accountingType=="RB"){liger.get("remainingBalance").setValue(a[b].balance);$("#remainingBalance").text(a[b].balance)}else{if(a[b].accountingType=="SP"){liger.get("currentPoints").setValue(a[b].balance)}}}}}function f_calculateLinePrice(g){var d=linegrid.records;var e=true;summary.pv=0;summary.currency=0;summary.exchange=0;summary.points=0;summary.tax=0;var h="STDP";for(var k in d){var a=d[k];if(a.itemId){e=false}if(!d[k].redeemPoint){d[k].redeemPoint=0}if(!d[k].unitOrigPrice){d[k].unitOrigPrice=0}if(!d[k].unitDiscountPrice){d[k].unitDiscountPrice=0}if(!d[k].amount){d[k].amount=0}if(!d[k].PVSum){d[k].PVSum=0}if(!d[k].quantity){d[k].quantity=1}if(d[k].PVSum){if(d[k].calPvFlag=="Y"){summary.pv+=Number(d[k].PVSum)}else{summary.pv+=0}}else{if(!d[k].pv){d[k].pv=0}summary.pv+=Number(d[k].pv*d[k].quantity)}var b=0;var c=0;if(summary.enableTax){for(var f in taxRateList){if(taxRateList[f].taxType==d[k].itemTaxType){b=b+taxRateList[f].taxRate/100}}var j;if(summary.priceIncludeTax){j=Number(d[k].unitTaxPrice/(1+b)).toFixed(2)}else{j=d[k].unitTaxPrice}for(var f in taxRateList){if(taxRateList[f].taxType==d[k].itemTaxType){c+=Number(Number(j*taxRateList[f].taxRate/100).toFixed(summary.precision))}}if(d[k].freeFlag=="Y"){c=0}d[k].taxAmt=Number(c.toFixed(summary.precision));summary.tax+=Number(c*d[k].quantity)}if(summary.enableTax&&!summary.priceIncludeTax){d[k].unitSellingPrice=(Number(d[k].unitOrigPrice)+Number(d[k].taxAmt)-Number(d[k].unitDiscountPrice)).toFixed(summary.precision)}else{d[k].unitSellingPrice=(Number(d[k].unitOrigPrice)-Number(d[k].unitDiscountPrice)).toFixed(summary.precision)}d[k].amount=Number(d[k].unitSellingPrice*d[k].quantity).toFixed(summary.precision);if(d[k].itemSalesType=="EXCH"){summary.exchange+=Number(d[k].amount)}summary.points+=Number(d[k].redeemPoint);if(d[k].itemSalesType!="FREE"){summary.currency+=Number(d[k].amount)}linegrid.updateRow(a,d[k])}linegrid.reRender();if(e){summary.tax=Number(0);summary.currency=Number(0)}summary.tax=Number(summary.tax.toFixed(summary.precision));summary.currency=Number(summary.currency.toFixed(summary.precision));f_summaryItem();if(g&&g==true){if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="SHIPP"&&deliveryaddress.getSelected()){f_queryAndCalShipping(deliveryaddress.getSelectedRow())}f_summaryTotal()}}function f_summaryItem(){$("#totalPV").text(Number(summary.pv).toFixed(summary.precision));$("#TotalCurrency").text(Number(summary.currency).toFixed(summary.precision));$("#beforeTax").text(Number((summary.currency-summary.tax)).toFixed(summary.precision));$("#tax").text(Number(summary.tax).toFixed(summary.precision));$("#afterTax").text(Number(summary.currency).toFixed(summary.precision));$("#summaryPV").text(Number(summary.pv).toFixed(summary.precision))}function roundingAdjustment(b,c,e){if(!e||c!=2){return Number(0).toFixed(c)}var d=2*Math.pow(10,(c-1));var a=Math.round(b*d)/d;return Number(a-b).toFixed(c)}function roundingPayAmt(c,b,a,d){if(!d){return c}return Number(c- -b).toFixed(a)}function f_summaryTotal(){var b,a;if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){b=Number(summary.currency- -summary.adjustMents-summary.discountAmt).toFixed(summary.precision);a=roundingAdjustment(b,summary.precision,showRounding);b=roundingPayAmt(b,a,summary.precision,showRounding);if(b>=0){$("#actrualPayAmt").text(b)}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}$("#roundingAmt").text(a)}else{b=Number(summary.currency- -summary.shippingTier- -summary.adjustMents-summary.discountAmt).toFixed(summary.precision);a=roundingAdjustment(b,summary.precision,showRounding);b=roundingPayAmt(b,a,summary.precision,showRounding);if(b>=0){$("#actrualPayAmt").text(b)}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}$("#roundingAmt").text(a)}if($("#getsalespoint")&&pointRate){if(pointLimit&&(Number($("#actrualPayAmt").text())*pointRate>pointLimit)){$("#getsalespoint").text((Number(pointLimit)).toFixed(summary.precision))}else{$("#getsalespoint").text(Number((Number($("#actrualPayAmt").text())*pointRate).toFixed(summary.precision)))}}}function f_payMentAdjust(g,b){var e=/^-?\d*\.?\d*$/;if(!e.test(g.value)){$(g).addClass("l-text-invalid");$(g).attr("title",$l("type.com.lkkhpg.dsis.common.order.payadjustment.number")).ligerTip({distanceX:5,distanceY:-3,auto:true});$(g).val("");return}else{if($(g).hasClass("l-text-invalid")){$(g).removeClass("l-text-invalid");$(g).removeAttr("title").ligerHideTip()}}if(g.value<0){$(g).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.minus"));return}var a;if(g){a=g.id+"Text";g.tempValue=Number($("#"+a).text());if(g.id=="adjust"){var j=$(g).parents("tr");if(!g.value){j.find("#adjustText").text("0")}else{if(j.find("input[type='hidden']:eq(0)").val()=="subs"){j.find("#adjustText").text("-"+g.value)}else{j.find("#adjustText").text(g.value)}}}else{$("#"+a).text(g.value)}}if(b){}var c=0;var f=$("#payAdjust table tr").length;var i=$("#payAdjust table tr:lt("+(f-1)+")");$.each(i,function(){if(Number($(this).find("#adjust").val())>0){if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){c-=Number($(this).find("#adjust").val())}else{c+=Number($(this).find("#adjust").val())}}});if((Number(summary.currency)+c)<0){if(g.id=="adjust"){var j=$(g).parents("tr");j.find("#adjustText").text("0")}else{$("#"+a).text("0")}c+=Number(g.value);$("#afterAdjust").text(Number(c).toFixed(summary.precision));$(g).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.adjustbiggerthenorder"));summary.adjustMents=c}else{$("#afterAdjust").text(Number(c).toFixed(summary.precision));summary.adjustMents=c}var d,h;if(liger.get("deliveryType").getValue()!="SHIPP"){d=Number(summary.currency- -c-summary.discountAmt).toFixed(summary.precision);h=roundingAdjustment(d,summary.precision,showRounding);d=roundingPayAmt(d,h,summary.precision,showRounding);if(d>=0){$("#actrualPayAmt").text(d)}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}$("#roundingAmt").text(h)}else{d=Number(summary.currency- -summary.shippingTier- -c-summary.discountAmt).toFixed(summary.precision);h=roundingAdjustment(d,summary.precision,showRounding);d=roundingPayAmt(d,h,summary.precision,showRounding);if(d>=0){$("#actrualPayAmt").text(d)}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}$("#roundingAmt").text(h)}return}function f_changeMemberShow(a){if(a){if($(".l-group:eq(1) div").hasClass("togglebtn-down")){$(".l-group:eq(1) div").click()}$(".l-group:eq(1)").show()}else{liger.get("memberId").clear();if(!$(".l-group:eq(1) div").hasClass("togglebtn-down")){$(".l-group:eq(1) div").click()}$(".l-group:eq(1)").hide()}}function f_changeStaffShow(a){if(a){if($(".l-group:eq(2) div").hasClass("togglebtn-down")){$(".l-group:eq(2) div").click()}$(".l-group:eq(2)").show()}else{if(!$(".l-group:eq(2) div").hasClass("togglebtn-down")){$(".l-group:eq(2) div").click()}$(".l-group:eq(2)").hide()}}function f_setDefaultAdjustMents(a){if(!a||!liger.get("adjustType")){return}var h=$("#payAdjust table tr:eq(0)");var b=$("#payAdjust table tr").length;var k=$("#payAdjust table tr:lt("+(b-3)+"):gt(0)");$.each(k,function(){if($(this).find("#adjustid").length>0){$(this).remove()}});var d=0;var l=liger.get("adjustType").options.data;for(var f in a){var e=new Object();e.value=Math.abs(a[f].adjustmentAmount);if("AD"==a[f].adjustmentType){d++;e.id="adjust";if(d>1){var g=h.clone();g.find("#adjustType_val").attr("id","adjustType"+d+"_val");g.find("#adjustType").attr("id","adjustType"+d);if(Number(a[f].adjustmentAmount)>0){g.find("#adjustType"+d+"_val").val("add");for(var c in l){if(l[c].value=="add"){g.find("#adjustType"+d).val(l[c].meaning);break}}}else{g.find("#adjustType"+d+"_val").val("subs");for(var c in l){if(l[c].value=="subs"){g.find("#adjustType"+d).val(l[c].meaning);break}}}g.find("#adjustText").html(e.value);g.find("#adjust").val(e.value);g.find("#remarks").val(a[f].remark);g.find("#adjustid").val(a[f].salesAdjustmentId);g.find(".addArtificial").hide();g.find(".subArtificial").show();h.after(g)}else{if(Number(a[f].adjustmentAmount)>0){h.find("#adjustType_val").val("add");for(var c in l){if(l[c].value=="add"){h.find("#adjustType").val(l[c].meaning);break}}}else{h.find("#adjustType_val").val("subs");for(var c in l){if(l[c].value=="subs"){h.find("#adjustType").val(l[c].meaning);break}}}h.find("#adjust").val(e.value);h.find("#adjustText").html(e.value);h.find("#remarks").val(a[f].remark);h.find("#adjustid").val(a[f].salesAdjustmentId)}f_payMentAdjust(e)}}}function f_initSalesOrg(b){for(var a in b){if(b[a].salesOrgId==defaultSaleOrg){liger.get("salesOrgId").setValue(b[a].salesOrgId);liger.get("salesOrgId").setText(b[a].name);liger.get("salesOrgId").set({readonly:true,data:b});f_setMarketAndCurrency(b[a].market,b[a].currency);break}}}function f_setMarketAndCurrency(b,a){if(b){liger.get("marketId").setValue(b.marketId);liger.get("marketId").setText(b.name)}if(a){liger.get("currency").setValue(a);liger.get("currency").setText(a);$(".currencysign").text(a)}}function f_getAdjustMents(){var b=new Array();var c=$("#payAdjust table tr").length;var a=$("#payAdjust table tr:lt("+(c-1)+")");$.each(a,function(){if($(this).find("#adjust").val()){var d=$(this).find("#adjust").val();if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){d=-Number($(this).find("#adjust").val())}b.push({adjustmentType:"AD",adjustmentAmount:d,headerId:$("#headerId").val(),remark:$(this).find("#remarks").val(),salesAdjustmentId:$(this).find("#adjustid").val()})}});return b}function f_getLogistics(){if(liger.get("deliveryType").getValue()=="PCKUP"||!liger.get("deliveryCompany").getValue()){return null}var a=new Object();a.logisticsId=$("#logisticsId").val();a.headerId=$("#headerId").val();a.shippingTierId=liger.get("deliveryCompany").getValue();a.shippingTierName=liger.get("deliveryCompany").getText();a.shippingFee=$("#shippingTier").text();a.taxAmount=$("#shippingTierTax").text();a.salesOrgId=liger.get("salesOrgId").getValue();a.autoshipFlag="N";if(liger.get("isCod")&&liger.get("isCod").getValue()){a.codFlag="Y"}else{a.codFlag="N"}var b=liger.get("deliveryCompany").getValue();for(var c in shippingTierList){if(b==shippingTierList[c].shippingTierId){a.feeCalcluateType=shippingTierList[c].feeCalcluateType;a.voucherCalculateType=shippingTierList[c].voucherCalculateType;a.voucherCalculateOperator=shippingTierList[c].voucherCalculateOperator;a.calculateAmount=shippingTierList[c].calculateAmount;a.discountType=shippingTierList[c].discountType;a.voucherAmount=shippingTierList[c].voucherAmount}}return a}function f_queryShippingTier(b){if(!b){return}var a=linegrid.getData();var d=liger.get("salesOrgId").getValue();var c=liger.get("deliveryType").getValue();var e={};if(liger.get("memberId").getValue()&&b.memberId){e.countryCode=b.spmLocation.countryCode;e.cityCode=b.spmLocation.cityCode;e.stateCode=b.spmLocation.stateCode;e.zipCode=b.spmLocation.zipCode}else{e.countryCode=b.countryCode;e.cityCode=b.cityCode;e.stateCode=b.stateCode;e.zipCode=b.zipCode}if(!e.zipCode){e.zipCode=""}queryItemTaxRate(true);a=linegrid.getData();$.ajax({url:_basePath+"/dm/shippingTierDtl/queryForAutoshipOrder?salesOrgId="+d+"&apptype=AUTOS&countryCode="+e.countryCode+"&cityCode="+e.cityCode+"&stateCode="+e.stateCode+"&zipCode="+e.zipCode,type:"POST",async:false,contentType:"application/json; charset=utf-8",data:JSON2.stringify(a),success:function(f){if(f.success){shippingTierList=f.rows;f_calculateShippingTier()}else{$.ligerDialog.error(f.message)}}})}function f_queryAndCalShipping(b){if(!liger.get("deliveryType")||liger.get("deliveryType").getValue()!="SHIPP"||!deliveryaddress.getSelected()){liger.get("deliveryCompany").setValue();$("#shippingTier").text(0);$("#shippingTierTax").text(0);summary.shippingTier=0;summary.shippingTierTax=0;return}var a=linegrid.getData();var c=liger.get("salesOrgId").getValue();var d={};if(liger.get("memberId").getValue()&&b.memberId){d.countryCode=b.spmLocation.countryCode;d.cityCode=b.spmLocation.cityCode;d.stateCode=b.spmLocation.stateCode;d.zipCode=b.spmLocation.zipCode}else{d.countryCode=b.countryCode;d.cityCode=b.cityCode;d.stateCode=b.stateCode;d.zipCode=b.zipCode}if(!d.zipCode){d.zipCode=""}$.ajax({url:_basePath+"/dm/shippingTierDtl/queryForAutoshipOrder?salesOrgId="+c+"&apptype=AUTOS&countryCode="+d.countryCode+"&cityCode="+d.cityCode+"&stateCode="+d.stateCode+"&zipCode="+d.zipCode,type:"POST",async:false,contentType:"application/json; charset=utf-8",data:JSON2.stringify(a),success:function(e){if(e.success){shippingTierList=e.rows;f_calculateShippingTier()}else{$.ligerDialog.error(e.message)}}})}function f_calculateShippingTier(){if(!shippingTierList||shippingTierList.length<1){liger.get("deliveryCompany").set({data:shippingTierList});liger.get("deliveryCompany").setValue();$("#shippingTier").text(0);$("#shippingTierTax").text(0);summary.shippingTier=0;summary.shippingTierTax=0;return}liger.get("deliveryCompany").set({data:shippingTierList});var k={};k.price=Number.MAX_VALUE;for(var d in shippingTierList){var g;var e=shippingTierList[d];if(e.feeCalcluateType=="WEG"){var a=0;var b=linegrid.rows;for(var d=0;d<b.length;d++){a=a+b[d].weight*b[d].quantity}for(var d in e.shippingTierWeights){var h=e.shippingTierWeights[d];if(a>=h.weightFrom&&(!h.weightTo||a<h.weightTo)){if(k.price>h.afterTaxShippingFee){k.price=h.afterTaxShippingFee;k.tax=h.taxShippingFee;k.name=e.shippingTierName;k.value=e.shippingTierId;k.shipIncludeTax=e.shipIncludeTax}}}}else{if(e.privilegeFlag=="Y"){if(e.calculationType=="AFTAX"){g=Number($("#beforeTax").text())-summary.discountAmt}else{g=Number($("#afterTax").text())-summary.discountAmt}}else{if(e.calculationType=="AFTAX"){g=$("#beforeTax").text()}else{g=$("#afterTax").text()}}for(var c in e.shippingTierDtls){var f=e.shippingTierDtls[c];if(g>=f.invAmountFrom&&(!f.invAmountTo||g<f.invAmountTo)){if(k.price>f.afterTaxShippingFee){k.price=f.afterTaxShippingFee;k.tax=f.taxShippingFee;k.name=e.shippingTierName;k.value=e.shippingTierId;k.shipIncludeTax=e.shipIncludeTax}}}}}if(k.price==Number.MAX_VALUE){k.price=0}summary.shippingTier=k.price;summary.shippingTierTax=k.tax;liger.get("deliveryCompany").setValue(k.value);liger.get("deliveryCompany").setText(k.name);$("#shippingTier").text(k.price.toFixed(summary.precision));$("#shippingTierTax").text(k.tax.toFixed(summary.precision));if(k.shipIncludeTax=="NO"){$("#shippingTierTax").parent().hide()}else{$("#shippingTierTax").parent().show()}return}function f_resetShippingTier(){var d=liger.get("deliveryCompany").options.data;if(!d){f_queryShippingTier(deliveryaddress.getSelectedRow());return}var l={};l.price=Number.MAX_VALUE;if(d){for(var e in d){var h;if(d[e].feeCalcluateType=="WEG"){var f=d[e];var a=0;var b=linegrid.rows;for(var e=0;e<b.length;e++){a=a+b[e].weight*b[e].quantity}for(var e in f.shippingTierWeights){var k=f.shippingTierWeights[e];if(a>=k.weightFrom&&(!k.weightTo||a<k.weightTo)){if(l.price>k.afterTaxShippingFee){l.price=k.afterTaxShippingFee;l.tax=k.taxShippingFee;l.name=f.shippingTierName;l.value=f.shippingTierId;l.shipIncludeTax=f.shipIncludeTax}}}}else{if(e.privilegeFlag=="Y"){if(e.calculationType=="AFTAX"){h=Number($("#beforeTax").text())-summary.discountAmt}else{h=Number($("#afterTax").text())-summary.discountAmt}}else{if(e.calculationType=="AFTAX"){h=$("#beforeTax").text()}else{h=$("#afterTax").text()}}var f=d[e];for(var c in f.shippingTierDtls){var g=f.shippingTierDtls[c];if(h>=g.invAmountFrom&&(!g.invAmountTo||h<g.invAmountTo)){if(l.price>g.afterTaxShippingFee){l.price=g.afterTaxShippingFee;l.tax=g.taxShippingFee;l.name=f.shippingTierName;l.value=f.shippingTierId;l.shipIncludeTax=f.shipIncludeTax}}}}}}if(l.price==Number.MAX_VALUE){l.price=0}summary.shippingTier=l.price;summary.shippingTierTax=l.tax;liger.get("deliveryCompany").setValue(l.value);liger.get("deliveryCompany").setText(l.name);$("#shippingTier").text(l.price.toFixed(summary.precision));$("#shippingTierTax").text(l.tax.toFixed(summary.precision));if(l.shipIncludeTax=="NO"){$("#shippingTierTax").parent().hide()}else{$("#shippingTierTax").parent().show()}}function f_renderItemName(d,a,b){if(!b){return}if(d.itemType!="PACKG"){return b}var c=b+"&nbsp;&nbsp;<img src='../lib/ligerUI/skins/icons/search.gif' id='gridimg' index="+a+"/>";return c}function f_setAutoShipDetail(e){var f=liger.get("memberId").getText();var g=liger.get("marketId").getText();var d=liger.get("salesOrgId").getText();om_oc_form.setData(e);$("#headerId").val(e.autoshipId);liger.get("memberId").setText(f);liger.get("marketId").setText(g);liger.get("salesOrgId").setText(d);if(e.spmSalesOrganization){f_setMarketAndCurrency(e.spmSalesOrganization.market,e.spmCurrency.currencyCode);liger.get("salesOrgId").setValue(e.spmSalesOrganization.salesOrgId);liger.get("salesOrgId").setText(e.spmSalesOrganization.name)}for(var c in autoShipStatusData){if(autoShipStatusData[c].value==e.autoshipStatus){liger.get("autoshipStatus").setText(autoShipStatusData[c].meaning);break}}var b={};b.rows=e.lines;linegrid.set({data:b});if(e.member){liger.get("cnName").setValue(e.member.chineseName);liger.get("enName").setValue(e.member.englishName);liger.get("memberId").setValue(e.member.memberId);liger.get("memberId").setText(e.member.memberCode);if(e.member.exchangeBalance){liger.get("exchangeBalance").setValue(e.member.exchangeBalance);$("#exchangeBalance").text(e.member.exchangeBalance)}if(e.member.remainingBalance){liger.get("remainingBalance").setValue(e.member.remainingBalance);$("#remainingBalance").text(e.member.remainingBalance)}liger.get("currentPoints").setValue(e.member.salesPiont);liger.get("currentPV").setValue(e.member.currentPv);memberStatus=e.member.status;f_setDelivery(e.member.memSites,e.logistics,e.salesSites)}else{f_setDelivery(null,e.logistics,e.salesSites)}if(e.memCard){liger.get("creditCardId").set("data",e.memCard);liger.get("creditCardId").setValue(e.creditCardId)}if(e&&e.member){memberType=e.member.memberType}if(enableEinvoice=="Y"){if(e.getEinvoiceMethod){getEinvoiceMethod=e.getEinvoiceMethod}else{getEinvoiceMethod="1"}if(e.einvoiceCarrier){carrierType=e.einvoiceCarrier.carrierType;carrierCode=e.einvoiceCarrier.carrierCode;if(carrierType=="21"){liger.get("phoneCode").setValue(carrierCode)}else{if(carrierType=="22"){liger.get("naturalPersonCode").setValue(carrierCode)}else{if(carrierType=="31"){liger.get("donateCode").setValue(carrierCode)}else{}}}}}if(enableEinvoice=="Y"){selectEinvoiceMethod(getEinvoiceMethod)}var a=0;for(var c in e.lines){a+=Number(e.lines[c].pv*e.lines[c].quantity)}}function f_updateAutoShipStatus(a){var b=$("#autoshipId").val();if(!b||!a){Hap.showError($l("type.com.lkkhpg.dsis.common.order.autoship.not_save"));return}var c={autoshipId:b,autoshipStatus:a};$.ajax({type:"POST",url:_basePath+"/om/autoship/updateStatus",data:c,success:function(e){if(e.success){Hap.showSuccess();for(var d in autoShipStatusData){if(autoShipStatusData[d].value==a){liger.get("autoshipStatus").setValue(a);liger.get("autoshipStatus").setText(autoShipStatusData[d].meaning);break}}initButton(true)}}})}function f_setDelivery(a,b,k){if(!a){f_setDefaultAddress(k)}else{var f={};var c=new Array();var h=new Array();for(var g in a){if(a[g].siteUseCode=="BILL"){c.push(a[g])}else{if(a[g].siteUseCode=="SHIP"){h.push(a[g])}}}if(k){for(var g in k){if(k[g].siteType=="BILL"){$("#billSiteId").val(k[g].salesSiteId);var e=false;for(var d in c){if(c[d].address==k[g].address&&c[d].phone==k[g].phone&&c[d].name==k[g].name){c[d].select=true;e=true}}if(!e){k[g].spmLocation={};k[g].spmLocation.zipCode=k[g].zipCode;k[g].select=true;c.push(k[g])}}else{$("#deliverySiteId").val(k[g].salesSiteId);liger.get("deliveryType").setValue("SHIPP");var e=false;for(var d in h){if(h[d].address==k[g].address&&h[d].phone==k[g].phone&&h[d].name==k[g].name){h[d].select=true;e=true}}if(!e){k[g].spmLocation={};k[g].spmLocation.zipCode=k[g].zipCode;k[g].select=true;h.push(k[g])}}}}f.rows=c;addressgrid.set({data:f});f.rows=h;deliveryaddress.set({data:f})}if(liger.get("deliveryType").getValue()!="SHIPP"){summary.shippingTier=0}if(b){if(b.shippingFee){summary.shippingTier=b.shippingFee}if(b.taxAmount){summary.shippingTierTax=b.taxAmount}$("#shippingTier").text(summary.shippingTier);$("#shippingTierTax").text(summary.shippingTierTax);$("#logisticsId").val(b.logisticsId);liger.get("deliveryCompany").setValue(b.shippingTierId);liger.get("deliveryCompany").setText(b.shippingTierName)}}function valideBefore(){var a=liger.get("orderType").getValue();if(!liger.get("orderType").getValue()||!liger.get("channel").getValue()||!liger.get("salesOrgId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.miss"));return false}if(liger.get("deliveryType").getValue()=="SHIPP"){if(!deliveryaddress.getSelectedRow()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.delivery_not_null"));return false}if(!addressgrid.getSelectedRow()){$.ligerDialog.error($l("msg.error.om.billing_address_null"));return false}if(!liger.get("deliveryCompany").getValue()){$.ligerDialog.error($l("msg.error.order.deliverycompany_null"));return false}}if(liger.get("channel")=="SRVC"&&!liger.get("serviceCenterId")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.servicecenter_not_null"));return false}var c=linegrid.getData();if(!c||c.length<1){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}for(var b in c){if(!c[b].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}}if(a=="DIRP"||a=="STFP"||a=="STFPT"||a=="CONP"||a=="CONPT"){return true}else{if(!liger.get("memberId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.not_member"));return false}return true}}function cleanMember(){liger.get("memberId").setValue("");liger.get("memberId").setText("");liger.get("cnName").setValue("");liger.get("enName").setValue("");liger.get("exchangeBalance").setValue("");liger.get("remainingBalance").setValue("");liger.get("currentPoints").setValue("");liger.get("currentPV").setValue("");memberType="";if(enableEinvoice=="Y"){getEinvoiceMethod="1";selectEinvoiceMethod(getEinvoiceMethod)}if($("#exchangeBalance")){$("#exchangeBalance").html("0");$("#remainingBalance").html("0")}if(liger.get("deliveryCompany")){liger.get("deliveryCompany").setValue("");liger.get("deliveryCompany").setText("");$("#shippingTier").html("")}if(!orderDetail){var a={};a.rows=[];if(addressgrid){addressgrid.set({data:a})}if(deliveryaddress){deliveryaddress.set({data:a})}}}function reSetLine(c,b,a){if(!linegrid){return}var f=linegrid.getData();if(c){for(var d in f){f[d].lineId="";f[d].headerId="";f[d].PVSum=0}var e={};e.rows=f;linegrid.set({data:e});f_calculateLinePrice(true);return}if(a){if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="PCKUP"){for(var d in f){if(!f[d].defaultInvOrgId){f[d].defaultInvOrgId=defaultInvOrg}}}else{for(var d in f){f[d].defaultInvOrgId=""}}var e={};e.rows=f;linegrid.set({data:e});return}if(b){if($("#headerId").val()&&f&&(orderDetail.orderType!=liger.get("orderType").getValue()||orderDetail.channel!=liger.get("channel").getValue())){$.ajax({type:"POST",url:_basePath+"/om/order/line/remove",async:false,data:JSON2.stringify(f),contentType:"application/json; charset=utf-8",success:function(g){if(g.success){var h={};h.rows=[];linegrid.set({data:h});f_calculateLinePrice(true);return}}})}else{var e={};e.rows=[];linegrid.set({data:e});f_calculateLinePrice(true);return}}}function validateAutoship(){if(!om_oc_form.valid()){return false}if(creditCardFlag!=null&&creditCardFlag.length>0&&"Y"==creditCardFlag[0]){if(!$("#creditCardId").val()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.autoship.not_credit"));return false}}var d=linegrid.getData();for(var c in d){if(!d[c].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}}if(liger.get("deliveryType").getValue()=="SHIPP"){if(!deliveryaddress.getSelectedRow()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.delivery_not_null"));return false}if(!addressgrid.getSelectedRow()){$.ligerDialog.error($l("msg.error.order.billing_address_null"));return false}if(!liger.get("deliveryCompany").getValue()){$.ligerDialog.error($l("msg.error.order.deliverycompany_null"));return false}}if(minMonery>(summary.currency+summary.shippingTier)){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.minimumorderamount")+minMonery);return false}if(minPV>summary.pv){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.minimumorderpv")+minPV);return false}var b=Number($("#beforeTax").text()).toFixed(summary.precision);var a=Number(autoMinAmount).toFixed(summary.precision);if(parseInt(a)>parseInt(b)){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.minimumorderbeforetaxamount")+a);return false}if($("#recordedInVehicle").ligerRadio().getValue()){if($("#phoneCodeOfVehicle").ligerRadio().getValue()&&($("#phoneCode").ligerGetTextBoxManager().getValue()==null||$("#phoneCode").ligerGetTextBoxManager().getValue()=="")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.einvoicecarrier.carriertype.phonecode_not_null"));return false}else{if($("#naturalPersonCodeOfVehicle").ligerRadio().getValue()&&($("#naturalPersonCode").ligerGetTextBoxManager().getValue()==null||$("#naturalPersonCode").ligerGetTextBoxManager().getValue()=="")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.einvoicecarrier.carriertype.naturalpersoncode_not_null"));return false}else{}}}if($("#donatedInvoice").ligerRadio().getValue()&&($("#donateCode").ligerGetTextBoxManager().getValue()==null||$("#donateCode").ligerGetTextBoxManager().getValue()=="")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.einvoicecarrier.carriertype.donatecode_not_null"));return false}if(!isCarrierCodeValidSuccess){$.ligerDialog.error($l("msg.error.integration.einvoice_validate_carrier_code_error"));return false}return true}function autoshipReadOnly(){liger.get("memberId").set({readonly:true});liger.get("executeDate").set({readonly:true});liger.get("executeType").set({readonly:true});liger.get("remark").set({readonly:true});liger.get("deliveryCompany").set({readonly:true});liger.get("creditCardId").set({readonly:true});liger.get("deliveryType").set({readonly:true});liger.get("salesOrgId").set({readonly:true});$("#addCreditCar").hide();$("[ toolbarid='addLineBtn']").hide();$("[ toolbarid='deleteLineBtn']").hide();linegrid.set({enabledEdit:false,rowSelectable:false,selectable:false});deliveryaddress.set({enabledEdit:false,rowSelectable:false,selectable:false});addressgrid.set({enabledEdit:false,rowSelectable:false,selectable:false});liger.get("paperInvoice").setDisabled(true);liger.get("recordedInVehicle").setDisabled(true);liger.get("donatedInvoice").setDisabled(true);liger.get("phoneCodeOfVehicle").setDisabled(true);liger.get("naturalPersonCodeOfVehicle").setDisabled(true);liger.get("phoneCode").set({readonly:true});liger.get("naturalPersonCode").set({readonly:true});liger.get("donateCode").set({readonly:true})}function autoshipActive(){liger.get("memberId").set({readonly:false});if(marketCode!="US"){liger.get("executeDate").set({readonly:true});liger.get("executeType").set({readonly:true})}liger.get("remark").set({readonly:false});liger.get("deliveryCompany").set({readonly:false});$("#addCreditCar").show();$("[ toolbarid='addLineBtn']").show();$("[ toolbarid='deleteLineBtn']").show();linegrid.set({enabledEdit:true,rowSelectable:true,selectable:true});deliveryaddress.set({enabledEdit:true,rowSelectable:true,selectable:true});addressgrid.set({enabledEdit:true,rowSelectable:true,selectable:true});liger.get("paperInvoice").setEnabled(true);liger.get("recordedInVehicle").setEnabled(true);liger.get("donatedInvoice").setEnabled(true);liger.get("phoneCodeOfVehicle").setEnabled(true);liger.get("naturalPersonCodeOfVehicle").setEnabled(true);liger.get("phoneCode").set({readonly:false});liger.get("naturalPersonCode").set({readonly:false});liger.get("donateCode").set({readonly:false})}function checkPayment(){if(!liger.get("isCod")||!liger.get("isCod").getValue()){return true}if(liger.get("freeShipping")&&liger.get("freeShipping").getValue()){return true}if(!freePayMent||!freeFreight){return true}if(summary.currency<freePayMent){return false}else{return true}}function f_getItemPackageDetail(c,a,d){if(c.itemType!="PACKG"&&c.itemType!="VN"&&c.itemType!="VY"){return}var b=document.createElement("div");$(a).append(b);$(b).css("margin",10).ligerGrid({columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity"}],isScroll:false,showToggleColBtn:false,width:500,url:_basePath+"/inv/item/queryHierarchyByItemId?itemId="+c.itemId,showTitle:false,usePager:false,onAfterShowData:d,frozen:false})}function f_openConfirm(){if($(liger.get("remark").element).hasClass("l-text-field error")){return}var a=liger.get("orderType").getValue();if(!liger.get("memberId").getValue()&&a!="DIRP"&&a!="CONP"&&a!="CONPT"&&a!="STFP"&&a!="STFPT"){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.not_member"));return}if(!liger.get("serviceCenterId").getValue()&&liger.get("channel").getValue()=="SRVC"){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.servicecenter_not_null"));return}var f=linegrid.getData();var g=new Array();for(var c=0;c<f.length;c++){if(f[c].itemId){g.push(f[c])}}if(g.length==0){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return}for(var e in g){if(!g[e].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return}}if(summary.points>Number(liger.get("currentPoints").getValue())){f_save(false,false,false,true);$.ligerDialog.error($l("msg.error.order.sales_point_insufficient"));return}else{f_save(false,false,true)}var b=window.top.tab.getSelectedTabItemID();var d=$("#headerId").val();if(!d){$.ligerDialog.error($l("msg.error.order_pls_save_order"));return}window.top.f_removeTab(b);window.top.f_addTab("ORDER_CREATE",$l("msg.info.order.confirm"),_basePath+"/om/om_order_confirm.html?orderId="+d)}function f_openCreate(){var a=window.top.tab.getSelectedTabItemID();var b=$("#headerId").val();window.top.f_removeTab(a);window.top.f_addTab("ORDER_CREATE",$l("msg.info.order.new_order"),_basePath+"/om/om_order_create.html?orderId="+b)}function getshowLineGrid(a){var b={columns:o_getConfirmLineColumns(a),detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},enabledEdit:true,usePager:false,width:"99%",onBeforeSelectRow:function(c){DsisOrderCreate.editLineIndex=c.rowindex}};return b}function o_getCreateLineColumns(i,f,e,c){defaultItemSalesType="PURC";var g={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitorigprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(k){if(!k||!k.itemId){return}if(!k.unitOrigPrice){k.unitOrigPrice=0;return"0"}if(k.itemSalesType&&k.itemSalesType=="FREE"){k.unitOrigPrice=0;return"0"}return Number(k.unitOrigPrice).toFixed(summary.precision)}};var d={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(k){if(!k||!k.itemId){return}if(!k.quantity){k.quantity=1}if(!k.unitOrigPrice){k.unitOrigPrice=0}if(k.itemSalesType&&k.itemSalesType=="FREE"){k.unitOrigPrice=0}return Number(k.unitSellingPrice*k.quantity).toFixed(summary.precision)}};var a={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(k){if(!k){return}for(var l in productSalesTypeData){if(k.itemSalesType==productSalesTypeData[l].value){return productSalesTypeData[l].meaning}}},editor:{type:"select",data:salesTypeList,valueField:"value",textField:"meaning",onChangeValue:function(k){}},validate:{required:true}};var b=[a,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",align:"center",width:100,textField:"itemNumber",editor:o_itemPupop(),validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",width:260,align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pv"),name:"pv",align:"center",type:"text",render:function(n){if(!n||!n.itemId){return}if(!n.pv){n.pv=0;return"0"}var k="STDP";if(liger.get("orderType")){k=liger.get("orderType").getValue()}if((k=="STDP"||k=="VIPP")&&(n.itemSalesType=="PURC"||n.itemSalesType=="PUSU")){if(n.pv>0){return n.pv}else{return"0"}var m=n.priceDetail;if(!m){var o={itemId:n.itemId,currency:liger.get("currency").getValue(),uomCode:n.uomCode,salesOrgId:defaultSaleOrg};$.getJSON(_basePath+"/inv/price/queryPriceByItemId?",o,function(q){m=q.rows;n.priceDetail=q.rows;for(var p in m){if(m[p].priceType=="PV"){n.pv=m[p].unitPrice}}})}else{for(var l in m){if(m[l].priceType=="PV"){n.pv=m[l].unitPrice}}}if(n.pv==0){return"0"}return Number(n.pv).toFixed(summary.precision)}else{n.pv=0;return"0"}}},g,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"int",editor:{type:"int",onChange:function(k){if(k.value>99999){k.record.quantity=99999;k.value=99999}else{if(k.value<1){k.record.quantity=1;k.value=1}}if(k.value>k.record.quantity){if(k.record.unitRedeemPoint){summary.points+=(k.record.quantity-k.value)*k.record.unitRedeemPoint;if(summary.points>Number(liger.get("currentPoints").getValue())){$.ligerDialog.error($l("msg.error.order.sales_point_insufficient"));k.value=k.record.quantity}}}},onChanged:function(k){f_setLinePrice(k.record)}},validate:{required:true,digits:true,min:1,max:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pvsum"),name:"PVSum",align:"center",type:"text",render:function(k){if(!k||!k.itemId){return}if(!k.pv){k.pv=0;return"0"}if(!k.quantity){k.quantity=1}k.PVSum=k.pv*k.quantity;if(!k.PVSum||k.PVSum==0){return"0"}return Number(k.PVSum).toFixed(summary.precision)}},d,{name:"calPvFlag",hide:"true"},];var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"taxAmt",align:"center",type:"float",render:function(k){if(!k||!k.itemId){return}return Number(k.taxAmt).toFixed(summary.precision)}};b.splice(5,0,j);if(!i){var h={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:150,type:"text",render:function(l){if(!l){return}for(var k in invOrgs){if(l.defaultInvOrgId==invOrgs[k].invOrgId){return invOrgs[k].name}}}};if(e){h.editor={type:"select",valueField:"invOrgId",textField:"name",value:_invOrgId,text:_invOrgName,cancelable:false,staticOptions:function(k){k.column.editor.data=invOrgs},onSelected:function(l,m){if(!linegrid.editor.editParm||!linegrid.editor.editParm.record){return}var k=linegrid.editor.editParm.record;linegrid.updateRow(k,{itemId:null,itemNumber:null,barCode:null,itemName:null,description:null,starterAid:null,starterAidField:null,countStockFlag:null,quantityCountType:null,minOrderQuantity:null,itemType:null,uomCode:null,publishStatus:null,publishStatusDesc:null,lotCtrlFlag:null,categoryId:null,invCategory:null,categoryDesc:null,categoryIdList:null,inStore:null,fax:null,agencyWeb:null,agencyApp:null,autoDeliver:null,channel:null,isActive:null,salesOrgId:null,currency:null,priceType:null,organizationId:null,priceListDetails:null,mode:null,uomName:null,quantity:null,organization:null,countItemName:null,countItemNumber:null,packageQuantity:null,savePropertyFlag:null,unitDiscountPrice:null,priceDetail:null,pv:null,unitOrigPrice:null,unitRedeemPoint:0,favorableSum:0,redeemPoint:0,PVSum:0,tax:0,unitSellingPrice:0,amount:0,weight:null});f_calculateLinePrice(true)}};h.validate={required:true}}b.unshift(h)}return b}function o_getConfirmLineColumns(a){defaultItemSalesType="PURC";var f={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitorigprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(h){if(!h||!h.itemId){return}if(!h.unitOrigPrice){h.unitOrigPrice=0;return"0"}if(h.itemSalesType&&h.itemSalesType=="FREE"){h.unitOrigPrice=0;return"0"}return Number(h.unitOrigPrice).toFixed(summary.precision)}};var c={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(h){if(!h||!h.itemId){return}if(!h.quantity){h.quantity=1}if(!h.unitSellingPrice){h.unitSellingPrice=0}if(h.itemSalesType&&h.itemSalesType=="FREE"){h.unitSellingPrice=0}return Number(h.unitSellingPrice*h.quantity).toFixed(summary.precision)}};var g={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitsellingprice"),name:"unitSellingPrice",align:"center",type:"float",render:function(h){if(!h||!h.itemId){return}if(!h.unitSellingPrice){h.unitSellingPrice=0;return"0"}if(h.itemSalesType&&h.itemSalesType=="FREE"){h.unitSellingPrice=0;return"0"}return Number(h.unitSellingPrice).toFixed(summary.precision)}};var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(h){if(!h){return}for(var i in productSalesTypeData){if(h.itemSalesType==productSalesTypeData[i].value){return productSalesTypeData[i].meaning}}},validate:{required:true}};if(a){f={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitredeempoint"),name:"unitRedeemPoint",align:"center",type:"text"};c={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",align:"center",type:"text",render:function(h){if(!h||!h.itemId){return}if(!h.quantity){h.quantity=1}if(!h.unitRedeemPoint){h.unitRedeemPoint=0}return Number(h.unitRedeemPoint*h.quantity).toFixed(summary.precision)}}}var b=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:120,type:"text",render:function(j){if(!j){return}for(var h in invOrgs){if(j.defaultInvOrgId==invOrgs[h].invOrgId){return invOrgs[h].name}}}},e,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",align:"center",width:100,textField:"itemNumber",validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",width:260,align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pv"),name:"pv",align:"center",type:"text",render:function(h){if(!h||!h.itemId){return}if(!h.pv){h.pv=0;return}else{if(h.pv==0){return"0"}else{return h.pv}}}},f,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitdiscountprice"),name:"unitDiscountPrice",align:"center",type:"float",editor:{type:"select",valueField:"value",textField:"meaning"},render:function(h){if(!h||!h.itemId){return}}},g,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"int",validate:{required:true,digits:true,min:1,max:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountprice"),name:"favorableSum",align:"center",type:"float",render:function(h){if(!h||!h.itemId){return}if(!h.favorableSum||h.favorableSum==0){return"0"}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pvsum"),name:"PVSum",align:"center",type:"text",render:function(h){if(!h||!h.itemId){return}if(!h.pv){h.pv=0;return}if(!h.quantity){h.quantity=1}h.PVSum=h.pv*h.quantity;if(!h.PVSum||h.PVSum==0){return"0"}return Number(h.PVSum).toFixed(summary.precision)}},c];if(summary.enableTax&&!summary.priceIncludeTax){var d={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"tax",align:"center",type:"float",render:function(h){if(!h||!h.itemId){return}if(h.disableTaxFlag&&h.disableTaxFlag=="Y"){h.tax=0}else{if(marketCode=="CA"&&h.itemNumber=="15160502"){h.tax=h.unitOrigPrice*0.07}else{h.tax=h.unitOrigPrice*summary.taxRate}}return Number(h.tax).toFixed(summary.precision)}};b.splice(6,0,d)}return b}function getOrderSites(){var d=[];var c=deliveryaddress.getSelectedRow();var a=addressgrid.getSelectedRow();if(liger.get("memberId").getValue()){if(c&&liger.get("deliveryType").getValue()=="SHIPP"){var b={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:"SHIP",salesSiteId:$("#deliverySiteId").val(),name:c.name,phone:c.phone,address:c.address,areaCode:c.areaCode,zipCode:c.spmLocation.zipCode};if(c.cityCode){b.cityCode=c.cityCode;b.stateCode=c.stateCode;b.countryCode=c.countryCode;b.address1=c.address1;b.address2=c.address2;b.address3=c.address3}else{b.cityCode=c.spmLocation.cityCode;b.stateCode=c.spmLocation.stateCode;b.countryCode=c.spmLocation.countryCode;b.address1=c.spmLocation.addressLine1;b.address2=c.spmLocation.addressLine2;b.address3=c.spmLocation.addressLine3}d.push(b)}if(a){var e={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:"BILL",salesSiteId:$("#billSiteId").val(),name:a.name,phone:a.phone,address:a.address,areaCode:a.areaCode,zipCode:a.spmLocation.zipCode};if(a.cityCode){e.cityCode=a.cityCode;e.stateCode=a.stateCode;e.countryCode=a.countryCode;e.address1=a.address1;e.address2=a.address2;e.address3=a.address3}else{e.cityCode=a.spmLocation.cityCode;e.stateCode=a.spmLocation.stateCode;e.countryCode=a.spmLocation.countryCode;e.address1=a.spmLocation.addressLine1;e.address2=a.spmLocation.addressLine2;e.address3=a.spmLocation.addressLine3}d.push(e)}}else{if(c){d.push(c)}if(a){d.push(a)}}return d}function f_setDefaultAddress(e){if(!e){return}for(var c in e){if(e[c].siteType=="BILL"){$("#billSiteId").val(e[c].salesSiteId);var a=addressgrid.getData();var d=false;for(var b in a){if(a[b].address==e[c].address&&a[b].phone==e[c].phone&&a[b].name==e[c].name){d=true;addressgrid.select(a[b])}}if(!d){e[c].spmLocation={};e[c].spmLocation.zipCode=e[c].zipCode;addressgrid.addRow(e[c]);addressgrid.select(e[c])}}else{$("#deliverySiteId").val(e[c].salesSiteId);liger.get("deliveryType").setValue("SHIPP");var a=deliveryaddress.getData();var d=false;for(var b in a){if(a[b].address==e[c].address&&a[b].phone==e[c].phone&&a[b].name==e[c].name){d=true;deliveryaddress.select(a[b])}}if(!d){e[c].spmLocation={};e[c].spmLocation.zipCode=e[c].zipCode;deliveryaddress.addRow(e[c])}}}}function o_paymentOptions(a){var b={columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),name:"paymentMethod",type:"select",render:function(d){for(var c in paydetail){if(d.paymentMethod==paydetail[c].value){return paydetail[c].meaning}}}},{display:$l("type.com.lkkhpg.dsis.common.inv.dto.transaction.totalprice"),name:"paymentAmount"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark"}],showTitle:false,width:"99%",url:_basePath+"/om/order/queryPaymentRefund?headerId="+a,detail:{onShowDetail:f_showPayment,height:"auto"}};return b}function f_showPayment(e,b,f){var d=e.paymentMethod;var a;if("CHEQU"==d||"REMIT"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.bank"),readonly:true,name:"bankCode",type:"select",options:{valueField:"value",textField:"meaning",data:bankBelongData}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}else{if("CREDI"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditCardType"),readonly:true,name:"creditCardType",},{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.tailnumber"),readonly:true,name:"tailNumber"},{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.pos"),readonly:true,name:"paymentMethodInfo",type:"select",options:{valueField:"value",textField:"meaning",data:posSelectData}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}else{if("DBCRD"==d){a=[{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.bank"),readonly:true,name:"bankCode",type:"select",options:{valueField:"value",textField:"meaning",data:bankBelongData}},{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.tailnumber"),readonly:true,name:"tailNumber"},{display:$l("type.com.lkkhpg.dsis.common.om.orderinvalid.pos"),readonly:true,name:"paymentMethodInfo",type:"select",options:{valueField:"value",textField:"meaning",data:posSelectData}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),readonly:true,name:"transactionNumber"}]}}}var c=document.createElement("div");$(b).append(c);$(c).css("margin",10).ligerForm({width:"90%",data:e,fields:a})}function confirmReceive(){var a=om_oc_form.getData();var b={headerId:a.headerId,remark:a.remark,orderStatus:"COMP"};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(b),success:function(c){location.reload()},contentType:"application/json; charset=utf-8"})}function o_getShowLineColumns(a,k,b,c){defaultItemSalesType="PURC";var h={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitsellingprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(l){if(!l){return}if(!l.unitOrigPrice){l.unitOrigPrice=0;return"0"}l.tax=l.unitOrigPrice*summary.taxRate;return Number(l.unitOrigPrice).toFixed(summary.precision)}};var g={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(l){if(!l){return}if(!l.quantity){l.quantity=1}if(!l.unitOrigPrice){l.unitOrigPrice=0}return Number(l.unitOrigPrice*l.quantity).toFixed(summary.precision)}};var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(l){if(!l){return}for(var m in productSalesTypeData){if(l.itemSalesType==productSalesTypeData[m].value){return productSalesTypeData[m].meaning}}}};if(k){h={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitredeempoint"),name:"unitRedeemPoint",align:"center",type:"text"};g={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",align:"center",type:"text",render:function(l){if(!l){return}if(!l.quantity){l.quantity=1}if(!l.unitRedeemPoint){l.unitRedeemPoint=0}return Number(l.unitRedeemPoint*l.quantity).toFixed(summary.precision)}}}var f=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverystatus"),name:"status",width:100,type:"select",render:function(l){for(var m in linesdeliverystatus){if(l.status==linesdeliverystatus[m].value){return linesdeliverystatus[m].meaning}}}},e,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemId",align:"center",width:200,textField:"itemNumber"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pv"),name:"pv",align:"center",type:"text",render:function(l){if(!l){return}if(!l.pv){l.pv=0;return}if(l.pv==0){return"0"}return Number(l.pv).toFixed(summary.precision)}},h,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitdiscountprice"),name:"unitDiscountPrice",align:"center",type:"float",render:function(l){if(!l){return}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"float",editor:{type:"float",onChanged:function(l){if(l.value>99999){l.record.quantity=99999}else{if(l.value<1){l.record.quantity=1}}f_setLinePrice(l.record)},minValue:1,maxValue:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountprice"),name:"favorableSum",align:"center",type:"float",render:function(l){if(!l){return}if(!l.favorableSum||l.favorableSum==0){return"0"}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pvsum"),name:"PVSum",align:"center",type:"text",render:function(l){if(!l){return}if(!l.pv){l.pv=0;return}if(!l.quantity){l.quantity=1}l.PVSum=l.pv*l.quantity;if(!l.PVSum||l.PVSum==0){return"0"}return Number(l.PVSum).toFixed(summary.precision)}},g];if(a){var d={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"tax",align:"center",type:"float",render:function(l){if(!l){return}if(l.disableTaxFlag&&l.disableTaxFlag=="Y"){if(marketCode=="CA"&&l.itemNumber=="15160502"){l.tax=l.unitOrigPrice*0.07}else{l.tax=l.unitOrigPrice*summary.taxRate}}else{l.tax=0}return Number(l.tax).toFixed(summary.precision)}};f.splice(5,0,d)}if(!c){var i={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:200,type:"text",render:function(m){if(!m){return}for(var l in invOrgs){if(m.defaultInvOrgId==invOrgs[l].invOrgId){return invOrgs[l].name}}}};f.unshift(i)}var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverystatus"),name:"status",width:100,type:"select",render:function(l){for(var m in linesdeliverystatus){if(l.status==linesdeliverystatus[m].value){return linesdeliverystatus[m].meaning}}}};if(liger.get("orderStatus").getValue()=="COMP"){f.unshift(j)}return f}function o_lineShowGridOptions(b){var a={detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},columns:o_getShowLineColumns(true,false,true,b),usePager:false,width:"98%"};return a}function o_ShowaddressGridOptions(c){var a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivebillsname");if(c){a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivegoodsname")}var b={usePager:false,checkbox:false,enabledEdit:false,width:"98%",columns:[{display:a,name:"name",type:"text",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.phone"),name:"phone",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.address"),name:"address",align:"center",width:400,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.spmlocation.zipcode"),name:"spmLocation.zipCode",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.defaultflag"),name:"defaultFlag",align:"center",type:"text"}]};return b}function showShippingTier(){var g=liger.get("deliveryCompany").getValue();if(!g){return}var h=liger.get("deliveryCompany").getText();var a=liger.get("deliveryCompany").options.data;var f;var e={};for(var d in a){if(a[d].shippingTierId==g){e.rows=a[d].shippingTierDtls;f=a[d];break}}var c;var b=_basePath+"/dm/shippingTier/showShippingTierFee?shippingTireId="+g+"&feeCalcluateType=AMT";if(f.feeCalcluateType=="WEG"){b=_basePath+"/dm/shippingTier/showShippingTierFee?shippingTireId="+g+"&feeCalcluateType=WEG";c=[{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtier.weightfrom"),name:"weightFrom",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtier.weightto"),name:"weightTo",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtierdtl.shippingfee"),name:"fee",align:"center",type:"text"}]}else{c=[{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtierdtl.invamountfrom"),name:"invAmountFrom",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtierdtl.invamountto"),name:"invAmountTo",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.delivery.dto.shippingtierdtl.shippingfee"),name:"shippingFee",align:"center",type:"text"}]}$.ligerDialog.open({target:$("#showShippingTier"),title:$l("type.com.lkkhpg.dsis.common.delivery.dto.shipping.shippingtier"),width:530});$("#showShippingTierGrid").ligerGrid({width:500,title:h,usePager:false,columns:c,url:b});$("#showShippingTierGrid .l-panel-header-text").text(h)}function initUpdatePeriod(){var a=new Date().getDate();if($.inArray(a+"",bonusDate)<0){$("#periodBtn").hide();return}var b;$.getJSON(_basePath+"/om/check_order_period?orderId="+$("#headerId").val(),function(c){if(c.success){b=c.rows}});if(!b||b.length<2){$("#periodBtn").hide();return}$("#updatePeriodFrom").ligerForm({fields:[{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paydate"),name:"updatePayDate",format:"yyyy-MM-dd",width:100,options:{cancelable:false,onChangeDate:function(c){selectPayDate(this)}},validate:{required:true},newline:false},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),name:"updatePeriod",newline:false,width:100,options:{valueFieldID:"updatePeriod",valueField:"periodId",textField:"periodName",cancelable:false,autocomplete:false,data:b},validate:{required:true}},{type:"hidden",name:"updateHeaderId"}],space:10});$("#periodBtn").ligerButton({click:function(){liger.get("updatePayDate").setValue(new Date());liger.get("updatePeriod").setValue($("#periodId").val());liger.get("updatePeriod").setText(liger.get("period").getText());$("#updateHeaderId").val($("#headerId").val());$.ligerDialog.open({target:$("#updatePeriod"),title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),width:500,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,e){if(!Hap.validateForm($("#updatePeriodFrom"))){return}$.ligerDialog.confirm($l("msg.warning.member.confirm_tip"),function(f){if(f){var d={};d.headerId=$("#updateHeaderId").val();d.periodId=liger.get("updatePeriod").getValue();d.payDate=liger.get("updatePayDate").getValue();$.ajax({url:_basePath+"/om/update_period_paydate",type:"POST",dataType:"json",data:d,success:function(g){if(g.success){liger.get("payDate").setValue(d.payDate);liger.get("period").setText(liger.get("updatePeriod").getText());$("#periodId").val(d.periodId);$.ligerDialog.success($l("sys.hand.tip.success"),function(){});e.hide()}}})}})}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){e.hide()}}]})},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period")})}function selectPayDate(b){var f=liger.get("updatePeriod").data;var c=new Date().getTime();if(b.getValue().getTime()>c||b.getValue().getTime()<getLastMonthFirstDay()){Hap.showError($l("msg.error.payment_date_can_be_modified_to_last_months_one_to_the_current_date"));if(liger.get("payDate").getValue()){liger.get("updatePayDate").setValue(new Date(liger.get("payDate").getValue()))}else{liger.get("updatePayDate").setValue(new Date())}}var a=liger.get("updatePayDate").currentDate;var d=a.year;if(a.month<10){d+="0"+a.month}else{d+=""+a.month}var g=false;for(var e in f){if(f[e].periodName==d){g=true;liger.get("updatePeriod").setValue(f[e].periodId);liger.get("updatePeriod").setText(d);break}}if(!g){liger.get("updatePayDate").setValue(new Date(liger.get("payDate").getValue()))}}function getLastMonthFirstDay(){var a=new Date();var c=a.getFullYear();var d=a.getMonth();var b=new Date(c,d-1,1);return b}function queryItemTaxRate(j,g){var f=getOrderSites();var h=liger.get("salesOrgId").getValue();var b=liger.get("deliveryType").getValue();var d=null;for(var e in f){if(f[e].siteType=="SHIP"){d=f[e]}}var c=_basePath+"/om/autoship/querytax?salesOrgId="+h+"&deliveryType="+b+"&salesType="+g;if(!d){b="";c=_basePath+"/om/autoship/querytax?salesOrgId="+h+"&deliveryType="+b+"&salesType="+g}else{var a=d.zipCode;if(!d.zipCode){a=""}c=c+"&countryCode="+d.countryCode+"&cityCode="+d.cityCode+"&stateCode="+d.stateCode+"&zipCode="+a}$.ajax({url:c,type:"POST",async:false,contentType:"application/json; charset=utf-8",success:function(i){if(i.success){summary.priceIncludeTax=i.rows[0].priceInclueTax;summary.taxLocal=i.rows[0].taxLocal;if(i.rows[0].enableTax=="Y"){summary.enableTax=true}else{summary.enableTax=false}if(summary.enableTax&&!summary.priceIncludeTax){linegrid.toggleCol("taxAmt",true)}else{linegrid.toggleCol("taxAmt",false)}if(summary.enableTax==true){$("#salesLineSummary tr:eq(1)").show()}else{$("#salesLineSummary tr:eq(1)").hide()}taxRateList=i.rows[1];priceStandard=i.rows[2];if(j&&j==true){f_calculateLinePrice(false)}}}})}function changeDeliveryType(){var a=liger.get("deliveryType");type=a.getValue();if(type=="PCKUP"){$("#addressPanel").hide();queryItemTaxRate(true);linegrid.reRender();summary.shippingTier=0;summary.shippingTierTax=0;$("#shippingTier").text(summary.shippingTier);$("#shippingTierTax").text(summary.shippingTierTax);f_summaryTotal()}else{if(type=="SHIPP"){$("#addressPanel").show();queryItemTaxRate(true);linegrid.reRender();f_queryShippingTier(deliveryaddress.getSelectedRow());f_summaryTotal()}}}function pickUpChange(b){var a=liger.get("salesOrgId").getValue();$.ajax({url:_basePath+"/om/autoship/querytaxForPickup?salesOrgId="+a+"&salesType="+b,type:"POST",async:false,contentType:"application/json; charset=utf-8",success:function(c){if(c.success){summary.priceIncludeTax=c.rows[0].priceInclueTax;summary.taxLocal=c.rows[0].taxLocal;if(c.rows[0].enableTax=="Y"){summary.enableTax=true}else{summary.enableTax=false}if(summary.enableTax&&!summary.priceIncludeTax){linegrid.toggleCol("taxAmt",true)}else{linegrid.toggleCol("taxAmt",false)}if(summary.enableTax==true){$("#salesLineSummary tr:eq(1)").show()}else{$("#salesLineSummary tr:eq(1)").hide()}taxRateList=c.rows[1];priceStandard=c.rows[2];f_calculateLinePrice(false);summary.shippingTier=0;summary.shippingTierTax=0;$("#shippingTier").text(summary.shippingTier);$("#shippingTierTax").text(summary.shippingTierTax);f_summaryTotal()}}})}function validateZipCode(){var f=false;var b;var d;var e=deliveryaddress.getSelectedRow();var c=liger.get("deliveryType").getValue();if(zipTaxFlag=="Y"){if(c=="SHIPP"&&e){if(liger.get("memberId").getValue()&&e.memberId){b=e.spmLocation.zipCode;d=e.spmLocation.cityCode}else{b=e.zipCode;d=e.cityCode}if((typeof(b)=="undefined"||b==null||b=="")){Hap.showError($l("msg.error.delivery_address_zipcode_cannot_be_empty"));return false}f=false;if(typeof(d)=="undefined"||d==null||d==""){zipCodeList=null}else{$.ajax({url:_basePath+"/spm/zip/queryforlocation",type:"GET",async:false,dataType:"json",contentType:"application/json",data:{cityCode:d},success:function(g){zipCodeList=g.rows},error:function(){$.ligerDialog.closeWaitting()}})}if(zipCodeList!=null&&typeof(zipCodeList)!="undefined"){for(var a=0;a<zipCodeList.length;a++){if(b==zipCodeList[a].zipCode){f=true}}}if(!f){Hap.showError($l("msg.error.delivery_address_zipcode_invalid"));return false}}f=false;$.ajax({type:"POST",async:false,url:_basePath+"/spm/location/validate?salesOrgId="+defaultSaleOrg,success:function(g){var h=g.rows;if(h&&h[0].zipCode){f=true;b=h[0].zipCode;d=h[0].cityCode}},contentType:"application/json; charset=utf-8"});if(!f){Hap.showError($l("msg.error.sales_organizaition_zipcode_is_empty"));return false}f=false;if(typeof(d)=="undefined"||d==null||d==""){zipCodeList=null}else{$.ajax({url:_basePath+"/spm/zip/queryforlocation",type:"GET",async:false,dataType:"json",contentType:"application/json",data:{cityCode:d},success:function(g){zipCodeList=g.rows},error:function(){$.ligerDialog.closeWaitting()}})}if(zipCodeList!=null&&typeof(zipCodeList)!="undefined"){for(var a=0;a<zipCodeList.length;a++){if(b==zipCodeList[a].zipCode){f=true}}}if(!f){Hap.showError($l("msg.error.sales_organizaition_zipcode_invalid"));return false}}return true}function f_valiItemMemberRole(h,a,d,i){var f="";if(a&&!d){var g=new Array();var e=linegrid.rows;for(var c=0;c<e.length;c++){if(e[c].itemId){var b=e[c].purchaseMember.split(";");if($.inArray(h,b)<0){f+=e[c].itemNumber+";";g.push(e[c])}}}linegrid.deleteRange(g)}if(!a&&d){var b=i.purchaseMember.split(";");if($.inArray(h,b)<0){f=i.itemNumber+";"}}if(f){$.ligerDialog.warn("["+f.substring(0,f.length-1)+"]"+$l("type.com.lkkhpg.dsis.common.order.salesline.purchasemember.error"));return false}return true}function selectEinvoiceMethod(a){$("#paperInvoice").ligerRadio().setEnabled();$("#recordedInVehicle").ligerRadio().setEnabled();$("#donatedInvoice").ligerRadio().setEnabled();$("#phoneCodeOfVehicle").ligerRadio().setEnabled();$("#naturalPersonCodeOfVehicle").ligerRadio().setEnabled();if(memberType){getInvoiceMethod(marketCode,memberType);if(typeof(invoiceMethod)=="undefined"||invoiceMethod==null||invoiceMethod.eInvoice!="Y"){return}if(!invoiceMethod.paperInvoice||invoiceMethod.paperInvoice!="Y"){$("#paperInvoice").ligerRadio().setDisabled()}if(invoiceMethod.recordedInVehicle!=null){if(invoiceMethod.recordedInVehicle.phoneBarCode=="N"){$("#phoneCodeOfVehicle").ligerRadio().setDisabled()}if(invoiceMethod.recordedInVehicle.naturalCode=="N"){$("#naturalPersonCodeOfVehicle").ligerRadio().setDisabled()}}else{$("#recordedInVehicle").ligerRadio().setDisabled()}if(invoiceMethod.donateInvoice==null||invoiceMethod.donateInvoice.loveCode!="Y"){$("#donatedInvoice").ligerRadio().setDisabled()}if(a=="2"){if(invoiceMethod.recordedInVehicle&&invoiceMethod.recordedInVehicle.phoneBarCode=="Y"){$("#phoneCodeOfVehicle").ligerRadio().setEnabled()}if(invoiceMethod.recordedInVehicle&&invoiceMethod.recordedInVehicle.naturalCode=="Y"){$("#naturalPersonCodeOfVehicle").ligerRadio().setEnabled()}}}if(a=="3"){$("#paperInvoice").ligerRadio().setValue(false);$("#recordedInVehicle").ligerRadio().setValue(false);$("#donatedInvoice").ligerRadio().setValue(true);$("#phoneCodeOfVehicle").ligerRadio().setValue(false);$("#naturalPersonCodeOfVehicle").ligerRadio().setValue(false);liger.get("phoneCode").setValue("");liger.get("naturalPersonCode").setValue("");liger.get("phoneCode").set({disabled:true});liger.get("naturalPersonCode").set({disabled:true});liger.get("donateCode").set({disabled:false});$("#donateCode").ligerTextBox({required:true})}else{if(a=="2"){$("#paperInvoice").ligerRadio().setValue(false);$("#recordedInVehicle").ligerRadio().setValue(true);$("#donatedInvoice").ligerRadio().setValue(false);selectRecordedInVehicle(carrierType);$("#phoneCodeOfVehicle").ligerRadio().setEnabled();if(!memberType||memberType!="COMP"){$("#naturalPersonCodeOfVehicle").ligerRadio().setEnabled()}liger.get("donateCode").setValue("");liger.get("donateCode").set({disabled:true})}else{isCarrierCodeValidSuccess=true;$("#paperInvoice").ligerRadio().setValue(true);$("#recordedInVehicle").ligerRadio().setValue(false);$("#donatedInvoice").ligerRadio().setValue(false);$("#phoneCodeOfVehicle").ligerRadio().setValue(false);$("#naturalPersonCodeOfVehicle").ligerRadio().setValue(false);liger.get("phoneCode").setValue("");liger.get("naturalPersonCode").setValue("");liger.get("donateCode").setValue("");liger.get("phoneCode").set({disabled:true});liger.get("naturalPersonCode").set({disabled:true});liger.get("donateCode").set({disabled:true})}}var b=liger.get("autoshipStatus").getValue();if(b=="SUS"||b=="TER"){liger.get("paperInvoice").setDisabled(true);liger.get("recordedInVehicle").setDisabled(true);liger.get("donatedInvoice").setDisabled(true);liger.get("phoneCodeOfVehicle").setDisabled(true);liger.get("naturalPersonCodeOfVehicle").setDisabled(true);liger.get("phoneCode").set({readonly:true});liger.get("naturalPersonCode").set({readonly:true});liger.get("donateCode").set({readonly:true})}}function selectRecordedInVehicle(a){$("#paperInvoice").ligerRadio().setValue(false);$("#recordedInVehicle").ligerRadio().setValue(true);$("#donatedInvoice").ligerRadio().setValue(false);liger.get("donateCode").setValue("");liger.get("donateCode").set({disabled:true});if(a=="22"){$("#phoneCodeOfVehicle").ligerRadio().setValue(false);$("#naturalPersonCodeOfVehicle").ligerRadio().setValue(true);liger.get("phoneCode").setValue("");liger.get("phoneCode").set({disabled:true});liger.get("naturalPersonCode").set({disabled:false});$("#naturalPersonCode").ligerTextBox({required:true})}else{$("#phoneCodeOfVehicle").ligerRadio().setValue(true);$("#naturalPersonCodeOfVehicle").ligerRadio().setValue(false);liger.get("naturalPersonCode").setValue("");liger.get("naturalPersonCode").set({disabled:true});liger.get("phoneCode").set({disabled:false});$("#phoneCode").ligerTextBox({required:true})}}function f_getEinvoiceCarrier(b){if(enableEinvoice!="Y"){return null}var a=new Object();if(b.einvoiceCarrier){a.einvoiceCarrierId=b.einvoiceCarrier.einvoiceCarrierId}a.memberId=b.memberId;a.orderId=b.autoshipId;a.orderType="AUTOSHIP";if($("#donatedInvoice").ligerRadio().getValue()){a.carrierType="31";a.carrierCode=$("#donateCode").ligerGetTextBoxManager().getValue()}else{if($("#recordedInVehicle").ligerRadio().getValue()){if($("#phoneCodeOfVehicle").ligerRadio().getValue()){a.carrierType="21";a.carrierCode=$("#phoneCode").ligerGetTextBoxManager().getValue()}else{a.carrierType="22";a.carrierCode=$("#naturalPersonCode").ligerGetTextBoxManager().getValue()}}else{return null}}return a}function getInvoiceMethod(a,b){$.ajax({url:_basePath+"/om/autoship/invoicemethod?marketCode="+a+"&memberType="+b,type:"POST",dataType:"json",async:false,contentType:"application/json",success:function(c){if(c&&c.rows&&c.rows.length>0){invoiceMethod=c.rows[0]}else{invoiceMethod=null}}})}function setCarrierTextBlurEvent(){$("#phoneCode").bind("change",function(){var a=liger.get("phoneCode").getValue().trim();isCarrierCodeValidSuccess=false;carrierCodeValidation(21,a)});$("#naturalPersonCode").bind("change",function(){var a=liger.get("naturalPersonCode").getValue().trim();isCarrierCodeValidSuccess=false;carrierCodeValidation(22,a)});$("#donateCode").bind("change",function(){var a=liger.get("donateCode").getValue().trim();isCarrierCodeValidSuccess=false;carrierCodeValidation(31,a)})}function carrierCodeValidation(d,e){if(!e){return}var c=new RegExp("^[A-Za-z0-9/]+$");var b=new RegExp("^[A-Za-z0-9]+$");if(d=="21"){if(!c.test(e)||e=="/"){Hap.showError($l("msg.error.einvoice.carriercode.include_special_char"));return}}else{if(!b.test(e)){Hap.showError($l("msg.error.einvoice.carriercode.include_special_char"));return}}var a=$.ligerDialog.waitting($l("msg.info.einvoice.carrier_code_validating"));Hap.ajax({url:_basePath+"/om/carrier/validation?carrierType="+d+"&code="+encodeURIComponent(e),success:function(f){isCarrierCodeValidSuccess=true;if(d=="21"){Hap.showSuccess($l("msg.info.einvoice.phone_code_validate_success"))}else{if(d=="22"){Hap.showSuccess($l("msg.info.einvoice.natural_code_validate_success"))}else{if(d=="31"){Hap.showSuccess($l("msg.info.einvoice.love_code_validate_success"))}}}}})};