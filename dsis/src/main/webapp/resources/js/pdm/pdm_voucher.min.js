var voucher={version:"1.0",vouchers:[],memberId:"",salesOrgId:"",discountAmt:"",notavalilable:false,hasUnStackableVoucher:false,appliedVouchers:[],availableVouchers:[]};$(function(){$(document).on("click",".addCoupon",function(){if(voucher.notavalilable){$.ligerDialog.error($l("msg.warn.pdm.voucher.notavalilablevoucher"));return}if(voucher.hasUnStackableVoucher){$.ligerDialog.error($l("msg.warn.pdm.voucher.unstackable"));return}var a=$("#couponsAdjust table tr").length+1;var d="<div style='float: left; margin-right: 5px'><input id='coupons"+a+"' name='coupons'/><input type='hidden' name='couponsid' id='couponsid'>";d+="</div>";var c=$(this).parents("tr");var b=c.clone();b.find(":input").val("");b.find(".addCoupon").hide();b.find(".subCoupon").show();b.find("td:eq(1)").html(d);b.find("td:eq(2)").html("<label id='couponsText"+a+"'>0</label>");c.after(b);$("#coupons"+a).ligerComboBox({css:"combobox",valueField:"voucherId",textField:"name",cancelable:false,autocomplete:false,focusWhenSetValue:false,onBeforeOpen:function(f){setAvailableVouchers(this,a)},onBeforeSelect:function(g,h,f){var e=this.getValue();if(e){if(e!=g){changeVoucher(this.getSelected(),f,a)}}else{selectVoucher(f,a)}}})});$(document).on("click",".subCoupon",function(){var a=$(this).parents("tr");var b=a.find("input[id^='coupons']").attr("id");if(liger.get(b).getSelected()){removeVoucher(liger.get(b).getSelected())}if(b=="coupons"){liger.get(b).clear();$("#couponsText").text("0");return}a.remove()})});function getAllAvailableVouchers(a){voucher.memberId=a||liger.get("memberId").getValue();voucher.salesOrgId=liger.get("salesOrgId").getValue();var b=_basePath+"/pdm/voucher/getByMember";if(liger.get("orderType").getValue()!="NMDP"){b=b+"?memberId="+voucher.memberId+"&salesOrgId="+voucher.salesOrgId}$.ajax({type:"GET",url:b,contentType:"application/json; charset=utf-8",success:function(e){if(e.success){var c=linegrid.getData();voucher.vouchers=e.rows;for(var d in e.rows){if(e.rows[d].quantity>0&&validateVoucher(e.rows[d],c)){e.rows[d].surplus=e.rows[d].quantity;voucher.availableVouchers.push(e.rows[d])}}if(voucher.availableVouchers.length<1){voucher.notavalilable=true}setAvailableVouchers(liger.get("coupons"),0)}}})}function getAppliedVouchers(){var b=[];var c=$("#couponsAdjust table tr").length;if(liger.get("coupons").getSelected()){b.push(liger.get("coupons").getSelected())}if(c==1){return b}for(var a=1;a<c;a++){b.push(liger.get("coupons"+(a+1)).getSelected())}return b}function setAvailableVouchers(c,l,n){var a=[];var e=$("#couponsAdjust table tr").length;for(var h in voucher.availableVouchers){if(!n){if(voucher.availableVouchers[h].applyCriteria=="PRODU"){continue}}else{if(voucher.availableVouchers[h].applyCriteria=="INVOI"){continue}}if(voucher.availableVouchers[h].usageMode=="NSTAC"){if(voucher.appliedVouchers.length>=1&&!voucher.hasUnStackableVoucher&&e>1){continue}}var d=-1;for(var f in voucher.appliedVouchers){if(voucher.appliedVouchers[f].voucherId==voucher.availableVouchers[h].voucherId){d=f;break}}if(d>=0){var g=voucher.appliedVouchers[d];if(g.surplus>0){if(voucher.availableVouchers[h].applyCriteria=="INVOI"&&voucher.availableVouchers[h].type=="AM"){var b=0;if(c.getSelected()){if(l==0){b=Number($("#couponsText").text()).toFixed(summary.precision)}else{b=Number($("#couponsText"+l).text()).toFixed(summary.precision)}summary.discountAmt=summary.discountAmt-Number(b)}if(validateVoucher(voucher.availableVouchers[h])){a.push(voucher.availableVouchers[h])}summary.discountAmt=summary.discountAmt+Number(b)}else{a.push(voucher.availableVouchers[h])}}}else{if(voucher.availableVouchers[h].applyCriteria=="INVOI"&&voucher.availableVouchers[h].type=="AM"){var b=0;if(c.getSelected()){if(l==0){b=Number($("#couponsText").text()).toFixed(summary.precision)}else{b=Number($("#couponsText"+l).text()).toFixed(summary.precision)}summary.discountAmt=summary.discountAmt-Number(b)}if(validateVoucher(voucher.availableVouchers[h])){a.push(voucher.availableVouchers[h])}summary.discountAmt=summary.discountAmt+Number(b)}else{a.push(voucher.availableVouchers[h])}}}if(c.getSelected()){var k=false;var m=c.getSelected();for(var h in a){if(a[h].voucherId==m.voucherId){k=true;break}}if(!k){a.push(c.getSelected())}}if(a.length>=1){c.set({data:a})}else{voucher.notavalilable=true;c.setText($l("msg.warn.pdm.voucher.notavalilablevoucher"))}return a}function validateVoucher(f,a){if(f.applyCriteria=="INVOI"&&f.type=="AM"){var g;if(f.useCriteria=="ECLD"){g=summary.currency-summary.discountAmt-summary.tax}else{g=summary.currency-summary.discountAmt}if(f.operation=="MT"&&g>f.orderAmount){return true}else{if(f.operation=="MOE"&&g>=f.orderAmount){return true}else{if(f.operation=="LT"&&g<f.orderAmount){return true}else{if(f.operation=="LOE"&&g<=f.orderAmount){return true}else{if(f.operation=="EQL"&&f.orderAmount==g){return true}else{return false}}}}}}else{if(f.applyCriteria=="INVOI"&&f.type=="NM"){for(var d in f.pdmVoucherItems){var e=f.pdmVoucherItems[d];var b=false;for(var c in a){if(a[c].itemId==e.itemId&&a[c].quantity>=e.quantity){b=true;break}}if(!b){return false}}return true}else{if(f.applyCriteria=="PRODU"&&f.type=="PD"){for(var d in f.pdmVoucherItems){var e=f.pdmVoucherItems[d];var b=false;for(var c in a){if(a[c].itemId==e.itemId&&a[c].quantity>=e.quantity){return true}}}return false}else{return false}}}}function selectVoucher(b,a){if(b.applyCriteria=="INVOI"){if(b.usageMode=="NSTAC"){voucher.hasUnStackableVoucher=true}var e=false;for(var c in voucher.appliedVouchers){if(voucher.appliedVouchers[c].voucherId==b.voucherId){e=true;voucher.appliedVouchers[c].surplus=voucher.appliedVouchers[c].surplus-1;break}}if(!e){b.surplus=b.surplus-1;voucher.appliedVouchers.push(b)}if(b.discountType=="FIX"){if(a==0){$("#couponsText").html("-"+b.discountValue)}else{if(a&&a>0){$("#couponsText"+a).html("-"+b.discountValue)}}summary.discountAmt=summary.discountAmt+b.discountValue;if(summary.discountAmt>summary.currency){$.ligerDialog.error($l("msg.error.pdm.voucher.morethenorderamount"))}else{if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){if(Number((summary.currency+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}else{if(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}}}else{if(b.discountType=="PERCE"){var d=Number(((summary.currency-summary.discountAmt)*(b.discountValue/100)).toFixed(summary.precision));summary.discountAmt=summary.discountAmt+d;if(a==0){$("#couponsText").html("-"+d)}else{if(a&&a>0){$("#couponsText"+a).html("-"+d)}}if(summary.discountAmt>summary.currency){$.ligerDialog.error($l("msg.error.pdm.voucher.morethenorderamount"));removeVoucher(b,a);return}else{if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){if(Number((summary.currency+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}else{if(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}}}else{if(b.discountType=="GIFT"){}}}return}else{var e=false;for(var c in voucher.appliedVouchers){if(voucher.appliedVouchers[c].voucherId==b.voucherId){e=true;voucher.appliedVouchers[c].surplus=voucher.appliedVouchers[c].surplus-1;break}}if(!e){b.surplus=b.surplus-1;voucher.appliedVouchers.push(b)}}}function changeVoucher(b,c,a){removeVoucher(b,a);selectVoucher(c,a)}function removeVoucher(e,a){var d=false;if(e.usageMode=="NSTAC"){voucher.hasUnStackableVoucher=false}for(var c in voucher.appliedVouchers){if(voucher.appliedVouchers[c].voucherId==e.voucherId){voucher.appliedVouchers[c].surplus=voucher.appliedVouchers[c].surplus+1;if(voucher.appliedVouchers[c].surplus<=voucher.appliedVouchers[c].quantity){if(voucher.appliedVouchers[c].surplus==voucher.appliedVouchers[c].quantity){voucher.appliedVouchers.splice(c,1)}d=true}break}}if(d){var b=false;for(var c in voucher.availableVouchers){if(voucher.availableVouchers[c].voucherId==e.voucherId){b=true;break}}if(!b){voucher.availableVouchers.push(e)}}if(e.discountType=="FIX"){summary.discountAmt=summary.discountAmt-e.discountValue;if(summary.discountAmt<0){summary.discountAmt=0}if(summary.discountAmt>summary.currency){$.ligerDialog.error($l("msg.error.pdm.voucher.morethenorderamount"))}else{if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){if(Number((summary.currency+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}else{if(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}}}else{if(e.discountType=="PERCE"){if(a==0){summary.discountAmt=summary.discountAmt-Number($("#couponsText").text()).toFixed(summary.precision)}else{summary.discountAmt=summary.discountAmt-Number($("#couponsText"+a).text()).toFixed(summary.precision)}if(summary.discountAmt<0){summary.discountAmt=0}if(summary.discountAmt>summary.currency){$.ligerDialog.error($l("msg.error.pdm.voucher.morethenorderamount"))}else{if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){if(Number((summary.currency+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}else{if(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}}}else{if(e.discountType=="GIFT"){}}}return}function getUseVoucher(){var d=[];for(var c in voucher.appliedVouchers){var a=voucher.appliedVouchers[c];for(var b=a.surplus;b<a.quantity;b++){d.push(a)}}return d}function setUseVouchers(f){if(!f){return}var e;if(f[0]){e=$("#coupons").parents("tr");e.find("td:eq(1)").html(f[0].name);if(f[0].discountType=="FIX"){summary.discountAmt=summary.discountAmt+f[0].discountValue;e.find("td:eq(2)").html("-"+f[0].discountValue)}else{if(f[0].discountType=="PERCE"){var c=Number((orderDetail.orderAmt*(selectVoucher.discountValue/100)).toFixed(summary.precision));summary.discountAmt=summary.discountAmt+c;e.find("td:eq(2)").html("-"+c)}}}else{return}if(f.length>1){var a=$("#couponsAdjust table tr").length+1;for(var b=1;b<f.length;b++){var d=e.clone();d.find("td:eq(1)").html(f[b].name);if(f[0].discountType=="FIX"){summary.discountAmt=summary.discountAmt+f[b].discountValue;d.find("td:eq(2)").html("-"+f[b].discountValue)}else{if(f[0].discountType=="PERCE"){var c=Number((orderDetail.orderAmt*(selectVoucher.discountValue/100)).toFixed(summary.precision));summary.discountAmt=summary.discountAmt+c;d.find("td:eq(2)").html("-"+c)}}e.after(d)}}if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){if(Number((summary.currency+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}else{if(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt))>=0){$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt)).toFixed(summary.precision))}else{Hap.showError($l("msg.error.om.actual_payment_amount_error"));$("#actrualPayAmt").text("0")}}};