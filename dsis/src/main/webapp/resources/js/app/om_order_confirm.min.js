function clearForm(a){$("#"+a+" :input").each(function(b){$(this).val("")})}function clearGrid(a){a=liger.get(a);if(a.currentData!=null&&a.currentData.length>0){var b=a.currentData.rows;b.splice(0,b.length);a.reRender()}}function f_copy(){$("#copyModelDialog").parent().hide();clearForm("om_oc_form");clearGrid("linegrid");clearGrid("addressgrid");clearForm("delivery");clearForm("payAdjust");liger.get("copyModelDialog").trigger("buttonClick")}function o_memberPupop(){var a={readonly:false,cancelable:false,autocomplete:true,placeholder:$l("msg.warn.order.om_sales_order.fullmembercode"),valueField:"memberId",textField:"memberCode",grid:{delayLoad:true,isSingleCheck:true,needQueryParam:true,columns:[{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberCode",align:"center",isAutoComplete:true,autocompleteField:true,width:200},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"),name:"phoneNo",align:"center",autocompleteField:true,isAutoComplete:false},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"chineseName",isAutoComplete:false,autocompleteField:true,align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"englishName",isAutoComplete:false,autocompleteField:true,align:"center"}],url:_basePath+"/mm/member/query",onLoadData:function(){if(liger.get("orderType")&&liger.get("orderType").getValue()!="NMDP"){this.setParm("marketId",liger.get("salesMarketId").getValue())}else{if(!liger.get("orderType")){this.setParm("marketId",liger.get("salesMarketId").getValue())}}this.setParm("isActive","Y")}},condition:{inputWidth:130,labelWidth:70,fields:[{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"englishName",isAutoComplete:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"chineseName",isAutoComplete:false,newline:false,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberCode",isAutoComplete:true,newline:true,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.phoneno"),name:"phoneNo",align:"center",newline:false,isAutoComplete:false}]},onselect:function(b){f_setMember(b.data[0])}};return a}function o_serviceCenterPupop(){var a={readonly:false,valueField:"serviceCenterId",textField:"name",autocomplete:true,cancelable:false,placeholder:"",grid:{columns:[{display:$l("服务中心号"),name:"code",isAutoComplete:true,autocompleteField:true,type:"int"},{display:$l("服务中心名称"),name:"name",isAutoComplete:false,autocompleteField:true,align:"left",width:200},{display:$l("负责会员"),name:"chargeMemberId",isAutoComplete:false,autocompleteField:true,align:"right"},{display:$l("联系号码"),isAutoComplete:false,autocompleteField:true,name:"phone",align:"right"}],url:_basePath+"/spm/serviceCenterAndMember/query",onLoadData:function(){if(liger.get("orderType")&&liger.get("orderType").getValue()!="NMDP"){this.setParm("marketId",liger.get("salesMarketId").getValue())}else{if(!liger.get("orderType")){this.setParm("marketId",liger.get("salesMarketId").getValue())}}this.setParm("status","ALED")}},condition:{inputWidth:150,labelWidth:100,fields:[{display:$l("服务中心号"),name:"code",newline:true,isAutoComplete:true,type:"text"},{display:$l("服务中心名称"),name:"name",newline:false,isAutoComplete:false,type:"text"}]},onselect:function(c){f_setMember(c.data[0].member);var b=c.data[0].member.memberId;var d=c.data[0].member.memberCode;liger.get("memberId").setValue(b);liger.get("memberId").setText(d)},validate:{required:true}};return a}function o_omCreateFormOptions(){var c=[];for(var b in channelData){if(channelData[b].value=="STORE"||channelData[b].value=="SRVC"||channelData[b].value=="FAX"){c.push(channelData[b])}}var a={fields:[{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.createuserid"),name:"createUserId",newline:false,readonly:true,group:"订单信息"},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesmarket"),name:"salesMarketId",cancelable:false,newline:false,readonly:true},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesorgid"),name:"salesOrgId",newline:false,cancelable:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.currency"),name:"currency",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.ordernumber"),name:"orderNumber",newline:true,readonly:true},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderstatus"),name:"orderStatus",newline:false,readonly:true,options:{valueFieldID:"orderStatus",valueField:"value",textField:"meaning",cancelable:false,data:orderStatusData,onselected:function(d){validatePeriod()}}},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderdate"),newline:false,readonly:true,name:"orderDate"},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paydate"),newline:false,readonly:true,name:"payDate"},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.ordertype"),name:"orderType",newline:true,options:{valueFieldID:"orderType",valueField:"value",textField:"meaning",data:orderTypeData,cancelable:false,onselected:function(f){cleanMember();var d=f;var e=true;if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="SHIPP"){e=false}if(d){switch(d){case"DIRP":case"STFP":case"CONP":if(linegrid){linegrid.set({columns:o_getLineColumns(true,false,e)})}liger.get("memberId").set({readonly:true});liger.get("memberId").setPlaceholder("   ");var g="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderamt")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(g);break;case"RDEM":if(linegrid){linegrid.set({columns:o_getLineColumns(true,true,e)})}liger.get("memberId").setEnabled();liger.get("memberId").set({readonly:false});liger.get("memberId").set({validate:{required:true}});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"));var g="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salespointsummary")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(g);break;default:liger.get("memberId").setEnabled();liger.get("memberId").set({readonly:false});liger.get("memberId").set({validate:{required:true}});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"));if(linegrid){linegrid.set({columns:o_getLineColumns(true,false,e)})}var g="<label class='label1'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderamt")+":</label><label id='TotalCurrency' class='label2'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(g);break}}reSetLine(false,true,false)}},validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.channel"),name:"channel",newline:false,options:{valueFieldID:"channel",valueField:"value",textField:"meaning",cancelable:false,data:c,value:c[0].value,text:c[0].meaning,onSelected:function(e,f,d){if(e=="SRVC"){liger.get("serviceCenterId").set({readonly:false});liger.get("serviceCenterId").set({validate:{required:true}});liger.get("memberId").set({readonly:true});liger.get("memberId").setPlaceholder("   ");liger.get("serviceCenterId").setPlaceholder($l("msg.warn.order.om_sales_order.fullservicecentercode"))}else{liger.get("serviceCenterId").set({readonly:true});liger.get("serviceCenterId").setPlaceholder("   ");liger.get("memberId").set({readonly:false});liger.get("memberId").setPlaceholder($l("msg.warn.order.om_sales_order.fullmembercode"))}reSetLine(false,true,false)},render:function(e){for(var d in channelData){if(channelData[d].value==e){return channelData[d].meaning}}}},validate:{required:true},render:function(e){for(var d in channelData){if(channelData[d].value==e){return channelData[d].meaning}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.period"),name:"period",newline:false,cancelable:false,options:{valueField:"value",textField:"meaning",onBeforeSelect:function(d){return confirm($l("msg.warning.order.payment_date_adjustment")+d)}}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invoicenumber"),name:"invoiceNumber",readonly:true,newline:false},{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberId",type:"popup",newline:true,cancelable:false,options:o_memberPupop(),validate:{required:true},group:"会员信息"},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"cnName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.exchangebalance"),name:"exchangeBalance",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.salesscore"),name:"currentPoints",newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.servicecenter"),name:"serviceCenterId",newline:true,cancelable:false,readonly:false,type:"popup",options:o_serviceCenterPupop(),validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"enName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.remainingbalance"),name:"remainingBalance",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.shortcut_operation.currentmoneypv"),name:"currentPV",newline:false,readonly:true},{type:"textarea",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:false,width:400,group:"备注信息"},{type:"hidden",name:"headerId"},{type:"hidden",name:"logisticsId"},{type:"hidden",name:"periodId"},{type:"hidden",name:"sourceType"}]};return a}function o_autoshipCreateFormOptions(){var c=[];for(var b=0;b<28;b++){c.push({value:b+1,meaning:b+1})}var a={fields:[{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.autoshipordernumber"),name:"autoshipNumber",newline:false,readonly:true,group:"订单信息"},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.autoshiporderstatus"),name:"autoshipStatus",width:150,labelWidth:120,newline:false,cancelable:false,readonly:true,render:function(e){for(var d in autoShipStatusData){if(autoShipStatusData[d].value==e){return autoShipStatusData[d].meaning}}}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.createuserid"),name:"createUserId",newline:false,readonly:true,validate:{required:true}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesmarket"),name:"salesMarketId",newline:false,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.executedate"),name:"executeDate",newline:true,readonly:true},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.executetype"),name:"executeType",newline:false,options:{valueFieldID:"executeType",valueField:"value",textField:"meaning",cancelable:false,data:executeTypeData,value:executeTypeData[0].value,text:executeTypeData[0].meaning,readonly:true,render:function(e){if(!e){return}for(var d in executeTypeData){if(executeTypeData[d].value==e){return executeTypeData[d].meaning}}}}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salesorgid"),name:"salesOrgId",newline:false,cancelable:false,readonly:true,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.currency"),name:"currency",newline:false,readonly:true,validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.user.dto.userinfo.memberid"),name:"memberId",type:"popup",newline:true,options:o_memberPupop(),validate:{required:true},group:"会员信息"},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.chinesename"),name:"cnName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.exchangebalance"),name:"exchangeBalance",width:150,labelWidth:120,newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.shortcut_operation.currentmoneypv"),name:"currentPV",newline:false,readonly:true},{type:"date",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderdate"),newline:true,cancelable:false,readonly:true,format:"yyyy/dd/MM",name:"autoshipCreateDate",validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.englishname"),name:"enName",newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingbalance.remainingbalance"),name:"remainingBalance",width:150,labelWidth:120,newline:false,readonly:true},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.autoshiporder.salesscore"),name:"currentPoints",newline:false,readonly:true},{type:"textarea",display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:true,width:500,group:"备注信息"},{type:"hidden",name:"creditCardId",newline:false,readonly:true},{type:"hidden",name:"autoshipId",newline:false,readonly:true},{type:"hidden",name:"logisticsId"}]};return a}function o_itemPupop(){var a={type:"popup",cancelable:false,autocomplete:true,valueField:"itemNumber",textField:"itemNumber",grid:{isSingleCheck:true,columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",isAutoComplete:true,autocompleteField:true,align:"left",width:200},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",isAutoComplete:false,autocompleteField:true,align:"right",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.product.invitem.dto.description"),name:"description",isAutoComplete:false,autocompleteField:true,align:"right",type:"text"}],url:_basePath+"/inv/item/queryForOrder",onLoadData:function(){if(liger.get("channel")){this.setParm("isActive","Y");var b=liger.get("channel").getValue();if(b=="FAX"){this.setParm("channel","FAX")}else{if(b=="DISWB"){this.setParm("channel","WEB")}else{if(b=="DISAP"){this.setParm("channel","APP")}else{if(b=="AUTOS"){this.setParm("channel","AUTOS")}else{this.setParm("channel","STORE")}}}}}else{this.setParm("channel","AUTOS")}var c=f_getPriceType();if(c!="0"){this.setParm("priceType",c);this.setParm("currency",liger.get("currency").getValue())}if(c=="RP"){this.setParm("redeemFlag","Y")}if(memberStatus&&memberRole&&memberStatus=="NEW"&&memberRole=="DIS"){this.setParm("starterAid","Y")}this.setParm("salesOrgId",liger.get("salesOrgId").getValue())}},condition:{inputWidth:150,labelWidth:70,fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",isAutoComplete:true,newline:true,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",isAutoComplete:false,newline:false,type:"text"}]},onselect:function(c){var b=linegrid.getSelected();if(!b){return}f_setLine(b,c.data[0])}};return a}function o_getLineColumns(a,o,b,c){defaultItemSalesType="PURC";var m={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitsellingprice"),name:"unitOrigPrice",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.unitOrigPrice){i.unitOrigPrice=0;return"0"}if(i.itemSalesType&&i.itemSalesType=="FREE"){i.unitOrigPrice=0;return"0"}i.tax=i.unitOrigPrice*summary.taxRate;return Number(i.unitOrigPrice).toFixed(2)}};var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.amount"),name:"amount",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.quantity){i.quantity=1}if(!i.unitOrigPrice){i.unitOrigPrice=0}if(i.itemSalesType&&i.itemSalesType=="FREE"){i.unitOrigPrice=0}return Number(i.unitOrigPrice*i.quantity).toFixed(2)}};var f={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemsalestype"),name:"itemSalesType",isSort:false,render:function(i){if(!i){return}for(var p in productSalesTypeData){if(i.itemSalesType==productSalesTypeData[p].value){return productSalesTypeData[p].meaning}}},validate:{required:true}};if(!c){var k=new Array();var d=new Array();var l=liger.get("orderType").getValue();switch(l){case"STDP":d.push("PURC");d.push("EXCH");d.push("FREE");defaultItemSalesType="PURC";break;case"BIGF":d.push("GIFT");defaultItemSalesType="GIFT";break;case"RDEM":d.push("REDE");defaultItemSalesType="REDE";break;default:d.push("PURC");defaultItemSalesType="PURC";break}for(var h in productSalesTypeData){if($.inArray(productSalesTypeData[h].value,d)>=0){k.push(productSalesTypeData[h])}}f.editor={type:"select",valueField:"value",textField:"meaning",cancelable:false,data:k,value:k[0].value,text:k[0].meaning,onChanged:function(r){if(l=="STDP"&&r.record.itemSalesType=="PURC"){if(r.record.pv){return}var q=r.record.priceDetail;if(!q){var s={itemId:r.record.itemId,currency:liger.get("currency").getValue(),uomCode:r.record.uomCode,salesOrgId:defaultSaleOrg};$.getJSON(_basePath+"/inv/price/queryPriceByItemId?",s,function(u){q=u.rows;r.record.priceDetail=u.rows;for(var t in q){if(q[t].priceType=="PV"){r.record.pv=q[t].unitPrice}}})}else{for(var p in q){if(q[p].priceType=="PV"){r.record.pv=q[p].unitPrice}}}}else{if(r.record.itemSalesType=="FREE"){r.record.unitOrigPrice=0}}f_setLinePrice(r.record)}}}if(o){m={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitredeempoint"),name:"unitRedeemPoint",align:"center",type:"text"};j={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",align:"center",type:"text",render:function(i){if(!i||!i.itemId){return}if(!i.quantity){i.quantity=1}if(!i.unitRedeemPoint){i.unitRedeemPoint=0}return Number(i.unitRedeemPoint*i.quantity).toFixed(2)}}}var g=[f,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",align:"center",width:200,textField:"itemNumber",editor:o_itemPupop(),validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pv"),name:"pv",align:"center",type:"text",render:function(s){if(!s||!s.itemId){return}if(!s.pv){s.pv=0;return}var p="STDP";if(liger.get("orderType")){p=liger.get("orderType").getValue()}if(p=="STDP"&&s.itemSalesType=="PURC"){if(s.pv){return s.pv}var r=s.priceDetail;if(!r){var t={itemId:s.itemId,currency:liger.get("currency").getValue(),uomCode:s.uomCode,salesOrgId:defaultSaleOrg};$.getJSON(_basePath+"/inv/price/queryPriceByItemId?",t,function(v){r=v.rows;s.priceDetail=v.rows;for(var u in r){if(r[u].priceType=="PV"){s.pv=r[u].unitPrice}}})}else{for(var q in r){if(r[q].priceType=="PV"){s.pv=r[q].unitPrice}}}if(s.pv==0){return"0"}return Number(s.pv).toFixed(2)}else{s.pv=0;return"0"}}},m,{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.unitdiscountprice"),name:"unitDiscountPrice",align:"center",type:"float",editor:{type:"select",valueField:"value",textField:"meaning"},render:function(i){if(!i||!i.itemId){return}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity",align:"center",type:"int",editor:{type:"int",onChange:function(i){if(i.value>99999){i.record.quantity=99999;i.value=99999}else{if(i.value<1){i.record.quantity=1;i.value=1}}if(i.value>i.record.quantity){if(i.record.unitRedeemPoint){summary.points+=(i.record.quantity-i.value)*i.record.unitRedeemPoint;if(summary.points>Number(liger.get("currentPoints").getValue())){$.ligerDialog.error($l("msg.error.order.sales_point_insufficient"));i.value=i.record.quantity}}}},onChanged:function(i){f_setLinePrice(i.record)}},validate:{required:true,digits:true,min:1,max:99999}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.discountprice"),name:"favorableSum",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}if(!i.favorableSum||i.favorableSum==0){return"0"}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.pvsum"),name:"PVSum",align:"center",type:"text",render:function(i){if(!i||!i.itemId){return}if(!i.pv){i.pv=0;return}if(!i.quantity){i.quantity=1}i.PVSum=i.pv*i.quantity;if(!i.PVSum||i.PVSum==0){return"0"}return Number(i.PVSum).toFixed(2)}},j];if(a){var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.tax"),name:"tax",align:"center",type:"float",render:function(i){if(!i||!i.itemId){return}i.tax=i.unitOrigPrice*summary.taxRate;return Number(i.tax).toFixed(2)}};g.splice(5,0,e)}if(!c){var n={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.invorg"),name:"defaultInvOrgId",align:"center",width:200,type:"text",render:function(q){if(!q){return}for(var p in invOrgs){if(q.defaultInvOrgId==invOrgs[p].invOrgId){return invOrgs[p].name}}}};if(b){n.editor={type:"select",valueField:"invOrgId",textField:"name",cancelable:false,staticOptions:function(i){i.column.editor.data=invOrgs}};n.validate={required:true}}g.unshift(n)}return g}function o_addCreditForm(){var a={fields:[{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.creditcard.creditcardnum"),name:"creditCardNum",width:290,newline:false,validate:{required:true,maxlength:16,minlength:5}},{type:"select",display:$l("type.com.lkkhpg.dsis.common.order.dto.creditcard.bankcode"),name:"bankCode",width:120,newline:true,options:{valueFieldID:"bankCode",valueField:"value",textField:"meaning",cancelable:false,data:bankBelongData,value:bankBelongData[0].value,text:bankBelongData[0].meaning},validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.creditcard.cardholder"),name:"cardHolder",width:70,newline:false,validate:{required:true}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.creditcard.validyear"),name:"validYear",width:50,newline:true,validate:{required:true,digits:true,min:0,maxlength:2,max:99}},{type:"text",display:$l("type.com.lkkhpg.dsis.common.order.dto.creditcard.validmonth"),width:50,name:"validMonth",newline:false,validate:{required:true,digits:true,min:1,max:12}}],validate:true,space:10};return a}function o_ligerGridOptions(b){var c=_basePath+"/om/order/line/remove";if(b){c=_basePath+"/om/autoship/deleteLine"}var a={columns:o_getLineColumns(true,false,true,b),detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},enabledEdit:true,usePager:false,width:"98%",toolbar:{items:[{text:$l("sys.hand.btn.new"),disable:false,id:"addLineBtn",click:function(){addLine(b)},icon:"add"},{line:true},{text:$l("sys.hand.btn.delete"),id:"deleteLineBtn",click:function(){Hap.gridDelete({grid:linegrid,url:c,success:function(e,d){f_calculateLinePrice()},failure:function(e,d){f_calculateLinePrice()}})},icon:"delete"}]}};return a}function o_addressGridOptions(c){var a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivegoodsname");if(c){a=$l("type.com.lkkhpg.dsis.common.member.dto.membersite.receivebillsname")}var b={unSetValidateAttr:false,usePager:false,checkbox:true,isSingleCheck:true,enabledEdit:false,width:"98%",columns:[{display:a,name:"name",type:"text",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.phone"),name:"phone",align:"center"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.address"),name:"address",align:"center",width:400,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.spmlocation.zipcode"),name:"spmLocation.zipCode",align:"center",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.member.dto.membersite.defaultflag"),name:"defaultFlag",align:"center",type:"text",render:function(f,d,e){if(!e||e=="N"){return""}else{return e}}},{display:$l("sys.hand.btn.action"),name:"UnitsInStock3",align:"center",type:"text",render:function(g,d,f){var e="";e+="<a href='javascript:beginEdit("+c+","+d+")'>"+$l("sys.hand.btn.edit")+"</a> ";e+="<a href='javascript:deleteRow("+c+","+d+")'>"+$l("sys.hand.btn.delete")+"</a> ";return e}}],isChecked:function(d){if(orderDetail&&orderDetail.billingLocationId&&c&&orderDetail.billingLocationId==d.locationId){return true}else{if(orderDetail&&orderDetail.deliveryLocationId&&!c&&orderDetail.deliveryLocationId==d.locationId){return true}else{if(d.defaultFlag&&d.defaultFlag=="Y"){return true}}}return false}};if(c){b.toolbar={items:[{text:$l("sys.hand.btn.new"),disable:false,id:"addLineBtn",click:function(){if(liger.get("memberId").getValue()){om_location_edit(_basePath,{},function(e){f_addAddressWithMember(e,c,addressgrid)})}else{om_location_edit(_basePath,{},function(e){f_addAddressWithoutMember(e,c,addressgrid)})}},icon:"add"},{line:true}]}}else{b.toolbar={items:[{text:$l("sys.hand.btn.new"),disable:false,id:"addLineBtn",click:function(){if(liger.get("memberId").getValue()){om_location_edit(_basePath,{},function(e){f_addAddressWithMember(e,c,deliveryaddress)})}else{om_location_edit(_basePath,{},function(e){f_addAddressWithoutMember(e,c,deliveryaddress)})}},icon:"add"},{line:true}]};b.onSelectRow=f_queryShippingTier}return b}function f_addAddressWithoutMember(b,f,e){var d=_basePath+"/om/sites/submit";var a="SHIP";if(f){a="BILL"}var c={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:a,name:b.memberName,phone:b.phoneNumber,cityCode:b.cityCode,stateCode:b.stateCode,countryCode:b.countryCode,address:b.address,areaCode:b.areaCode,zipCode:b.zipCode,autoshipFlag:"N"};if(f){c.salesSiteId=$("#billSiteId").val()}else{c.salesSiteId=$("#deliverySiteId").val()}Hap.ajax({url:d,data:c,success:function(h){var g=h.rows[0];g.spmLocation={};g.spmLocation.zipCode=h.rows[0].zipCode;g.defaultFlag="Y";e.addRow(g);e.select(g);if(f){$("#billSiteId").val(g.salesSiteId)}else{$("#deliverySiteId").val(g.salesSiteId)}}})}function f_addAddressWithMember(b,g,d){var c=_basePath+"/mm/memsite/save";var e;if(b.save){e="N"}else{e="Y"}var a="SHIP";if(g){a="BILL"}var f=[{memberId:liger.get("memberId").getValue(),siteUseCode:a,name:b.memberName,phone:b.phoneNumber,defaultFlag:e,address:b.address,areaCode:b.areaCode,spmLocation:{countryCode:b.countryCode,countryName:b.countryName,stateName:b.stateName,stateCode:b.stateCode,cityCode:b.cityCode,cityName:b.cityName,addressLine1:b.addressLine1,addressLine2:b.addressLine2,addressLine3:b.addressLine3,zipCode:b.zipCode}}];Hap.ajax({url:c,data:f,success:function(k){if(k.rows[0].defaultFlag=="Y"){var j=d.getData();for(var h in j){if(j[h].defaultFlag=="Y"){j[h].defaultFlag="N";d.updateRow(j[h]);break}}}d.addRow(k.rows[0])}})}function f_editAddressWithMember(e,a){var d;if(e){d=addressgrid.getRow(a)}else{d=deliveryaddress.getRow(a)}var c;if(d.defaultFlag&&d.defaultFlag=="Y"){c=true}else{c=false}var b={memberId:d.memberId,memberName:d.name,phoneNumber:d.phone,countryCode:d.spmLocation.countryCode,stateCode:d.spmLocation.stateCode,cityCode:d.spmLocation.cityCode,addressLine1:d.spmLocation.addressLine1,addressLine2:d.spmLocation.addressLine2,addressLine3:d.spmLocation.addressLine3,zipCode:d.spmLocation.zipCode,save:c,address:d.address,areaCode:d.areaCode};om_location_edit(_basePath,b,function(h){var g="N";if(h.save){g="Y"}var f=_basePath+"/mm/memsite/save";d.name=h.memberName,d.phone=h.phoneNumber,d.defaultFlag=g,d.address=h.address,d.spmLocation.countryCode=h.countryCode,d.spmLocation.countryName=h.countryName,d.spmLocation.stateName=h.stateName,d.spmLocation.stateCode=h.stateCode,d.spmLocation.cityCode=h.cityCode,d.spmLocation.cityName=h.cityName,d.spmLocation.addressLine1=h.addressLine1,d.spmLocation.addressLine2=h.addressLine2,d.spmLocation.addressLine3=h.addressLine3,d.spmLocation.zipCode=h.zipCode;d.areaCode=h.areaCode;var i=[d];$.ajax({url:f,type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(i),success:function(k){k.rows[0].__index=d.__index;if(e){if(k.rows[0].defaultFlag=="Y"){var l=addressgrid.getData();for(var j in l){if(l[j].defaultFlag=="Y"){l[j].defaultFlag="N";addressgrid.updateRow(l[j]);break}}}addressgrid.updateRow(k.rows[0])}else{if(k.rows[0].defaultFlag=="Y"){var l=deliveryaddress.getData();orderDetail.deliveryLocationId=k.rows[0].locationId;for(var j in l){if(l[j].defaultFlag=="Y"){l[j].defaultFlag=="N";deliveryaddress.updateRow(l[j]);break}}}deliveryaddress.updateRow(k.rows[0])}},error:function(){$.ligerDialog.closeWaitting()}})})}function f_editAddressWithOutMember(e,a){var d;if(e){d=addressgrid.getRow(a)}else{d=deliveryaddress.getRow(a)}var c=true;var b={memberName:d.name,phoneNumber:d.phone,countryCode:d.countryCode,stateCode:d.stateCode,cityCode:d.cityCode,addressLine1:d.address,zipCode:d.zipCode,save:c,address:d.address,areaCode:d.areaCode};om_location_edit(_basePath,b,function(g){var j="Y";var i=_basePath+"/om/sites/submit";var f="SHIP";if(e){f="BILL"}var h={headerId:$("#headerId").val(),salesOrgId:liger.get("salesOrgId").getValue(),siteType:f,salesSiteId:d.salesSiteId,name:g.memberName,phone:g.phoneNumber,cityCode:g.cityCode,stateCode:g.stateCode,countryCode:g.countryCode,address:g.address,areaCode:g.areaCode,zipCode:g.zipCode,autoshipFlag:"N"};$.ajax({url:i,type:"POST",dataType:"json",async:false,contentType:"application/json",data:JSON2.stringify(h),success:function(k){k.rows[0].__id=d.__id;k.rows[0].__previd=d.__previd;k.rows[0].__index=d.__index;k.rows[0].__nextid=d.__nextid;k.rows[0].spmLocation={};k.rows[0].spmLocation.zipCode=k.rows[0].zipCode;k.rows[0].defaultFlag="Y";if(e){addressgrid.updateRow(k.rows[0])}else{deliveryaddress.updateRow(k.rows[0])}},error:function(){$.ligerDialog.closeWaitting()}})})}function beginEdit(b,a){if(liger.get("memberId").getValue()){f_editAddressWithMember(b,a)}else{f_editAddressWithOutMember(b,a)}}function deleteRow(b,a){$.ligerDialog.confirm($l("sys.hand.tip.delete_confirm"),$l("sys.hand.tip.info"),function(f){if(f){var c=_basePath+"/mm/memsite/delete";if(!liger.get("memberId").getValue()){c=_basePath+"/om/sites/delete";var e;if(b){e=addressgrid.getRow(a).salesSiteId}else{e=deliveryaddress.getRow(a).salesSiteId}c=c+"?siteId="+e}else{var d;if(b){d=addressgrid.getRow(a).siteId}else{d=deliveryaddress.getRow(a).siteId}c=c+"?memSiteId="+d}Hap.ajax({url:c,success:function(g){if(g.success){if(b){addressgrid.remove(addressgrid.getRow(a))}else{deliveryaddress.remove(deliveryaddress.getRow(a))}}}})}})}function addLine(b){var a={itemSalesType:defaultItemSalesType};if(!b&&liger.get("deliveryType").getValue()!="SHIPP"){a.defaultInvOrgId=defaultInvOrg}linegrid.addRow(a)}function validatePeriod(){var c=new Date();var g=c.getMonth()+1;var d=c.getFullYear();var h=liger.get("period");var b="";var f="";if(g==1){b=d+"01";f=(d-1)+"12"}else{if(g<10){b=d+"0"+g;f=d+"0"+g-1}else{if(g==10){b=d+"10";f=d+"09"}else{b=d.toString()+g;f=d.toString()+(g-1)}}}h.setData([{meaning:b,value:b},{meaning:f,value:f}]);h.setValue(b);var h=liger.get("period");var e=liger.get("orderStatus").getValue();switch(e){case"SAV":case"WPAY":case"FAIL":case"COMP":break;default:h.set({readonly:true});return}var a=c.getDate();if(a>3){h.set({readonly:true});return}h.set({readonly:false})}function validateDeliver(b){var c=liger.get("deliveryType");type=c.getValue();var a=false;if(liger.get("orderType")&&liger.get("orderType").getValue()=="RDEM"){a=true}if(type=="PCKUP"){$("#addressPanel").hide();if(linegrid){linegrid.set({columns:o_getLineColumns(true,a,true,b)});linegrid.reRender()}liger.get("isCod").setValue(false);$("#actrualPayAmt").text(Number(summary.currency+summary.adjustMents).toFixed(2));reSetLine(false,false,true)}else{if(type=="SHIPP"){if(linegrid){linegrid.set({columns:o_getLineColumns(true,a,false,b)});linegrid.reRender()}reSetLine(false,false,true);$("#addressPanel").show();if(liger.get("memberId")){f_memberAddress(liger.get("memberId").getValue())}}}}function validate(a){if(!a){validatePeriod()}else{for(var b in autoShipStatusData){if(autoShipStatusData[b].value=="NEW"){liger.get("autoshipStatus").setText(autoShipStatusData[b].meaning);break}}}validateDeliver(a)}function init(a){initButton(a);$("#deliveryType").ligerComboBox({css:"l-text-required",data:deliveryTypeData,valueField:"value",textField:"meaning",cancelable:false,focusWhenSetValue:false,readonly:a,onSelected:function(e){validateDeliver(a)},validate:{required:true},render:function(f){if(!f){return}for(var e in deliveryTypeData){if(deliveryTypeData[e].value==f){return deliveryTypeData[e].meaning}}}});var d="SHIPP";if(!a){d="PCKUP"}for(var b in deliveryTypeData){if(deliveryTypeData[b].value==d){liger.get("deliveryType").setValue(d);liger.get("deliveryType").setText(deliveryTypeData[b].meaning);break}}$("#deliveryCompany").ligerComboBox({css:"combobox",valueField:"shippingTierId",textField:"shippingTierName",cancelable:false,focusWhenSetValue:false,onSelected:function(h,j,g){var f=Number.MAX_VALUE;if(g){for(var e in g.shippingTierDtls){if(g.shippingTierDtls[e].shippingFee<f&&summary.currency>g.shippingTierDtls[e].invAmountFrom&&(!g.shippingTierDtls[e].invAmountTo||summary.currency<=g.shippingTierDtls[e].invAmountTo)){summary.shippingTier=g.shippingTierDtls[e].shippingFee;$("#shippingTier").text(summary.shippingTier);$("#actrualPayAmt").text(summary.currency+summary.shippingTier+summary.adjustMents)}}}}});if(!a){$("#payAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.adjustment"),width:"98%",height:"auto"});liger.get("payAdjust").collapse();$("#coupons").ligerComboBox({css:"combobox",valueField:"value",textField:"meaning",cancelable:false,onSelected:function(e){var f=new Object();f.id="coupons";f.value=e;f_payMentAdjust(f)}});$("#adjustType").ligerComboBox({width:120,data:adjustTypeData,valueField:"value",textField:"meaning",cancelable:false});liger.get("serviceCenterId").set({readonly:true});liger.get("adjustType").setValue("add");for(var b in adjustTypeData){if(adjustTypeData[b].value=="add"){liger.get("adjustType").setText(adjustTypeData[b].meaning)}}if(liger.get("orderStatus").getValue()!="COMP"){var c=new Array();c.push("sourceKey");c.push("batchNumber");om_oc_form.setVisible(c,false)}}validate(a)}function f_sumbitSales(){if(!checkPayment()){$.ligerDialog.confirm($l("实付款小于"+freePayMent+"的货到付款订单，收取额外费用"+freeFreight),$l("sys.hand.tip.info"),function(a){if(a){$("#shippingTier").text(Number(summary.shippingTier)+Number(freeFreight));$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents+Number(freeFreight))).toFixed(2));f_save(false,true)}})}else{f_save(false,true)}}function f_save(f,d){var c=om_oc_form.getData();c.orderStatus="SAV";if(d){c.orderStatus="WPAY";if(!valideBefore()){return}}if(!f&&!d&&!liger.get("memberId").getValue()){return}var e=deliveryaddress.getSelectedRow();if(e){c.deliveryLocationId=e.locationId;c.deliveryTo=e.siteId}var b=addressgrid.getSelectedRow();if(b){c.billingLocationId=b.locationId;c.billingTo=b.siteId}var a=linegrid.getData();c.lines=a;c.deliveryType=liger.get("deliveryType").getValue();c.orderAmt=$("#afterTax").text();c.discountAmt=summary.discountAmt;c.taxAmt=$("#tax").text();c.actrualPayAmt=$("#actrualPayAmt").text();c.adjustMents=f_getAdjustMents();c.logistics=f_getLogistics();c.codFlag="N";c.sourceType="MANUL";c.salesPoints=$("#getsalespoint").text();if(liger.get("isCod").getValue()&&c.deliveryType=="SHIPP"){c.codFlag="Y"}else{c.codFlag="N"}$.ajax({type:"POST",url:_basePath+"/om/order/submit",data:JSON2.stringify(c),success:function(g){console.log("--1");if(f){}if(d){if(g.success){var h=g.rows[0];if(h.attribute1&&h.attribute1=="out"){$.ligerDialog.error($l("msg.warning.order.product_order_qty_over_onhand"),function(){console.log("666");toPaymentPage(h.headerId)})}else{toPaymentPage(h.headerId)}}}else{if(f){if(g.success){Hap.showSuccess()}}var h=g.rows[0];orderDetail=h;f_setOrderDetai(h);if(h.logistics){$("#logisticsId").val(h.logistics.logisticsId)}}},contentType:"application/json; charset=utf-8"})}function toPaymentPage(a){window.top.f_removeTab("ORDER_CREATE");window.top.f_addTab("ORDER_CREATE",$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.orderpayment"),_basePath+"/om/om_order_payment.html?orderHeaderId="+a)}function f_sumbitAutoShip(){if(!validateAutoship()){return}var c=om_oc_form.getData();var d=deliveryaddress.getSelectedRow();if(d){c.deliveryLocationId=d.locationId;c.deliveryTo=d.siteId}var b=addressgrid.getSelectedRow();if(b){c.billingLocationId=b.locationId;c.billingTo=b.siteId}if(c.autoshipStatus=="NEW"){c.autoshipStatus=="ACV"}var a=linegrid.getData();c.lines=a;c.deliveryType=liger.get("deliveryType").getValue();c.orderAmt=$("#afterTax").text();c.discountAmt=summary.discountAmt;c.taxAmt=$("#tax").text();c.actrualPayAmt=$("#actrualPayAmt").text();c.logistics=f_getLogistics();c.salesScore=$("#getsalespoint").text();$.ajax({type:"POST",url:_basePath+"/om/autoship/submit",data:JSON2.stringify(c),success:function(e){if(e.success){var f=e.rows[0];f_setAusoShipDetail(f);Hap.showSuccess();initButton(true)}else{$.ligerDialog.error(e.message)}},contentType:"application/json; charset=utf-8"})}function initButton(a){if(!a){$("#pickItem").hide();$("#saveBtn").hide();$("#submitBtn").hide();$("#deliveryPackage").hide();$("#cancle").hide();$("#invalid").hide();$("#printInvoice").hide();$("#copyBtn").hide();var b=liger.get("orderStatus").getValue();if(b=="WPAY"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_sumbitSales()},text:$l("sys.hand.btn.submit")});$("#cancle").ligerButton({click:function(){$.ligerDialog.confirm($l("msg.warn.iscancel"),function(d){if(d){var c={orderStatus:"CANCL",headerId:$("#headerId").val()};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(c),success:function(f){if(f.success){liger.get("orderStatus").setValue("CANCL");for(var e in orderStatusData){if(orderStatusData[e].value=="CANCL"){liger.get("orderStatus").setText(orderStatusData[e].meaning);break}}var g=top.tab.getSelectedTabItemID();top.f_addTab("ORDER_DETAIL",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderDetail.headerId);top.tab.removeTabItem(g)}},contentType:"application/json; charset=utf-8"})}})},text:$l("sys.hand.btn.cancel")});$("#saveBtn").show();$("#cancle").show();$("#submitBtn").show()}else{if(b=="NEW"||b=="FAIL"||b=="SAV"){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#submitBtn").ligerButton({click:function(){f_sumbitSales()},text:$l("sys.hand.btn.submit")});$("#saveBtn").show();$("#submitBtn").show()}else{if(b=="COMP"){$("#pickItem").ligerButton({click:function(){window.top.f_addTab(null,$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverypickrelease"),_basePath+"/dm/dm_delivery_pick_release.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.deliverypick")});$("#deliveryPackage").ligerButton({click:function(){window.top.f_addTab(null,$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.delivery_query"),_basePath+"/dm/dm_delivery_query.html?orderNumber="+liger.get("orderNumber").getValue())},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.delivery")});$("#printInvoice").ligerButton({click:function(){alert($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.printinvoice"))},text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.printinvoice")});$("#printInvoice").show();$("#deliveryPackage").show();$("#pickItem").show();$("#invalid").ligerButton({click:getMarket,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invalid")});$("#invalid").show()}else{if(b=="CONF"){$("#invalid").ligerButton({click:getMarket,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.invalid")});$("#invalid").show()}}}}if(b=="WPAY"||b=="SAV"||b=="NEW"){$("#copyBtn").show()}$("#copyBtn").ligerButton({click:f_copy,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.copytemplate")})}else{$("#activeBtn").ligerButton({click:function(){f_updateAutoShipStatus("ACV");autoshipActive()},text:$l("msg.warning.order.active")});$("#stopBtn").ligerButton({click:function(){f_updateAutoShipStatus("SUS");autoshipReadOnly()},text:$l("msg.hand.btn.pause")});$("#endBtn").ligerButton({click:function(){f_updateAutoShipStatus("TER");autoshipReadOnly()},text:$l("type.com.lkkhpg.dsis.common.member.btn.memberdetails.terminate")});$("#endBtn").hide();$("#stopBtn").hide();$("#activeBtn").hide();$("#autoShipsaveBtn").hide();if(liger.get("autoshipStatus").getValue()=="ACV"){$("#endBtn").show();$("#stopBtn").show();$("#autoShipsaveBtn").show();autoshipActive()}else{if(liger.get("autoshipStatus").getValue()=="NEW"){$("#autoShipsaveBtn").show()}else{if(liger.get("autoshipStatus").getValue()=="SUS"){$("#endBtn").show();$("#activeBtn").show()}}}$("#autoShipsaveBtn").ligerButton({text:$l("sys.hand.btn.submit"),click:f_sumbitAutoShip});$("#addCreditCar").ligerButton({click:function(){$.ligerDialog.open({target:$("#addCredit"),title:$l("msg.com.lkkhpg.dsis.common.order.addcredit"),width:500,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,e){if(!addCreditFrom.valid()){return}$.ajax({type:"POST",url:_basePath+"/om/creditCard/submit",data:addCreditFrom.getData(),success:function(d){var f=d.rows[0];$("#creditCardId").val(f.creditCardId);$("#cardNo").text(f.maskedCreditCardNum);$("#bankName").text(liger.get("bankCode").getText());$("input").ligerHideTip();e.hide()}})}},{text:$l("sys.hand.btn.cancel"),onclick:function(c,e){$("input").ligerHideTip();e.hide()}}]})},text:$l("sys.hand.btn.new")})}}function f_setMember(a){if(!a){return}cleanMember();memberStatus=a.status;memberRole=a.memberRole;if(memberStatus=="NEW"&&memberRole=="DIS"){$.ligerDialog.warn($l("此会员为新会员"));reSetLine(false,true,false)}$.ajax({type:"POST",url:_basePath+"/mm/member/isMemberBirthdayMonth?memberId="+a.memberId+"&dob="+new Date(a.dob.replace(/-/g,"/")),success:function(b){if(b.code=="true"){$.ligerDialog.warn($l("msg.info.om.member_birthday_month"))}}});liger.get("cnName").setValue("");liger.get("enName").setValue("");liger.get("cnName").setValue(a.chineseName);liger.get("enName").setValue(a.englishName);if(ordertype=="autoship"){$.ajax({type:"POST",url:_basePath+"/om/autoship/checkByMemberId?memberId="+a.memberId,success:function(c){if(c.success){if(!c.rows||c.total==0){f_memberAddress(a.memberId);f_memberAccount(a.memberId);var e={};e.rows=[];linegrid.set({data:e});$("#creditCardId").val("");$("#autoshipId").val("");$("#logisticsId").val("");$("#bankName").text("");$("#cardNo").text("");liger.get("autoshipNumber").setValue("");liger.get("autoshipStatus").setValue("NEW");for(var b in autoShipStatusData){if(autoShipStatusData[b].value=="NEW"){liger.get("autoshipStatus").setText(autoShipStatusData[b].meaning);break}}liger.get("creditCardNum").setValue("");liger.get("cardHolder").setValue("");liger.get("validYear").setValue("");liger.get("validMonth").setValue("");f_calculateLinePrice();$("#getsalespoint").text(0);$("#shippingTier").text(0);$("#actrualPayAmt").text(0);$("#summaryPV").text(0);addLine(true)}else{var d={autoshipId:c.rows[0].autoshipId};$.getJSON(_basePath+"/om/autoship/detail",d,function(f){f_setAusoShipDetail(f.rows[0]);initButton(true)})}}}})}else{f_memberAddress(a.memberId);f_memberAccount(a.memberId)}}function f_setLine(b,c){if(!b||!c){return}var d=c;d.__id=b.__id;d.__previd=b.__previd;d.__index=b.__index;d.__nextid=b.__nextid;d.quantity=1;d.defaultInvOrgId=b.defaultInvOrgId;d.itemSalesType=b.itemSalesType;d.unitDiscountPrice=0;d.uomCode=c.uomCode;d.itemId=c.itemId;var e=f_getPriceType();var a=liger.get("orderType");$.ajax({type:"POST",url:_basePath+"/inv/price/queryPriceByItemId?itemId="+c.itemId+"&currency="+liger.get("currency").getValue()+"&uomCode="+c.uomCode+"&salesOrgId="+defaultSaleOrg,success:function(g){if(g.success){d.priceDetail=g.rows;for(var f in g.rows){if(g.rows[f].priceType=="PV"){if(a&&a.getValue()=="STDP"&&d.itemSalesType=="PURC"){d.pv=g.rows[f].unitPrice}else{if(!a){d.pv=g.rows[f].unitPrice}else{d.pv=0}}}else{if(g.rows[f].priceType==e){if(e=="RP"){if((summary.points+g.rows[f].unitPrice)>Number(liger.get("currentPoints").getValue())){$.ligerDialog.error($l("msg.error.order.sales_point_insufficient"));return}summary.points+g.rows[f].unitPrice;d.unitRedeemPoint=g.rows[f].unitPrice}else{d.unitOrigPrice=g.rows[f].unitPrice}}}}if(!d.pv){d.pv=0}if(!d.unitOrigPrice){d.unitOrigPrice=0}if(!d.unitDiscountPrice){d.unitDiscountPrice=0}if(!d.unitRedeemPoint){d.unitRedeemPoint=0}d.favorableSum=d.quantity*d.unitDiscountPrice;d.redeemPoint=d.unitRedeemPoint*d.quantity;d.amount=d.unitOrigPrice*d.quantity-d.favorableSum;d.PVSum=d.quantity*d.pv;d.tax=summary.taxRate*d.unitOrigPrice;d.unitSellingPrice=d.unitOrigPrice;linegrid.updateRow(b,d);f_calculateLinePrice();return}}})}function f_getPriceType(){var a;if(liger.get("orderType")){a=liger.get("orderType").getValue()}else{a="STDP"}var b;if(a=="DIRP"||a=="STFP"){b="STU"}else{if(a=="STDP"||a=="NMDP"){b="DIS"}else{if(a=="CONP"){b="RE"}else{if(a=="BIGF"){b="0"}else{b="RP"}}}}return b}function f_setLinePrice(a){if(!a){return}var b=a;if(!b.pv){b.pv=0}if(!b.unitOrigPrice){b.unitOrigPrice=0}if(!b.unitDiscountPrice){b.unitDiscountPrice=0}if(!b.unitRedeemPoint){b.unitRedeemPoint=0}b.favorableSum=Number(b.quantity*b.unitDiscountPrice);b.amount=Number(b.unitOrigPrice*b.quantity-b.favorableSum);b.redeemPoint=b.unitRedeemPoint*b.quantity;b.PVSum=Number(b.quantity*b.pv);b.tax=summary.taxRate*b.unitOrigPrice;b.unitSellingPrice=b.unitOrigPrice-b.unitDiscountPrice;linegrid.updateRow(a,b);f_calculateLinePrice();return}function f_memberAddress(a){if(!a){return}if(liger.get("deliveryType").getValue()!="SHIPP"){return}$.ajax({type:"POST",url:_basePath+"/mm/site/query?memberId="+a,success:function(d){if(d.success){var e={};var f=new Array();var b=new Array();for(var c in d.rows){if(d.rows[c].siteUseCode=="BILL"){f.push(d.rows[c])}else{if(d.rows[c].siteUseCode=="SHIP"){b.push(d.rows[c])}}}e.rows=f;addressgrid.set({data:e});e.rows=b;deliveryaddress.set({data:e})}}})}function f_memberAccount(a){if(!a){return}$.ajax({type:"POST",url:_basePath+"/mm/accountingbalance/query?memberId="+a,success:function(b){if(b.success){f_setMemberAccount(b.rows)}}})}function f_setMemberAccount(a){for(var b in a){if(a[b].accountingType=="EB"){liger.get("exchangeBalance").setValue(a[b].balance);$("#exchangeBalance").text(a[b].balance)}else{if(a[b].accountingType=="RB"){liger.get("remainingBalance").setValue(a[b].balance);$("#remainingBalance").text(a[b].balance)}else{if(a[b].accountingType=="SP"){liger.get("currentPoints").setValue(a[b].balance)}}}}}function f_calculateLinePrice(){var d=linegrid.getData();summary.pv=0;summary.currency=0;summary.exchange=0;summary.points=0;var b;if(liger.get("orderType")){b=liger.get("orderType").getValue()}else{b="STDP"}var c=(b=="RDEM");for(var a in d){if(!d[a].redeemPoint){d[a].redeemPoint=0}if(!d[a].unitOrigPrice){d[a].unitOrigPrice=0}if(!d[a].unitDiscountPrice){d[a].unitDiscountPrice=0}if(!d[a].amount){d[a].amount=0}if(!d[a].PVSum){d[a].PVSum=0}if(!d[a].quantity){d[a].quantity=1}if(d[a].PVSum){summary.pv+=Number(d[a].PVSum)}else{if(!d[a].pv){d[a].pv=0}summary.pv+=Number(d[a].pv*d[a].quantity)}d[a].unitSellingPrice=Number(d[a].unitOrigPrice-d[a].unitDiscountPrice);d[a].amount=Number(d[a].unitSellingPrice*d[a].quantity);if(d[a].itemSalesType=="EXCH"){summary.exchange+=Number(d[a].amount)}summary.points+=Number(d[a].redeemPoint);if(d[a].itemSalesType!="FREE"){summary.currency+=Number(d[a].amount)}}$("#totalPV").text(Number(summary.pv.toFixed(2)));$("#summaryPV").text(Number(summary.pv.toFixed(2)));if(c){$("#beforeTax").text(0);$("#tax").text(0);$("#afterTax").text(0);$("#TotalCurrency").text(Number(summary.points));if(liger.get("deliveryType").getValue()!="SHIPP"){$("#actrualPayAmt").text(Number((summary.adjustMents).toFixed(2)))}else{$("#actrualPayAmt").text(Number((summary.shippingTier+summary.adjustMents).toFixed(2)))}}else{if(summary.enableTax){if(summary.priceIncludeTax){summary.tax=Number((summary.currency/(1+Number(summary.taxRate))*summary.taxRate).toFixed(2))}else{summary.tax=Number((summary.currency*summary.taxRate).toFixed(2))}}else{summary.tax=0}if(summary.priceIncludeTax){$("#beforeTax").text(Number((summary.currency-summary.tax).toFixed(2)))}else{$("#beforeTax").text(Number(summary.currency.toFixed(2)))}$("#tax").text(Number(summary.tax));if(!summary.priceIncludeTax){summary.currency=summary.currency+summary.tax;$("#afterTax").text(Number((summary.currency+summary.tax).toFixed(2)));$("#TotalCurrency").text(Number((summary.currency+summary.tax).toFixed(2)))}$("#afterTax").text(Number(summary.currency.toFixed(2)));$("#TotalCurrency").text(Number(summary.currency.toFixed(2)));if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()!="SHIPP"){$("#actrualPayAmt").text(Number((summary.currency+summary.adjustMents-summary.discountAmt).toFixed(2)))}else{$("#actrualPayAmt").text(Number((summary.currency+summary.shippingTier+summary.adjustMents-summary.discountAmt).toFixed(2)))}$("#exchange").text(Number(summary.exchange.toFixed(2)));if($("#getsalespoint")&&ordertype=="autoship"&&pointRate){if(pointLimit&&(Number($("#actrualPayAmt").text())*pointRate>pointLimit)){$("#getsalespoint").text(pointLimit)}else{$("#getsalespoint").text(Number((Number($("#actrualPayAmt").text())*pointRate).toFixed(2)))}}}if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="SHIPP"&&deliveryaddress.getSelected()){f_resetShippingTier()}}function f_payMentAdjust(e,d){var f=/^[0-9]*$/;if(!f.test(e.value)){Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.number"));$(e).val("");return}if(e.value<0){$(e).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.minus"));return}var g;if(e){g=e.id+"Text";e.tempValue=Number($("#"+g).text());if(e.id=="adjust"){var c=$(e).parents("tr");c.find("#adjustText").text(e.value)}else{$("#"+g).text(e.value)}}if(d){if(e.id=="exchangeBalanceUse"){if(Number(e.value)>Number(liger.get("exchangeBalance").getValue())){Hap.showError("exchangeBalance"+$l("type.com.lkkhpg.dsis.common.order.payadjustment.biggerthenorder")+"exchangeBalance");$(e).val("");$("#"+g).text("0");return}if(Number(e.value)>Number(summary.exchange)){Hap.showError("exchangeBalance"+$l("type.com.lkkhpg.dsis.common.order.payadjustment.totalbiggerthenorder"));$(e).val("");$("#"+g).text("0");return}$("#exchangeBalanceUse").val(e.value);$("#"+g).text(e.value)}else{if(e.id=="remainingBalanceUse"){if(Number(e.value)>Number(liger.get("remainingBalance").getValue())){Hap.showError("remainingBalance"+$l("type.com.lkkhpg.dsis.common.order.payadjustment.totalbiggerthenorder")+"remainingBalance");$(e).val("");$("#"+g).text("0");return}else{$("#remainingBalanceUse").val(e.value);$("#"+g).text(e.value)}}}}var b=0;b-=Number($("#coupons").val());b-=Number($("#exchangeBalanceUse").val());b-=Number($("#remainingBalanceUse").val());b+=Number($("#extra").val());var a=$("#payAdjust table tr:gt(3)");$.each(a,function(){if(Number($(this).find("#adjust").val())>0){if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){b-=Number($(this).find("#adjust").val())}else{b+=Number($(this).find("#adjust").val())}}});if((Number(summary.currency)+b)<0){if(e.id=="adjust"){var c=$(e).parents("tr");c.find("#adjustText").text("0")}else{$("#"+g).text("0")}$(e).val("");Hap.showError($l("type.com.lkkhpg.dsis.common.order.payadjustment.adjustbiggerthenorder"));return}else{$("#afterAdjust").text(b);summary.adjustMents=b;$("#actrualPayAmt").text(summary.currency+summary.shippingTier+b)}return}function f_changeShow(a,b){if($(a).hasClass("l-panel-header-toggle-hide")){$("#"+b).show();$(a).removeClass("l-panel-header-toggle-hide");a.title=$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.colse")}else{$("#"+b).hide();$(a).addClass("l-panel-header-toggle-hide");a.title=$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.open")}}function f_setOrderDetai(d){var e=liger.get("memberId").getText();var c=liger.get("salesOrgId").getText();var f=liger.get("salesMarketId").getText();om_oc_form.setData(d);liger.get("memberId").setText(e);liger.get("salesOrgId").setText(c);liger.get("salesMarketId").setText(f);if(d.salesOrganization){f_setMarketAndCurrency(d.salesOrganization.market,d.spmCurrency);liger.get("salesOrgId").setValue(d.salesOrganization.salesOrgId);liger.get("salesOrgId").setText(d.salesOrganization.name)}for(var b in orderStatusData){if(orderStatusData[b].value==d.orderStatus){liger.get("orderStatus").setText(orderStatusData[b].meaning);break}}for(var b in orderTypeData){if(orderTypeData[b].value==d.orderType){liger.get("orderType").setText(orderTypeData[b].meaning);break}}for(var b in channelData){if(channelData[b].value==d.channel){liger.get("channel").setText(channelData[b].meaning);break}}if(d.codFlag=="Y"){liger.get("isCod").setValue(true)}var a={};a.rows=d.lines;linegrid.set({data:a});summary.currency=d.orderAmt;if(d.adjustMents){f_setDefaultAdjustMents(d.adjustMents)}if(d.member){if(d.member.memAccountingBalances){f_setMemberAccount(d.member.memAccountingBalances)}a.rows=d.member.memSites;liger.get("cnName").setValue(d.member.chineseName);liger.get("enName").setValue(d.member.englishName);liger.get("memberId").setValue(d.member.memberId);if(d.member.memberCode){liger.get("memberId").setText(d.member.memberCode)}memberStatus=d.member.status;f_setDelivery(d.member.memSites,d.logistics,d.deliveryLocationId);liger.get("deliveryType").setValue(d.deliveryType);for(var b in deliveryTypeData){if(deliveryTypeData[b].value==d.deliveryType){liger.get("deliveryType").setText(deliveryTypeData[b].meaning);validateDeliver();break}}}f_calculateLinePrice()}function f_setDefaultAdjustMents(a){var g=$("#payAdjust table tr:eq(4)");var h=$("#payAdjust table tr:gt(4)");$.each(h,function(){if($(this).find("#adjustid").length>0){$(this).remove()}});var c=0;var k=liger.get("adjustType").options.data;for(var e in a){var d=new Object();d.value=Math.abs(a[e].adjustmentAmount);if("EB"==a[e].adjustmentType){$("#exchangeBalanceUse").val(d.value);d.id="exchangeBalanceUse";$("#exchangeBalanceUseid").val(a[e].salesAdjustmentId);f_payMentAdjust(d)}if("RB"==a[e].adjustmentType){$("#remainingBalanceUse").val(d.value);$("#remainingBalanceUseid").val(a[e].salesAdjustmentId);d.id="remainingBalanceUse";f_payMentAdjust(d)}if("AD"==a[e].adjustmentType){c++;d.id="adjust";if(c>1){var f=g.clone();f.find("#adjustType_val").attr("id","adjustType"+c+"_val");f.find("#adjustType").attr("id","adjustType"+c);if(Number(a[e].adjustmentAmount)>0){f.find("#adjustType"+c+"_val").val("add");for(var b in k){if(k[b].value=="add"){f.find("#adjustType"+c).val(k[b].meaning);break}}}else{f.find("#adjustType"+c+"_val").val("subs");for(var b in k){if(k[b].value=="subs"){f.find("#adjustType"+c).val(k[b].meaning);break}}}f.find("#adjustText").html(d.value);f.find("#adjust").val(d.value);f.find("#remarks").val(a[e].remark);f.find("#adjustid").val(a[e].salesAdjustmentId);f.find(".addArtificial").hide();f.find(".subArtificial").show();g.after(f)}else{if(Number(a[e].adjustmentAmount)>0){g.find("#adjustType_val").val("add");for(var b in k){if(k[b].value=="add"){g.find("#adjustType").val(k[b].meaning);break}}}else{g.find("#adjustType_val").val("subs");for(var b in k){if(k[b].value=="subs"){g.find("#adjustType").val(k[b].meaning);break}}}g.find("#adjust").val(d.value);g.find("#adjustText").html(d.value);g.find("#remarks").val(a[e].remark);g.find("#adjustid").val(a[e].salesAdjustmentId)}f_payMentAdjust(d)}if("EX"==a[e].adjustmentType){$("#extra").val(d.value);d.id="extra";f_payMentAdjust(d)}}}function f_initSalesOrg(b){for(var a in b){if(b[a].salesOrgId==defaultSaleOrg){liger.get("salesOrgId").setValue(b[a].salesOrgId);liger.get("salesOrgId").setText(b[a].name);liger.get("salesOrgId").set({readonly:true,data:b});f_setMarketAndCurrency(b[a].market,b[a].currency);break}}}function f_setMarketAndCurrency(b,a){if(b){liger.get("salesMarketId").setValue(b.marketId);liger.get("salesMarketId").setText(b.name)}if(a){liger.get("currency").setValue(a);$(".currencysign").text(a)}}function f_getAdjustMents(){var b=new Array();if($("#exchangeBalanceUse").val()){b.push({adjustmentType:"EB",adjustmentAmount:-$("#exchangeBalanceUse").val(),headerId:$("#headerId").val(),salesAdjustmentId:$("#exchangeBalanceUseid").val()})}if($("#remainingBalanceUse").val()){b.push({adjustmentType:"RB",adjustmentAmount:-$("#remainingBalanceUse").val(),headerId:$("#headerId").val(),salesAdjustmentId:$("#remainingBalanceUseid").val()})}if($("#extra").val()){b.push({adjustmentType:"EX",adjustmentAmount:$("#extra").val(),headerId:$("#headerId").val(),salesAdjustmentId:$("#extraid").val()})}if($("#coupons").val()){b.push({adjustmentType:"CP",adjustmentAmount:-$("#coupons").val(),headerId:$("#headerId").val(),salesAdjustmentId:$("#couponsid").val()})}var a=$("#payAdjust table tr:gt(3)");$.each(a,function(){if($(this).find("#adjust").val()){var c=$(this).find("#adjust").val();if($(this).find("input[type='hidden']:eq(0)").val()=="subs"){c=-Number($(this).find("#adjust").val())}b.push({adjustmentType:"AD",adjustmentAmount:c,headerId:$("#headerId").val(),remark:$(this).find("#remarks").val(),salesAdjustmentId:$(this).find("#adjustid").val()})}});return b}function f_getLogistics(){if(!liger.get("deliveryCompany").getValue()){return null}var a=new Object();a.logisticsId=$("#logisticsId").val();a.headerId=$("#headerId").val();a.shippingTierId=liger.get("deliveryCompany").getValue();a.shippingFee=$("#shippingTier").text();a.salesOrgId=liger.get("salesOrgId").getValue();a.autoshipFlag="N";if(liger.get("isCod")&&liger.get("isCod").getValue()){a.codFlag="Y"}else{a.codFlag="N"}return a}function f_queryShippingTier(a){var b={salesOrgId:liger.get("salesOrgId").getValue()};if(liger.get("memberId").getValue()){b.countryCode=a.spmLocation.countryCode;b.cityCode=a.spmLocation.cityCode;b.stateCode=a.spmLocation.stateCode}else{b.countryCode=a.countryCode;b.cityCode=a.cityCode;b.stateCode=a.stateCode}$.post(_basePath+"/dm/shippingTierDtl/queryByLocation",b,function(h){liger.get("deliveryCompany").set({data:h.rows});var f={};f.price=Number.MAX_VALUE;for(var e in h.rows){var g=h.rows[e];for(var d in g.shippingTierDtls){var c=g.shippingTierDtls[d];if(summary.currency>c.invAmountFrom&&(!c.invAmountTo||summary.currency<=c.invAmountTo)){if(f.price>c.shippingFee){f.price=c.shippingFee;f.name=g.shippingTierName;f.value=g.shippingTierId}}}}if(f.price==Number.MAX_VALUE){f.price=0}summary.shippingTier=f.price;liger.get("deliveryCompany").setValue(f.value);liger.get("deliveryCompany").setText(f.name);$("#shippingTier").text(f.price);return h.rows})}function f_resetShippingTier(){var f=liger.get("deliveryCompany").options.data;var d={};d.price=Number.MAX_VALUE;for(var c in f){var e=f[c];for(var b in e.shippingTierDtls){var a=e.shippingTierDtls[b];if(summary.currency>a.invAmountFrom&&(!a.invAmountTo||summary.currency<=a.invAmountTo)){if(d.price>a.shippingFee){d.price=a.shippingFee;d.name=e.shippingTierName;d.value=e.shippingTierId}}}}if(d.price==Number.MAX_VALUE){d.price=0}summary.shippingTier=d.price;liger.get("deliveryCompany").setValue(d.value);liger.get("deliveryCompany").setText(d.name);$("#shippingTier").text(d.price)}function f_renderItemName(d,a,b){if(!b){return}if(d.itemType!="PACKG"){return b}var c=b+"&nbsp;&nbsp;<img src='../lib/ligerUI/skins/icons/search.gif' id='gridimg' index="+a+"/>";return c}function f_setAusoShipDetail(c){om_oc_form.setData(c);if(c.spmSalesOrganization){f_setMarketAndCurrency(c.spmSalesOrganization.market,c.spmCurrency);liger.get("salesOrgId").setValue(c.spmSalesOrganization.salesOrgId);liger.get("salesOrgId").setText(c.spmSalesOrganization.name)}for(var b in autoShipStatusData){if(autoShipStatusData[b].value==c.autoshipStatus){liger.get("autoshipStatus").setText(autoShipStatusData[b].meaning);break}}var a={};a.rows=c.lines;linegrid.set({data:a});if(c.member){f_setMemberAccount(c.member.memAccountingBalances);a.rows=c.member.memSites;liger.get("cnName").setValue(c.member.chineseName);liger.get("enName").setValue(c.member.englishName);liger.get("memberId").setValue(c.member.memberId);liger.get("memberId").setText(c.member.memberCode);memberStatus=c.member.status;f_setDelivery(c.member.memSites,c.logistics,c.deliveryLocationId)}if(c.creditCard){addCreditFrom.setData(c.creditCard);$("#creditCardId").val(c.creditCard.creditCardId);$("#cardNo").text(c.creditCard.maskedCreditCardNum);for(var b in bankBelongData){if(bankBelongData[b].value==c.creditCard.bankCode){$("#bankName").text(bankBelongData[b].meaning)}}}f_calculateLinePrice()}function f_updateAutoShipStatus(a){var b=$("#autoshipId").val();if(!b||!a){Hap.showError($l("type.com.lkkhpg.dsis.common.order.autoship.not_save"));return}var c={autoshipId:b,autoshipStatus:a};$.ajax({type:"POST",url:_basePath+"/om/autoship/updateStatus",data:c,success:function(e){if(e.success){Hap.showSuccess();for(var d in autoShipStatusData){if(autoShipStatusData[d].value==a){liger.get("autoshipStatus").setValue(a);liger.get("autoshipStatus").setText(autoShipStatusData[d].meaning);break}}initButton(true)}}})}function f_setDelivery(f,a,d){if(!f||!d){return}var e={};var g=new Array();var b=new Array();for(var c in f){if(f[c].siteUseCode=="BILL"){g.push(f[c])}else{if(f[c].siteUseCode=="SHIP"){b.push(f[c])}}}e.rows=g;addressgrid.set({data:e});e.rows=b;deliveryaddress.set({data:e});if(a){if(a.shippingFee){summary.shippingTier=a.shippingFee}$("#shippingTier").text(a.shippingFee);$("#logisticsId").val(a.logisticsId);liger.get("deliveryCompany").setValue(a.shippingTierId);liger.get("deliveryCompany").setText(a.shippingTierName)}}function valideBefore(){var a=liger.get("orderType").getValue();if(!liger.get("orderType").getValue()||!liger.get("channel").getValue()||!liger.get("salesOrgId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.miss"));return false}if(liger.get("deliveryType").getValue()=="SHIPP"){if(!deliveryaddress.getSelectedRow()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.delivery_not_null"));return false}if(!liger.get("deliveryCompany").getValue()){$.ligerDialog.error($l("msg.error.order.deliverycompany_null"));return false}}if(liger.get("channel")=="SRVC"&&!liger.get("serviceCenterId")){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.servicecenter_not_null"));return false}var c=linegrid.getData();for(var b in c){if(!c[b].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}}if(a=="DIRP"||a=="STFP"||a=="CONP"){return true}else{if(!liger.get("memberId").getValue()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.not_member"));return false}return true}}function cleanMember(){liger.get("memberId").setValue("");liger.get("memberId").setText("");liger.get("cnName").setValue("");liger.get("enName").setValue("");liger.get("exchangeBalance").setValue("");liger.get("remainingBalance").setValue("");liger.get("currentPoints").setValue("");liger.get("currentPV").setValue("");if($("#exchangeBalance")){$("#exchangeBalance").html("0");$("#remainingBalance").html("0")}if(liger.get("deliveryCompany")){liger.get("deliveryCompany").setValue("");liger.get("deliveryCompany").setText("");$("#shippingTier").html("")}if(!orderDetail){var a={};a.rows=[];if(addressgrid){addressgrid.set({data:a})}if(deliveryaddress){deliveryaddress.set({data:a})}}}function reSetLine(c,b,a){if(!linegrid){return}var f=linegrid.getData();if(c){for(var d in f){f[d].lineId="";f[d].headerId="";f[d].PVSum=0}var e={};e.rows=f;linegrid.set({data:e});f_calculateLinePrice();return}if(a){if(liger.get("deliveryType")&&liger.get("deliveryType").getValue()=="PCKUP"){for(var d in f){f[d].defaultInvOrgId=defaultInvOrg}}else{for(var d in f){f[d].defaultInvOrgId=""}}var e={};e.rows=f;linegrid.set({data:e});return}if(b){if($("#headerId").val()&&liger.get("orderStatus").getValue()!=orderDetail.orderStatus){$.ajax({type:"POST",url:_basePath+"/om/order/line/remove",data:JSON2.stringify(f),contentType:"application/json; charset=utf-8",success:function(g){if(g.success){var h={};h.rows=[];linegrid.set({data:h});f_calculateLinePrice();return}}})}else{if(!orderDetail||liger.get("orderStatus").getValue()!=orderDetail.orderStatus){var e={};e.rows=[];linegrid.set({data:e});f_calculateLinePrice();return}}}}function validateAutoship(){if(!om_oc_form.valid()){return false}if(!$("#creditCardId").val()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.autoship.not_credit"));return false}var b=linegrid.getData();for(var a in b){if(!b[a].itemId){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesline.item_not_null"));return false}}if(liger.get("deliveryType").getValue()=="SHIPP"){if(!deliveryaddress.getSelectedRow()){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.salesorder.delivery_not_null"));return false}if(!addressgrid.getSelectedRow()){$.ligerDialog.error($l("msg.error.order.billing_address_null"));return false}if(!liger.get("deliveryCompany").getValue()){$.ligerDialog.error($l("msg.error.order.deliverycompany_null"));return false}}if(minMonery>(summary.currency+summary.shippingTier)){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.salesorder.minimumorderamount")+minMonery);return false}return true}function autoshipReadOnly(){liger.get("memberId").set({readonly:true});liger.get("executeDate").set({readonly:true});liger.get("executeType").set({readonly:true});liger.get("remark").set({readonly:true});liger.get("deliveryCompany").set({readonly:true});$("#addCreditCar").hide();$("[ toolbarid='addLineBtn']").hide();$("[ toolbarid='deleteLineBtn']").hide();linegrid.set({enabledEdit:false,rowSelectable:false,selectable:false});deliveryaddress.set({enabledEdit:false,rowSelectable:false,selectable:false});addressgrid.set({enabledEdit:false,rowSelectable:false,selectable:false})}function autoshipActive(){liger.get("memberId").set({readonly:false});liger.get("executeDate").set({readonly:false});liger.get("executeType").set({readonly:false});liger.get("remark").set({readonly:false});liger.get("deliveryCompany").set({readonly:false});$("#addCreditCar").show();$("[ toolbarid='addLineBtn']").show();$("[ toolbarid='deleteLineBtn']").show();linegrid.set({enabledEdit:true,rowSelectable:true,selectable:true});deliveryaddress.set({enabledEdit:true,rowSelectable:true,selectable:true});addressgrid.set({enabledEdit:true,rowSelectable:true,selectable:true})}function checkPayment(){if(!liger.get("isCod")||!liger.get("isCod").getValue()){return true}if(!freePayMent||!freeFreight){return true}if(summary.currency<freePayMent){return false}else{return true}}function f_getItemPackageDetail(c,a,d){if(c.itemType!="PACKG"){return}var b=document.createElement("div");$(a).append(b);$(b).css("margin",10).ligerGrid({columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemid"),name:"itemNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.itemname"),name:"itemName",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.quantity"),name:"quantity"}],isScroll:false,showToggleColBtn:false,width:500,url:_basePath+"/inv/item/queryHierarchyByItemId?itemId="+c.itemId,showTitle:false,usePager:false,onAfterShowData:d,frozen:false})}function initSalesOrder(b){if(!b){$("#saveBtn").ligerButton({click:function(){f_save(true,false)},text:$l("sys.hand.btn.save")});$("#copyBtn").ligerButton({click:f_copy,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.copytemplate")});$("#nextBtn").ligerButton({click:f_openConfirm,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.next")})}else{$("#couponsAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.coupons"),width:"98%",height:"auto"});$("#billPannel").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.billaddress"),width:"98%",height:"auto"});$("#deliveryType").ligerComboBox({css:"l-text-required",data:deliveryTypeData,valueField:"value",textField:"meaning",cancelable:false,focusWhenSetValue:false,readonly:false,onSelected:function(c){validateDeliver(false)},validate:{required:true},render:function(d){if(!d){return}for(var c in deliveryTypeData){if(deliveryTypeData[c].value==d){return deliveryTypeData[c].meaning}}}});defaultType="PCKUP";for(var a in deliveryTypeData){if(deliveryTypeData[a].value==defaultType){liger.get("deliveryType").setValue(defaultType);liger.get("deliveryType").setText(deliveryTypeData[a].meaning);break}}$("#deliveryCompany").ligerComboBox({css:"combobox",valueField:"shippingTierId",textField:"shippingTierName",cancelable:false,focusWhenSetValue:false,onSelected:function(f,g,e){var d=Number.MAX_VALUE;if(e){for(var c in e.shippingTierDtls){if(e.shippingTierDtls[c].shippingFee<d&&summary.currency>e.shippingTierDtls[c].invAmountFrom&&(!e.shippingTierDtls[c].invAmountTo||summary.currency<=e.shippingTierDtls[c].invAmountTo)){summary.shippingTier=e.shippingTierDtls[c].shippingFee;$("#shippingTier").text(summary.shippingTier);$("#actrualPayAmt").text(summary.currency+summary.shippingTier+summary.adjustMents)}}}}});$("#payAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.adjustment"),width:"98%",height:"auto"});liger.get("payAdjust").collapse();$("#coupons").ligerComboBox({css:"combobox",valueField:"value",textField:"meaning",cancelable:false});$("#adjustType").ligerComboBox({width:120,data:adjustTypeData,valueField:"value",textField:"meaning",cancelable:false});liger.get("serviceCenterId").set({readonly:true});liger.get("adjustType").setValue("add");for(var a in adjustTypeData){if(adjustTypeData[a].value=="add"){liger.get("adjustType").setText(adjustTypeData[a].meaning)}}}validate(false)};