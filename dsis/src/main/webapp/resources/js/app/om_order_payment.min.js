var saveEditButton;var queryBankCard;function init(){saveEditButton=$("#saveOrderPayment").ligerButton({click:saveOrderPayment,text:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.orderpaymentsave")});saveEditButton.setEnabled();$("#returnBtn").ligerButton({click:f_openConfirm,text:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.return")});$("#cancelOrder").ligerButton({click:cancelOrder,text:$l("type.com.lkkhpg.dsis.common.dto.order.cancel")});var b=$("#orderDetail").ligerButton({click:toOrderDetail,text:$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo")});var a=$("#bankCard").ligerButton({click:checkBankCard,text:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.querybank")})}function om_InitOrderNumberForm(){var a={inputWidth:150,space:10,fields:[{name:"salesOrgCode",type:"hidden"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.ordernumber"),type:"text",name:"orderNumber",newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.bonus.dto.bonusadjust.membercode"),type:"text",name:"memberCode",newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.membername"),type:"text",name:"memberName",newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.order.dto.shortcut_operation.currentmoneypv"),type:"text",name:"currentPv",newline:false,readonly:true},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.orderpv"),type:"text",name:"orderPv",newline:false,readonly:true}]};return a}function orgParamGet(a){var b=[{orgId:a,orgType:"SALES",paramNames:["SPM.PAY_BY_RB","SPM.PAYMENT_METHOD"]}];$.ajax({async:false,url:_basePath+"/spm/orgParam/get",type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(b),success:function(e){var f=e.rows;for(var d=0;d<f.length;d++){if(f[d]["paramValues"]["SPM.PAYMENT_METHOD"]){payMethodOrgParam=f[d]["paramValues"]["SPM.PAYMENT_METHOD"]}if(f[d]["paramValues"]["SPM.PAY_BY_RB"]){if(!f[d]["paramValues"]["SPM.PAY_BY_RB"][0]||f[d]["paramValues"]["SPM.PAY_BY_RB"][0]=="N"){var g=-1;for(var c=0;c<paymentMethodData.length;c++){if(paymentMethodData[c].value=="RBPAY"){g=c;break}}if(g!=-1){paymentMethodData.splice(g,1)}}}}}})}function om_showItemListGrid(){var a={height:250,width:"99%",usePager:false,enabledEdit:true,columns:om_getItemColumns(false,false),detail:{onShowDetail:f_getItemPackageDetail,height:"auto"},onBeforeShowData:function(b){f_valiOrderStatus(b.rows[0].orderStatus);if("RDEM"==b.rows[0].orderType){grid1.set({columns:om_getItemColumns(false,true)})}orgParamGet(b.rows[0].salesOrgId)},onAfterShowData:om_itemAfterShowData};a.url=_basePath+"/orderPayment/queryCommodityList?orderHeaderId="+orderHeaderId;return a}function om_getItemColumns(a,c){var b={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemsalestype"),name:"itemSalesType",isSort:false,type:"text",align:"center",isSort:false,render:function(h){if(!h){return}for(var i in productSalesTypeData){if(h.itemSalesType==productSalesTypeData[i].value){return productSalesTypeData[i].meaning}}}};var g={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.unitsellingprice"),name:"unitSellingPrice",type:"int",align:"center",isSort:false};var e={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.moneysubtotal"),name:"amount",type:"float",align:"center",isSort:false};if(c){g={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.unitredeempoint"),name:"unitRedeemPoint",type:"float",align:"center",isSort:false};e={display:$l("type.com.lkkhpg.dsis.common.order.dto.salesline.redeempoint"),name:"redeemPoint",type:"float",align:"center",isSort:false,render:function(h){if(!h){return}if(!h.unitRedeemPoint){h.unitRedeemPoint=0}return h.unitRedeemPoint*h.quantity}}}var d=[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.invorgname"),name:"defaultInvOrgId",width:120,type:"text",align:"center",isSort:false,render:function(j){if(!j){return}for(var h in invOrgs){if(j.defaultInvOrgId==invOrgs[h].invOrgId){return invOrgs[h].name}}}},b,{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemid"),name:"itemNumber",type:"text",align:"center",isSort:false},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemname"),name:"itemName",width:200,type:"text",align:"center",isSort:false},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.pvvalue"),name:"pv",type:"float",align:"center",isSort:false},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.voucherid"),name:"voucherName",type:"text",align:"center",isSort:false},g,{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.quantity"),name:"quantity",type:"int",align:"center",isSort:false},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.favorablesum"),name:"favorableSum",type:"float",align:"center",isSort:false},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.pvsubtotal"),name:"PVSubtotal",type:"float",align:"center",isSort:false,render:function(h){if(!h){return}if(!h.pv){h.pv=0}return h.pv*h.quantity}},e];if(a){var f={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemtax"),name:"tax",type:"float",align:"center",isSort:false};d.splice(6,0,f)}return d}function om_itemAfterShowData(v){orderNumber=v.rows[0].orderNumber;tab1form.setData({salesOrgCode:v.rows[0].salesOrgCode,orderNumber:orderNumber});var e=0;var p=0;memberId=v.rows[0].memberId;var o=v.rows[0].salesOrgId;codFlag=v.rows[0].codFlag;for(var q=0;q<defaultPayMethod.length;q++){if(v.rows[0].channel==defaultPayMethod[q].value){defaultPayMth=defaultPayMethod[q].meaning}}var n=v.rows[0].userType;var k=v.rows[0].orderType;var s=Number(v.rows[0].taxAmt).toFixed(2);var l=Number(v.rows[0].orderAmt).toFixed(2);var m=l-s;var r=v.rows[0].discountValueSum;if(r==null){r=0}var c=v.rows[0].adjustmentAmountCount;if(c==null){c=0}var j=v.rows[0].shippingFee;if(j==null){j=0}var h=Number(v.rows[0].actrualPayAmt).toFixed(2);var g=v.rows[0].salesPoint;for(var q=0;q<v.rows.length;q++){e+=(v.rows[q].pv*v.rows[q].quantity);p+=v.rows[q].redeemPoint;if(v.rows[q].itemSalesType=="EXCH"){curEB+=v.rows[q].amount}}if(v.rows[0].memAccountingBalances){var f=v.rows[0].memAccountingBalances;for(var q=0;q<f.length;q++){if("EB"==f[q].accountingType){exchangingBalance=f[q].balance}else{if("RB"==f[q].accountingType){remainingBalance=f[q].balance}}}}om_getEcupon();if(!("VIPP"==v.rows[0].orderType||"STDP"==v.rows[0].orderType)||ecuponList.length<=0){for(var d=0;d<paymentMethodData.length;d++){if(paymentMethodData[d].value=="ECUP"){paymentMethodData.splice(d,1)}}}if("RDEM"==v.rows[0].orderType){var u="<label align='right'>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salespointsummary")+" :</label>";var t="<label id='redeemPointSum' style='font-weight : bold;'>0</label>";var b="<label>"+$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.salespointsnow")+" :</label>";var a="<label id='salesPoint' style='font-weight : bold;'>0</label>";$("#salesLineSummary tr:eq(0) td:eq(2)").html(u);$("#salesLineSummary tr:eq(0) td:eq(3)").html(t);$("#salesLineSummary tr:eq(3) td:eq(0)").html(b);$("#salesLineSummary tr:eq(3) td:eq(1)").html(a);$("#redeemPointSum")[0].textContent=p;$("#salesPoint")[0].textContent=g}else{$("#afterTaxValue")[0].textContent=l}$("#discountValueSum")[0].textContent=Number("-"+r).toFixed(2);$("#actualPay")[0].textContent=h;$("#adjustmentAmountCount")[0].textContent=Number(c).toFixed(2);$("#shippingFee")[0].textContent=Number(j).toFixed(2);tab1form.setData({memberCode:v.rows[0].memberCode,memberName:v.rows[0].memberName,currrentPv:v.rows[0].currentPv,orderPv:e});$("#pvSum")[0].textContent=e;$("#paymentSum")[0].textContent=h;$("#balance")[0].textContent=h;grid2=$("#d_om_002_grid").ligerGrid(om_paymentMethodGrid(n));if("Y"==codFlag){grid2.addRow({orderHeaderId:orderHeaderId,salesOrgId:o,orderType:k,paymentMethod:"PODEL",paymentAmount:"",remark:"",redeemPointCount:p,})}else{if(h!=0){grid2.addRow({orderHeaderId:orderHeaderId,orderType:v.rows[0].orderType,salesOrgId:o,paymentMethod:defaultPayMth,paymentMethodInfo:"",paymentAmount:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:"",redeemPointCount:p,})}}}var lovCheckPassword;function checkBankCard(){if(!lovCheckPassword){window.checkform=$("#checkform").ligerForm({prefixID:"checkform_",fields:[{name:"memberId",type:"hidden",newline:false,options:{value:memberId}},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.cardpass"),name:"value",newline:true,type:"text",validate:{required:true}}]});lovCheckPassword=$.ligerDialog.open({height:150,width:350,allowClose:false,title:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.inputpass"),target:$("#checkform"),buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(b,a){if(Hap.validateForm(checkform)){a.hide();var c={url:_basePath+"/om/payment/checkBank",data:checkform.getData(),success:function(d){if("empty"==d.rows[0]){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.cardauthority"));a.hide();clearPassword()}else{if("error"==d.rows[0]){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.password_error"));a.hide();clearPassword()}else{if("true"==d.rows[0]){queryBankCard();a.hide();clearPassword()}}}}};Hap.ajax(c)}}},{text:$l("sys.hand.btn.cancel"),onclick:function(b,a){a.hide();clearPassword()}}]})}lovCheckPassword.show()}function clearPassword(){checkform.setData({value:""})}function queryBankCard(){$.ajax({type:"POST",url:_basePath+"/om/query/bankInfo?memberId="+memberId,success:function(a){showBankInfo(a.rows)}})}var lovBankInfo;function showBankInfo(a){if(!lovBankInfo){window.bankInfo=$("#bankInfo").ligerForm({prefixID:"bankInfo_",fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.bankcard"),name:"cardId",newline:true,type:"select",options:{data:a,valueField:"cardId",textField:"bankCode"},editor:{onChangeValue:function(d){for(var c=0;c<a.length;c++){if(d==a[c].cardId){liger.get("bankInfo").setData(a[c])}}}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.cardnumber"),name:"cardNumber",newline:true,type:"text",readonly:true},{display:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.effectdate"),name:"expiryDate",newline:true,type:"text",readonly:true},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditCardType"),name:"cardSubType",newline:true,type:"select",readonly:true,options:{data:creditCardTypeData,valueField:"value",textField:"meaning"}}]});lovBankInfo=$.ligerDialog.open({height:225,width:350,allowClose:false,title:$l("type.com.lkkhpg.dsis.common.member.dto.memberdetails.bankcardinfo"),target:$("#bankInfo"),buttons:[{text:$l("sys.hand.btn.cancel"),onclick:function(d,c){c.hide()}}]})}for(var b=0;b<a.length;b++){if(a[b].defaultFlag=="Y"){liger.get("bankInfo").setData(a[b])}}lovBankInfo.show()}function om_getEcupon(){$.ajax({url:_basePath+"/orderPayment/queryEcupon",type:"POST",dataType:"json",data:{orderHeaderId:orderHeaderId},success:function(a){ecuponList=a.rows}})}function om_paymentMethodGrid(c){var a=0;var b={unSetValidateAttr:false,columns:om_getPaymentColumns(false,false,c),enabledEdit:true,checkbox:true,usePager:false,width:"99%",onBeforeSubmitEdit:function(i){usedEb=usedEB();var f=i.column.columnname;var d=i.record.paymentMethod;var g=Number($("#balance")[0].textContent);a=Number(a);if(f=="paymentAmount"){if(Number(i.value)<=0){Hap.showError($l("type.com.lkkhpg.dsis.common.order.orderinvalid.amountError"));return false}if(Number(i.value)>(a+g)){Hap.showError($l("msg.error.order.amount_beyond"));return false}if(d=="EBPAY"){var h=i.record.paymentAmount;if(Number(i.value)>curEB-usedEb+h||Number(i.value)>exchangingBalance-usedEb+h){Hap.showError($l("msg.error.order.amount_eb_excessive_use"));return false}}if(d=="RBPAY"){var h=i.record.paymentAmount;if(Number(i.value)>remainingBalance-usedRB()+h){Hap.showError($l("msg.error.order.amount_rb_excessive_use"));return false}}}else{if(f=="paymentMethod"){if(i.value=="EBPAY"){if(curEB==0||curEB-usedEb<=0){Hap.showError($l("msg.error.order.amount_exchange_goods_is_zero"));return false}else{if(exchangingBalance==0||exchangingBalance-usedEb<=0){Hap.showError($l("msg.error.order.amount_eb_is_not_enough"));return false}}}else{if(i.value=="RBPAY"){if(remainingBalance==0||remainingBalance-usedRB()<=0){Hap.showError($l("msg.error.order.amount_rb_is_not_enough"));return false}}}}}},onAfterEdit:function(f){updateEcuponAmt(null);var d=$("#balance")[0].textContent;if(d==0){saveEditButton.setEnabled()}else{saveEditButton.setDisabled()}},onBeforeEdit:function(d){if(d.column.columnname=="paymentAmount"){a=d.value}if("Y"==codFlag){grid2.setCellEditing(d.record,d.column,false);return false}if("ECUP"==d.record.paymentMethod){if(d.column.columnname=="paymentAmount"){grid2.setCellEditing(d.record,d.column,false);return false}}},onAfterAddRow:function(d){grid2.updateCell("paymentAmount",$("#balance")[0].textContent,d);$("#balance")[0].textContent=0;saveEditButton.setEnabled()},toolbar:{items:[{text:$l("sys.hand.btn.new"),click:function(){var f=grid1.getData();var e=f[0].salesOrgId;var j=$("#balance")[0].textContent;var h=grid2.getData();if(grid2.getData()!=""){for(var g=0;g<h.length;g++){var d=h[g].paymentMethod;if("PODEL"==d||"ONLPA"==d){return false}}}if(j<=0){Hap.showError($l("msg.error.order.amount_beyond"));return false}grid2.addRow({orderHeaderId:orderHeaderId,orderType:f[0].orderType,salesOrgId:e,paymentMethod:defaultPayMth,paymentMethodInfo:"",paymentAmount:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:"",})},icon:"add"},{line:true},{text:$l("sys.hand.btn.delete"),click:function(){var g=grid2.getData();if(grid2.getData()!=""){for(var f=0;f<g.length;f++){var d=g[f].paymentMethod;if("PODEL"==d||"ONLPA"==d){return false}}}var e=grid2.getSelectedRow();grid2.deleteSelectedRow();updateEcuponAmt(e.paymentAmount)},icon:"delete"}]}};return b}function om_paymentBeforeEdit(a){if("Y"==codFlag){grid2.setCellEditing(a.record,a.column,false);return false}}function om_paymentAfterAddRow(a){if($("#balance")[0].textContent==0){saveEditButton.setEnabled()}}function om_getPaymentColumns(a,g,c){if("Y"==codFlag){a=true}var j={display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),name:"paymentMethod",align:"center",width:"20%",validate:{required:true},render:function(e){if(!e){return}if("IPONT"==c){for(var d=0;d<paymentMethodData.length;d++){if("ECUP"==paymentMethodData[d].value||("Y"==paymentMethodData[d].description&&paymentMethodData[d].value==e.paymentMethod)){return paymentMethodData[d].meaning}}}else{if(a||g){for(var d=0;d<paymentMethodFixed.length;d++){if(paymentMethodFixed[d].value==e.paymentMethod){return paymentMethodFixed[d].meaning}}}else{for(var d=0;d<paymentMethodData.length;d++){if(paymentMethodData[d].value==e.paymentMethod){return paymentMethodData[d].meaning}}}}}};var b=[j,{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentamount"),name:"paymentAmount",align:"center",width:"20%",editor:{type:"float"},option:{sign:false},validate:{required:true},totalSummary:{render:function(d,e){var i=$("#paymentSum")[0].textContent;$("#balance")[0].textContent=Number((i-d.sum)).toFixed(2)}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.otherInfo"),name:"otherInfo",align:"center",width:"60%",render:om_paymentOtherInfoRender}];if(!a){if("IPONT"==c){for(var f=0;f<paymentMethodData.length;f++){if("ECUP"==paymentMethodData[f].value){continue}if("Y"!=paymentMethodData[f].description||paymentMethodData[f].description==null){paymentMethodData.splice(f,1);f--}}}for(var h=0;h<payMethodOrgParam.length;h++){for(var l=0;l<paymentMethodData.length;l++){if(payMethodOrgParam[h]==paymentMethodData[l].value){payMethodList.push(paymentMethodData[l]);break}}}var k=false;for(var f=0;f<payMethodList.length;f++){if(defaultPayMth==payMethodList[f].value){k=true;break}}if(!k){defaultPayMth=""}j.editor={type:"select",data:payMethodList,valueField:"value",textField:"meaning",onChanged:function(e){var d=e.record.paymentAmount;if(e.value=="EBPAY"){if(exchangingBalance>=curEB){if(curEB-usedEb<d){$("#balance")[0].textContent=Number(d-curEB+usedEb+Number($("#balance")[0].textContent)).toFixed(2);d=Number(curEB-usedEb).toFixed(2)}}else{if(exchangingBalance-usedEb<d){$("#balance")[0].textContent=Number(d-exchangingBalance+usedEb+Number($("#balance")[0].textContent)).toFixed(2);d=Number(exchangingBalance-usedEb).toFixed(2)}}}else{if(e.value=="RBPAY"){if(remainingBalance-usedRB()<d){$("#balance")[0].textContent=Number(d-remainingBalance+usedRB()+Number($("#balance")[0].textContent)).toFixed(2);d=Number(remainingBalance).toFixed(2)}}else{if(e.value=="ECUP"){$("#balance")[0].textContent=Number(d+Number($("#balance")[0].textContent)).toFixed(2);d=Number(0).toFixed(2)}}}grid2.updateRow(e.record,{paymentAmount:d,paymentMethodInfo:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:""})}}}else{j.editor={type:"select",data:paymentMethodFixed,valueField:"value",textField:"meaning",onChanged:function(e){var d=e.record.paymentAmount;if(e.value=="EBPAY"){if(exchangingBalance>=curEB){if(curEB<d){d=curEB}}else{if(exchangingBalance<d){d=exchangingBalance}}curEB=-d;exchangingBalance=exchangingBalance-d}grid2.updateRow(e.record,{paymentAmount:d,paymentMethodInfo:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:""})}}}return b}function setGridData(c,a){var b=$(c).val();grid2.updateRow(grid2.getRow(a),{remark:b,})}function setGridEcupon(c){var f=$("#ecupon_"+c).val();var g=$("#ecupon_"+c).find("option:selected").text();var b=g.indexOf(" ");var a=Number(g.substring(0,b));var d=Number(grid2.getRow(c).paymentAmount);if(f==-1){$("#balance")[0].textContent=Number(d+Number($("#balance")[0].textContent)).toFixed(2);grid2.updateRow(grid2.getRow(c),{voucherId:"",paymentAmount:0})}else{if(a>(Number($("#balance")[0].textContent)+d)){grid2.updateRow(grid2.getRow(c),{voucherId:f,paymentAmount:Number($("#balance")[0].textContent)+d});$("#balance")[0].textContent=Number(0).toFixed(2)}else{grid2.updateRow(grid2.getRow(c),{voucherId:f,paymentAmount:a});$("#balance")[0].textContent=Number(d-a+Number($("#balance")[0].textContent)).toFixed(2)}}grid2.reRender();var e=$("#balance")[0].textContent;if(e==0){saveEditButton.setEnabled()}else{saveEditButton.setDisabled()}}function setGridEcupon2(c,e){var g=$("#ecupon_"+c).val();var h=$("#ecupon_"+c).find("option:selected").text();var b=h.indexOf(" ");var a=Number(h.substring(0,b));var d=Number(grid2.getRow(c).paymentAmount);if(g==-1){$("#balance")[0].textContent=Number(d+Number($("#balance")[0].textContent)).toFixed(2);grid2.updateRow(grid2.getRow(c),{voucherId:"",paymentAmount:0})}else{if(a>(Number($("#balance")[0].textContent)+d+Number(e))){grid2.updateRow(grid2.getRow(c),{voucherId:g,paymentAmount:Number($("#balance")[0].textContent)+d+Number(e)});$("#balance")[0].textContent=Number(0).toFixed(2)}else{grid2.updateRow(grid2.getRow(c),{voucherId:g,paymentAmount:a});$("#balance")[0].textContent=Number(d-a+Number($("#balance")[0].textContent)).toFixed(2)}}grid2.reRender();var f=Number($("#balance")[0].textContent)+Number(e);if(f==0){saveEditButton.setEnabled()}else{saveEditButton.setDisabled()}}function updateEcuponAmt(c){var b=grid2.getData();for(var a=0;a<b.length;a++){if(b[a].paymentMethod=="ECUP"){if(null!=c){setGridEcupon2(a,c)}else{setGridEcupon(a)}}}}function om_paymentOtherInfoRender(f,j,o,g){var l=f.paymentMethod;var n="";if(l==""||l=="CASH"||l=="PODEL"||l=="ONLPA"){n=$("#otherInfo1").clone();var a=n.find("input")[0];$(a).attr("id","remark_"+j);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+j+");")}else{if(l=="CREDI"){n=$("#otherInfo2").clone();var r=n.find("input")[0];$(r).attr("id","credit_card_type_"+j);$(r).attr("value",getCreditCardType(f.creditCardType));var d=n.find("input")[1];$(d).attr("id","tail_number_"+j);$(d).attr("value",f.tailNumber);var c=n.find("input[type=button]")[0];$(c).attr("onclick","javascript:editInfo("+j+")")}else{if(l=="DBCRD"){n=$("#otherInfo3").clone();var m=n.find("input")[0];$(m).attr("id","bank_code_"+j);$(m).attr("value",f.bankCode);var d=n.find("input")[1];$(d).attr("id","tail_number_"+j);$(d).attr("value",f.tailNumber);var c=n.find("input[type=button]")[0];$(c).attr("onclick","javascript:editInfo("+j+")")}else{if(l=="CHEQU"||l=="REMIT"){n=$("#otherInfo4").clone();var m=n.find("input")[0];$(m).attr("id","bank_code_"+j);$(m).attr("value",f.bankCode);var t=n.find("input")[1];$(t).attr("id","transaction_number_"+j);$(t).attr("value",f.transactionNumber);var c=n.find("input[type=button]")[0];$(c).attr("onclick","javascript:editInfo("+j+")")}else{if(l=="EBPAY"){n=$("#otherInfo5").clone();var k=n.find("input")[0];$(k).attr("id","eb1_"+j);$(k).attr("value",exchangingBalance);var h=n.find("input")[1];$(h).attr("id","eb2_"+j);$(h).attr("value",curEB)}else{if(l=="RBPAY"){n=$("#otherInfo6").clone();var p=n.find("input")[0];$(p).attr("id","rb"+j);$(p).attr("value",remainingBalance)}else{if(l=="ECUP"){n=$("#otherInfo7").clone();var a=n.find("input")[0];$(a).attr("id","remark_"+j);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+j+");");var s=n.find("select")[0];$(s).attr("id","ecupon_"+j);$(s).attr("onchange","setGridEcupon("+j+");");s.options.add(new Option($l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.choose.ecupon"),-1));var v=grid2.getData();var e=[];for(var q=0;q<v.length;q++){if(v[q].paymentMethod=="ECUP"&&v[q].__id!=f.__id&&!checkNull(v[q].voucherId)){e.push({voucherId:v[q].voucherId})}}var u=[];for(var q=0;q<ecuponList.length;q++){if(!containList(ecuponList[q].voucherId,e)){u.push(ecuponList[q])}}for(var q=0;q<u.length;q++){var b='<option value="'+u[q].voucherId+'" '+(u[q].voucherId==f.voucherId?"selected":"")+">"+u[q].discountValue+" "+u[q].name+"</option>";$(s).append(b)}}else{n=$("#otherInfo1").clone();var a=n.find("input")[0];$(a).attr("id","remark_"+j);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+j+");")}}}}}}}return n.html()}function containList(c,b){for(var a=0;a<b.length;a++){if(c==b[a].voucherId){return true}}return false}function getCreditCardType(b){for(var a=0;a<creditCardTypeData.length;a++){if(creditCardTypeData[a].value==b){return creditCardTypeData[a].meaning}}}function om_paymentShowDialogInfo(){var a={inputWidth:100,labelWidth:80,space:40,fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditCardType"),name:"creditCardType",newline:true,type:"combobox",options:{data:creditCardTypeData,valueField:"value",textField:"meaning",isMultiSelect:false},validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.bank"),name:"bankCode",newline:false,type:"text",},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.tailnumber"),name:"tailNumber",newline:true,type:"text",validate:{required:true,minlength:4,maxlength:4}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.pos"),name:"paymentMethodInfo",newline:false,type:"select",options:{data:posSelectData,valueField:"value",textField:"meaning",isMultiSelect:false}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),name:"transactionNumber",newline:true,type:"text",width:200},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:true,type:"text",width:200}]};return a}function getBankName(b){for(var a=0;a<bankBelongData.length;a++){if(bankBelongData[a].value==b){return bankBelongData[a].meaning}}}function editInfo(b){var c=grid2.getRow(b);var a=grid2.getRow(b).paymentMethod;if(a=="CHEQU"||a=="REMIT"){tab3form.setVisible(["creditCardType","tailNumber","paymentMethodInfo"],false)}if(a=="CHEQU"||a=="DBCRD"||a=="CREDI"){tab3form.setFieldValidate("transactionNumber",{required:true})}else{if(a=="REMIT"){tab3form.setFieldValidate("transactionNumber",{required:false})}}liger.get("tab3form").setData({creditCardType:c.creditCardType,bankCode:c.bankCode,tailNumber:c.tailNumber,paymentMethodInfo:c.paymentMethodInfo,transactionNumber:c.transactionNumber,remark:c.remark});$.ligerDialog.open({target:$("#div3"),title:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.otherInfo"),name:"otherInfo",width:500,height:300,isResize:true,modal:true,allowClose:false,buttons:[{text:$l("sys.hand.btn.ok"),cls:"l-dialog-btn-highlight",onclick:function(e,d){var f=liger.get("tab3form").getData();f.paymentMethod=grid2.getRow(b).paymentMethod;if(!checkoutOtherInfo(f)){Hap.showError($l("type.com.lkkhpg.dsis.common.order.orderinvalid.otherinfoerror"));return false}grid2.updateRow(grid2.getRow(b),{creditCardType:f.creditCardType,transactionNumber:f.transactionNumber,bankCode:f.bankCode,tailNumber:f.tailNumber,remark:f.remark,paymentMethodInfo:f.paymentMethodInfo,});tab3form.setVisible(["bankCode","creditCardType","creditCardType","tailNumber","paymentMethodInfo"],true);d.hide()}},{text:$l("sys.hand.btn.cancel"),onclick:function(e,d){tab3form.setVisible(["bankCode","creditCardType","creditCardType","tailNumber","paymentMethodInfo"],true);d.hide()}}]})}function cancelOrder(){var a=grid1.getData();var b=a[0].orderStatus;if("WPAY"!=b){Hap.showError($l("msg.error.order.status_not_allow_pay"));return false}$.ligerDialog.confirm($l("msg.warn.iscancel"),function(d){if(d){var c={orderStatus:"CANCL",headerId:orderHeaderId};$.ajax({type:"POST",url:_basePath+"/om/order/update",data:JSON2.stringify(c),contentType:"application/json; charset=utf-8",success:function(e){window.top.f_removeTab("ORDER_INFO");window.top.f_addTab("ORDER_INFO",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderHeaderId);window.top.f_removeTab("ORDER_PAYMENT")}})}})}function f_valiOrderStatus(a){if("WPAY"!=a){Hap.showError($l("msg.error.order.status_not_allow_pay"),function(){window.top.f_removeTab("ORDER_CREATE");window.top.f_addTab("ORDER_INFO",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderquery"),_basePath+"/om/om_order_query.html")})}}function toOrderDetail(){window.top.f_removeTab("ORDER_INFO");window.top.f_addTab("ORDER_INFO",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderHeaderId);window.top.f_removeTab("ORDER_CREATE")}function saveOrderPayment(){if(!Hap.validateGrid(d_om_002_grid)){return false}var h;var b="";var d=grid1.getData();var c=d[0].orderType;var a=d[0].salesPoint;var e;var f=grid2.getData();if(!checkoutInfo(f)){Hap.showError($l("type.com.lkkhpg.dsis.common.order.orderinvalid.infoerror"));return false}if(c=="RDEM"){e=$("#redeemPointSum")[0].textContent;if(a-e<=0){Hap.showError($l("msg.error.om.sales_point_insufficient"));return false}}var g;if("RDEM"==c){g=$l("msg.info.order.total_payment")+e+$l("msg.info.order.sales_point")+$("#actualPay")[0].textContent+$l("msg.info.order.amount_confirm")}else{g=$l("msg.info.order.total_payment")+$("#actualPay")[0].textContent+$l("msg.info.order.amount_confirm")}$.ligerDialog.confirm($l(g),$l("sys.hand.tip.info"),function(j){if(j){var i=checkEcuponAmt();if(i>0){$.ligerDialog.confirm($l("type.com.lkkhpg.dsis.common.order.orderinvalid.ecupon.beyond")+i+","+$l("msg.warning.om.confirm_payment"),function(k){if(k){createOrderPayment(f)}})}else{createOrderPayment(f)}}})}function checkEcuponAmt(){var a=grid2.getData();var e=0;for(var d=0;d<a.length;d++){if(a[d].paymentMethod=="ECUP"){var c=0;for(var b=0;b<ecuponList.length;b++){if(ecuponList[b].voucherId==a[d].voucherId){c=ecuponList[b].discountValue}}if(c>0&&c>Number(a[d].paymentAmount)){e+=c-Number(a[d].paymentAmount)}}}return e}function createOrderPayment(a){$.ligerDialog.waitting($l("sys.hand.tip.processing"));$.ajax({url:_basePath+"/orderPayment/createOrderPayment?orderHeaderId="+orderHeaderId,type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(a),success:function(b){if(b.success){if(b.rows&&b.rows.length>0){window.top.f_removeTab("ORDER_INFO");window.top.f_addTab("ORDER_INFO",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderHeaderId);window.top.f_removeTab("ORDER_CREATE")}else{$.ligerDialog.alert($l("msg.warning.om.need_pick_up"),function(){window.top.f_removeTab("ORDER_INFO");window.top.f_addTab("ORDER_INFO",$l("type.com.lkkhpg.dsis.common.order.dto.queryorder.orderinfo"),_basePath+"/om/om_order_detail.html?orderId="+orderHeaderId);window.top.f_removeTab("ORDER_CREATE")})}}},error:function(b){Hap.showError($l("msg.error.order.failure_pay_again"))}})}function checkoutOtherInfo(a){if("CHEQU"==a.paymentMethod){if(checkNull(a.transactionNumber)){return false}}else{if("CREDI"==a.paymentMethod||"DBCRD"==a.paymentMethod){if(isNaN(a.tailNumber)){return false}if(checkNull(a.creditCardType)||checkNull(a.transactionNumber)||checkNull(a.tailNumber)||(a.tailNumber+"").length!=4){return false}}}return true}function checkoutInfo(c){var a;for(var b in c){a=c[b];if(!checkoutOtherInfo(a)){return false}if(checkNull(a.paymentAmount)||a.paymentAmount<=0){if(codFlag=="Y"&&a.paymentAmount==0){return true}return false}}return true}function checkNull(a){if(null==a||""==a){return true}return false}function usedEB(){var c=grid2.getData();if(!c){return 0}var a=0;for(var b=0;b<c.length;b++){if(c[b].paymentMethod=="EBPAY"){a=a+Number(c[b].paymentAmount)}}return a}function usedRB(){var c=grid2.getData();if(!c){return 0}var b=0;for(var a=0;a<c.length;a++){if(c[a].paymentMethod=="RBPAY"){b=b+Number(c[a].paymentAmount)}}return b}function f_getItemPackageDetail(c,a,d){if(c.itemType!="PACKG"&&c.itemType!="VN"&&c.itemType!="VY"){return}var b=document.createElement("div");$(a).append(b);$(b).css("margin",10).ligerGrid({columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemid"),name:"itemNumber",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.itemname"),name:"itemName",type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.quantity"),name:"quantity"}],isScroll:false,showToggleColBtn:false,width:500,url:_basePath+"/inv/item/queryHierarchyByItemId?itemId="+c.itemId,showTitle:false,usePager:false,onAfterShowData:d,frozen:false})}function f_openConfirm(){console.log("77777");var a=window.top.tab.getSelectedTabItemID();var b=orderHeaderId;if(!orderHeaderId){$.ligerDialog.error($l("msg.error.order_pls_save_order"));return}$.ajax({type:"POST",url:_basePath+"/om/order/paytosave?orderId="+b,success:function(c){window.top.f_removeTab(a);window.top.f_addTab("ORDER_CREATE",$l("msg.info.order.confirm"),_basePath+"/om/om_order_confirm.html?orderId="+b)}})};