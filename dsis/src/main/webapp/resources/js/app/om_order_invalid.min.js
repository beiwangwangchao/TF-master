var headerId=0;var amount=0;var amountLess=0;var market;var balance=0;var payments;var paymentMethodFixed=[];var payMethodList=[];var ajaxTemp1=null;var ajaxTemp2=null;var ajaxTemp3=null;function getPaymentOfEditPaymentMth(){headerId=$("#headerId").val();if(!headerId){return}isCod=liger.get("isCod").getValue();if(isCod){Hap.showError($l("msg.warning.om.paymentedit.podel.not_allow_edit"));return false}loadEditform();getMethod(true);$.ajax({url:_basePath+"/om/orderinfo/queryPayments?headerId="+headerId,type:"POST",dataType:"json",contentType:"application/json",success:function(b){if(b.rows[0]=="error"){Hap.showError($l("msg.warning.om.paymentedit.get.payment_error"))}else{amount=0;payments=null;for(var a=0;a<b.total;a++){amount+=b.rows[a].paymentAmount}if(amount){payments=b;invalid2=window.invalid2=$("#invalid2").ligerGrid(initInvalidGrid(true));dialog_editPayMethod()}else{Hap.showError($l("msg.warning.om.paymentedit.not_allow_edit"));return false}}},error:function(){Hap.showError($l("type.com.lkkhpg.dsis.common.order.error.edit_paymethod"))}})}function dialog_editPayMethod(){$.ligerDialog.open({target:$("#invalidFrame"),title:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.paymentinfo"),width:1020,height:500,modal:true,isResize:true,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(b,e){var c=liger.get("amountsform").getData().invalidBalance;if(!checkoutInfo(invalid2.getData())){Hap.showError($l("type.com.lkkhpg.dsis.common.order.orderinvalid.infoerror"));return false}if(c!=0){Hap.showError($l("type.com.lkkhpg.dsis.common.order.orderinvalid.errorrefundamounts"));return false}else{var a=invalid2.currentData.rows;$.ajax({url:_basePath+"/om/update/paymentInfo?orderHeaderId="+headerId,type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(a),success:function(f){if(f.success){Hap.showSuccess($l("msg.info.om.paymethod.edit_successful"),function(){location.reload()});e.hide()}},error:function(){Hap.showError($l("type.com.lkkhpg.dsis.common.order.error.update_payment"))}})}}},{text:$l("sys.hand.btn.cancel"),onclick:function(a,b){b.hide()}}]})}function getMethod(c){payMethodList=[];paymentMethodFixed=[];if(c){payMethodList=modifyPayinfoPaymethod}else{payMethodList=voidPaymethodData}for(var b=0;b<orgParamPayMethod.length;b++){for(var a=0;a<payMethodList.length;a++){if(orgParamPayMethod[b]==payMethodList[a].value){paymentMethodFixed.push(payMethodList[a])}}}}function getMarket(a){a=$("#headerId").val();if(!a){return}loadEditform();loadAmountsform();$.ajax({url:_basePath+"/om/order/querySpmRefund?headerId="+a,type:"POST",dataType:"json",contentType:"application/json",success:function(b){if(b.success){market=b.rows[0];getMethod(false);getPayment()}},error:function(){alert("error")}})}function getPayment(){headerId=$("#headerId").val();isCod=liger.get("isCod").getValue();$.ajax({url:_basePath+"/om/order/queryPayments?headerId="+headerId,type:"POST",dataType:"json",contentType:"application/json",success:function(b){if(b.rows[0]=="error"){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.orderinvalid.refundConditions"))}else{if(isCod){payments=b.rows;invalidDialog3()}else{amount=0;amountLess=0;payments=null;for(var a=0;a<b.total;a++){amount+=b.rows[a].paymentAmount;if("EBPAY"!=b.rows[a].paymentMethod&&"RBPAY"!=b.rows[a].paymentMethod&&"ECUP"!=b.rows[a].paymentMethod){amountLess+=b.rows[a].paymentAmount}}payments=b;if(market=="Y"){invalidDialog1()}else{invalid2=window.invalid2=$("#invalid2").ligerGrid(initInvalidGrid());invalidDialog2()}}}},error:function(){alert("error")}})}function invalidDialog1(){$("#invalid_lable").text(amountLess+$l("type.com.lkkhpg.dsis.common.order.orderinvalid.refundtoremain"));$.ligerDialog.open({target:$("#invalid1"),title:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.refund"),width:400,height:200,modal:true,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(b,c){var a=JSON2.stringify($("#invalid_text").val());if(ajaxTemp1&&ajaxTemp1.readyState!=4){return}ajaxTemp1=$.ajax({url:_basePath+"/om/order/invalidToRemaining?headerId="+headerId,type:"POST",dataType:"json",contentType:"application/json",data:a,success:function(e){if(e.success){$.ligerDialog.success($l("type.com.lkkhpg.dsis.common.order.orderinvalid.refundsuccess"),function(){location.reload()});c.hide()}},error:function(){alert("error")}});$("#invalid_text").val("")}},{text:$l("sys.hand.btn.cancel"),onclick:function(a,b){$("#invalid_text").val("");b.hide()}}]})}function loadAmountsform(b){var a="type.com.lkkhpg.dsis.common.order.orderinvalid.refundamounts";if(b){a="type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentamount"}amountsform=$("#amountsform").ligerForm({inputWidth:80,labelWidth:80,space:40,align:"center",labelAlign:"center",readonly:true,fields:[{display:$l(a),name:"invalidAmount",newline:true,type:"text",},{display:$l("type.com.lkkhpg.dsis.common.member.dto.accountingtrx.balance"),name:"invalidBalance",newline:false,type:"text",}]})}function initInvalidGrid(f){var e="type.com.lkkhpg.dsis.common.order.orderinvalid.refundamounts";if(f){e="type.com.lkkhpg.dsis.common.inv.dto.transaction.totalprice"}loadAmountsform(f);var c=0;var b=0;liger.get("amountsform").setData({invalidAmount:amount,invalidBalance:balance,});var a={columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.paymentmethod"),name:"paymentMethod",align:"center",width:260,editor:{type:"combobox",data:paymentMethodFixed,valueField:"value",textField:"meaning",onChanged:function(g){invalid2.updateRow(invalid2.getSelected(),{paymentMethodInfo:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:"",})},},render:function(h){for(var g=0;g<allPayMethod.length;g++){if(allPayMethod[g].value==h.paymentMethod){return allPayMethod[g].meaning}}return""},},{display:$l(e),align:"center",name:"paymentAmount",width:260,type:"float",editor:{type:"float",},totalSummary:{render:function(g,h){liger.get("amountsform").setData({invalidBalance:(amount-g.sum),})}}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.otherinfo"),name:"transactionNumber",align:"center",render:gridRender,}],data:payments,enabledEdit:true,width:980,height:400,usePager:false,onBeforeEdit:function(g){if(g.column.columnname=="paymentAmount"){c=g.value;b=liger.get("amountsform").getData().invalidBalance}if("ECUP"==g.record.paymentMethod||"EBPAY"==g.record.paymentMethod||"RBPAY"==g.record.paymentMethod||"ONLPA"==g.record.paymentMethod||"CDCRD"==g.record.paymentMethod){if(g.column.columnname=="paymentAmount"||g.column.columnname=="paymentMethod"){invalid2.setCellEditing(g.record,g.column,false);return false}}},onBeforeSubmitEdit:function(g){if(g.column.columnname=="paymentAmount"){if(g.value<0){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.orderinvalid.amountError"));return false}if(g.value>(b+c)){$.ligerDialog.error($l("msg.error.order.amount_beyond"));return false}return true}},onAfterAddRow:function(g){invalid2.updateCell("paymentAmount",liger.get("invalidBalance").getValue(),g);liger.get("invalidBalance").setValue(0);if($("#balance")[0].textContent==0){saveEditButton.setEnabled()}},toolbar:{items:[{text:$l("sys.hand.btn.new"),icon:"add",click:function(){invalid2.addRow({orderHeaderId:headerId,salesOrgId:payments.rows[0].salesOrgId,paymentMethod:"CASH",paymentMethodInfo:"",paymentAmount:"",transactionNumber:"",bankCode:"",creditCardType:"",tailNumber:"",remark:"",})}},{line:true},{text:$l("sys.hand.btn.delete"),icon:"delete",click:function(){invalid2.deleteSelectedRow()}}]}};return a}function invalidDialog2(){$.ligerDialog.open({target:$("#invalidFrame"),title:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.refund"),width:1020,height:500,modal:true,isResize:true,buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(b,e){var c=liger.get("amountsform").getData().invalidBalance;if(!checkoutInfo(invalid2.getData())){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.orderinvalid.infoerror"));return false}if(c!=0){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.orderinvalid.errorrefundamounts"))}else{var a=JSON2.stringify(invalid2.getData());if(ajaxTemp2&&ajaxTemp2.readyState!=4){return}ajaxTemp2=$.ajax({url:_basePath+"/om/order/updatePaymentRefund?headerId="+headerId,type:"POST",dataType:"json",contentType:"application/json",data:a,success:function(f){if(f.success){$.ligerDialog.success($l("type.com.lkkhpg.dsis.common.order.orderinvalid.refundsuccess"),function(){location.reload()});e.hide()}},error:function(){alert("error")}})}}},{text:$l("sys.hand.btn.cancel"),onclick:function(a,b){b.hide()}}]})}function invalidDialog3(){$.ligerDialog.confirm($l("type.com.lkkhpg.dsis.common.order.orderinvalid.confirminvalid"),function(a){if(a){if(ajaxTemp3&&ajaxTemp3.readyState!=4){return}ajaxTemp3=$.ajax({url:_basePath+"/om/order/updatePaymentRefund?headerId="+headerId,type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(payments),success:function(b){if(b.success){$.ligerDialog.success($l("type.com.lkkhpg.dsis.common.order.orderinvalid.refundsuccess"),function(){location.reload()});d.hide()}},error:function(){alert("error")}})}})}function gridRender(f,i,q,g){var c=f.paymentMethod+"";if(f.paymentMethod=="CASH"||f.paymentMethod=="CDCRD"||f.paymentMethod=="ONLPA"){var r=$("#remarkText").clone();var a=r.find("input")[0];$(a).attr("id","remark_"+i);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+i+");");return r.html()}else{if(f.paymentMethod=="CREDI"){var b=$("#creditText").clone();var n=b.find("input")[0];$(n).attr("id","credit_card_type_"+i);$(n).attr("value",getCreditCardType(f.creditCardType));var l=b.find("input")[1];$(l).attr("id","tail_number_"+i);$(l).attr("value",f.tailNumber);var m=b.find("input")[2];$(m).attr("onclick","javascript:editInfo("+i+',"'+f.paymentMethod+'");');return b.html()}else{if(f.paymentMethod=="DBCRD"){var j=$("#debitText").clone();var o=j.find("input")[0];$(o).attr("id","bank_code_"+i);$(o).attr("value",f.bankCode);var e=j.find("input")[1];$(e).attr("id","tail_number_"+i);$(e).attr("value",f.tailNumber);var m=j.find("input")[2];$(m).attr("onclick","javascript:editInfo("+i+',"'+f.paymentMethod+'");');return j.html()}else{if(f.paymentMethod=="REMIT"||f.paymentMethod=="CHEQU"){var p=$("#chequeText").clone();var o=p.find("input")[0];$(o).attr("id","bank_code_"+i);$(o).attr("value",f.bankCode);var s=p.find("input")[1];$(s).attr("id","transaction_number_"+i);$(s).attr("value",f.transactionNumber);var m=p.find("input")[2];$(m).attr("onclick","javascript:editInfo("+i+',"'+f.paymentMethod+'");');return p.html()}else{if(f.paymentMethod=="EBPAY"||f.paymentMethod=="RBPAY"){var r=$("#remarkText").clone();var a=r.find("input")[0];$(a).attr("id","remark_"+i);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+i+");");return r.html()}else{if(f.paymentMethod=="ECUP"){var k=$("#ecuponText").clone();var a=k.find("input")[1];$(a).attr("id","remark_"+i);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+i+");");var h=k.find("input")[0];$(h).attr("id","ecupon_"+i);$(h).attr("value",f.discountValue+"  "+f.name);return k.html()}else{var r=$("#remarkText").clone();var a=r.find("input")[0];$(a).attr("id","remark_"+i);$(a).attr("value",f.remark);$(a).attr("onblur","javascript:setGridData(this,"+i+");");return r.html()}}}}}}}function getCreditCardType(b){for(var a=0;a<creditCardType.length;a++){if(creditCardType[a].value==b){return creditCardType[a].meaning}}}function setGridData(c,a){var e=$(c).attr("id");var b=$(c).val();invalid2.updateRow(invalid2.getRow(a),{remark:b,})}function loadEditform(){var a=[{value:"VISA",meaning:"VISA"},{value:"MASTER",meaning:"MASTER"}];editform=window.editform=$("#editform").ligerForm({inputWidth:100,labelWidth:80,space:40,rightToken:" ",fields:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.creditcardtype"),name:"creditCardType",newline:true,type:"combobox",options:{valueField:"value",textField:"meaning",data:creditCardType,},validate:{required:true}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.bank"),name:"bankCode",newline:false,type:"text",},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.tailnumber"),name:"tailNumber",newline:true,type:"text",validate:{required:true,minlength:4,maxlength:4}},{display:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.pos"),name:"paymentMethodInfo",newline:false,type:"combobox",options:{valueField:"value",textField:"meaning",data:posSelectData,}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.orderpayment.transactionnumber"),name:"transactionNumber",newline:true,type:"text",width:200},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesorder.remark"),name:"remark",newline:true,type:"text",width:200}]})}function editInfo(c,a){var b=invalid2.getRow(c);if(a=="CREDI"){}else{if(a=="DBCRD"){}else{if(a=="CHEQU"||a=="REMIT"){editform.setVisible(["creditCardType","tailNumber","paymentMethodInfo"],false)}}}liger.get("editform").setData({creditCardType:b.creditCardType,bankCode:b.bankCode,tailNumber:b.tailNumber,paymentMethodInfo:b.paymentMethodInfo,transactionNumber:b.transactionNumber,remark:b.remark});$.ligerDialog.open({target:$("#invalid3"),title:$l("type.com.lkkhpg.dsis.common.order.orderinvalid.refund"),width:500,height:300,modal:true,isResize:true,isHidden:true,allowClose:false,buttons:[{text:$l("sys.hand.btn.ok"),cls:"l-dialog-btn-highlight",onclick:function(h,g){var f=liger.get("editform").getData();var e=f.tailNumber+"";invalid2.updateRow(invalid2.getRow(c),{creditCardType:f.creditCardType,transactionNumber:f.transactionNumber,bankCode:f.bankCode,tailNumber:e,remark:f.remark,paymentMethodInfo:f.paymentMethodInfo,});if(!checkoutOtherInfo(invalid2.getRow(c))){$.ligerDialog.error($l("type.com.lkkhpg.dsis.common.order.orderinvalid.otherinfoerror"));return false}editform.setVisible(["bankCode","creditCardType","creditCardType","tailNumber","paymentMethodInfo"],true);g.hide()}},{text:$l("sys.hand.btn.cancel"),onclick:function(f,e){editform.setVisible(["bankCode","creditCardType","creditCardType","tailNumber","paymentMethodInfo"],true);e.hide()}}]})}function checkoutOtherInfo(a){if("CHEQU"==a.paymentMethod){if(checkNull(a.transactionNumber)){return false}}else{if("CREDI"==a.paymentMethod){if(checkNull(a.creditCardType)||checkNull(a.transactionNumber)||checkNull(a.tailNumber)||a.tailNumber.length!=4||isNaN(a.tailNumber)){return false}}else{if("DBCRD"==a.paymentMethod){if(checkNull(a.creditCardType)||checkNull(a.transactionNumber)||checkNull(a.tailNumber)||a.tailNumber.length!=4||isNaN(a.tailNumber)){return false}}}}return true}function checkoutInfo(c){var a;for(var b in c){a=c[b];if(!checkoutOtherInfo(a)){return false}if(checkNull(a.paymentAmount)||a.paymentAmount<=0){return false}}return true}function checkNull(a){if(null==a||""==a){return true}return false};