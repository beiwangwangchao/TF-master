function init(){$("#returnAdjust").ligerPanel({title:$l("type.com.lkkhpg.dsis.common.order.dto.return.manualadjustment"),width:"98%",height:"auto"});printBtn=$("#printBtn").ligerButton({text:$l("msg.info.order.salesreturn.print"),click:function(){f_printList()}});deleteBtn=$("#deleteBtn").ligerButton({text:$l("sys.hand.btn.delete"),click:function(){var a=$("#returnId").val();if(a){f_deleteReturnInfo()}else{Hap.showError($l("msg.warning.dto.salesreturn.return.not_save"));return false}}});saveBtn=$("#saveBtn").ligerButton({text:$l("sys.hand.btn.save"),click:function(){f_saveReturnInfo()}});submitBtn=$("#submitBtn").ligerButton({text:$l("sys.hand.btn.submit"),click:function(){f_submitReturnInfo()}})}function f_getOrgParam(b,a){$.ligerDialog.waitting($l("sys.hand.tip.processing"));var c=[{orgType:"SALES",orgId:b,paramNames:["SPM.ENABLE_TAX","SPM.TAX_CODE","SPM.RETURN_TYPE","SPM.RETURN_LIMIT","SPM.REFUND_WAY_OPTION","SPM.CURRENCY","SPM.ENABLE_CONVERSION_RATE"]}];$.ajax({url:_basePath+"/spm/orgParam/get",type:"POST",dataType:"json",contentType:"application/json",data:JSON2.stringify(c),success:function(f){spmTaxFlag=f.rows[0].paramValues["SPM.ENABLE_TAX"];spmRefundMethod=f.rows[0].paramValues["SPM.REFUND_WAY_OPTION"];spmTaxCode=f.rows[0].paramValues["SPM.TAX_CODE"];spmReturnType=f.rows[0].paramValues["SPM.RETURN_TYPE"];spmReturnLimit=f.rows[0].paramValues["SPM.RETURN_LIMIT"];spmCurrentCode=f.rows[0].paramValues["SPM.CURRENCY"];spmEnableConversionRate=f.rows[0].paramValues["SPM.ENABLE_CONVERSION_RATE"];if(a&&a.rows[0].returnStatus=="NEW"){if(f_valiReturnDate(a.rows[0].payDate)){Hap.showError($l("msg.warning.dto.salesreturn.returndate.not_in_period"),function(){window.parent.f_removeTab("UPDATE_RETURN")},{allowClose:false});return false}}$.getJSON(_basePath+"/spm/currency/query?currencyCode="+spmCurrentCode[0],function(i){if(i.success&&i.rows[0]){precision=i.rows[0].precision}});for(var e=0;e<returnTypeData.length;e++){for(var d=0;d<spmReturnType.length;d++){if(spmReturnType[d]==returnTypeData[e].value){returnType.push(returnTypeData[e]);break}}}liger.get("returnType").setData(returnType);var h=spmTaxCode[0];if(!h){h="NaN"}var g={taxCode:spmTaxCode[0],isActive:"Y"};$.getJSON(_basePath+"/spm/tax/queryForOrder",g,function(j){if(j.success){if(j.rows==null||j.rows.length==0){taxPercent=0}else{taxPercent=j.rows[0].taxPercent/100}var k="NEW";if(a){f_setReturnDetai(a);k=a.rows[0].returnStatus}f_getReturnMethod(spmRefundMethod);var i=$("#returnId").val();if(i){f_initPage(k)}else{liger.get("returnDate").setValue(new Date());liger.get("creationDate").setValue(new Date())}}});$.ligerDialog.closeWaitting()}})}function f_getReturnMethod(f){var b=[];var a=$("#orderType").val();if(f){for(var g=0;g<refundWayData.length;g++){for(var h=0;h<f.length;h++){if(refundWayData[g].value==f[h]){refundMethodsData.push(refundWayData[g]);break}}}}if(a){if(refundMethod.length!=0){refundMethod.splice(0,refundMethod.length)}for(var c=0;c<orderTypeRmMethod.length;c++){if(orderTypeRmMethod[c].value==a){b=(orderTypeRmMethod[c].meaning).split(";");break}}for(var g=0;g<b.length;g++){for(var h=0;h<refundMethodsData.length;h++){if(b[g]==refundMethodsData[h].value){refundMethod.push(refundMethodsData[h]);break}}}}}function f_getLocation(b,a){$.ajax({url:_basePath+"/om/return/getLocation",type:"POST",data:b,success:function(c){if(a){liger.get("salesOrgLocation").setValue(c.rows[0].addressReturn)}else{liger.get("invOrgLocation").setValue(c.rows[0].addressReturn)}}})}function f_onSelectedOrderNumber(d){var i=new Date();var b=i.getTime();var e=new Date(Date.parse((d.data[0].payDate).replace(/-/g,"/"))).getTime();var j=Math.abs((b-e))/(1000*60*60*24);if(j>spmReturnLimit[0]){Hap.showError($l("msg.warning.dto.salesreturn.returndate.not_in_period"));liger.get("orderNumber").setValue();liger.get("orderNumber").setText();submitBtn.setDisabled();return false}f_reset();om_return_form.setData(d.data[0]);var h=d.data[0].orderType;if(h=="RDEM"){liger.get("returnType").setValue("REFD");liger.get("returnType").setDisabled()}else{liger.get("returnType").setEnabled()}$("[toolbarid='om_rtnRefund_gridAdd']").show();$("[toolbarid='om_rtnRefund_gridDel']").show();liger.get("returnStatus").setValue("NEW");liger.get("creationDate").setValue(new Date());liger.get("returnDate").setValue(new Date());liger.get("returnAdjustFlag").setValue("N");liger.get("shippingFeeFlag").setValue("N");var g=d.data[0].shippingFeeFlag;$("#shippingFeeFlagBefore").val(g);var f=Number(d.data[0].shippingFeeAmt);if(g!="Y"&&f){liger.get("shippingFeeFlag").setEnabled()}else{liger.get("shippingFeeFlag").setDisabled()}var a=d.data[0].returnAdjustFlag;$("#rtnAdjustFlagBefore").val(a);var c=Number(d.data[0].adjustAmt);if(a!="Y"&&c){liger.get("returnAdjustFlag").setEnabled()}else{liger.get("returnAdjustFlag").setDisabled()}f_getReturnMethod(null)}function f_reset(){liger.get("returnType").setValue();liger.get("returnReason").setValue();liger.get("invOrgId").setValue("");liger.get("invOrgId").setText("");liger.get("returnPromotion").setValue();liger.get("invOrgLocation").setValue("");liger.get("remark").setValue("");$("#manualAdjustAmt").val("");$("#comments").val("");$("#returnAmtCount")[0].textContent=0;$("#rtnPromotionSum")[0].textContent=0;$("#adjustAmtCount")[0].textContent=0;$("#shippingFeeAmtCount")[0].textContent=0;$("#actualRtnAmt")[0].textContent=0;$("#taxAmt")[0].textContent=0;om_return_grid.loadData();om_rtnRefund_grid.loadData()}function f_valiReturnDate(d){var c=new Date();var a=d;var e=c.getTime();var b=new Date(Date.parse(a.replace(/-/g,"/"))).getTime();var f=Math.abs((e-b))/(1000*60*60*24);if(f>spmReturnLimit[0]){return true}return false}function f_onSelectedItem(b){var e=this.options;var a=om_return_grid.getData();for(var c=0;c<a.length;c++){if(a[c].orderLineId==b.data[0].lineId){Hap.showError($l("msg.warning.dto.salesreturn.item.not_same"));return false}}om_return_grid.updateRow(om_return_grid.getRow(rowIndex),{salesOrgId:currentSalesOrgId,orderLineId:b.data[0].lineId,countItemId:b.data[0].countItemId,discountType:b.data[0].discountType,discountValue:b.data[0].discountValue,adjustmentAmount:b.data[0].adjustmentAmount,unitOrigPrice:b.data[0].unitOrigPrice,unitDiscountPrice:b.data[0].unitDiscountPrice,pv:b.data[0].pv,lotCtrlFlag:b.data[0].lotCtrlFlag,countStockFlag:b.data[0].countStockFlag,itemType:b.data[0].itemType,countType:b.data[0].countType,parentLineId:b.data[0].parentLineId,quantity:null,disableTaxFlag:b.data[0].disableTaxFlag,conversionRate:1});e.host_grid.updateCell("itemName",b.data[0].itemName,e.host_grid_row);e.host_grid.updateCell("countItemNumber",b.data[0].countItemNumber,e.host_grid_row);e.host_grid.updateCell("countItemName",b.data[0].countItemName,e.host_grid_row);e.host_grid.updateCell("unitSellingPrice",b.data[0].unitSellingPrice,e.host_grid_row);e.host_grid.updateCell("unitRedeemPoint",b.data[0].unitRedeemPoint,e.host_grid_row);e.host_grid.updateCell("uomName",b.data[0].uomName,e.host_grid_row);e.host_grid.updateCell("orderQuantity",b.data[0].quantity,e.host_grid_row);if(b.data[0].outstandingQty-b.data[0].returnQty<0){e.host_grid.updateCell("enabledRtnQuantity",0,e.host_grid_row)}else{e.host_grid.updateCell("enabledRtnQuantity",b.data[0].outstandingQty-b.data[0].returnQty,e.host_grid_row)}var e=this.options;tr=$(e.host_grid.getRowObj(e.host_grid_row));tr.next("tr.l-grid-detailpanel").remove();tr.find(".l-grid-row-cell-detailbtn").removeClass("l-open");if(b.data[0].countType!="PACKG"){if(b.data[0].itemType=="PACKG"||b.data[0].itemType=="VN"||b.data[0].itemType=="VY"){var d=new Object();d.headerId=$("#orderHeaderId").val();d.defaultInvOrgId=liger.get("invOrgId").getValue();d.parentLineId=b.data[0].lineId;d.returnId=$("#returnId").val();d.returnStatus=liger.get("returnStatus").getValue();$.ajax({url:_basePath+"/om/sales/getHierarchyByParentLineId",type:"POST",dataType:"json",data:JSON2.stringify(d),contentType:"application/json",success:function(g){if(g.success){for(var f=0;f<g.rows.length;f++){g.rows[f].orderLineId=g.rows[f].lineId;g.rows[f].orderQuantity=g.rows[f].quantity;g.rows[f].quantity=0;g.rows[f].enabledRtnQuantity=g.rows[f].outstandingQty-g.rows[f].returnQty;g.rows[f].returnInvFlag=e.host_grid_row.returnInvFlag;g.rows[f].salesRtnLots=null}om_return_grid.updateRow(om_return_grid.getRow(rowIndex),{itemPkgDetail:g.rows})}}})}}}function f_onChangeValue(b){if(!b){if(!om_return_grid.editor.editParm||!om_return_grid.editor.editParm.record){return}var a=om_return_grid.editor.editParm.record;om_return_grid.updateRow(a,{itemName:null,countItemNumber:null,countItemName:null,unitSellingPrice:null,uomName:null,orderQuantity:null,enabledRtnQuantity:null,returnId:null,salesOrgId:null,orderLineId:null,itemId:null,pv:null,countItemId:null,quantity:null,returnPromotion:null,returnInvFlag:null,salesRtnLots:null,discountType:null,discountValue:null,unitOrigPrice:null,unitDiscountPrice:null,adjustmentAmount:null,lotCtrlFlag:null,countStockFlag:null,itemType:null,countType:null,conversionRate:1,conversionAmt:null,itemPkgDetail:null});f_amtCalculation()}}function lineItemPkgVali(d){var b=d.salesRtnLines;var l;for(var h=0;h<b.length;h++){if(b[h].countType!="PACKG"){if(b[h].itemType=="PACKG"||b[h].itemType=="VN"&&b[h].itemType=="VY"){l=b[h].itemPkgDetail;for(var g=0;g<l.length;g++){if(!l[g].quantity){Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.larger_zero"));return false}if(b[h].countStockFlag=="Y"&&b[h].countType=="IDV"){if(b[h].returnInvFlag=="N"){if(l[g].returnInvFlag!="N"){Hap.showError($l("msg.warning.dto.salesreturn.returninvflag.not_match_n"));return false}}if(b[h].returnInvFlag=="Y"){if(l[g].returnInvFlag!="Y"){Hap.showError($l("msg.warning.dto.salesreturn.returninvflag.not_match_y"));return false}}if(l[g].countStockFlag=="O"&&l[g].lotCtrlFlag=="Y"){if(l[g].salesRtnLots==undefined){Hap.showError('"'+b[h].itemName+'"'+$l("msg.warning.dto.salesreturn.returnlot.not_selection"));return false}else{var c=l[g].salesRtnLots;var f=l[g].quantity;var a=0;for(var e=0;e<c.length;e++){if(c[e].__status!="delete"){a+=c[e].quantity}}if(f!=a){Hap.showError('"'+b[h].itemName+'"'+$l("msg.warning.dto.salesreturn.returnquantity.not_equals"));return false}}}}}}}}return true}function returnInfoVali(d){if(!Hap.validateForm(om_return_form)){return false}if(!Hap.validateGrid(om_rtnRefund_grid)){return false}var n;for(var f=0;f<d.salesRtnLines.length;f++){if(d.salesRtnLines[f].__status!="delete"){n=d.salesRtnLines[f];if(n.countStockFlag!="N"&&n.lotCtrlFlag=="Y"){if(!n.salesRtnLots||n.salesRtnLots.length==0){Hap.showError($l("msg.error.dm.delivery_lot_can_not_be_empty"));return false}}if(!n.itemId){Hap.showError($l("msg.warning.dto.inventory.stockio.no_item_selected"));return false}if(!n.returnInvFlag){Hap.showError($l("msg.error.order.returninvflag_not_empty"));return false}if(!n.quantity){Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.larger_zero"));return false}if(n.enabledRtnQuantity<n.quantity){Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.not_match"));return false}if(!n.conversionRate&&n.conversionRate!=0){Hap.showError($l("msg.warning.dto.salesreturn.conversionrate.error"));return false}if(!lineItemPkgVali(d)){return false}}}var l=Number(d.amount).toFixed(precision);var j=Number(0);var a=Number(d.adjustAmt).toFixed(precision);var k=Number(d.shippingFeeAmt).toFixed(precision);var e=Number(d.returnPromotionSum).toFixed(precision);var m=Number(d.actualPayAmount).toFixed(precision);if(d.returnType=="REFD"&&m!=0&&d.salesRtnRefundLines==null){Hap.showError($l("msg.error.rm.refund_way_not_null"));return false}var h=0;var g=Number(0);if(d.returnType=="REFD"&&m!=0){for(var f=0;f<d.salesRtnRefundLines.length;f++){if(d.salesRtnRefundLines[f].__status!="delete"){if("RDEM"==d.orderType&&"SP"==d.salesRtnRefundLines[f].refundMethod){h++;g+=Number(d.salesRtnRefundLines[f].refundAmount)}j+=Number(d.salesRtnRefundLines[f].refundAmount)}}if(Number(j).toFixed(precision)!=m){Hap.showError($l("msg.warning.dto.salesreturn.returnamount.not_match"));return false}if("RDEM"==d.orderType){if(h!=1||Number(g).toFixed(precision)!=(m-a)){Hap.showError($l("msg.warning.dto.salesreturn.rtnmethod.not_match"));return false}}}var b=Number(l)+Number(a)+Number(k)-Number(e)-Number(d.manualAdjustAmt);if(Number(b).toFixed(precision)!=m){Hap.showError($l("msg.warning.dto.salesreturn.returnamount.not_match"));return false}var c=f_shippingFeeAndAdjustVal(m);if("ADJ"==c){Hap.showError($l("msg.error.rm.must_return_adjust_amt"));return false}else{if("SHIP"==c){Hap.showError($l("msg.error.rm.must_return_shipping_fee_amt"));return false}}return true}function f_shippingFeeAndAdjustVal(e){var j=liger.get("shippingFeeFlag").getValue();var c=$("#shippingFeeFlagBefore").val();var f=Number($("#shippingFeeAmt").val());var a=liger.get("returnAdjustFlag").getValue();var h=$("#rtnAdjustFlagBefore").val();var b=Number($("#adjustAmt").val());var l=0;var k=0;var g=om_return_grid.getData();for(var d=0;d<g.length;d++){l+=g[d].enabledRtnQuantity;k+=g[d].quantity}if(l==k){if(f!=Number(0)&&j=="N"){if(c=="N"){return"SHIP"}}if(b!=Number(0)&&a=="N"){if(h=="N"){return"ADJ"}}}return"YES"}function f_deleteReturnInfo(){var a=new Array();a.push(f_getRequestData());$.ligerDialog.confirm($l("msg.warning.sys.delete_or_not"),function(b){if(b){$.ligerDialog.waitting($l("sys.hand.tip.processing"));Hap.ajax({url:_basePath+"/om/return/deleteSalesReturn",data:a,success:function(d){if(d.success){var c=new Object();c.json=d;Hap.defaultSuccessHandler(c);window.location=_basePath+"/om/om_salesreturn_create.html"}}});return true}else{return false}})}function f_saveReturnInfo(){if(om_return_grid.conn){return}if(!returnInfoVali(f_getRequestData())){return false}$.ligerDialog.waitting($l("sys.hand.tip.processing"));Hap.ajax({url:_basePath+"/om/return/saveRtnDetail",data:f_getRequestData(),success:function(c){if(c.success){var b=c.rows[0].returnId;var a=new Object();a.json=c;Hap.defaultSuccessHandler(a);window.location=_basePath+"/om/om_salesreturn_create.html?returnId="+b}}})}function f_submitReturnInfo(){if(!returnInfoVali(f_getRequestData())){return false}$.ligerDialog.confirm($l("msg.warning.sys.commit_or_not"),function(a){if(a){$.ligerDialog.waitting($l("sys.hand.tip.processing"));Hap.ajax({url:_basePath+"/om/return/submitRtnDetail",data:f_getRequestData(),success:function(d){if(d.success){var c=d.rows[0].returnId;var b=new Object();b.json=d;Hap.defaultSuccessHandler(b);window.location=_basePath+"/om/om_salesreturn_create.html?returnId="+c}}})}})}function f_initPage(a){liger.get("returnType").setData(returnTypeData);liger.get("salesOrgId").set({readonly:true});liger.get("orderNumber").set({readonly:true});liger.get("returnType").set({readonly:true});liger.get("returnReason").set({readonly:true});liger.get("returnStatus").set({readonly:true});liger.get("returnAdjustFlag").set({readonly:true});liger.get("shippingFeeFlag").set({readonly:true});liger.get("invOrgId").set({readonly:true});liger.get("remark").set({readonly:true});if(a!="NEW"){$("#manualAdjustAmt").attr("disabled",true);$("#comments").attr("disabled",true);$("[toolbarid='om_return_lotGridAdd']").hide();$("[toolbarid='om_return_lotGridDel']").hide();$("[toolbarid='om_return_gridAdd']").hide();$("[toolbarid='om_return_gridDel']").hide();$("[toolbarid='om_rtnRefund_gridAdd']").hide();$("[toolbarid='om_rtnRefund_gridDel']").hide();submitBtn.setDisabled();saveBtn.setDisabled();deleteBtn.setDisabled()}}function f_getRequestData(){var a=om_return_form.getData();a.payDate=new Date(Date.parse($("#payDate").val()));a.returnDate=new Date(Date.parse(new Date()));a.amount=Number($("#returnAmtCount")[0].textContent).toFixed(precision);a.taxAmount=Number($("#taxAmt")[0].textContent).toFixed(precision);a.actualPayAmount=Number($("#actualRtnAmt")[0].textContent).toFixed(precision);a.returnPromotionSum=Number($("#rtnPromotionSum")[0].textContent).toFixed(precision);a.adjustAmt=Number($("#adjustAmtCount")[0].textContent).toFixed(precision);a.shippingFeeAmt=Number($("#shippingFeeAmtCount")[0].textContent).toFixed(precision);a.manualAdjustAmt=Number($("#manualAdjustAmt").val()).toFixed(precision);a.comments=$("#comments").val();var b=om_return_grid.currentData.rows;a.salesRtnLines=b;if(a.returnType=="REFD"){a.salesRtnRefundLines=om_rtnRefund_grid.currentData.rows}return a}function invLotSelect(d,b,e){lineId=b;itemId=e;var g=liger.get("returnStatus").getValue();var a=liger.get("returnType").getValue();var c=om_return_grid.getRow(d).salesRtnLots;var f={};f.rows=c;om_return_lotGrid.loadData(f);$.ligerDialog.open({target:$("#om_return_lotGrid"),width:900,height:400,buttons:[{text:$l("sys.hand.btn.ok"),cls:"l-dialog-btn-highlight",onclick:function(i,h){if(g!="NEW"){h.hide();return true}if(f_lotValidator(d)){h.hide()}else{return false}}},{text:$l("sys.hand.btn.cancel"),onclick:function(i,h){h.hide()}}]});om_return_lotGrid.reRender()}function invLotPkgSelect(d,c,b,e){if(!om_return_grid.getRow(d).quantity){Hap.showError($l("msg.warning.dto.salesreturn.returnline_quantity_pre"));return false}lineId=b;itemId=e;var g=liger.get("returnStatus").getValue();var a=om_return_grid.getRow(d).itemPkgDetail;var f={};f.rows=a[c].salesRtnLots;om_return_lotGrid.loadData(f);$.ligerDialog.open({target:$("#om_return_lotGrid"),width:900,height:400,buttons:[{text:$l("sys.hand.btn.ok"),cls:"l-dialog-btn-highlight",onclick:function(i,h){if(g!="NEW"){h.hide();return true}if(f_pkgLotValidator(d,c)){h.hide()}else{return false}}},{text:$l("sys.hand.btn.cancel"),onclick:function(i,h){h.hide()}}]});om_return_lotGrid.reRender()}function f_lotValidator(d){var a=om_return_grid.getRow(d);var c=om_return_lotGrid.currentData.rows;if(!c){return true}var g=0;var e=0;var f=a.unitDiscountPrice;if(!Hap.validateGrid(om_return_lotGrid)){return false}for(var b=0;b<c.length;b++){if(c[b].__status!="delete"){if(!c[b].lotNumber){Hap.showError($l("msg.warning.dto.salesreturn.returnline.lot_not_selection"));return false}if(c[b].quantity&&Number(c[b].quantity)>0){g+=c[b].quantity}else{Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.larger_zero"));return false}}}if(g>a.enabledRtnQuantity){Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.not_match"));return false}e=Number(f*g);om_return_grid.updateRow(om_return_grid.getRow(d),{quantity:g,returnPromotion:e,salesRtnLots:c});f_amtCalculation();return true}function f_pkgLotValidator(d,c){var e=om_return_grid.getRow(d).itemPkgDetail;var f=om_return_lotGrid.currentData.rows;if(!f){return true}var g=0;var a=e[c].quantity;if(!Hap.validateGrid(om_return_lotGrid)){return false}for(var b=0;b<f.length;b++){if(f[b].__status!="delete"){if(!f[b].lotNumber){Hap.showError($l("msg.warning.dto.salesreturn.returnline.lot_not_selection"));return false}if(f[b].quantity&&Number(f[b].quantity)>0){g+=f[b].quantity}else{Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.larger_zero"));return false}}}if(g!=a){Hap.showError($l("msg.warning.dto.salesreturn.returnquantity.not_equals"));return false}e[c].salesRtnLots=f;om_return_grid.updateRow(om_return_grid.getRow(d),{itemPkgDetail:e});return true}function f_returnAdjust(a){var b=/^-?\d*\.?\d*$/;if(!b.test(a.value)){Hap.showError($l("msg.warning.dto.salesreturn.manualadjustamt.only_numeric"));$(a).val("");f_amtCalculation();return}if(a.value<0){Hap.showError($l("msg.warning.dto.salesreturn.manualadjustamt.larger_zero"));$(a).val("");f_amtCalculation();return}f_amtCalculation()}function f_amtCalculation(){var l=0,t=0,a=0;var o=0,v=0,s=0;var f=0,r=0,g=0;var b;var h=om_return_grid.getData();var m=Number($("#manualAdjustAmt").val());var k=$("#orderType").val();var c=Number($("#orderAmt").val());var w=Number($("#adjustAmt").val());var n=Number($("#adjustAmtCount")[0].textContent);var d=Number($("#shippingFeeAmtCount")[0].textContent);var e=Number($("#voucherAmt").val());var p=Number($("#voucherOrderAmt").val());var u=Number($("#returnAmt").val());var j=Number($("#returnPromotionSum").val());l=Number(c)-Number(u)+Number(w)-Number(p);for(var q=0;q<h.length;q++){if(h[q].__status!="delete"&&h[q].itemId){g+=(h[q].quantity*h[q].pv);if("RDEM"==k){s=h[q].unitRedeemPoint}else{s=h[q].unitSellingPrice}f=h[q].quantity;r=h[q].conversionRate;conversionAmt=Number(f)*Number(r)*Number(s);om_return_grid.updateCell("conversionAmt",Number(conversionAmt).toFixed(precision),q);t+=(Number(s)*Number(f)*Number(r));a+=Number(h[q].returnPromotion);if(spmTaxFlag[0]=="Y"){b=h[q].disableTaxFlag;if("Y"!=b){o+=(Number(s)-(Number(s)/(1+taxPercent)))*Number(f)}}}}if("RDEM"!=k){if(l>=t){liger.get("returnPromotion").setValue(0);v=Number(t+n)}else{if(j>0){liger.get("returnPromotion").setValue(0);v=Number(t+n)}else{liger.get("returnPromotion").setValue(e);a+=e;v=Number(t-a+n)}}}else{v=Number(t+n)}v=v+d-m;liger.get("returnPvSum").setValue(g);$("#returnAmtCount")[0].textContent=Number(t).toFixed(precision);$("#rtnPromotionSum")[0].textContent=Number(a).toFixed(precision);$("#actualRtnAmt")[0].textContent=Number(v).toFixed(precision);if(spmTaxFlag[0]=="Y"){$("#taxAmt")[0].textContent=Number(o).toFixed(precision)}else{$("#taxAmt")[0].textContent=0}if("RDEM"==k&&om_rtnRefund_grid.rows.length>0){om_rtnRefund_grid.updateCell("refundAmount",Number(v-n).toFixed(precision),0)}}function f_amtCalculationDetail(c){$("#returnAmtCount")[0].textContent=Number(c.rows[0].amount).toFixed(precision);$("#taxAmt")[0].textContent=Number(c.rows[0].taxAmount).toFixed(precision);var a=liger.get("returnAdjustFlag").getValue();if(a=="Y"){$("#adjustAmtCount")[0].textContent=Number($("#adjustAmt").val())}else{$("#adjustAmtCount")[0].textContent=Number(0)}var b=liger.get("shippingFeeFlag").getValue();if(b=="Y"){$("#shippingFeeAmtCount")[0].textContent=Number($("#shippingFeeAmt").val())}else{$("#shippingFeeAmtCount")[0].textContent=Number(0)}$("#rtnPromotionSum")[0].textContent=Number(c.rows[0].returnPromotion).toFixed(precision);$("#actualRtnAmt")[0].textContent=Number(c.rows[0].actualPayAmount).toFixed(precision)}function f_setReturnDetai(h){var f=0;om_return_form.setData(h.rows[0]);liger.get("invOrgId").setText(h.rows[0].invOrgName);$("#manualAdjustAmt").val(h.rows[0].manualAdjustAmt);$("#comments").val(h.rows[0].comments);var l=h.rows[0].salesRtnLines;var n,c,e=0;if(l.length>0){for(var m=0;m<l.length;m++){e+=(l[m].pv*l[m].quantity);f=Number(l[m].unitSellingPrice)*Number(l[m].quantity)*Number(l[m].conversionRate);l[m].conversionAmt=Number(f).toFixed(precision);if(l[m].itemType=="PACKG"||l[m].itemType=="VN"||l[m].itemType=="VY"){if(l[m].countType=="IDV"){n=l[m].itemPkgDetail;for(var g=0;g<n.length;g++){c=n[g].salesRtnLots;for(var d=0;d<c.length;d++){c[d].__status="nochange"}}}}}}liger.get("returnPvSum").setValue(e);var a={};a.rows=h.rows[0].salesRtnLines;om_return_grid.loadData(a);var b={};b.rows=h.rows[0].salesRtnRefundLines;om_rtnRefund_grid.loadData(b);var o=$("#orderType").val();if("RDEM"==o&&h.rows[0].returnAdjustFlag=="N"){$("[toolbarid='om_rtnRefund_gridAdd']").hide();$("[toolbarid='om_rtnRefund_gridDel']").hide()}f_amtCalculationDetail(h)}function f_getItemPackageDetail(e,b,g){var a=new Object();a.rows=e.itemPkgDetail;if(e.itemType!="PACKG"&&e.itemType!="VN"&&e.itemType!="VY"){return}if(e.countType=="PACKG"){return false}var d=e.countType;var c=document.createElement("div");$(b).append(c);var f=$(c).css("margin",10).ligerGrid({columns:[{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.itemid"),name:"itemNumber",width:100,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.itemname"),name:"itemName",width:100,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.countitemnumber"),name:"countItemNumber",width:100,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.countitemname"),name:"countItemName",width:100,type:"text"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.orderquantity"),name:"orderQuantity",width:100,type:"int"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.enabledrtnquantity"),name:"enabledRtnQuantity",width:100,type:"int"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.quantity"),name:"quantity",width:100,type:"int"},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.returninvflag"),name:"returnInvFlag",width:100,editor:{type:"select",data:yesOrNo,valueField:"value",textField:"meaning"},render:function(j){for(var h in yesOrNo){if(yesOrNo[h].value==j.returnInvFlag){return yesOrNo[h].meaning}}}},{display:$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots"),name:"invLot",align:"center",width:100,render:function(k,h,j,i){if(k.lotCtrlFlag=="Y"&&k.countStockFlag=="O"){return'<a href="javascript:void(0)	" onclick="invLotPkgSelect('+e.__index+","+h+","+k.orderLineId+","+k.itemId+')">'+$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")+"</a>"}if(k.lotCtrlFlag=="N"&&k.countStockFlag=="O"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}if(k.lotCtrlFlag=="N"&&k.countStockFlag=="R"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}if(k.lotCtrlFlag=="Y"&&k.countStockFlag=="R"){return'<a href="javascript:void(0)	" onclick="invLotPkgSelect('+e.__index+","+h+","+k.orderLineId+","+k.itemId+')">'+$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")+"</a>"}if(k.countStockFlag=="N"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}}],enabledEdit:false,isScroll:false,showToggleColBtn:false,width:910,data:a,showTitle:false,usePager:false,frozen:false})}function f_itemTypeRender(d,a,c,b){if(d.countType!="IDV"){if(d.countStockFlag=="N"){om_return_grid.setCellEditing(d,b,true);return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}if(d.lotCtrlFlag=="N"){if(d.countStockFlag=="O"||d.countStockFlag=="R"||d.countStockFlag=="Y"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}}if(d.lotCtrlFlag=="Y"){if(d.countStockFlag=="O"||d.countStockFlag=="R"||d.countStockFlag=="Y"){return'<a href="javascript:void(0)	" onclick="invLotSelect('+a+","+d.orderLineId+","+d.itemId+')">'+$l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")+"</a>"}}}else{if(d.countStockFlag=="Y"&&d.countType=="IDV"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}if(d.countStockFlag=="N"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}if(d.countType=="IDV"){return $l("type.com.lkkhpg.dsis.common.order.dto.salesrtnline.lots")}}}function f_printList(){$.ligerDialog.open({title:$l("type.com.lkkhpg.dsis.report.type.choosing"),width:400,height:300,slide:false,url:_basePath+"/sys/report/sys_report_type_dialog.html",buttons:[{text:$l("sys.hand.btn.ok"),onclick:function(c,f){var b=liger.get("returnNumber").getValue();var a="RPT-RETURN-ORDER-"+marketCode;if(!orderNumber){return}else{var e=f.frame.report_type_form;var g=e.getData().docType;if(e.valid()){f.close();window.open(_basePath+"/report/run?docType="+g+"&reportProgramCode="+a+"&returnNumber="+b)}}}},{text:$l("sys.hand.btn.cancel"),onclick:function(a,b){b.hide()}}]})};