<?xml version="1.0" encoding="UTF-8"?>
<report xmlns="http://www.eclipse.org/birt/2005/design" version="3.2.23" id="1">
    <property name="createdBy">Eclipse BIRT Designer Version 4.5.0.v201506092134 Build &lt;@BUILD@></property>
    <property name="units">in</property>
    <property name="iconFile">/templates/blank_report.gif</property>
    <property name="bidiLayoutOrientation">ltr</property>
    <property name="imageDPI">120</property>
	<list-property name="libraries">
        <structure>
            <property name="fileName">datasource.rptlibrary</property>
            <property name="namespace">datasource</property>
        </structure>
    </list-property>
    <parameters>
        <parameter-group name="request" id="360">
            <parameters>
                <scalar-parameter name="locale" id="361">
                    <text-property name="helpText">language</text-property>
                    <text-property name="promptText">locale</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">string</property>
                    <property name="distinct">true</property>
                    <simple-property-list name="defaultValue">
                        <value type="constant">zh_CN</value>
                    </simple-property-list>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="marketId" id="362">
                    <text-property name="helpText">marketId</text-property>
                    <text-property name="promptText">marketId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">string</property>
                    <property name="distinct">true</property>
                    <simple-property-list name="defaultValue">
                        <value type="constant">11000001</value>
                    </simple-property-list>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="salesOrgId" id="363">
                    <property name="hidden">false</property>
                    <text-property name="helpText">Sales Org Id</text-property>
                    <text-property name="promptText">salesOrgId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">true</property>
                    <property name="dataType">integer</property>
                    <property name="distinct">true</property>
                    <simple-property-list name="defaultValue">
                        <value type="constant">11000021</value>
                    </simple-property-list>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="invOrgId" id="10">
                    <text-property name="helpText">Inv Org id</text-property>
                    <text-property name="promptText">invOrgId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">string</property>
                    <property name="distinct">true</property>
                    <simple-property-list name="defaultValue">
                        <value type="constant">11000001</value>
                    </simple-property-list>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="userId" id="11">
                    <text-property name="helpText">User Id</text-property>
                    <text-property name="promptText">userId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">integer</property>
                    <property name="distinct">true</property>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="accountId" id="12">
                    <text-property name="helpText">accountId</text-property>
                    <text-property name="promptText">accountId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">integer</property>
                    <property name="distinct">true</property>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="roleId" id="13">
                    <text-property name="helpText">roleId</text-property>
                    <text-property name="promptText">roleId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">integer</property>
                    <property name="distinct">true</property>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
                <scalar-parameter name="memberId" id="364">
                    <property name="hidden">false</property>
                    <text-property name="helpText">memberId</text-property>
                    <text-property name="promptText">memberId</text-property>
                    <property name="valueType">static</property>
                    <property name="isRequired">false</property>
                    <property name="dataType">integer</property>
                    <property name="distinct">true</property>
                    <list-property name="selectionList"/>
                    <property name="paramType">simple</property>
                    <property name="concealValue">false</property>
                    <property name="controlType">text-box</property>
                    <structure name="format">
                        <property name="category">Unformatted</property>
                    </structure>
                </scalar-parameter>
            </parameters>
        </parameter-group>
        <scalar-parameter name="trxDateFrom" id="1807">
            <text-property name="helpText">trxDateFrom</text-property>
            <text-property name="promptText">trxDateFrom</text-property>
            <property name="valueType">static</property>
            <property name="isRequired">true</property>
            <property name="dataType">string</property>
            <property name="distinct">true</property>
            <simple-property-list name="defaultValue">
                <value type="constant">2016-02-01</value>
            </simple-property-list>
            <list-property name="selectionList"/>
            <property name="paramType">simple</property>
            <property name="concealValue">false</property>
            <property name="controlType">text-box</property>
            <structure name="format">
                <property name="category">Unformatted</property>
            </structure>
        </scalar-parameter>
        <scalar-parameter name="trxDateTo" id="1808">
            <text-property name="helpText">trxDateTo</text-property>
            <text-property name="promptText">trxDateTo</text-property>
            <property name="valueType">static</property>
            <property name="isRequired">true</property>
            <property name="dataType">string</property>
            <property name="distinct">true</property>
            <simple-property-list name="defaultValue">
                <value type="constant">2016-02-29</value>
            </simple-property-list>
            <list-property name="selectionList"/>
            <property name="paramType">simple</property>
            <property name="concealValue">false</property>
            <property name="controlType">text-box</property>
            <structure name="format">
                <property name="category">Unformatted</property>
            </structure>
        </scalar-parameter>
        <scalar-parameter name="itemNumberFrom" id="1809">
            <text-property name="helpText">itemNumberFrom</text-property>
            <text-property name="promptText">itemNumberFrom</text-property>
            <property name="valueType">static</property>
            <property name="isRequired">false</property>
            <property name="dataType">string</property>
            <property name="distinct">true</property>
            <simple-property-list name="defaultValue">
                <value type="constant"></value>
            </simple-property-list>
            <list-property name="selectionList"/>
            <property name="paramType">simple</property>
            <property name="controlType">text-box</property>
            <structure name="format">
                <property name="category">Unformatted</property>
            </structure>
        </scalar-parameter>
        <scalar-parameter name="itemNumberTo" id="1810">
            <text-property name="helpText">itemNumberTo</text-property>
            <text-property name="promptText">itemNumberTo</text-property>
            <property name="valueType">static</property>
            <property name="isRequired">false</property>
            <property name="dataType">string</property>
            <property name="distinct">true</property>
            <simple-property-list name="defaultValue">
                <value type="constant"></value>
            </simple-property-list>
            <list-property name="selectionList"/>
            <property name="paramType">simple</property>
            <property name="concealValue">false</property>
            <property name="controlType">text-box</property>
            <structure name="format">
                <property name="category">Unformatted</property>
            </structure>
        </scalar-parameter>
        <scalar-parameter name="orgId" id="1900">
            <text-property name="helpText">orgId</text-property>
            <text-property name="promptText">orgId</text-property>
            <property name="valueType">static</property>
            <property name="dataType">string</property>
            <property name="distinct">true</property>
            <simple-property-list name="defaultValue">
                <value type="constant">11000001,11000041</value>
            </simple-property-list>
            <list-property name="selectionList"/>
            <property name="paramType">simple</property>
            <property name="controlType">text-box</property>
            <structure name="format">
                <property name="category">Unformatted</property>
            </structure>
        </scalar-parameter>
    </parameters>
    <data-sources>
        <oda-data-source extensionID="org.eclipse.birt.report.data.oda.jdbc" name="Data Source" id="999"
 extends="datasource.Data Source"/>
    </data-sources>
    <data-sets>
        <oda-data-set extensionID="org.eclipse.birt.report.data.oda.jdbc.JdbcSelectDataSet" name="COST" id="1806">
            <property name="nullsOrdering">nulls lowest</property>
            <list-property name="columnHints"/>
            <list-property name="parameters">
                <structure>
                    <property name="name">locale1</property>
                    <property name="paramName">locale</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">1</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateFrom1</property>
                    <property name="paramName">trxDateFrom</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">2</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateForm2</property>
                    <property name="paramName">trxDateFrom</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">3</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateTo1</property>
                    <property name="paramName">trxDateTo</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">4</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">locale2</property>
                    <property name="paramName">locale</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">5</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateForm3</property>
                    <property name="paramName">trxDateFrom</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">6</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateTo2</property>
                    <property name="paramName">trxDateTo</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">7</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateTo3</property>
                    <property name="paramName">trxDateTo</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">8</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">locale3</property>
                    <property name="paramName">locale</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">9</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">locale4</property>
                    <property name="paramName">locale</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">10</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateFrom4</property>
                    <property name="paramName">trxDateFrom</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">11</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">trxDateTo4</property>
                    <property name="paramName">trxDateTo</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">12</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">costOrgId</property>
                    <property name="paramName">invOrgId</property>
                    <property name="dataType">integer</property>
                    <property name="position">13</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">itemNumberFrom1</property>
                    <property name="paramName">itemNumberFrom</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">14</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
                <structure>
                    <property name="name">itemNumberTo1</property>
                    <property name="paramName">itemNumberTo</property>
                    <property name="nativeName"></property>
                    <property name="dataType">string</property>
                    <property name="nativeDataType">0</property>
                    <property name="position">15</property>
                    <property name="isOptional">false</property>
                    <property name="isInput">true</property>
                    <property name="isOutput">false</property>
                </structure>
            </list-property>
            <structure name="cachedMetaData">
                <list-property name="resultSet">
                    <structure>
                        <property name="position">1</property>
                        <property name="name">FLAG</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">2</property>
                        <property name="name">COST_ORG_ID</property>
                        <property name="dataType">decimal</property>
                    </structure>
                    <structure>
                        <property name="position">3</property>
                        <property name="name">ITEM_NUMBER</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">4</property>
                        <property name="name">ITEM_NAME</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">5</property>
                        <property name="name">REMARK</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">6</property>
                        <property name="name">TRX_DATE</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">7</property>
                        <property name="name">TRX_SOURCE_REFERENCE</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">8</property>
                        <property name="name">LOT_NUMBER</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">9</property>
                        <property name="name">EXPIRY_DATE</property>
                        <property name="dataType">date-time</property>
                    </structure>
                    <structure>
                        <property name="position">10</property>
                        <property name="name">TRX_TYPE_EN</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">11</property>
                        <property name="name">TRX_QTY_SUM</property>
                        <property name="dataType">decimal</property>
                    </structure>
                    <structure>
                        <property name="position">12</property>
                        <property name="name">UNIT_COST</property>
                        <property name="dataType">decimal</property>
                    </structure>
                    <structure>
                        <property name="position">13</property>
                        <property name="name">OPEN_BALANCE</property>
                        <property name="dataType">string</property>
                    </structure>
                    <structure>
                        <property name="position">14</property>
                        <property name="name">ROW_NUM</property>
                        <property name="dataType">string</property>
                    </structure>
                </list-property>
            </structure>
            <method name="beforeOpen"><![CDATA[if (params["orgId"] == null || params["orgId"] == '' || params["orgId"] == ' ') {
	this.queryText = this.queryText.replace("orgIdList", params["orgId"]);
}else {
	this.queryText = this.queryText.replace("orgIdList", params["orgId"]);
}]]></method>
            <property name="dataSource">Data Source</property>
            <list-property name="resultSet">
                <structure>
                    <property name="position">1</property>
                    <property name="name">FLAG</property>
                    <property name="nativeName">FLAG</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">2</property>
                    <property name="name">COST_ORG_ID</property>
                    <property name="nativeName">COST_ORG_ID</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">3</property>
                    <property name="name">ITEM_NUMBER</property>
                    <property name="nativeName">ITEM_NUMBER</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">4</property>
                    <property name="name">ITEM_NAME</property>
                    <property name="nativeName">ITEM_NAME</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">5</property>
                    <property name="name">REMARK</property>
                    <property name="nativeName">REMARK</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">6</property>
                    <property name="name">TRX_DATE</property>
                    <property name="nativeName">TRX_DATE</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">7</property>
                    <property name="name">TRX_SOURCE_REFERENCE</property>
                    <property name="nativeName">TRX_SOURCE_REFERENCE</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">8</property>
                    <property name="name">LOT_NUMBER</property>
                    <property name="nativeName">LOT_NUMBER</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">9</property>
                    <property name="name">EXPIRY_DATE</property>
                    <property name="nativeName">EXPIRY_DATE</property>
                    <property name="dataType">date-time</property>
                </structure>
                <structure>
                    <property name="position">10</property>
                    <property name="name">TRX_TYPE_EN</property>
                    <property name="nativeName">TRX_TYPE_EN</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">11</property>
                    <property name="name">TRX_QTY_SUM</property>
                    <property name="nativeName">TRX_QTY_SUM</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">12</property>
                    <property name="name">UNIT_COST</property>
                    <property name="nativeName">UNIT_COST</property>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="position">13</property>
                    <property name="name">OPEN_BALANCE</property>
                    <property name="nativeName">OPEN_BALANCE</property>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="position">14</property>
                    <property name="name">ROW_NUM</property>
                    <property name="nativeName">ROW_NUM</property>
                    <property name="dataType">string</property>
                </structure>
            </list-property>
            <xml-property name="queryText"><![CDATA[
SELECT FLAG,
       COST_ORG_ID,
       ITEM_NUMBER,
       ITEM_NAME,
       REMARK,
       TRX_DATE,
       TRX_SOURCE_REFERENCE,
       LOT_NUMBER,
       EXPIRY_DATE,
       TRX_TYPE_EN,
       TRX_QTY_SUM,
       UNIT_COST,
       OPEN_BALANCE,
       ROW_NUM
  FROM (SELECT DISTINCT 'O' FLAG,
                        SIOB.COST_ORG_ID,
                        ITEM.ITEM_NUMBER,
                        ITEM.ITEM_NAME,
                        NULL REMARK,
                        NULL TRX_DATE,
                        NULL TRX_SOURCE_REFERENCE,
                        INV_TRX.LOT_NUMBER,
                        INV_TRX.EXPIRY_DATE,
                        NULL TRX_TYPE_EN,
                        NVL(BEFORE_TRX_QTY.TRX_QTY_SUM, 0) TRX_QTY_SUM,
                        LAST_UNIT_COST.UNIT_COST,
                        'Opening Balance' OPEN_BALANCE,
                        '1OB' ROW_NUM
          FROM INV_TRANSACTION INV_TRX
          LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
            ON SIOB.INV_ORG_ID = INV_TRX.ORGANIZATION_ID
          LEFT OUTER JOIN ( --商品
                          SELECT IIB.ITEM_ID, IIB.ITEM_NUMBER, IIT.ITEM_NAME
                            FROM INV_ITEM_B IIB
                            LEFT OUTER JOIN INV_ITEM_TL IIT
                              ON (IIT.ITEM_ID = IIB.ITEM_ID AND
                                 IIT.LANG = ?)) ITEM
            ON ITEM.ITEM_ID = INV_TRX.ITEM_ID
          LEFT OUTER JOIN ( --上月单位成本
                          SELECT DISTINCT
                          		  ICR.COST_ORG_ID,
                                  ICR.ITEM_ID,
                                  ICR.YEAR,
                                  ICR.MONTH,
                                  ICR.UNIT_COST,
                                  ICR.LOT_NUMBER,
                                  ICR.EXPIRY_DATE
                            FROM INV_COST_RECORDS ICR
                           WHERE ICR.STATUS = 'P'
                             AND CONCAT(ICR.YEAR, LPAD(ICR.MONTH, 2, 0)) =
                                 TO_CHAR(ADD_MONTHS(TO_DATE(?,
                                                            'yyyy-MM-dd'),
                                                    -1),
                                         'YYYYMM')) LAST_UNIT_COST
            ON LAST_UNIT_COST.ITEM_ID = INV_TRX.ITEM_ID
           AND LAST_UNIT_COST.COST_ORG_ID = SIOB.COST_ORG_ID
           AND (LAST_UNIT_COST.LOT_NUMBER IS NULL OR
               LAST_UNIT_COST.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (LAST_UNIT_COST.EXPIRY_DATE IS NULL OR
               LAST_UNIT_COST.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
          LEFT OUTER JOIN ( --起始日期之前事务处理数量
                          SELECT SIOB.COST_ORG_ID,
                                  IT.ITEM_ID,
                                  IT.LOT_NUMBER,
                                  IT.EXPIRY_DATE,
                                  SUM(IT.TRX_QTY) TRX_QTY_SUM
                            FROM INV_TRANSACTION IT
                            LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
                              ON SIOB.INV_ORG_ID = IT.ORGANIZATION_ID
                           WHERE IT.TRX_DATE <
                                 TO_DATE(?, 'yyyy-MM-dd')
                           GROUP BY (SIOB.COST_ORG_ID, IT.ITEM_ID,
                                      IT.LOT_NUMBER, IT.EXPIRY_DATE)) BEFORE_TRX_QTY
            ON BEFORE_TRX_QTY.ITEM_ID = INV_TRX.ITEM_ID
           AND BEFORE_TRX_QTY.COST_ORG_ID = SIOB.COST_ORG_ID
           AND (BEFORE_TRX_QTY.LOT_NUMBER IS NULL OR
               BEFORE_TRX_QTY.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (BEFORE_TRX_QTY.EXPIRY_DATE IS NULL OR
               BEFORE_TRX_QTY.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
         WHERE TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM-DD') <= ?
        UNION
        SELECT DISTINCT 'C' FLAG,
                        SIOB.COST_ORG_ID,
                        ITEM.ITEM_NUMBER,
                        ITEM.ITEM_NAME,
                        NULL REMARK,
                        NULL TRX_DATE,
                        NULL TRX_SOURCE_REFERENCE,
                        INV_TRX.LOT_NUMBER,
                        INV_TRX.EXPIRY_DATE,
                        NULL TRX_TYPE_EN,
                        NVL(CURRENT_TRX_QTY.TRX_QTY_SUM, 0) TRX_QTY_SUM,
                        LAST_UNIT_COST.UNIT_COST,
                        'Closing Balance' OPEN_BALANCE,
                        '1CB' ROW_NUM
          FROM INV_TRANSACTION INV_TRX
          LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
            ON SIOB.INV_ORG_ID = INV_TRX.ORGANIZATION_ID
          LEFT OUTER JOIN ( --商品
                          SELECT IIB.ITEM_ID, IIB.ITEM_NUMBER, IIT.ITEM_NAME
                            FROM INV_ITEM_B IIB
                            LEFT OUTER JOIN INV_ITEM_TL IIT
                              ON (IIT.ITEM_ID = IIB.ITEM_ID AND
                                 IIT.LANG = ?)) ITEM
            ON ITEM.ITEM_ID = INV_TRX.ITEM_ID
          LEFT OUTER JOIN ( --本月单位成本
                          SELECT DISTINCT
                          		  ICR.COST_ORG_ID,
                                  ICR.ITEM_ID,
                                  ICR.YEAR,
                                  ICR.MONTH,
                                  ICR.UNIT_COST,
                                  ICR.LOT_NUMBER,
                                  ICR.EXPIRY_DATE
                            FROM INV_COST_RECORDS ICR
                           WHERE ICR.STATUS = 'P'
                             AND CONCAT(ICR.YEAR, LPAD(ICR.MONTH, 2, 0)) =
                                 TO_CHAR(TO_DATE(?, 'yyyy-MM-dd'), 'YYYYMM')) LAST_UNIT_COST
            ON LAST_UNIT_COST.ITEM_ID = INV_TRX.ITEM_ID
           AND LAST_UNIT_COST.COST_ORG_ID = SIOB.COST_ORG_ID
           AND (LAST_UNIT_COST.LOT_NUMBER IS NULL OR
               LAST_UNIT_COST.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (LAST_UNIT_COST.EXPIRY_DATE IS NULL OR
               LAST_UNIT_COST.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
          LEFT OUTER JOIN ( --终止日期之前的事务处理数量(期末数量)
                          SELECT SIOB.COST_ORG_ID,
                                  IT.ITEM_ID,
                                  IT.LOT_NUMBER,
                                  IT.EXPIRY_DATE,
                                  SUM(IT.TRX_QTY) TRX_QTY_SUM
                            FROM INV_TRANSACTION IT
                            LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
                              ON SIOB.INV_ORG_ID = IT.ORGANIZATION_ID
                           WHERE IT.TRX_DATE <
                                 TO_DATE(?, 'yyyy-MM-dd')
                           GROUP BY (SIOB.COST_ORG_ID, IT.ITEM_ID,
                                      IT.LOT_NUMBER, IT.EXPIRY_DATE)) CURRENT_TRX_QTY
            ON CURRENT_TRX_QTY.ITEM_ID = INV_TRX.ITEM_ID
           AND CURRENT_TRX_QTY.COST_ORG_ID = SIOB.COST_ORG_ID
           AND (CURRENT_TRX_QTY.LOT_NUMBER IS NULL OR
               CURRENT_TRX_QTY.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (CURRENT_TRX_QTY.EXPIRY_DATE IS NULL OR
               CURRENT_TRX_QTY.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
         WHERE TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM-DD') <= ?
        UNION
        SELECT DISTINCT 'D' FLAG,
                        SIOB.COST_ORG_ID, --库存归集中心组织
                        ITEM.ITEM_NUMBER, --商品编号
                        ITEM.ITEM_NAME, --商品名称
                        NULL REMARK, --备注
                        (CASE INV_TRX.TRX_TYPE
                          WHEN 'DELVY' THEN
                           TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM') --事务处理日期
                          ELSE
                           TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM-DD')
                        END) TRX_DATE,
                        (CASE INV_TRX.TRX_TYPE
                          WHEN 'DELVY' THEN
                           ''
                          ELSE
                           INV_TRX.TRX_SOURCE_REFERENCE
                        END) TRX_SOURCE_REFERENCE, --来源单据
                        INV_TRX.LOT_NUMBER, --批次号
                        INV_TRX.EXPIRY_DATE, --批次到期日
                        (SELECT SCVT.MEANING
                           FROM SYS_CODE_B        SCB,
                                SYS_CODE_VALUE_B  SVB,
                                SYS_CODE_VALUE_TL SCVT
                          WHERE SCB.CODE = 'INV.TRANSACTION_TYPE'
                            AND SVB.CODE_ID = SCB.CODE_ID
                            AND SVB.CODE_VALUE_ID = SCVT.CODE_VALUE_ID
                            AND SVB.VALUE = INV_TRX.TRX_TYPE
                            AND SCVT.LANG = ?) TRX_TYPE_EN, --事务处理类型
                        (CASE INV_TRX.TRX_TYPE
                          WHEN 'DELVY' THEN
                           NVL(QTY_DELVY_SUM.TRX_QTY_SUM, 0)
                          ELSE
                           NVL(INV_TRX.TRX_QTY, 0)
                        END) TRX_QTY_SUM, --事务处理数量
                        NVL(CURRENT_UNIT_COST.UNIT_COST, 0) UNIT_COST, --单位成本
                        NULL OPEN_BALANCE, --opening balance
                        NULL ROW_NUM
          FROM INV_TRANSACTION INV_TRX
          LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
            ON SIOB.INV_ORG_ID = INV_TRX.ORGANIZATION_ID
          LEFT OUTER JOIN ( --商品
                          SELECT IIB.ITEM_ID, IIB.ITEM_NUMBER, IIT.ITEM_NAME
                            FROM INV_ITEM_B IIB
                            LEFT OUTER JOIN INV_ITEM_TL IIT
                              ON (IIT.ITEM_ID = IIB.ITEM_ID AND
                                 IIT.LANG = ?)) ITEM
            ON ITEM.ITEM_ID = INV_TRX.ITEM_ID
          LEFT OUTER JOIN ( --本月期末成本
                          SELECT DISTINCT
								  ICR.UNIT_COST,
                                  ICR.ITEM_ID,
                                  ICR.LOT_NUMBER,
                                  ICR.EXPIRY_DATE,
                                  ICR.YEAR,
                                  ICR.MONTH,
                                  ICR.COST_ORG_ID
                            FROM INV_COST_RECORDS ICR
                           WHERE ICR.STATUS = 'P') CURRENT_UNIT_COST
            ON CURRENT_UNIT_COST.ITEM_ID = INV_TRX.ITEM_ID
           AND CURRENT_UNIT_COST.COST_ORG_ID = SIOB.COST_ORG_ID
           AND (CURRENT_UNIT_COST.LOT_NUMBER IS NULL OR
               CURRENT_UNIT_COST.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (CURRENT_UNIT_COST.EXPIRY_DATE IS NULL OR
               CURRENT_UNIT_COST.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
           AND CURRENT_UNIT_COST.YEAR = TO_CHAR(INV_TRX.TRX_DATE, 'YYYY')
           AND CURRENT_UNIT_COST.MONTH = TO_CHAR(INV_TRX.TRX_DATE, 'MM')
          LEFT OUTER JOIN ( --发运数量
                          SELECT SUM(IT.TRX_QTY) TRX_QTY_SUM,
                                  SIOB.COST_ORG_ID,
                                  IT.ITEM_ID,
                                  IT.LOT_NUMBER,
                                  IT.EXPIRY_DATE,
                                  TO_CHAR(IT.TRX_DATE, 'YYYY-MM') TRX_DATE
                            FROM INV_TRANSACTION IT
                            LEFT OUTER JOIN SPM_INV_ORGANIZATION_B SIOB
                              ON SIOB.INV_ORG_ID = IT.ORGANIZATION_ID
                           WHERE IT.TRX_TYPE = 'DELVY'
                           GROUP BY (SIOB.COST_ORG_ID, IT.ITEM_ID,
                                      IT.LOT_NUMBER, IT.EXPIRY_DATE,
                                      TO_CHAR(IT.TRX_DATE, 'YYYY-MM'))) QTY_DELVY_SUM
            ON QTY_DELVY_SUM.ITEM_ID = INV_TRX.ITEM_ID
           AND QTY_DELVY_SUM.COST_ORG_ID = SIOB.COST_ORG_ID
           AND QTY_DELVY_SUM.TRX_DATE = TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM')
           AND (QTY_DELVY_SUM.LOT_NUMBER IS NULL OR
               QTY_DELVY_SUM.LOT_NUMBER = INV_TRX.LOT_NUMBER)
           AND (QTY_DELVY_SUM.EXPIRY_DATE IS NULL OR
               QTY_DELVY_SUM.EXPIRY_DATE = INV_TRX.EXPIRY_DATE)
         WHERE TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM-DD') >= ?
           AND TO_CHAR(INV_TRX.TRX_DATE, 'YYYY-MM-DD') <= ?) HK_UNIT_COST
 WHERE HK_UNIT_COST.COST_ORG_ID = ?
 	AND HK_UNIT_COST.ITEM_NUMBER >= COALESCE(?, HK_UNIT_COST.ITEM_NUMBER)
	AND HK_UNIT_COST.ITEM_NUMBER <= COALESCE(?, HK_UNIT_COST.ITEM_NUMBER)
 ORDER BY ITEM_NUMBER ASC, FLAG DESC, COST_ORG_ID DESC, LOT_NUMBER ASC
]]></xml-property>
        </oda-data-set>
    </data-sets>
    <page-setup>
        <simple-master-page name="Simple MasterPage" id="2">
            <property name="type">a4</property>
            <property name="orientation">landscape</property>
        </simple-master-page>
    </page-setup>
    <body>
        <table id="1812">
            <property name="canShrink">false</property>
            <property name="width">11.2in</property>
            <property name="dataSet">COST</property>
            <list-property name="boundDataColumns">
                <structure>
                    <property name="name">ITEM_NUMBER</property>
                    <text-property name="displayName">ITEM_NUMBER</text-property>
                    <expression name="expression" type="javascript">dataSetRow["ITEM_NUMBER"]</expression>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="name">ITEM_NAME</property>
                    <text-property name="displayName">ITEM_NAME</text-property>
                    <expression name="expression" type="javascript">dataSetRow["ITEM_NAME"]</expression>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="name">REMARK</property>
                    <text-property name="displayName">REMARK</text-property>
                    <expression name="expression" type="javascript">dataSetRow["REMARK"]</expression>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="name">TRX_DATE</property>
                    <text-property name="displayName">TRX_DATE</text-property>
                    <expression name="expression" type="javascript">if (dataSetRow["TRX_DATE"] == null)&#13;
	""&#13;
else &#13;
	dataSetRow["TRX_DATE"]</expression>
                    <property name="dataType">string</property>
                    <property name="allowExport">true</property>
                </structure>
                <structure>
                    <property name="name">TRX_SOURCE_REFERENCE</property>
                    <text-property name="displayName">TRX_SOURCE_REFERENCE</text-property>
                    <expression name="expression" type="javascript">if (dataSetRow["TRX_SOURCE_REFERENCE"] == null || dataSetRow["TRX_SOURCE_REFERENCE"] == "")&#13;
	dataSetRow["OPEN_BALANCE"]&#13;
else&#13;
	dataSetRow["TRX_SOURCE_REFERENCE"]</expression>
                    <property name="dataType">string</property>
                    <property name="allowExport">true</property>
                </structure>
                <structure>
                    <property name="name">EXPIRY_DATE</property>
                    <text-property name="displayName">EXPIRY_DATE</text-property>
                    <expression name="expression" type="javascript">if (dataSetRow["EXPIRY_DATE"] == null)&#13;
	""&#13;
else &#13;
	Formatter.format(dataSetRow["EXPIRY_DATE"],'yyyy-MM-dd')</expression>
                    <property name="dataType">string</property>
                    <property name="allowExport">true</property>
                </structure>
                <structure>
                    <property name="name">TRX_TYPE_EN</property>
                    <text-property name="displayName">TRX_TYPE_EN</text-property>
                    <expression name="expression" type="javascript">if(dataSetRow["TRX_TYPE_EN"] == null || dataSetRow["TRX_TYPE_EN"] == "")&#13;
	dataSetRow["ROW_NUM"]&#13;
else&#13;
	dataSetRow["TRX_TYPE_EN"]</expression>
                    <property name="dataType">string</property>
                    <property name="allowExport">true</property>
                </structure>
                <structure>
                    <property name="name">TRX_QTY_SUM</property>
                    <text-property name="displayName">TRX_QTY_SUM</text-property>
                    <expression name="expression" type="javascript">dataSetRow["TRX_QTY_SUM"]</expression>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="name">UNIT_COST</property>
                    <text-property name="displayName">UNIT_COST</text-property>
                    <expression name="expression" type="javascript">dataSetRow["UNIT_COST"]</expression>
                    <property name="dataType">decimal</property>
                </structure>
                <structure>
                    <property name="name">TotalCost</property>
                    <text-property name="displayName">TotalCost</text-property>
                    <expression name="expression" type="javascript">dataSetRow["TRX_QTY_SUM"]*dataSetRow["UNIT_COST"]</expression>
                    <property name="dataType">decimal</property>
                    <property name="allowExport">true</property>
                </structure>
                <structure>
                    <property name="name">LOT_NUMBER</property>
                    <text-property name="displayName">LOT_NUMBER</text-property>
                    <expression name="expression" type="javascript">dataSetRow["LOT_NUMBER"]</expression>
                    <property name="dataType">string</property>
                </structure>
                <structure>
                    <property name="name">ORGANIZATION_ID</property>
                    <text-property name="displayName">COST_ORG_ID</text-property>
                    <expression name="expression" type="javascript">dataSetRow["COST_ORG_ID"]</expression>
                    <property name="dataType">integer</property>
                    <property name="allowExport">true</property>
                </structure>
            </list-property>
            <structure name="toc"/>
            <column id="1871">
                <property name="width">0.8in</property>
            </column>
            <column id="1872">
                <property name="width">1.4in</property>
            </column>
            <column id="1895">
                <property name="width">0.8in</property>
            </column>
            <column id="1873">
                <property name="width">0.8in</property>
            </column>
            <column id="1874">
                <property name="width">0.8in</property>
            </column>
            <column id="1875">
                <property name="width">1.5in</property>
            </column>
            <column id="1906">
                <property name="width">1.2in</property>
            </column>
            <column id="1899">
                <property name="width">0.8in</property>
            </column>
            <column id="1879">
                <property name="width">0.6in</property>
            </column>
            <column id="1880">
                <property name="width">0.6in</property>
            </column>
            <column id="1885">
                <property name="width">0.6in</property>
            </column>
            <column id="1890">
                <property name="fontFamily">"Arial"</property>
                <property name="width">0.65in</property>
            </column>
            <header>
                <row id="1813">
                    <property name="fontFamily">"Arial"</property>
                    <property name="fontWeight">bold</property>
                    <property name="borderBottomStyle">solid</property>
                    <property name="borderBottomWidth">thin</property>
                    <property name="textAlign">left</property>
                    <cell id="1814">
                        <label id="1815">
                            <text-property name="text">Product Code</text-property>
                        </label>
                    </cell>
                    <cell id="1816">
                        <label id="1817">
                            <text-property name="text">Product Name</text-property>
                        </label>
                    </cell>
                    <cell id="1892">
                        <label id="1829">
                            <text-property name="text">Type of Movement</text-property>
                        </label>
                    </cell>
                    <cell id="1818">
                        <label id="1819">
                            <text-property name="text">Description</text-property>
                        </label>
                    </cell>
                    <cell id="1820">
                        <label id="1821">
                            <text-property name="text">Date</text-property>
                        </label>
                    </cell>
                    <cell id="1822">
                        <label id="1823">
                            <text-property name="text">Ref No.</text-property>
                        </label>
                    </cell>
                    <cell id="1903">
                        <label id="1907">
                            <text-property name="text">Batch No.</text-property>
                        </label>
                    </cell>
                    <cell id="1896">
                        <label id="1827">
                            <text-property name="text">Expiry Date</text-property>
                        </label>
                    </cell>
                    <cell id="1830">
                        <label id="1831">
                            <text-property name="text">Total&#13;
QTY</text-property>
                        </label>
                    </cell>
                    <cell id="1832">
                        <label id="1833">
                            <text-property name="text">Unit Cost HK$</text-property>
                        </label>
                    </cell>
                    <cell id="1882">
                        <label id="1886">
                            <text-property name="text">Total Cost&#13;
HK$</text-property>
                        </label>
                    </cell>
                    <cell id="1887">
                        <label id="1891">
                            <text-property name="text">Checking</text-property>
                        </label>
                    </cell>
                </row>
            </header>
            <detail>
                <row id="1836">
                    <property name="fontFamily">"Arial"</property>
                    <cell id="1837">
                        <data id="1838">
                            <property name="resultSetColumn">ITEM_NUMBER</property>
                        </data>
                    </cell>
                    <cell id="1839">
                        <data id="1840">
                            <property name="resultSetColumn">ITEM_NAME</property>
                        </data>
                    </cell>
                    <cell id="1893">
                        <data id="1852">
                            <property name="resultSetColumn">TRX_TYPE_EN</property>
                        </data>
                    </cell>
                    <cell id="1841">
                        <data id="1842">
                            <property name="resultSetColumn">REMARK</property>
                        </data>
                    </cell>
                    <cell id="1843">
                        <data id="1844">
                            <property name="resultSetColumn">TRX_DATE</property>
                        </data>
                    </cell>
                    <cell id="1845">
                        <data id="1846">
                            <property name="resultSetColumn">TRX_SOURCE_REFERENCE</property>
                        </data>
                    </cell>
                    <cell id="1904">
                        <data id="1908">
                            <property name="resultSetColumn">LOT_NUMBER</property>
                        </data>
                    </cell>
                    <cell id="1897">
                        <data id="1850">
                            <property name="resultSetColumn">EXPIRY_DATE</property>
                        </data>
                    </cell>
                    <cell id="1853">
                        <data id="1854">
                            <property name="resultSetColumn">TRX_QTY_SUM</property>
                        </data>
                    </cell>
                    <cell id="1855">
                        <data id="1856">
                            <structure name="numberFormat">
                                <property name="category">Currency</property>
                                <property name="pattern">###0.00{RoundingMode=HALF_UP}</property>
                            </structure>
                            <property name="resultSetColumn">UNIT_COST</property>
                        </data>
                    </cell>
                    <cell id="1883">
                        <data id="1902">
                            <structure name="numberFormat">
                                <property name="category">Currency</property>
                                <property name="pattern">###0.00{RoundingMode=HALF_UP}</property>
                            </structure>
                            <property name="resultSetColumn">TotalCost</property>
                        </data>
                    </cell>
                    <cell id="1888"/>
                </row>
            </detail>
            <footer>
                <row id="1859">
                    <cell id="1860"/>
                    <cell id="1861"/>
                    <cell id="1894"/>
                    <cell id="1862"/>
                    <cell id="1863"/>
                    <cell id="1864"/>
                    <cell id="1905"/>
                    <cell id="1898"/>
                    <cell id="1868"/>
                    <cell id="1869"/>
                    <cell id="1884"/>
                    <cell id="1889"/>
                </row>
            </footer>
        </table>
    </body>
</report>
